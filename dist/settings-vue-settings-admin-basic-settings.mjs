/*! third party licenses: dist/vendor.LICENSE.txt */
import{b_ as a,G as p,ai as k,a7 as v,b$ as c,bR as d,aV as i,bS as x}from"./core-common.mjs";import{l as m}from"./chunks/logger-C7fGMvfA.mjs";import"./chunks/index-PaKKd09k.mjs";import{z as h}from"./chunks/_plugin-vue2_normalizer-VrK6B12S-BQkexw0P.mjs";import{v as y,s as C}from"./chunks/validate-DSIeNYaS.mjs";import{n as f}from"./chunks/icons-TElqpmA8.mjs";import{m as l}from"./chunks/index-DaZEPb_2.mjs";import{x as u}from"./chunks/index-CDMqmWCu.mjs";/* empty css                      */import"./chunks/index-CiG5J8j_.mjs";const w=a("settings","profileEnabledByDefault",!0),_={name:"ProfileSettings",components:{NcCheckboxRadioSwitch:p},data(){return{initialProfileEnabledByDefault:w}},methods:{async onProfileDefaultChange(e){y(e)&&await this.updateProfileDefault(e)},async updateProfileDefault(e){var o,s;try{const n=await C(e);this.handleResponse({isEnabled:e,status:(s=(o=n.ocs)==null?void 0:o.meta)==null?void 0:s.status})}catch(n){this.handleResponse({errorMessage:t("settings","Unable to update profile default setting"),error:n})}},handleResponse({isEnabled:e,status:o,errorMessage:s,error:n}){o==="ok"?this.initialProfileEnabledByDefault=e:(h(s),m.error(s,n))}}};var M=function(){var e=this,o=e._self._c;return o("div",{staticClass:"section",attrs:{id:"profile-settings"}},[o("h2",{staticClass:"inlineblock"},[e._v(" "+e._s(e.t("settings","Profile"))+" ")]),o("p",{staticClass:"settings-hint"},[e._v(" "+e._s(e.t("settings","Enable or disable profile by default for new accounts."))+" ")]),o("NcCheckboxRadioSwitch",{attrs:{type:"switch",checked:e.initialProfileEnabledByDefault},on:{"update:checked":[function(s){e.initialProfileEnabledByDefault=s},e.onProfileDefaultChange]}},[e._v(" "+e._s(e.t("settings","Enable"))+" ")])],1)},N=[],P=f(_,M,N,!1,null,"a3e0bd76");const J=P.exports,g=a("settings","lastCron"),b=a("settings","cronMaxAge",""),R=a("settings","backgroundJobsMode","cron"),E=a("settings","cliBasedCronPossible",!0),B=a("settings","cliBasedCronUser","www-data"),S=a("settings","backgroundJobsDocUrl"),T={name:"BackgroundJob",components:{NcCheckboxRadioSwitch:p,NcSettingsSection:k,NcNoteCard:v},data(){return{lastCron:g,cronMaxAge:b,backgroundJobsMode:R,cliBasedCronPossible:E,cliBasedCronUser:B,backgroundJobsDocUrl:S,relativeTime:l(g*1e3).fromNow(),maxAgeRelativeTime:l(b*1e3).fromNow()}},computed:{cronLabel(){let e=t("settings","Use system cron service to call the cron.php file every 5 minutes.");return this.cliBasedCronPossible?e+="<br>"+t("settings",'The cron.php needs to be executed by the system account "{user}".',{user:this.cliBasedCronUser}):e+="<br>"+t("settings","The PHP POSIX extension is required. See {linkstart}PHP documentation{linkend} for more details.",{linkstart:'<a target="_blank" rel="noreferrer nofollow" class="external" href="https://www.php.net/manual/en/book.posix.php">',linkend:"</a>"},void 0,{escape:!1,sanitize:!1}),e},oldExecution(){return Date.now()/1e3-this.lastCron>600},longExecutionNotCron(){return Date.now()/1e3-this.cronMaxAge>12*3600&&this.backgroundJobsMode!=="cron"},longExecutionCron(){return Date.now()/1e3-this.cronMaxAge>24*3600&&this.backgroundJobsMode==="cron"}},methods:{async onBackgroundJobModeChanged(e){var s,n;const o=c("/apps/provisioning_api/api/v1/config/apps/{appId}/{key}",{appId:"core",key:"backgroundjobs_mode"});await u();try{const{data:r}=await d.post(o,{value:e});this.handleResponse({status:(n=(s=r.ocs)==null?void 0:s.meta)==null?void 0:n.status})}catch(r){this.handleResponse({errorMessage:t("settings","Unable to update background job mode"),error:r})}},async handleResponse({status:e,errorMessage:o,error:s}){e==="ok"?await this.deleteError():(h(o),console.error(o,s))},async deleteError(){const e=c("/apps/provisioning_api/api/v1/config/apps/{appId}/{key}",{appId:"core",key:"cronErrors"});await u();try{await d.delete(e)}catch(o){console.error(o)}}}};var D=function(){var e=this,o=e._self._c;return o("NcSettingsSection",{attrs:{name:e.t("settings","Background jobs"),description:e.t("settings","For the server to work properly, it's important to configure background jobs correctly. Cron is the recommended setting. Please see the documentation for more information."),"doc-url":e.backgroundJobsDocUrl}},[e.lastCron!==0?[e.oldExecution?o("NcNoteCard",{attrs:{type:"error"}},[e._v(" "+e._s(e.t("settings","Last job execution ran {time}. Something seems wrong.",{time:e.relativeTime}))+" ")]):e.longExecutionCron?o("NcNoteCard",{attrs:{type:"warning"}},[e._v(" "+e._s(e.t("settings","Some jobs have not been executed since {maxAgeRelativeTime}. Please consider increasing the execution frequency.",{maxAgeRelativeTime:e.maxAgeRelativeTime}))+" ")]):e.longExecutionNotCron?o("NcNoteCard",{attrs:{type:"warning"}},[e._v(" "+e._s(e.t("settings","Some jobs have not been executed since {maxAgeRelativeTime}. Please consider switching to system cron.",{maxAgeRelativeTime:e.maxAgeRelativeTime}))+" ")]):o("NcNoteCard",{attrs:{type:"success"}},[e._v(" "+e._s(e.t("settings","Last job ran {relativeTime}.",{relativeTime:e.relativeTime}))+" ")])]:o("NcNoteCard",{attrs:{type:"error"}},[e._v(" "+e._s(e.t("settings","Background job did not run yet!"))+" ")]),o("NcCheckboxRadioSwitch",{staticClass:"ajaxSwitch",attrs:{type:"radio",checked:e.backgroundJobsMode,name:"backgroundJobsMode",value:"ajax"},on:{"update:checked":[function(s){e.backgroundJobsMode=s},e.onBackgroundJobModeChanged]}},[e._v(" "+e._s(e.t("settings","AJAX"))+" ")]),o("em",[e._v(e._s(e.t("settings","Execute one task with each page loaded. Use case: Single account instance.")))]),o("NcCheckboxRadioSwitch",{attrs:{type:"radio",checked:e.backgroundJobsMode,name:"backgroundJobsMode",value:"webcron"},on:{"update:checked":[function(s){e.backgroundJobsMode=s},e.onBackgroundJobModeChanged]}},[e._v(" "+e._s(e.t("settings","Webcron"))+" ")]),o("em",[e._v(e._s(e.t("settings","cron.php is registered at a webcron service to call cron.php every 5 minutes over HTTP. Use case: Very small instance (1â€“5 accounts depending on the usage).")))]),o("NcCheckboxRadioSwitch",{attrs:{type:"radio",disabled:!e.cliBasedCronPossible,checked:e.backgroundJobsMode,value:"cron",name:"backgroundJobsMode"},on:{"update:checked":[function(s){e.backgroundJobsMode=s},e.onBackgroundJobModeChanged]}},[e._v(" "+e._s(e.t("settings","Cron (Recommended)"))+" ")]),o("em",{domProps:{innerHTML:e._s(e.cronLabel)}})],2)},A=[],j=f(T,D,A,!1,null,"7ef5285c");const U=j.exports,I=a("settings","profileEnabledGlobally",!0);i.mixin({props:{logger:m},methods:{t:x}});const L=i.extend(U);if(new L().$mount("#vue-admin-background-job"),I){const e=i.extend(J);new e().$mount("#vue-admin-profile-settings")}
