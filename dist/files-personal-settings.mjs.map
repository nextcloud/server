{"version":3,"file":"files-personal-settings.mjs","sources":["../apps/files/src/components/TransferOwnershipDialogue.vue","../apps/files/src/components/PersonalSettings.vue","../apps/files/src/main-personal-settings.js"],"sourcesContent":["<!--\n  - SPDX-FileCopyrightText: 2019 Nextcloud GmbH and Nextcloud contributors\n  - SPDX-License-Identifier: AGPL-3.0-or-later\n-->\n\n<template>\n\t<div>\n\t\t<h3>{{ t('files', 'Transfer ownership of a file or folder') }} </h3>\n\t\t<form @submit.prevent=\"submit\">\n\t\t\t<p class=\"transfer-select-row\">\n\t\t\t\t<span>{{ readableDirectory }}</span>\n\t\t\t\t<NcButton v-if=\"directory === undefined\" \n\t\t\t\t\tclass=\"transfer-select-row__choose_button\"\n\t\t\t\t\t@click.prevent=\"start\">\n\t\t\t\t\t{{ t('files', 'Choose file or folder to transfer') }}\n\t\t\t\t</NcButton>\n\t\t\t\t<NcButton v-else @click.prevent=\"start\">\n\t\t\t\t\t{{ t('files', 'Change') }}\n\t\t\t\t</NcButton>\n\t\t\t</p>\n\t\t\t<p class=\"new-owner-row\">\n\t\t\t\t<label for=\"targetUser\">\n\t\t\t\t\t<span>{{ t('files', 'New owner') }}</span>\n\t\t\t\t</label>\n\t\t\t\t<NcSelect input-id=\"targetUser\"\n\t\t\t\t\tv-model=\"selectedUser\"\n\t\t\t\t\t:options=\"formatedUserSuggestions\"\n\t\t\t\t\t:multiple=\"false\"\n\t\t\t\t\t:loading=\"loadingUsers\"\n\t\t\t\t\tlabel=\"displayName\"\n\t\t\t\t\t:user-select=\"true\"\n\t\t\t\t\tclass=\"middle-align\"\n\t\t\t\t\t@search=\"findUserDebounced\" />\n\t\t\t</p>\n\t\t\t<p>\n\t\t\t\t<NcButton native-type=\"submit\"\n\t\t\t\t\ttype=\"primary\"\n\t\t\t\t\t:disabled=\"!canSubmit\">\n\t\t\t\t\t{{ submitButtonText }}\n\t\t\t\t</NcButton>\n\t\t\t</p>\n\t\t</form>\n\t</div>\n</template>\n\n<script>\nimport axios from '@nextcloud/axios'\nimport debounce from 'debounce'\nimport { generateOcsUrl } from '@nextcloud/router'\nimport { getFilePickerBuilder, showSuccess, showError } from '@nextcloud/dialogs'\nimport NcSelect from '@nextcloud/vue/dist/Components/NcSelect.js'\nimport Vue from 'vue'\nimport NcButton from '@nextcloud/vue/dist/Components/NcButton.js'\n\nimport logger from '../logger.js'\n\nconst picker = getFilePickerBuilder(t('files', 'Choose a file or folder to transfer'))\n\t.setMultiSelect(false)\n\t.setType(1)\n\t.allowDirectories()\n\t.build()\n\nexport default {\n\tname: 'TransferOwnershipDialogue',\n\tcomponents: {\n\t\tNcSelect,\n\t\tNcButton,\n\t},\n\tdata() {\n\t\treturn {\n\t\t\tdirectory: undefined,\n\t\t\tdirectoryPickerError: undefined,\n\t\t\tsubmitError: undefined,\n\t\t\tloadingUsers: false,\n\t\t\tselectedUser: null,\n\t\t\tuserSuggestions: {},\n\t\t\tconfig: {\n\t\t\t\tminSearchStringLength: parseInt(OC.config['sharing.minSearchStringLength'], 10) || 0,\n\t\t\t},\n\t\t}\n\t},\n\tcomputed: {\n\t\tcanSubmit() {\n\t\t\treturn !!this.directory && !!this.selectedUser\n\t\t},\n\t\tformatedUserSuggestions() {\n\t\t\treturn Object.keys(this.userSuggestions).map((uid) => {\n\t\t\t\tconst user = this.userSuggestions[uid]\n\t\t\t\treturn {\n\t\t\t\t\tuser: user.uid,\n\t\t\t\t\tdisplayName: user.displayName,\n\t\t\t\t\ticon: 'icon-user',\n\t\t\t\t}\n\t\t\t})\n\t\t},\n\t\tsubmitButtonText() {\n\t\t\tif (!this.canSubmit) {\n\t\t\t\treturn t('files', 'Transfer')\n\t\t\t}\n\t\t\tconst components = this.readableDirectory.split('/')\n\t\t\treturn t('files', 'Transfer {path} to {userid}', { path: components[components.length - 1], userid: this.selectedUser.displayName })\n\t\t},\n\t\treadableDirectory() {\n\t\t\tif (!this.directory) {\n\t\t\t\treturn ''\n\t\t\t}\n\t\t\treturn this.directory.substring(1)\n\t\t},\n\t},\n\tcreated() {\n\t\tthis.findUserDebounced = debounce(this.findUser, 300)\n\t\tthis.findUser('')\n\t},\n\tmethods: {\n\t\tstart() {\n\t\t\tthis.directoryPickerError = undefined\n\n\t\t\tpicker.pick()\n\t\t\t\t.then(dir => dir === '' ? '/' : dir)\n\t\t\t\t.then(dir => {\n\t\t\t\t\tlogger.debug(`path ${dir} selected for transferring ownership`)\n\t\t\t\t\tif (!dir.startsWith('/')) {\n\t\t\t\t\t\tthrow new Error(t('files', 'Invalid path selected'))\n\t\t\t\t\t}\n\t\t\t\t\t// /ocs/v2.php/apps/files/api/v1/transferownership\n\t\t\t\t\t// /ocs/v2.php/apps/files/api/v1/transferownership\n\t\t\t\t\tthis.directory = dir\n\t\t\t\t}).catch(error => {\n\t\t\t\t\tlogger.error(`Selecting object for transfer aborted: ${error.message || 'Unknown error'}`, { error })\n\n\t\t\t\t\tthis.directoryPickerError = error.message || t('files', 'Unknown error')\n\t\t\t\t\tshowError(this.directoryPickerError)\n\t\t\t\t})\n\t\t},\n\t\tasync findUser(query) {\n\t\t\tthis.query = query.trim()\n\n\t\t\tif (query.length < this.config.minSearchStringLength) {\n\t\t\t\treturn\n\t\t\t}\n\n\t\t\tthis.loadingUsers = true\n\t\t\ttry {\n\t\t\t\tconst response = await axios.get(generateOcsUrl('apps/files_sharing/api/v1/sharees'), {\n\t\t\t\t\tparams: {\n\t\t\t\t\t\tformat: 'json',\n\t\t\t\t\t\titemType: 'file',\n\t\t\t\t\t\tsearch: query,\n\t\t\t\t\t\tperPage: 20,\n\t\t\t\t\t\tlookup: false,\n\t\t\t\t\t},\n\t\t\t\t})\n\n\t\t\t\tthis.userSuggestions = {}\n\t\t\t\tresponse.data.ocs.data.exact.users.concat(response.data.ocs.data.users).forEach(user => {\n\t\t\t\t\tVue.set(this.userSuggestions, user.value.shareWith, {\n\t\t\t\t\t\tuid: user.value.shareWith,\n\t\t\t\t\t\tdisplayName: user.label,\n\t\t\t\t\t})\n\t\t\t\t})\n\t\t\t} catch (error) {\n\t\t\t\tlogger.error('could not fetch users', { error })\n\t\t\t} finally {\n\t\t\t\tthis.loadingUsers = false\n\t\t\t}\n\t\t},\n\t\tsubmit() {\n\t\t\tif (!this.canSubmit) {\n\t\t\t\tlogger.warn('ignoring form submit')\n\t\t\t}\n\n\t\t\tthis.submitError = undefined\n\t\t\tconst data = {\n\t\t\t\tpath: this.directory,\n\t\t\t\trecipient: this.selectedUser.user,\n\t\t\t}\n\t\t\tlogger.debug('submit transfer ownership form', data)\n\n\t\t\tconst url = generateOcsUrl('apps/files/api/v1/transferownership')\n\n\t\t\taxios.post(url, data)\n\t\t\t\t.then(resp => resp.data)\n\t\t\t\t.then(data => {\n\t\t\t\t\tlogger.info('Transfer ownership request sent', { data })\n\n\t\t\t\t\tthis.directory = undefined\n\t\t\t\t\tthis.selectedUser = null\n\t\t\t\t\tshowSuccess(t('files', 'Ownership transfer request sent'))\n\t\t\t\t})\n\t\t\t\t.catch(error => {\n\t\t\t\t\tlogger.error('Could not send ownership transfer request', { error })\n\n\t\t\t\t\tif (error?.response?.status === 403) {\n\t\t\t\t\t\tthis.submitError = t('files', 'Cannot transfer ownership of a file or folder you do not own')\n\t\t\t\t\t} else {\n\t\t\t\t\t\tthis.submitError = error.message || t('files', 'Unknown error')\n\t\t\t\t\t}\n\t\t\t\t\tshowError(this.submitError)\n\t\t\t\t})\n\t\t},\n\t},\n}\n</script>\n\n<style scoped lang=\"scss\">\n.middle-align {\n\tvertical-align: middle;\n}\np {\n\tmargin-top: 12px;\n\tmargin-bottom: 12px;\n}\n.new-owner-row {\n\tdisplay: flex;\n\tflex-wrap: wrap;\n\n\tlabel {\n\t\tdisplay: flex;\n\t\talign-items: center;\n\t\tmargin-bottom: calc(var(--default-grid-baseline) * 2);\n\n\t\tspan {\n\t\t\tmargin-right: 8px;\n\t\t}\n\t}\n\n\t.multiselect {\n\t\tflex-grow: 1;\n\t\tmax-width: 280px;\n\t}\n}\n.transfer-select-row {\n\tspan {\n\t\tmargin-right: 8px;\n\t}\n\n\t&__choose_button {\n\t\twidth: min(100%, 400px) !important;\n\t}\n}\n</style>\n","<!--\n  - SPDX-FileCopyrightText: 2019 Nextcloud GmbH and Nextcloud contributors\n  - SPDX-License-Identifier: AGPL-3.0-or-later\n-->\n\n<template>\n\t<div id=\"files-personal-settings\" class=\"section\">\n\t\t<h2>{{ t('files', 'Files') }}</h2>\n\t\t<TransferOwnershipDialogue />\n\t</div>\n</template>\n\n<script>\nimport TransferOwnershipDialogue from './TransferOwnershipDialogue.vue'\n\nexport default {\n\tname: 'PersonalSettings',\n\tcomponents: {\n\t\tTransferOwnershipDialogue,\n\t},\n}\n</script>\n","/**\n * SPDX-FileCopyrightText: 2019 Nextcloud GmbH and Nextcloud contributors\n * SPDX-License-Identifier: AGPL-3.0-or-later\n */\n\nimport Vue from 'vue'\nimport PersonalSettings from './components/PersonalSettings.vue'\n\nVue.prototype.t = t\n\nif (!window.TESTING) {\n\tconst View = Vue.extend(PersonalSettings)\n\tnew View().$mount('#files-personal-settings')\n}\n"],"names":["picker","getFilePickerBuilder","_sfc_main","NcSelect","NcButton","uid","user","components","debounce","dir","logger","error","showError","query","response","axios","generateOcsUrl","Vue","data","url","resp","showSuccess","TransferOwnershipDialogue","View","PersonalSettings"],"mappings":"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"}