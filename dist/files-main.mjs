/*! third party licenses: dist/vendor.LICENSE.txt */
var Ze=Object.defineProperty;var et=(e,i,s)=>i in e?Ze(e,i,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[i]=s;var E=(e,i,s)=>et(e,typeof i!="symbol"?i+"":i,s);import{d as S,m as tt,P as it}from"./chunks/pinia-CcZmjq9w.mjs";import{i as I,c as ke,d as Ie,f as De,n as Le,e as w,b as st,N as D,P as L,w as X,D as rt,k as Z,p as nt,x as ot,V as Ee,y as at}from"./chunks/index-DG15V7L3.mjs";import{aV as h,bZ as M,b_ as P,c0 as b,bR as ee,bQ as T,g as Te,aa as lt,bS as a,O as ct,A as dt,G as te,cb as ut,c1 as ht,bW as ft,S as pt,a1 as $,cj as gt,c4 as mt,a_ as y,J as vt,E as yt,b as Ve,v as Me,l as _t,a4 as K,d8 as bt,al as wt,d9 as St,P as Ct,F as Pe,cc as Nt,H as xt,X as Ft,cg as H,N as At}from"./core-common.mjs";import{d as j,c as kt,M as $e,f as It,U as Oe,j as Dt,k as ge,l as Re,h as Lt,m as Et,n as Tt,Y as Vt,p as Mt}from"./chunks/LivePhotos-CMdH4wdf.mjs";import{q as Pt}from"./chunks/base-DGiCN8Wo.mjs";import{V as G}from"./chunks/vue-router.esm-CkRP8kF4.mjs";import{bx as $t,n as m,z as Ot,by as Rt,bz as qt,bA as zt,a8 as qe,bB as Bt,b8 as Ut,al as me,bC as Q,a9 as Wt,bD as Ht,bE as ve,N as J,bF as ye,bG as _e,bH as Kt,bg as jt,bh as Gt,bI as Yt,bJ as Qt,be as Jt,bK as Xt}from"./chunks/icons-TElqpmA8.mjs";import{l as c}from"./chunks/logger-R_K4lHwR.mjs";import{p as V}from"./chunks/index-PaKKd09k.mjs";import{z as p,B as O,j as ie,_ as Zt}from"./chunks/_plugin-vue2_normalizer-VrK6B12S-BQkexw0P.mjs";import{T as k}from"./chunks/index-YIotKjSS.mjs";import{a as q}from"./chunks/sidebarAction-DYCQBJiz.mjs";import{j as ei}from"./chunks/index-CPb3EwrS.mjs";import{m as ti}from"./chunks/index-DaZEPb_2.mjs";import{a as ii,d as si}from"./chunks/index-DCgLaXhm.mjs";import"./chunks/index-CiG5J8j_.mjs";import"./chunks/index-tn-fAC9x.mjs";import"./chunks/index-D0hy_tCT.mjs";import"./chunks/preload-helper-BG02UnR2.mjs";import"./chunks/index-C20CehWT.mjs";h.use(G);const be=G.prototype.push;G.prototype.push=function(e,i,s){return i||s?be.call(this,e,i,s):be.call(this,e).catch(r=>r)};const ze=new G({mode:"history",base:M("/apps/files"),linkActiveClass:"active",routes:[{path:"/",redirect:{name:"filelist",params:{view:"files"}}},{path:"/:view/:fileid(\\d+)?",name:"filelist",props:!0}],stringifyQuery(e){const i=Pt.stringify(e).replace(/%2F/gmi,"/");return i?"?"+i:""}});var ri=Object.defineProperty,ni=(e,i,s)=>i in e?ri(e,i,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[i]=s,oi=(e,i,s)=>ni(e,i+"",s);class ai{constructor(i){oi(this,"_router"),this._router=i}get name(){return this._router.currentRoute.name}get query(){return this._router.currentRoute.query||{}}get params(){return this._router.currentRoute.params||{}}goTo(i,s=!1){return this._router.push({path:i,replace:s})}goToRoute(i,s,r,n){return this._router.push({name:i,query:r,params:s,replace:n})}}let li=class{constructor(e,{el:i,open:s,close:r}){E(this,"_close");E(this,"_el");E(this,"_name");E(this,"_open");this._name=e,this._el=i,this._open=s,this._close=r,typeof this._open!="function"&&(this._open=()=>{}),typeof this._close!="function"&&(this._close=()=>{})}get name(){return this._name}get el(){return this._el}get open(){return this._open}get close(){return this._close}},ci=class{constructor(){E(this,"_settings");this._settings=[],console.debug("OCA.Files.Settings initialized")}register(e){return this._settings.filter(i=>i.name===e.name).length>0?(console.error("A setting with the same name is already registered"),!1):(this._settings.push(e),!0)}get settings(){return this._settings}};const di=P("files","viewConfigs",{}),se=function(...e){const i=S("viewconfig",{state:()=>({viewConfig:di}),getters:{getConfig:s=>r=>s.viewConfig[r]||{}},actions:{onUpdate(s,r,n){this.viewConfig[s]||h.set(this.viewConfig,s,{}),h.set(this.viewConfig[s],r,n)},async update(s,r,n){ee.put(M("/apps/files/api/v1/views/".concat(s,"/").concat(r)),{value:n}),T("files:viewconfig:updated",{view:s,key:r,value:n})},setSortingBy(s="basename",r="files"){this.update(r,"sorting_mode",s),this.update(r,"sorting_direction","asc")},toggleSortingDirection(s="files"){const r=(this.getConfig(s)||{sorting_direction:"asc"}).sorting_direction==="asc"?"desc":"asc";this.update(s,"sorting_direction",r)}}})(...e);return i._initialized||(b("files:viewconfig:updated",function({view:s,key:r,value:n}){i.onUpdate(s,r,n)}),i._initialized=!0),i};function Be(e,i,s){var r=s||{},n=r.noTrailing,o=n===void 0?!1:n,l=r.noLeading,d=l===void 0?!1:l,u=r.debounceMode,f=u===void 0?void 0:u,g,v=!1,_=0;function x(){g&&clearTimeout(g)}function R(B){var U=B||{},F=U.upcomingOnly,Y=F===void 0?!1:F;x(),v=!Y}function he(){for(var B=arguments.length,U=new Array(B),F=0;F<B;F++)U[F]=arguments[F];var Y=this,fe=Date.now()-_;if(v)return;function W(){_=Date.now(),i.apply(Y,U)}function pe(){g=void 0}!d&&f&&!g&&W(),x(),f===void 0&&fe>e?d?(_=Date.now(),o||(g=setTimeout(f?pe:W,e))):W():o!==!0&&(g=setTimeout(f?pe:W,f===void 0?e-fe:e))}return he.cancel=R,he}function ui(e,i,s){var r={},n=r.atBegin,o=n===void 0?!1:n;return Be(e,i,{debounceMode:o!==!1})}const hi={name:"NavigationQuota",components:{ChartPie:$t,NcAppNavigationItem:Te,NcProgressBar:lt},data(){return{loadingStorageStats:!1,storageStats:P("files","storageStats",null)}},computed:{storageStatsTitle(){var s,r,n;const e=I((s=this.storageStats)==null?void 0:s.used,!1,!1),i=I((r=this.storageStats)==null?void 0:r.quota,!1,!1);return((n=this.storageStats)==null?void 0:n.quota)<0?this.t("files","{usedQuotaByte} used",{usedQuotaByte:e}):this.t("files","{used} of {quota} used",{used:e,quota:i})},storageStatsTooltip(){return this.storageStats.relative?this.t("files","{relative}% used",this.storageStats):""}},beforeMount(){setInterval(this.throttleUpdateStorageStats,60*1e3),b("files:node:created",this.throttleUpdateStorageStats),b("files:node:deleted",this.throttleUpdateStorageStats),b("files:node:moved",this.throttleUpdateStorageStats),b("files:node:updated",this.throttleUpdateStorageStats)},mounted(){var e,i;((e=this.storageStats)==null?void 0:e.quota)>0&&((i=this.storageStats)==null?void 0:i.free)<=0&&this.showStorageFullWarning()},methods:{debounceUpdateStorageStats:ui(200,function(e){this.updateStorageStats(e)}),throttleUpdateStorageStats:Be(1e3,function(e){this.updateStorageStats(e)}),async updateStorageStats(e=null){var i,s,r,n;if(!this.loadingStorageStats){this.loadingStorageStats=!0;try{const o=await ee.get(M("/apps/files/api/v1/stats"));if(!((i=o==null?void 0:o.data)!=null&&i.data))throw new Error("Invalid storage stats");((s=this.storageStats)==null?void 0:s.free)>0&&((r=o.data.data)==null?void 0:r.free)<=0&&((n=o.data.data)==null?void 0:n.quota)>0&&this.showStorageFullWarning(),this.storageStats=o.data.data}catch(o){c.error("Could not refresh storage stats",{error:o}),e&&p(t("files","Could not refresh storage stats"))}finally{this.loadingStorageStats=!1}}},showStorageFullWarning(){p(this.t("files","Your storage is full, files can not be updated or synced anymore!"))},t:a}};var fi=function(){var e=this,i=e._self._c;return e.storageStats?i("NcAppNavigationItem",{staticClass:"app-navigation-entry__settings-quota",class:{"app-navigation-entry__settings-quota--not-unlimited":e.storageStats.quota>=0},attrs:{"aria-label":e.t("files","Storage informations"),loading:e.loadingStorageStats,name:e.storageStatsTitle,title:e.storageStatsTooltip,"data-cy-files-navigation-settings-quota":""},on:{click:function(s){return s.stopPropagation(),s.preventDefault(),e.debounceUpdateStorageStats.apply(null,arguments)}}},[i("ChartPie",{attrs:{slot:"icon",size:20},slot:"icon"}),e.storageStats.quota>=0?i("NcProgressBar",{attrs:{slot:"extra",error:e.storageStats.relative>80,value:Math.min(e.storageStats.relative,100)},slot:"extra"}):e._e()],1):e._e()},pi=[],gi=m(hi,fi,pi,!1,null,"f6ad29b4");const mi=gi.exports,vi={name:"Setting",props:{el:{type:Function,required:!0}},mounted(){this.$el.appendChild(this.el())}};var yi=function(){var e=this,i=e._self._c;return i("div")},_i=[],bi=m(vi,yi,_i,!1,null,null);const wi=bi.exports,Si={name:"Settings",components:{Clipboard:Ot,NcAppSettingsDialog:ct,NcAppSettingsSection:dt,NcCheckboxRadioSwitch:te,NcInputField:ut,Setting:wi},props:{open:{type:Boolean,default:!1}},setup(){return{userConfigStore:j()}},data(){var e,i,s,r,n;return{settings:((s=(i=(e=window.OCA)==null?void 0:e.Files)==null?void 0:i.Settings)==null?void 0:s.settings)||[],webdavUrl:ht("dav/files/"+encodeURIComponent((r=ft())==null?void 0:r.uid)),webdavDocs:"https://docs.nextcloud.com/server/stable/go.php?to=user-webdav",appPasswordUrl:M("/settings/user/security#generate-app-token-section"),webdavUrlCopied:!1,enableGridView:(n=P("core","config",[])["enable_non-accessible_features"])!=null?n:!0}},computed:{userConfig(){return this.userConfigStore.userConfig}},beforeMount(){this.settings.forEach(e=>e.open())},beforeDestroy(){this.settings.forEach(e=>e.close())},methods:{onClose(){this.$emit("close")},setConfig(e,i){this.userConfigStore.update(e,i)},async copyCloudId(){if(document.querySelector("input#webdav-url-input").select(),!navigator.clipboard){p(t("files","Clipboard is not available"));return}await navigator.clipboard.writeText(this.webdavUrl),this.webdavUrlCopied=!0,O(t("files","WebDAV URL copied to clipboard")),setTimeout(()=>{this.webdavUrlCopied=!1},5e3)},t:a}};var Ci=function(){var e=this,i=e._self._c;return i("NcAppSettingsDialog",{attrs:{open:e.open,"show-navigation":!0,name:e.t("files","Files settings")},on:{"update:open":e.onClose}},[i("NcAppSettingsSection",{attrs:{id:"settings",name:e.t("files","Files settings")}},[i("NcCheckboxRadioSwitch",{attrs:{"data-cy-files-settings-setting":"sort_favorites_first",checked:e.userConfig.sort_favorites_first},on:{"update:checked":function(s){return e.setConfig("sort_favorites_first",s)}}},[e._v(" "+e._s(e.t("files","Sort favorites first"))+" ")]),i("NcCheckboxRadioSwitch",{attrs:{"data-cy-files-settings-setting":"sort_folders_first",checked:e.userConfig.sort_folders_first},on:{"update:checked":function(s){return e.setConfig("sort_folders_first",s)}}},[e._v(" "+e._s(e.t("files","Sort folders before files"))+" ")]),i("NcCheckboxRadioSwitch",{attrs:{"data-cy-files-settings-setting":"show_hidden",checked:e.userConfig.show_hidden},on:{"update:checked":function(s){return e.setConfig("show_hidden",s)}}},[e._v(" "+e._s(e.t("files","Show hidden files"))+" ")]),i("NcCheckboxRadioSwitch",{attrs:{"data-cy-files-settings-setting":"crop_image_previews",checked:e.userConfig.crop_image_previews},on:{"update:checked":function(s){return e.setConfig("crop_image_previews",s)}}},[e._v(" "+e._s(e.t("files","Crop image previews"))+" ")]),e.enableGridView?i("NcCheckboxRadioSwitch",{attrs:{"data-cy-files-settings-setting":"grid_view",checked:e.userConfig.grid_view},on:{"update:checked":function(s){return e.setConfig("grid_view",s)}}},[e._v(" "+e._s(e.t("files","Enable the grid view"))+" ")]):e._e()],1),e.settings.length!==0?i("NcAppSettingsSection",{attrs:{id:"more-settings",name:e.t("files","Additional settings")}},[e._l(e.settings,function(s){return[i("Setting",{key:s.name,attrs:{el:s.el}})]})],2):e._e(),i("NcAppSettingsSection",{attrs:{id:"webdav",name:e.t("files","WebDAV")}},[i("NcInputField",{attrs:{id:"webdav-url-input",label:e.t("files","WebDAV URL"),"show-trailing-button":!0,success:e.webdavUrlCopied,"trailing-button-label":e.t("files","Copy to clipboard"),value:e.webdavUrl,readonly:"readonly",type:"url"},on:{focus:function(s){return s.target.select()},"trailing-button-click":e.copyCloudId},scopedSlots:e._u([{key:"trailing-button-icon",fn:function(){return[i("Clipboard",{attrs:{size:20}})]},proxy:!0}])}),i("em",[i("a",{staticClass:"setting-link",attrs:{href:e.webdavDocs,target:"_blank",rel:"noreferrer noopener"}},[e._v(" "+e._s(e.t("files","Use this address to access your Files via WebDAV"))+" ↗ ")])]),i("br"),i("em",[i("a",{staticClass:"setting-link",attrs:{href:e.appPasswordUrl}},[e._v(" "+e._s(e.t("files","If you have enabled 2FA, you must create and use a new app password by clicking here."))+" ↗ ")])])],1)],1)},Ni=[],xi=m(Si,Ci,Ni,!1,null,"f3220be4");const Fi=xi.exports,Ai={name:"Navigation",components:{Cog:Rt,NavigationQuota:mi,NcAppNavigation:pt,NcAppNavigationItem:Te,NcIconSvgWrapper:$,SettingsModal:Fi},setup(){return{viewConfigStore:se()}},data(){return{settingsOpened:!1}},computed:{currentViewId(){var e,i;return((i=(e=this.$route)==null?void 0:e.params)==null?void 0:i.view)||"files"},currentView(){return this.views.find(e=>e.id===this.currentViewId)},views(){return this.$navigation.views},parentViews(){return this.views.filter(e=>!e.parent).sort((e,i)=>e.order-i.order)},childViews(){return this.views.filter(e=>!!e.parent).reduce((e,i)=>(e[i.parent]=[...e[i.parent]||[],i],e[i.parent].sort((s,r)=>s.order-r.order),e),{})}},watch:{currentView(e,i){e.id!==(i==null?void 0:i.id)&&(this.$navigation.setActive(e),c.debug("Navigation changed from ".concat(i.id," to ").concat(e.id),{from:i,to:e}),this.showView(e))}},beforeMount(){this.currentView&&(c.debug("Navigation mounted. Showing requested view",{view:this.currentView}),this.showView(this.currentView))},methods:{useExactRouteMatching(e){var i;return((i=this.childViews[e.id])==null?void 0:i.length)>0},showView(e){var i,s,r,n;(n=(r=(s=(i=window==null?void 0:window.OCA)==null?void 0:i.Files)==null?void 0:s.Sidebar)==null?void 0:r.close)==null||n.call(r),this.$navigation.setActive(e),T("files:navigation:changed",e)},onToggleExpand(e){const i=this.isExpanded(e);e.expanded=!i,this.viewConfigStore.update(e.id,"expanded",!i)},isExpanded(e){var i;return typeof((i=this.viewConfigStore.getConfig(e.id))==null?void 0:i.expanded)=="boolean"?this.viewConfigStore.getConfig(e.id).expanded===!0:e.expanded===!0},generateToNavigation(e){if(e.params){const{dir:i}=e.params;return{name:"filelist",params:e.params,query:{dir:i}}}return{name:"filelist",params:{view:e.id}}},openSettings(){this.settingsOpened=!0},onSettingsClose(){this.settingsOpened=!1},t:a}};var ki=function(){var e=this,i=e._self._c;return i("NcAppNavigation",{attrs:{"data-cy-files-navigation":"","aria-label":e.t("files","Files")},scopedSlots:e._u([{key:"list",fn:function(){return e._l(e.parentViews,function(s){return i("NcAppNavigationItem",{key:s.id,attrs:{"allow-collapse":!0,"data-cy-files-navigation-item":s.id,exact:e.useExactRouteMatching(s),icon:s.iconClass,name:s.name,open:e.isExpanded(s),pinned:s.sticky,to:e.generateToNavigation(s)},on:{"update:open":function(r){return e.onToggleExpand(s)}}},[s.icon?i("NcIconSvgWrapper",{attrs:{slot:"icon",svg:s.icon},slot:"icon"}):e._e(),e._l(e.childViews[s.id],function(r){return i("NcAppNavigationItem",{key:r.id,attrs:{"data-cy-files-navigation-item":r.id,"exact-path":!0,icon:r.iconClass,name:r.name,to:e.generateToNavigation(r)}},[r.icon?i("NcIconSvgWrapper",{attrs:{slot:"icon",svg:r.icon},slot:"icon"}):e._e()],1)})],2)})},proxy:!0},{key:"footer",fn:function(){return[i("ul",{staticClass:"app-navigation-entry__settings"},[i("NavigationQuota"),i("NcAppNavigationItem",{attrs:{"aria-label":e.t("files","Open the files app settings"),name:e.t("files","Files settings"),"data-cy-files-navigation-settings-button":""},on:{click:function(s){return s.preventDefault(),s.stopPropagation(),e.openSettings.apply(null,arguments)}}},[i("Cog",{attrs:{slot:"icon",size:20},slot:"icon"})],1)],1)]},proxy:!0}])},[i("SettingsModal",{attrs:{open:e.settingsOpened,"data-cy-files-navigation-settings":""},on:{close:e.onSettingsClose}})],1)},Ii=[],Di=m(Ai,ki,Ii,!1,null,"d8089e54");const Li=Di.exports,we=async e=>{const i=ke(),s=await kt.stat("".concat(Ie).concat(e.path),{details:!0,data:i});return De(s.data)},C=function(...e){const i=S("files",{state:()=>({files:{},roots:{}}),getters:{getNode:s=>r=>s.files[r],getNodes:s=>r=>r.map(n=>s.files[n]).filter(Boolean),getNodesById:s=>r=>Object.values(s.files).filter(n=>n.fileid===r),getRoot:s=>r=>s.roots[r]},actions:{updateNodes(s){const r=s.reduce((n,o)=>o.fileid?(n[o.source]=o,n):(c.error("Trying to update/set a node without fileid",{node:o}),n),{});h.set(this,"files",{...this.files,...r})},deleteNodes(s){s.forEach(r=>{r.source&&h.delete(this.files,r.source)})},setRoot({service:s,root:r}){h.set(this.roots,s,r)},onDeletedNode(s){this.deleteNodes([s])},onCreatedNode(s){this.updateNodes([s])},async onUpdatedNode(s){if(!s.fileid){c.error("Trying to update/set a node without fileid",{node:s});return}const r=this.getNodesById(s.fileid);if(r.length>1){await Promise.all(r.map(we)).then(this.updateNodes),c.debug(r.length+" nodes updated in store",{fileid:s.fileid});return}if(s.source===r[0].source){this.updateNodes([s]);return}we(s).then(n=>this.updateNodes([n]))}}})(...e);return i._initialized||(b("files:node:created",i.onCreatedNode),b("files:node:deleted",i.onDeletedNode),b("files:node:updated",i.onUpdatedNode),i._initialized=!0),i},re=function(...e){const i=C(...e),s=S("paths",{state:()=>({paths:{}}),getters:{getPath:r=>(n,o)=>{if(r.paths[n])return r.paths[n][o]}},actions:{addPath(r){this.paths[r.service]||h.set(this.paths,r.service,{}),h.set(this.paths[r.service],r.path,r.source)},onCreatedNode(r){var n,o;const l=((o=(n=Le())==null?void 0:n.active)==null?void 0:o.id)||"files";if(!r.fileid){c.error("Node has no fileid",{node:r});return}if(r.type===w.Folder&&this.addPath({service:l,path:r.path,source:r.source}),r.dirname==="/"){const d=i.getRoot(l);d._children||h.set(d,"_children",[]),d._children.push(r.source);return}if(this.paths[l][r.dirname]){const d=this.paths[l][r.dirname],u=i.getNode(d);if(c.debug("Path already exists, updating children",{parentFolder:u,node:r}),!u){c.error("Parent folder not found",{parentSource:d});return}u._children||h.set(u,"_children",[]),u._children.push(r.source);return}c.debug("Parent path does not exists, skipping children update",{node:r})}}})(...e);return s._initialized||(b("files:node:created",s.onCreatedNode),s._initialized=!0),s},N=S("selection",{state:()=>({selected:[],lastSelection:[],lastSelectedIndex:null}),actions:{set(e=[]){h.set(this,"selected",[...new Set(e)])},setLastIndex(e=null){h.set(this,"lastSelection",e?this.selected:[]),h.set(this,"lastSelectedIndex",e)},reset(){h.set(this,"selected",[]),h.set(this,"lastSelection",[]),h.set(this,"lastSelectedIndex",null)}}});let Se;const Ue=function(...e){return Se=$e(),S("uploader",{state:()=>({queue:Se.queue})})(...e)};function Ce(e){return e instanceof Date?e.toISOString():String(e)}function Ei(e,i,s){i=i!=null?i:[o=>o],s=s!=null?s:[];const r=i.map((o,l)=>{var d;return((d=s[l])!=null?d:"asc")==="asc"?1:-1}),n=Intl.Collator([gt(),mt()],{numeric:!0,usage:"sort"});return[...e].sort((o,l)=>{for(const[d,u]of i.entries()){const f=n.compare(Ce(u(o)),Ce(u(l)));if(f!==0)return f*r[d]}return 0})}var Ti=Object.defineProperty,Vi=(e,i,s)=>i in e?Ti(e,i,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[i]=s,Mi=(e,i,s)=>Vi(e,i+"",s);class ne extends File{constructor(i,s=[]){super([],i,{type:"httpd/unix-directory"}),Mi(this,"_contents"),this._contents=s}set contents(i){this._contents=i}get contents(){return this._contents}get size(){return this._computeDirectorySize(this)}get lastModified(){return this._contents.length===0?Date.now():this._computeDirectoryMtime(this)}_computeDirectoryMtime(i){return i.contents.reduce((s,r)=>r.lastModified>s?r.lastModified:s,0)}_computeDirectorySize(i){return i.contents.reduce((s,r)=>s+r.size,0)}}const We=async e=>{if(e.isFile)return new Promise((n,o)=>{e.file(n,o)});c.debug("Handling recursive file tree",{entry:e.name});const i=e,s=await Pi(i),r=(await Promise.all(s.map(We))).flat();return new ne(i.name,r)},Pi=e=>{const i=e.createReader();return new Promise((s,r)=>{const n=[],o=()=>{i.readEntries(l=>{l.length?(n.push(...l),o()):s(n)},l=>{r(l)})};o()})},$i=async e=>{const i=st();if(!await i.exists(e)){c.debug("Directory does not exist, creating it",{absolutePath:e}),await i.createDirectory(e,{recursive:!0});const s=await i.stat(e,{details:!0,data:ke()});T("files:node:created",De(s.data))}},He=async(e,i,s)=>{try{const r=e.filter(d=>s.find(u=>u.basename===(d instanceof File?d.name:d.basename))).filter(Boolean),n=e.filter(d=>!r.includes(d)),{selected:o,renamed:l}=await It(i.path,r,s);return c.debug("Conflict resolution",{uploads:n,selected:o,renamed:l}),o.length===0&&l.length===0?(ie(a("files","Conflicts resolution skipped")),c.info("User skipped the conflict resolution"),[]):[...n,...o,...l]}catch(r){console.error(r),p(a("files","Upload cancelled")),c.error("User cancelled the upload")}return[]},oe=async e=>{const i=e.filter(n=>n.kind!=="file"?(c.debug("Skipping dropped item",{kind:n.kind,type:n.type}),!1):!0).map(n=>{var o,l,d,u;return(u=(d=(o=n==null?void 0:n.getAsEntry)==null?void 0:o.call(n))!=null?d:(l=n==null?void 0:n.webkitGetAsEntry)==null?void 0:l.call(n))!=null?u:n});let s=!1;const r=new ne("root");for(const n of i){if(n instanceof DataTransferItem){c.warn("Could not get FilesystemEntry of item, falling back to file");const o=n.getAsFile();if(o===null){c.warn("Could not process DataTransferItem",{type:n.type,kind:n.kind}),p(a("files","One of the dropped files could not be processed"));continue}if(o.type==="httpd/unix-directory"||!o.type){s||(c.warn("Browser does not support Filesystem API. Directories will not be uploaded"),Zt(a("files","Your browser does not support the Filesystem API. Directories will not be uploaded")),s=!0);continue}r.contents.push(o);continue}try{r.contents.push(await We(n))}catch(o){c.error("Error while traversing file tree",{error:o})}}return r},ae=async(e,i,s)=>{const r=$e();if(await Oe(e.contents,s)&&(e.contents=await He(e.contents,i,s)),e.contents.length===0)return c.info("No files to upload",{root:e}),ie(a("files","No files to upload")),[];c.debug("Uploading files to ".concat(i.path),{root:e,contents:e.contents});const n=[],o=async(d,u)=>{for(const f of d.contents){const g=V.join(u,f.name);if(f instanceof ne){const v=ei(Ie,i.path,g);try{console.debug("Processing directory",{relativePath:g}),await $i(v),await o(f,g)}catch(_){p(a("files","Unable to create the directory {directory}",{directory:f.name})),c.error("",{error:_,absolutePath:v,directory:f})}continue}c.debug("Uploading file to "+V.join(i.path,g),{file:f}),n.push(r.upload(g,f,i.source))}};r.pause(),await o(e,"/"),r.start();const l=(await Promise.allSettled(n)).filter(d=>d.status==="rejected");return l.length>0?(c.error("Error while uploading files",{errors:l}),p(a("files","Some files could not be uploaded")),[]):(c.debug("Files uploaded successfully"),O(a("files","Files uploaded successfully")),Promise.all(n))},Ke=async(e,i,s,r=!1)=>{const n=[];if(await Oe(e,s)&&(e=await He(e,i,s)),e.length===0){c.info("No files to process",{nodes:e}),ie(a("files","No files to process"));return}for(const d of e)h.set(d,"status",D.LOADING),n.push(Dt(d,i,r?ge.COPY:ge.MOVE));const o=await Promise.allSettled(n);e.forEach(d=>h.set(d,"status",void 0));const l=o.filter(d=>d.status==="rejected");if(l.length>0){c.error("Error while copying or moving files",{errors:l}),p(r?a("files","Some files could not be copied"):a("files","Some files could not be moved"));return}c.debug("Files copy/move successful"),O(r?a("files","Files copied successfully"):a("files","Files moved successfully"))},le=S("dragging",{state:()=>({dragging:[]}),actions:{set(e=[]){h.set(this,"dragging",e)},reset(){h.set(this,"dragging",[])}}}),z=y({data(){return{filesListWidth:0}},mounted(){var e;const i=document.querySelector("#app-content-vue");this.filesListWidth=(e=i==null?void 0:i.clientWidth)!=null?e:0,this.$resizeObserver=new ResizeObserver(s=>{s.length>0&&s[0].target===i&&(this.filesListWidth=s[0].contentRect.width)}),this.$resizeObserver.observe(i)},beforeDestroy(){this.$resizeObserver.disconnect()}}),Oi=y({name:"BreadCrumbs",components:{NcBreadcrumbs:vt,NcBreadcrumb:yt,NcIconSvgWrapper:$},mixins:[z],props:{path:{type:String,default:"/"}},setup(){const e=le(),i=C(),s=re(),r=N(),n=Ue();return{draggingStore:e,filesStore:i,pathsStore:s,selectionStore:r,uploaderStore:n}},computed:{currentView(){return this.$navigation.active},dirs(){const e=i=>s=>i+="".concat(s,"/");return["/",...this.path.split("/").filter(Boolean).map(e("/")).map(i=>i.replace(/^(.+)\/$/,"$1"))]},sections(){return this.dirs.map((e,i)=>{const s=this.getFileSourceFromPath(e),r=s?this.getNodeFromSource(s):void 0,n={...this.$route,params:{node:r==null?void 0:r.fileid},query:{dir:e}};return{dir:e,exact:!0,name:this.getDirDisplayName(e),to:n,disableDrop:i===this.dirs.length-1}})},isUploadInProgress(){return this.uploaderStore.queue.length!==0},wrapUploadProgressBar(){return this.isUploadInProgress&&this.filesListWidth<512},viewIcon(){var e,i;return(i=(e=this.currentView)==null?void 0:e.icon)!=null?i:qt},selectedFiles(){return this.selectionStore.selected},draggingFiles(){return this.draggingStore.dragging}},methods:{getNodeFromSource(e){return this.filesStore.getNode(e)},getFileSourceFromPath(e){var i;return this.pathsStore.getPath((i=this.currentView)==null?void 0:i.id,e)},getDirDisplayName(e){var i,s,r;if(e==="/")return((s=(i=this.$navigation)==null?void 0:i.active)==null?void 0:s.name)||a("files","Home");const n=this.getFileSourceFromPath(e),o=n?this.getNodeFromSource(n):void 0;return((r=o==null?void 0:o.attributes)==null?void 0:r.displayName)||V.basename(e)},onClick(e){var i;((i=e==null?void 0:e.query)==null?void 0:i.dir)===this.$route.query.dir&&this.$emit("reload")},onDragOver(e,i){if(i===this.dirs[this.dirs.length-1]){e.dataTransfer.dropEffect="none";return}e.ctrlKey?e.dataTransfer.dropEffect="copy":e.dataTransfer.dropEffect="move"},async onDrop(e,i){var s,r,n,o;if(!this.draggingFiles&&!((r=(s=e.dataTransfer)==null?void 0:s.items)!=null&&r.length))return;e.preventDefault();const l=this.draggingFiles,d=[...((n=e.dataTransfer)==null?void 0:n.items)||[]],u=await oe(d),f=await((o=this.currentView)==null?void 0:o.getContents(i)),g=f==null?void 0:f.folder;if(!g){p(this.t("files","Target folder does not exist any more"));return}const v=(g.permissions&L.CREATE)!==0,_=e.ctrlKey;if(!v||e.button!==0)return;if(c.debug("Dropped",{event:e,folder:g,selection:l,fileTree:u}),u.contents.length>0){await ae(u,g,f.contents);return}const x=l.map(R=>this.filesStore.getNode(R));await Ke(x,g,f.contents,_),l.some(R=>this.selectedFiles.includes(R))&&(c.debug("Dropped selection, resetting select store..."),this.selectionStore.reset())},titleForSection(e,i){var s,r;return((r=(s=i==null?void 0:i.to)==null?void 0:s.query)==null?void 0:r.dir)===this.$route.query.dir?a("files","Reload current directory"):e===0?a("files",'Go to the "{dir}" directory',i):null},ariaForSection(e){var i,s;return((s=(i=e==null?void 0:e.to)==null?void 0:i.query)==null?void 0:s.dir)===this.$route.query.dir?a("files","Reload current directory"):null},t:a}});var Ri=function(){var e=this,i=e._self._c;return e._self._setupProxy,i("NcBreadcrumbs",{staticClass:"files-list__breadcrumbs",class:{"files-list__breadcrumbs--with-progress":e.wrapUploadProgressBar},attrs:{"data-cy-files-content-breadcrumbs":"","aria-label":e.t("files","Current directory path")},scopedSlots:e._u([{key:"actions",fn:function(){return[e._t("actions")]},proxy:!0}],null,!0)},e._l(e.sections,function(s,r){return i("NcBreadcrumb",e._b({key:s.dir,attrs:{dir:"auto",to:s.to,"force-icon-text":r===0&&e.filesListWidth>=486,title:e.titleForSection(r,s),"aria-description":e.ariaForSection(s)},on:{drop:function(n){return e.onDrop(n,s.dir)}},nativeOn:{click:function(n){return e.onClick(s.to)},dragover:function(n){return e.onDragOver(n,s.dir)}},scopedSlots:e._u([r===0?{key:"icon",fn:function(){return[i("NcIconSvgWrapper",{attrs:{size:20,svg:e.viewIcon}})]},proxy:!0}:null],null,!0)},"NcBreadcrumb",s,!1))}),1)},qi=[],zi=m(Oi,Ri,qi,!1,null,"d14a5b35");const Bi=zi.exports,ce=S("actionsmenu",{state:()=>({opened:null})}),de=function(...e){const i=S("renaming",{state:()=>({renamingNode:void 0,newName:""})})(...e);return i._initialized||(b("files:node:rename",function(s){i.renamingNode=s,i.newName=s.basename}),i._initialized=!0),i},Ui=h.extend({name:"DragAndDropPreview",components:{FileMultipleIcon:zt,FolderIcon:qe},data(){return{nodes:[]}},computed:{isSingleNode(){return this.nodes.length===1},isSingleFolder(){return this.isSingleNode&&this.nodes[0].type===w.Folder},name(){return this.size?"".concat(this.summary," – ").concat(this.size):this.summary},size(){const e=this.nodes.reduce((s,r)=>s+r.size||0,0),i=parseInt(e,10)||0;return typeof i!="number"||i<0?null:I(i,!0)},summary(){var e;if(this.isSingleNode){const i=this.nodes[0];return((e=i.attributes)==null?void 0:e.displayName)||i.basename}return Re(this.nodes)}},methods:{update(e){this.nodes=e,this.$refs.previewImg.replaceChildren(),e.slice(0,3).forEach(i=>{const s=document.querySelector('[data-cy-files-list-row-fileid="'.concat(i.fileid,'"] .files-list__row-icon img'));s&&this.$refs.previewImg.appendChild(s.parentNode.cloneNode(!0))}),this.$nextTick(()=>{this.$emit("loaded",this.$el)})}}});var Wi=function(){var e=this,i=e._self._c;return e._self._setupProxy,i("div",{staticClass:"files-list-drag-image"},[i("span",{staticClass:"files-list-drag-image__icon"},[i("span",{ref:"previewImg"}),e.isSingleFolder?i("FolderIcon"):i("FileMultipleIcon")],1),i("span",{staticClass:"files-list-drag-image__name"},[e._v(e._s(e.name))])])},Hi=[],Ki=m(Ui,Wi,Hi,!1,null,null);const ji=Ki.exports,Gi=h.extend(ji);let A;const Yi=async e=>new Promise(i=>{A||(A=new Gi().$mount(),document.body.appendChild(A.$el)),A.update(e),A.$on("loaded",()=>{i(A.$el),A.$off("loaded")})}),Qi={name:"CustomElementRender",props:{source:{type:Object,required:!0},currentView:{type:Object,required:!0},render:{type:Function,required:!0}},watch:{source(){this.updateRootElement()},currentView(){this.updateRootElement()}},mounted(){this.updateRootElement()},methods:{async updateRootElement(){const e=await this.render(this.source,this.currentView);e?this.$el.replaceChildren(e):this.$el.replaceChildren()}}};var Ji=function(){var e=this,i=e._self._c;return i("span")},Xi=[],Zi=m(Qi,Ji,Xi,!1,null,null);const je=Zi.exports,es=X(),ts=y({name:"FileEntryActions",components:{ArrowLeftIcon:Bt,CustomElementRender:je,NcActionButton:Ve,NcActions:Me,NcActionSeparator:_t,NcIconSvgWrapper:$,NcLoadingIcon:K},props:{filesListWidth:{type:Number,required:!0},loading:{type:String,required:!0},opened:{type:Boolean,default:!1},source:{type:Object,required:!0},gridMode:{type:Boolean,default:!1}},data(){return{openedSubmenu:null}},computed:{currentDir(){var e,i,s;return(((s=(i=(e=this.$route)==null?void 0:e.query)==null?void 0:i.dir)==null?void 0:s.toString())||"/").replace(/^(.+)\/$/,"$1")},currentView(){return this.$navigation.active},isLoading(){return this.source.status===D.LOADING},enabledActions(){return this.source.attributes.failed?[]:es.filter(e=>!e.enabled||e.enabled([this.source],this.currentView)).sort((e,i)=>(e.order||0)-(i.order||0))},enabledInlineActions(){return this.filesListWidth<768||this.gridMode?[]:this.enabledActions.filter(e=>{var i;return(i=e==null?void 0:e.inline)==null?void 0:i.call(e,this.source,this.currentView)})},enabledRenderActions(){return this.gridMode?[]:this.enabledActions.filter(e=>typeof e.renderInline=="function")},enabledDefaultActions(){return this.enabledActions.filter(e=>!!(e!=null&&e.default))},enabledMenuActions(){if(this.openedSubmenu)return this.enabledInlineActions;const e=[...this.enabledInlineActions,...this.enabledActions.filter(s=>s.default!==rt.HIDDEN&&typeof s.renderInline!="function")].filter((s,r,n)=>r===n.findIndex(o=>o.id===s.id)),i=e.filter(s=>!s.parent).map(s=>s.id);return e.filter(s=>!(s.parent&&i.includes(s.parent)))},enabledSubmenuActions(){return this.enabledActions.filter(e=>e.parent).reduce((e,i)=>(e[i.parent]||(e[i.parent]=[]),e[i.parent].push(i),e),{})},openedMenu:{get(){return this.opened},set(e){this.$emit("update:opened",e)}},getBoundariesElement(){return document.querySelector(".app-content > .files-list")},mountType(){return this.source.attributes["mount-type"]}},methods:{actionDisplayName(e){if((this.gridMode||this.filesListWidth<768&&e.inline)&&typeof e.title=="function"){const i=e.title([this.source],this.currentView);if(i)return i}return e.displayName([this.source],this.currentView)},async onActionClick(e,i=!1){if(this.isLoading||this.loading!=="")return;if(this.enabledSubmenuActions[e.id]){this.openedSubmenu=e;return}const s=e.displayName([this.source],this.currentView);try{this.$emit("update:loading",e.id),h.set(this.source,"status",D.LOADING);const r=await e.exec(this.source,this.currentView,this.currentDir);if(r==null)return;if(r){O(a("files",'"{displayName}" action executed successfully',{displayName:s}));return}p(a("files",'"{displayName}" action failed',{displayName:s}))}catch(r){c.error("Error while executing action",{action:e,e:r}),p(a("files",'"{displayName}" action failed',{displayName:s}))}finally{this.$emit("update:loading",""),h.set(this.source,"status",void 0),i&&(this.openedSubmenu=null)}},execDefaultAction(e){this.enabledDefaultActions.length>0&&(e.preventDefault(),e.stopPropagation(),this.enabledDefaultActions[0].exec(this.source,this.currentView,this.currentDir))},isMenu(e){var i;return((i=this.enabledSubmenuActions[e])==null?void 0:i.length)>0},async onBackToMenuClick(e){this.openedSubmenu=null,await this.$nextTick(),this.$nextTick(()=>{var i,s;const r=(i=this.$refs["action-".concat(e.id)])==null?void 0:i[0];r&&((s=r.$el.querySelector("button"))==null||s.focus())})},t:a}});var is=function(){var s,r;var e=this,i=e._self._c;return e._self._setupProxy,i("td",{staticClass:"files-list__row-actions",attrs:{"data-cy-files-list-row-actions":""}},[e._l(e.enabledRenderActions,function(n){return i("CustomElementRender",{key:n.id,staticClass:"files-list__row-action--inline",class:"files-list__row-action-"+n.id,attrs:{"current-view":e.currentView,render:n.renderInline,source:e.source}})}),i("NcActions",{ref:"actionsMenu",attrs:{"boundaries-element":e.getBoundariesElement,container:e.getBoundariesElement,"force-name":!0,type:"tertiary","force-menu":e.enabledInlineActions.length===0,inline:e.enabledInlineActions.length,open:e.openedMenu},on:{"update:open":function(n){e.openedMenu=n},close:function(n){e.openedSubmenu=null}}},[e._l(e.enabledMenuActions,function(n){var o;return i("NcActionButton",{key:n.id,ref:"action-".concat(n.id),refInFor:!0,class:{["files-list__row-action-".concat(n.id)]:!0,"files-list__row-action--menu":e.isMenu(n.id)},attrs:{"close-after-click":!e.isMenu(n.id),"data-cy-files-list-row-action":n.id,"is-menu":e.isMenu(n.id),title:(o=n.title)==null?void 0:o.call(n,[e.source],e.currentView)},on:{click:function(l){return e.onActionClick(n)}},scopedSlots:e._u([{key:"icon",fn:function(){return[e.loading===n.id?i("NcLoadingIcon",{attrs:{size:18}}):i("NcIconSvgWrapper",{attrs:{svg:n.iconSvgInline([e.source],e.currentView)}})]},proxy:!0}],null,!0)},[e._v(" "+e._s(e.mountType==="shared"&&n.id==="sharing-status"?"":e.actionDisplayName(n))+" ")])}),e.openedSubmenu&&e.enabledSubmenuActions[(s=e.openedSubmenu)==null?void 0:s.id]?[i("NcActionButton",{staticClass:"files-list__row-action-back",on:{click:function(n){return e.onBackToMenuClick(e.openedSubmenu)}},scopedSlots:e._u([{key:"icon",fn:function(){return[i("ArrowLeftIcon")]},proxy:!0}],null,!1,3001860362)},[e._v(" "+e._s(e.actionDisplayName(e.openedSubmenu))+" ")]),i("NcActionSeparator"),e._l(e.enabledSubmenuActions[(r=e.openedSubmenu)==null?void 0:r.id],function(n){var o;return i("NcActionButton",{key:n.id,staticClass:"files-list__row-action--submenu",class:"files-list__row-action-".concat(n.id),attrs:{"close-after-click":"","data-cy-files-list-row-action":n.id,title:(o=n.title)==null?void 0:o.call(n,[e.source],e.currentView)},on:{click:function(l){return e.onActionClick(n)}},scopedSlots:e._u([{key:"icon",fn:function(){return[e.loading===n.id?i("NcLoadingIcon",{attrs:{size:18}}):i("NcIconSvgWrapper",{attrs:{svg:n.iconSvgInline([e.source],e.currentView)}})]},proxy:!0}],null,!0)},[e._v(" "+e._s(e.actionDisplayName(n))+" ")])})]:e._e()],2)],2)},ss=[],rs=m(ts,is,ss,!1,null,"a0d066d5");const Ge=rs.exports;h.directive("onClickOutside",bt);const Ye=y({props:{source:{type:[Z,nt,ot],required:!0},nodes:{type:Array,required:!0},filesListWidth:{type:Number,default:0}},data(){return{loading:"",dragover:!1,gridMode:!1}},computed:{currentView(){return this.$navigation.active},currentDir(){var e,i,s;return(((s=(i=(e=this.$route)==null?void 0:e.query)==null?void 0:i.dir)==null?void 0:s.toString())||"/").replace(/^(.+)\/$/,"$1")},currentFileId(){var e,i;return((e=this.$route.params)==null?void 0:e.fileid)||((i=this.$route.query)==null?void 0:i.fileid)||null},fileid(){var e;return(e=this.source)==null?void 0:e.fileid},uniqueId(){return Lt(this.source.source)},isLoading(){return this.source.status===D.LOADING},extension(){var e;return(e=this.source.attributes)!=null&&e.displayName?V.extname(this.source.attributes.displayName):this.source.extension||""},displayName(){const e=this.extension,i=String(this.source.attributes.displayName||this.source.basename);return e?i.slice(0,0-e.length):i},draggingFiles(){return this.draggingStore.dragging},selectedFiles(){return this.selectionStore.selected},isSelected(){return this.selectedFiles.includes(this.source.source)},isRenaming(){return this.renamingStore.renamingNode===this.source},isRenamingSmallScreen(){return this.isRenaming&&this.filesListWidth<512},isActive(){return String(this.fileid)===String(this.currentFileId)},canDrag(){if(this.isRenaming)return!1;const e=i=>((i==null?void 0:i.permissions)&L.UPDATE)!==0;return this.selectedFiles.length>0?this.selectedFiles.map(i=>this.filesStore.getNode(i)).every(e):e(this.source)},canDrop(){return this.source.type!==w.Folder||this.draggingFiles.includes(this.source.source)?!1:(this.source.permissions&L.CREATE)!==0},openedMenu:{get(){return this.actionsMenuStore.opened===this.uniqueId.toString()},set(e){this.actionsMenuStore.opened=e?this.uniqueId.toString():null}}},watch:{source(e,i){e.source!==i.source&&this.resetState()}},beforeDestroy(){this.resetState()},methods:{resetState(){var e,i,s;this.loading="",(s=(i=(e=this.$refs)==null?void 0:e.preview)==null?void 0:i.reset)==null||s.call(i),this.openedMenu=!1},onRightClick(e){var i,s;if(this.openedMenu)return;if(this.gridMode){const n=(s=this.$el)==null?void 0:s.closest("main.app-content");n.style.removeProperty("--mouse-pos-x"),n.style.removeProperty("--mouse-pos-y")}else{const n=(i=this.$el)==null?void 0:i.closest("main.app-content"),o=n.getBoundingClientRect();n.style.setProperty("--mouse-pos-x",Math.max(0,e.clientX-o.left-200)+"px"),n.style.setProperty("--mouse-pos-y",Math.max(0,e.clientY-o.top)+"px")}const r=this.selectedFiles.length>1;this.actionsMenuStore.opened=this.isSelected&&r?"global":this.uniqueId.toString(),e.preventDefault(),e.stopPropagation()},execDefaultAction(e){if(!(e.button>1)){if(e.ctrlKey||e.metaKey||e.button===1)return e.preventDefault(),window.open(M("/f/{fileId}",{fileId:this.fileid})),!1;this.$refs.actions.execDefaultAction(e)}},openDetailsIfAvailable(e){var i,s;e.preventDefault(),e.stopPropagation(),(s=(i=q)==null?void 0:i.enabled)!=null&&s.call(i,[this.source],this.currentView)&&q.exec(this.source,this.currentView,this.currentDir)},onDragOver(e){if(this.dragover=this.canDrop,!this.canDrop){e.dataTransfer.dropEffect="none";return}e.ctrlKey?e.dataTransfer.dropEffect="copy":e.dataTransfer.dropEffect="move"},onDragLeave(e){const i=e.currentTarget;i!=null&&i.contains(e.relatedTarget)||(this.dragover=!1)},async onDragStart(e){var i,s,r;if(e.stopPropagation(),!this.canDrag||!this.fileid){e.preventDefault(),e.stopPropagation();return}c.debug("Drag started",{event:e}),(s=(i=e.dataTransfer)==null?void 0:i.clearData)==null||s.call(i),this.renamingStore.$reset(),this.selectedFiles.includes(this.source.source)?this.draggingStore.set(this.selectedFiles):this.draggingStore.set([this.source.source]);const n=this.draggingStore.dragging.map(l=>this.filesStore.getNode(l)),o=await Yi(n);(r=e.dataTransfer)==null||r.setDragImage(o,-10,-10)},onDragEnd(){this.draggingStore.reset(),this.dragover=!1,c.debug("Drag ended")},async onDrop(e){var i,s,r,n;if(!this.draggingFiles&&!((s=(i=e.dataTransfer)==null?void 0:i.items)!=null&&s.length))return;e.preventDefault(),e.stopPropagation();const o=this.draggingFiles,l=[...((r=e.dataTransfer)==null?void 0:r.items)||[]],d=await oe(l),u=await((n=this.currentView)==null?void 0:n.getContents(this.source.path)),f=u==null?void 0:u.folder;if(!f){p(this.t("files","Target folder does not exist any more"));return}if(!this.canDrop||e.button)return;const g=e.ctrlKey;if(this.dragover=!1,c.debug("Dropped",{event:e,folder:f,selection:o,fileTree:d}),d.contents.length>0){await ae(d,f,u.contents);return}const v=o.map(_=>this.filesStore.getNode(_));await Ke(v,f,u.contents,g),o.some(_=>this.selectedFiles.includes(_))&&(c.debug("Dropped selection, resetting select store..."),this.selectionStore.reset())},t:a}}),ns=function(...e){const i=S("keyboard",{state:()=>({altKey:!1,ctrlKey:!1,metaKey:!1,shiftKey:!1}),actions:{onEvent(s){s||(s=window.event),h.set(this,"altKey",!!s.altKey),h.set(this,"ctrlKey",!!s.ctrlKey),h.set(this,"metaKey",!!s.metaKey),h.set(this,"shiftKey",!!s.shiftKey)}}})(...e);return i._initialized||(window.addEventListener("keydown",i.onEvent),window.addEventListener("keyup",i.onEvent),window.addEventListener("mousemove",i.onEvent),i._initialized=!0),i},os=y({name:"FileEntryCheckbox",components:{NcCheckboxRadioSwitch:te,NcLoadingIcon:K},props:{fileid:{type:Number,required:!0},isLoading:{type:Boolean,default:!1},nodes:{type:Array,required:!0},source:{type:Object,required:!0}},setup(){const e=N();return{keyboardStore:ns(),selectionStore:e}},computed:{selectedFiles(){return this.selectionStore.selected},isSelected(){return this.selectedFiles.includes(this.source.source)},index(){return this.nodes.findIndex(e=>e.source===this.source.source)},isFile(){return this.source.type===w.File},ariaLabel(){return this.isFile?a("files",'Toggle selection for file "{displayName}"',{displayName:this.source.basename}):a("files",'Toggle selection for folder "{displayName}"',{displayName:this.source.basename})}},methods:{onSelectionChange(e){var i;const s=this.index,r=this.selectionStore.lastSelectedIndex;if((i=this.keyboardStore)!=null&&i.shiftKey&&r!==null){const o=this.selectedFiles.includes(this.source.source),l=Math.min(s,r),d=Math.max(r,s),u=this.selectionStore.lastSelection,f=this.nodes.map(v=>v.source).slice(l,d+1).filter(Boolean),g=[...u,...f].filter(v=>!o||v!==this.source.source);c.debug("Shift key pressed, selecting all files in between",{start:l,end:d,filesToSelect:f,isAlreadySelected:o}),this.selectionStore.set(g);return}const n=e?[...this.selectedFiles,this.source.source]:this.selectedFiles.filter(o=>o!==this.source.source);c.debug("Updating selection",{selection:n}),this.selectionStore.set(n),this.selectionStore.setLastIndex(s)},resetSelection(){this.selectionStore.reset()},t:a}});var as=function(){var e=this,i=e._self._c;return e._self._setupProxy,i("td",{staticClass:"files-list__row-checkbox",on:{keyup:function(s){return!s.type.indexOf("key")&&e._k(s.keyCode,"esc",27,s.key,["Esc","Escape"])||s.ctrlKey||s.shiftKey||s.altKey||s.metaKey?null:e.resetSelection.apply(null,arguments)}}},[e.isLoading?i("NcLoadingIcon"):i("NcCheckboxRadioSwitch",{attrs:{"aria-label":e.ariaLabel,checked:e.isSelected},on:{"update:checked":e.onSelectionChange}})],1)},ls=[],cs=m(os,as,ls,!1,null,null);const Qe=cs.exports,ds=P("files","forbiddenCharacters",[]),us=y({name:"FileEntryName",components:{NcTextField:wt},props:{displayName:{type:String,required:!0},extension:{type:String,required:!0},filesListWidth:{type:Number,required:!0},nodes:{type:Array,required:!0},source:{type:Object,required:!0},gridMode:{type:Boolean,default:!1}},setup(){return{renamingStore:de()}},computed:{currentView(){return this.$navigation.active},isRenaming(){return this.renamingStore.renamingNode===this.source},isRenamingSmallScreen(){return this.isRenaming&&this.filesListWidth<512},newName:{get(){return this.renamingStore.newName},set(e){this.renamingStore.newName=e}},renameLabel(){return{[w.File]:a("files","File name"),[w.Folder]:a("files","Folder name")}[this.source.type]},linkTo(){var e,i,s,r;if(this.source.attributes.failed)return{is:"span",params:{title:a("files","This node is unavailable")}};const n=(s=(i=(e=this.$parent)==null?void 0:e.$refs)==null?void 0:i.actions)==null?void 0:s.enabledDefaultActions;return(n==null?void 0:n.length)>0?{is:"a",params:{title:n[0].displayName([this.source],this.currentView),role:"button",tabindex:"0"}}:((r=this.source)==null?void 0:r.permissions)&L.READ?{is:"a",params:{download:this.source.basename,href:this.source.source,title:a("files","Download file {name}",{name:this.displayName}),tabindex:"0"}}:{is:"span"}}},watch:{isRenaming:{immediate:!0,handler(e){e&&this.startRenaming()}}},methods:{checkInputValidity(e){var i,s;const r=e.target,n=((s=(i=this.newName).trim)==null?void 0:s.call(i))||"";c.debug("Checking input validity",{newName:n});try{this.isFileNameValid(n),r.setCustomValidity(""),r.title=""}catch(o){o instanceof Error?(r.setCustomValidity(o.message),r.title=o.message):r.setCustomValidity(a("files","Invalid file name"))}finally{r.reportValidity()}},isFileNameValid(e){const i=e.trim();if(i==="."||i==="..")throw new Error(a("files",'"{name}" is an invalid file name.',{name:e}));if(i.length===0)throw new Error(a("files","File name cannot be empty."));if(i.indexOf("/")!==-1)throw new Error(a("files",'"/" is not allowed inside a file name.'));if(i.match(window.OC.config.blacklist_files_regex))throw new Error(a("files",'"{name}" is not an allowed filetype.',{name:e}));if(this.checkIfNodeExists(e))throw new Error(a("files","{newName} already exists.",{newName:e}));const s=ds.find(r=>i.includes(r));if(s)throw new Error(a("files",'"{char}" is not allowed inside a file name.',{char:s}));return!0},checkIfNodeExists(e){return this.nodes.find(i=>i.basename===e&&i!==this.source)},startRenaming(){this.$nextTick(()=>{var e,i,s,r;const n=(this.source.extension||"").split("").length,o=this.source.basename.split("").length-n,l=(r=(s=(i=(e=this.$refs.renameInput)==null?void 0:e.$refs)==null?void 0:i.inputField)==null?void 0:s.$refs)==null?void 0:r.input;if(!l){c.error("Could not find the rename input");return}l.setSelectionRange(0,o),l.focus(),l.dispatchEvent(new Event("keyup"))})},stopRenaming(){this.isRenaming&&this.renamingStore.$reset()},async onRename(){var e,i,s,r,n;const o=this.source.basename,l=this.source.encodedSource,d=((i=(e=this.newName).trim)==null?void 0:i.call(e))||"";if(d===""){p(a("files","Name cannot be empty"));return}if(o===d){this.stopRenaming();return}if(this.checkIfNodeExists(d)){p(a("files","Another entry with the same name already exists"));return}h.set(this.source,"status",D.LOADING),this.source.rename(d),c.debug("Moving file to",{destination:this.source.encodedSource,oldEncodedSource:l});try{await ee({method:"MOVE",url:l,headers:{Destination:this.source.encodedSource,Overwrite:"F"}}),T("files:node:updated",this.source),T("files:node:renamed",this.source),O(a("files",'Renamed "{oldName}" to "{newName}"',{oldName:o,newName:d})),this.stopRenaming(),this.$nextTick(()=>{var u;(u=this.$refs.basename)==null||u.focus()})}catch(u){if(c.error("Error while renaming file",{error:u}),this.source.rename(o),(s=this.$refs.renameInput)==null||s.focus(),St(u)){if(((r=u==null?void 0:u.response)==null?void 0:r.status)===404){p(a("files",'Could not rename "{oldName}", it does not exist any more',{oldName:o}));return}else if(((n=u==null?void 0:u.response)==null?void 0:n.status)===412){p(a("files",'The name "{newName}" is already used in the folder "{dir}". Please choose a different name.',{newName:d,dir:this.currentDir}));return}}p(a("files",'Could not rename "{oldName}"',{oldName:o}))}finally{h.set(this.source,"status",void 0)}},t:a}});var hs=function(){var e=this,i=e._self._c;return e._self._setupProxy,e.isRenaming?i("form",{directives:[{name:"on-click-outside",rawName:"v-on-click-outside",value:e.onRename,expression:"onRename"}],staticClass:"files-list__row-rename",attrs:{"aria-label":e.t("files","Rename file")},on:{submit:function(s){return s.preventDefault(),s.stopPropagation(),e.onRename.apply(null,arguments)}}},[i("NcTextField",{ref:"renameInput",attrs:{label:e.renameLabel,autofocus:!0,minlength:1,required:!0,value:e.newName,enterkeyhint:"done"},on:{"update:value":function(s){e.newName=s},keyup:[e.checkInputValidity,function(s){return!s.type.indexOf("key")&&e._k(s.keyCode,"esc",27,s.key,["Esc","Escape"])?null:e.stopRenaming.apply(null,arguments)}]}})],1):i(e.linkTo.is,e._b({ref:"basename",tag:"component",staticClass:"files-list__row-name-link",attrs:{"aria-hidden":e.isRenaming,"data-cy-files-list-row-name-link":""}},"component",e.linkTo.params,!1),[i("span",{staticClass:"files-list__row-name-text"},[i("span",{staticClass:"files-list__row-name-",domProps:{textContent:e._s(e.displayName)}}),i("span",{staticClass:"files-list__row-name-ext",domProps:{textContent:e._s(e.extension)}})])])},fs=[],ps=m(us,hs,fs,!1,null,null);const Je=ps.exports,gs={name:"CollectivesIcon",props:{title:{type:String,default:""},fillColor:{type:String,default:"currentColor"},size:{type:Number,default:24}}};var ms=function(){var e=this,i=e._self._c;return i("span",e._b({staticClass:"material-design-icon collectives-icon",attrs:{"aria-hidden":!e.title,"aria-label":e.title,role:"img"},on:{click:function(s){return e.$emit("click",s)}}},"span",e.$attrs,!1),[i("svg",{staticClass:"material-design-icon__svg",attrs:{fill:e.fillColor,width:e.size,height:e.size,viewBox:"0 0 16 16"}},[i("path",{attrs:{d:"M2.9,8.8c0-1.2,0.4-2.4,1.2-3.3L0.3,6c-0.2,0-0.3,0.3-0.1,0.4l2.7,2.6C2.9,9,2.9,8.9,2.9,8.8z"}}),i("path",{attrs:{d:"M8,3.7c0.7,0,1.3,0.1,1.9,0.4L8.2,0.6c-0.1-0.2-0.3-0.2-0.4,0L6.1,4C6.7,3.8,7.3,3.7,8,3.7z"}}),i("path",{attrs:{d:"M3.7,11.5L3,15.2c0,0.2,0.2,0.4,0.4,0.3l3.3-1.7C5.4,13.4,4.4,12.6,3.7,11.5z"}}),i("path",{attrs:{d:"M15.7,6l-3.7-0.5c0.7,0.9,1.2,2,1.2,3.3c0,0.1,0,0.2,0,0.3l2.7-2.6C15.9,6.3,15.9,6.1,15.7,6z"}}),i("path",{attrs:{d:"M12.3,11.5c-0.7,1.1-1.8,1.9-3,2.2l3.3,1.7c0.2,0.1,0.4-0.1,0.4-0.3L12.3,11.5z"}}),i("path",{attrs:{d:"M9.6,10.1c-0.4,0.5-1,0.8-1.6,0.8c-1.1,0-2-0.9-2.1-2C5.9,7.7,6.8,6.7,8,6.7c0.6,0,1.1,0.3,1.5,0.7 c0.1,0.1,0.1,0.1,0.2,0.1h1.4c0.2,0,0.4-0.2,0.3-0.5c-0.7-1.3-2.1-2.2-3.8-2.1C5.8,5,4.3,6.6,4.1,8.5C4,10.8,5.8,12.7,8,12.7 c1.6,0,2.9-0.9,3.5-2.3c0.1-0.2-0.1-0.4-0.3-0.4H9.9C9.8,10,9.7,10,9.6,10.1z"}})])])},vs=[],ys=m(gs,ms,vs,!1,null,null);const Ne=ys.exports,_s=y({name:"FavoriteIcon",components:{NcIconSvgWrapper:$},data(){return{StarSvg:Ut}},async mounted(){var e;await this.$nextTick();const i=this.$el.querySelector("svg");(e=i==null?void 0:i.setAttribute)==null||e.call(i,"viewBox","-4 -4 30 30")},methods:{t:a}});var bs=function(){var e=this,i=e._self._c;return e._self._setupProxy,i("NcIconSvgWrapper",{staticClass:"favorite-marker-icon",attrs:{name:e.t("files","Favorite"),svg:e.StarSvg}})},ws=[],Ss=m(_s,bs,ws,!1,null,"4fee71b2");const Cs=Ss.exports,Ns=h.extend({name:"FileEntryPreview",components:{AccountGroupIcon:me,AccountPlusIcon:Q,CollectivesIcon:Ne,FavoriteIcon:Cs,FileIcon:Wt,FolderIcon:qe,FolderOpenIcon:Ht,KeyIcon:ve,LinkIcon:J,NetworkIcon:ye,TagIcon:_e},props:{source:{type:Object,required:!0},dragover:{type:Boolean,default:!1},gridMode:{type:Boolean,default:!1}},setup(){return{userConfigStore:j()}},data(){return{backgroundFailed:void 0}},computed:{fileid(){var e,i,s;return(s=(i=(e=this.source)==null?void 0:e.fileid)==null?void 0:i.toString)==null?void 0:s.call(i)},isFavorite(){return this.source.attributes.favorite===1},userConfig(){return this.userConfigStore.userConfig},cropPreviews(){return this.userConfig.crop_image_previews===!0},previewUrl(){var e,i;if(this.source.type===w.Folder||this.backgroundFailed===!0)return null;try{const s=this.source.attributes.previewUrl||M("/core/preview?fileId={fileid}",{fileid:this.fileid}),r=new URL(window.location.origin+s);r.searchParams.set("x",this.gridMode?"128":"32"),r.searchParams.set("y",this.gridMode?"128":"32"),r.searchParams.set("mimeFallback","true");const n=((i=(e=this.source)==null?void 0:e.attributes)==null?void 0:i.etag)||"";return r.searchParams.set("v",n.slice(0,6)),r.searchParams.set("a",this.cropPreviews===!0?"0":"1"),r.href}catch{return null}},fileOverlay(){return Et(this.source)?Kt:null},folderOverlay(){var e,i,s,r,n,o,l,d;if(this.source.type!==w.Folder)return null;if(((i=(e=this.source)==null?void 0:e.attributes)==null?void 0:i["is-encrypted"])===1)return ve;if((r=(s=this.source)==null?void 0:s.attributes)!=null&&r["is-tag"])return _e;const u=Object.values(((o=(n=this.source)==null?void 0:n.attributes)==null?void 0:o["share-types"])||{}).flat();if(u.some(f=>f===k.SHARE_TYPE_LINK||f===k.SHARE_TYPE_EMAIL))return J;if(u.length>0)return Q;switch((d=(l=this.source)==null?void 0:l.attributes)==null?void 0:d["mount-type"]){case"external":case"external-session":return ye;case"group":return me;case"collective":return Ne}return null}},methods:{reset(){this.backgroundFailed=void 0,this.$refs.previewImg&&(this.$refs.previewImg.src="")},onBackgroundError(e){var i;((i=e.target)==null?void 0:i.src)!==""&&(this.backgroundFailed=!0)},t:a}});var xs=function(){var e=this,i=e._self._c;return e._self._setupProxy,i("span",{staticClass:"files-list__row-icon"},[e.source.type==="folder"?[e.dragover?e._m(0):[e._m(1),e.folderOverlay?i(e.folderOverlay,{tag:"OverlayIcon",staticClass:"files-list__row-icon-overlay"}):e._e()]]:e.previewUrl&&e.backgroundFailed!==!0?i("img",{ref:"previewImg",staticClass:"files-list__row-icon-preview",class:{"files-list__row-icon-preview--loaded":e.backgroundFailed===!1},attrs:{alt:"",loading:"lazy",src:e.previewUrl},on:{error:e.onBackgroundError,load:function(s){e.backgroundFailed=!1}}}):e._m(2),e.isFavorite?i("span",{staticClass:"files-list__row-icon-favorite"},[e._m(3)],1):e._e(),e.fileOverlay?i(e.fileOverlay,{tag:"OverlayIcon",staticClass:"files-list__row-icon-overlay files-list__row-icon-overlay--file"}):e._e()],2)},Fs=[function(){var e=this,i=e._self._c;return e._self._setupProxy,i("FolderOpenIcon")},function(){var e=this,i=e._self._c;return e._self._setupProxy,i("FolderIcon")},function(){var e=this,i=e._self._c;return e._self._setupProxy,i("FileIcon")},function(){var e=this,i=e._self._c;return e._self._setupProxy,i("FavoriteIcon")}],As=m(Ns,xs,Fs,!1,null,null);const Xe=As.exports,ks=y({name:"FileEntry",components:{CustomElementRender:je,FileEntryActions:Ge,FileEntryCheckbox:Qe,FileEntryName:Je,FileEntryPreview:Xe,NcDateTime:Ct},mixins:[Ye],props:{isMtimeAvailable:{type:Boolean,default:!1},isSizeAvailable:{type:Boolean,default:!1},compact:{type:Boolean,default:!1}},setup(){const e=ce(),i=le(),s=C(),r=de(),n=N();return{actionsMenuStore:e,draggingStore:i,filesStore:s,renamingStore:r,selectionStore:n}},computed:{rowListeners(){return{...this.isRenaming?{}:{dragstart:this.onDragStart,dragover:this.onDragOver},contextmenu:this.onRightClick,dragleave:this.onDragLeave,dragend:this.onDragEnd,drop:this.onDrop}},columns(){var e;return this.filesListWidth<512||this.compact?[]:((e=this.currentView)==null?void 0:e.columns)||[]},size(){const e=parseInt(this.source.size,10);return typeof e!="number"||isNaN(e)||e<0?this.t("files","Pending"):I(e,!0)},sizeOpacity(){const e=parseInt(this.source.size,10);if(!e||isNaN(e)||e<0)return{};const i=Math.round(Math.min(100,100*Math.pow(this.source.size/10485760,2)));return{color:"color-mix(in srgb, var(--color-main-text) ".concat(i,"%, var(--color-text-maxcontrast))")}},mtimeOpacity(){var e,i;const s=(i=(e=this.source.mtime)==null?void 0:e.getTime)==null?void 0:i.call(e);if(!s)return{};const r=Math.round(Math.min(100,100*(26784e5-(Date.now()-s))/26784e5));return r<0?{}:{color:"color-mix(in srgb, var(--color-main-text) ".concat(r,"%, var(--color-text-maxcontrast))")}},mtimeTitle(){return this.source.mtime?ti(this.source.mtime).format("LLL"):""}},methods:{formatFileSize:I}});var Is=function(){var e=this,i=e._self._c;return e._self._setupProxy,i("tr",e._g({staticClass:"files-list__row",class:{"files-list__row--dragover":e.dragover,"files-list__row--loading":e.isLoading,"files-list__row--active":e.isActive},attrs:{"data-cy-files-list-row":"","data-cy-files-list-row-fileid":e.fileid,"data-cy-files-list-row-name":e.source.basename,draggable:e.canDrag}},e.rowListeners),[e.source.attributes.failed?i("span",{staticClass:"files-list__row--failed"}):e._e(),i("FileEntryCheckbox",{attrs:{fileid:e.fileid,"is-loading":e.isLoading,nodes:e.nodes,source:e.source}}),i("td",{staticClass:"files-list__row-name",attrs:{"data-cy-files-list-row-name":""}},[i("FileEntryPreview",{ref:"preview",attrs:{source:e.source,dragover:e.dragover},nativeOn:{auxclick:function(s){return e.execDefaultAction.apply(null,arguments)},click:function(s){return e.execDefaultAction.apply(null,arguments)}}}),i("FileEntryName",{ref:"name",attrs:{"display-name":e.displayName,extension:e.extension,"files-list-width":e.filesListWidth,nodes:e.nodes,source:e.source},nativeOn:{auxclick:function(s){return e.execDefaultAction.apply(null,arguments)},click:function(s){return e.execDefaultAction.apply(null,arguments)}}})],1),i("FileEntryActions",{directives:[{name:"show",rawName:"v-show",value:!e.isRenamingSmallScreen,expression:"!isRenamingSmallScreen"}],ref:"actions",class:"files-list__row-actions-".concat(e.uniqueId),attrs:{"files-list-width":e.filesListWidth,loading:e.loading,opened:e.openedMenu,source:e.source},on:{"update:loading":function(s){e.loading=s},"update:opened":function(s){e.openedMenu=s}}}),!e.compact&&e.isSizeAvailable?i("td",{staticClass:"files-list__row-size",style:e.sizeOpacity,attrs:{"data-cy-files-list-row-size":""},on:{click:e.openDetailsIfAvailable}},[i("span",[e._v(e._s(e.size))])]):e._e(),!e.compact&&e.isMtimeAvailable?i("td",{staticClass:"files-list__row-mtime",style:e.mtimeOpacity,attrs:{"data-cy-files-list-row-mtime":""},on:{click:e.openDetailsIfAvailable}},[e.source.mtime?i("NcDateTime",{attrs:{timestamp:e.source.mtime,"ignore-seconds":!0}}):e._e()],1):e._e(),e._l(e.columns,function(s){var r;return i("td",{key:s.id,staticClass:"files-list__row-column-custom",class:"files-list__row-".concat((r=e.currentView)==null?void 0:r.id,"-").concat(s.id),attrs:{"data-cy-files-list-row-column-custom":s.id},on:{click:e.openDetailsIfAvailable}},[i("CustomElementRender",{attrs:{"current-view":e.currentView,render:s.render,source:e.source}})],1)})],2)},Ds=[],Ls=m(ks,Is,Ds,!1,null,null);const Es=Ls.exports,Ts=y({name:"FileEntryGrid",components:{FileEntryActions:Ge,FileEntryCheckbox:Qe,FileEntryName:Je,FileEntryPreview:Xe},mixins:[Ye],inheritAttrs:!1,setup(){const e=ce(),i=le(),s=C(),r=de(),n=N();return{actionsMenuStore:e,draggingStore:i,filesStore:s,renamingStore:r,selectionStore:n}},data(){return{gridMode:!0}}});var Vs=function(){var e=this,i=e._self._c;return e._self._setupProxy,i("tr",{staticClass:"files-list__row",class:{"files-list__row--active":e.isActive,"files-list__row--dragover":e.dragover,"files-list__row--loading":e.isLoading},attrs:{"data-cy-files-list-row":"","data-cy-files-list-row-fileid":e.fileid,"data-cy-files-list-row-name":e.source.basename,draggable:e.canDrag},on:{contextmenu:e.onRightClick,dragover:e.onDragOver,dragleave:e.onDragLeave,dragstart:e.onDragStart,dragend:e.onDragEnd,drop:e.onDrop}},[e.source.attributes.failed?i("span",{staticClass:"files-list__row--failed"}):e._e(),i("FileEntryCheckbox",{attrs:{fileid:e.fileid,"is-loading":e.isLoading,nodes:e.nodes,source:e.source}}),i("td",{staticClass:"files-list__row-name",attrs:{"data-cy-files-list-row-name":""}},[i("FileEntryPreview",{ref:"preview",attrs:{dragover:e.dragover,"grid-mode":!0,source:e.source},nativeOn:{auxclick:function(s){return e.execDefaultAction.apply(null,arguments)},click:function(s){return e.execDefaultAction.apply(null,arguments)}}}),i("FileEntryName",{ref:"name",attrs:{"display-name":e.displayName,extension:e.extension,"files-list-width":e.filesListWidth,"grid-mode":!0,nodes:e.nodes,source:e.source},nativeOn:{auxclick:function(s){return e.execDefaultAction.apply(null,arguments)},click:function(s){return e.execDefaultAction.apply(null,arguments)}}})],1),i("FileEntryActions",{ref:"actions",class:"files-list__row-actions-".concat(e.uniqueId),attrs:{"files-list-width":e.filesListWidth,"grid-mode":!0,loading:e.loading,opened:e.openedMenu,source:e.source},on:{"update:loading":function(s){e.loading=s},"update:opened":function(s){e.openedMenu=s}}})],1)},Ms=[],Ps=m(Ts,Vs,Ms,!1,null,null);const $s=Ps.exports,Os={name:"FilesListHeader",props:{header:{type:Object,required:!0},currentFolder:{type:Object,required:!0},currentView:{type:Object,required:!0}},computed:{enabled(){return this.header.enabled(this.currentFolder,this.currentView)}},watch:{enabled(e){e&&this.header.updated(this.currentFolder,this.currentView)},currentFolder(){this.header.updated(this.currentFolder,this.currentView)}},mounted(){console.debug("Mounted",this.header.id),this.header.render(this.$refs.mount,this.currentFolder,this.currentView)}};var Rs=function(){var e=this,i=e._self._c;return i("div",{directives:[{name:"show",rawName:"v-show",value:e.enabled,expression:"enabled"}],class:"files-list__header-".concat(e.header.id)},[i("span",{ref:"mount"})])},qs=[],zs=m(Os,Rs,qs,!1,null,null);const Bs=zs.exports,Us=y({name:"FilesListTableFooter",props:{currentView:{type:Ee,required:!0},isMtimeAvailable:{type:Boolean,default:!1},isSizeAvailable:{type:Boolean,default:!1},nodes:{type:Array,required:!0},summary:{type:String,default:""},filesListWidth:{type:Number,default:0}},setup(){const e=re();return{filesStore:C(),pathsStore:e}},computed:{dir(){var e,i;return(((i=(e=this.$route)==null?void 0:e.query)==null?void 0:i.dir)||"/").replace(/^(.+)\/$/,"$1")},currentFolder(){var e;if(!((e=this.currentView)!=null&&e.id))return;if(this.dir==="/")return this.filesStore.getRoot(this.currentView.id);const i=this.pathsStore.getPath(this.currentView.id,this.dir);return this.filesStore.getNode(i)},columns(){var e;return this.filesListWidth<512?[]:((e=this.currentView)==null?void 0:e.columns)||[]},totalSize(){var e;return(e=this.currentFolder)!=null&&e.size?I(this.currentFolder.size,!0):I(this.nodes.reduce((i,s)=>{var r;return i+((r=s.size)!=null?r:0)},0),!0)}},methods:{classForColumn(e){return{"files-list__row-column-custom":!0,["files-list__row-".concat(this.currentView.id,"-").concat(e.id)]:!0}},t:a}});var Ws=function(){var e=this,i=e._self._c;return e._self._setupProxy,i("tr",[i("th",{staticClass:"files-list__row-checkbox"},[i("span",{staticClass:"hidden-visually"},[e._v(e._s(e.t("files","Total rows summary")))])]),i("td",{staticClass:"files-list__row-name"},[i("span",{staticClass:"files-list__row-icon"}),i("span",[e._v(e._s(e.summary))])]),i("td",{staticClass:"files-list__row-actions"}),e.isSizeAvailable?i("td",{staticClass:"files-list__column files-list__row-size"},[i("span",[e._v(e._s(e.totalSize))])]):e._e(),e.isMtimeAvailable?i("td",{staticClass:"files-list__column files-list__row-mtime"}):e._e(),e._l(e.columns,function(s){var r;return i("th",{key:s.id,class:e.classForColumn(s)},[i("span",[e._v(e._s((r=s.summary)==null?void 0:r.call(s,e.nodes,e.currentView)))])])})],2)},Hs=[],Ks=m(Us,Ws,Hs,!1,null,"7b1cbb19");const js=Ks.exports,ue=h.extend({computed:{...tt(se,["getConfig","setSortingBy","toggleSortingDirection"]),currentView(){return this.$navigation.active},sortingMode(){var e,i;return((e=this.getConfig(this.currentView.id))==null?void 0:e.sorting_mode)||((i=this.currentView)==null?void 0:i.defaultSortKey)||"basename"},isAscSorting(){var e;return((e=this.getConfig(this.currentView.id))==null?void 0:e.sorting_direction)!=="desc"}},methods:{toggleSortBy(e){if(this.sortingMode===e){this.toggleSortingDirection(this.currentView.id);return}this.setSortingBy(e,this.currentView.id)}}}),Gs=y({name:"FilesListTableHeaderButton",components:{MenuDown:jt,MenuUp:Gt,NcButton:Pe},mixins:[ue],props:{name:{type:String,required:!0},mode:{type:String,required:!0}},methods:{t:a}});var Ys=function(){var e=this,i=e._self._c;return e._self._setupProxy,i("NcButton",{class:["files-list__column-sort-button",{"files-list__column-sort-button--active":e.sortingMode===e.mode,"files-list__column-sort-button--size":e.sortingMode==="size"}],attrs:{alignment:e.mode==="size"?"end":"start-reverse",type:"tertiary"},on:{click:function(s){return e.toggleSortBy(e.mode)}},scopedSlots:e._u([{key:"icon",fn:function(){return[e.sortingMode!==e.mode||e.isAscSorting?i("MenuUp",{staticClass:"files-list__column-sort-button-icon"}):i("MenuDown",{staticClass:"files-list__column-sort-button-icon"})]},proxy:!0}])},[i("span",{staticClass:"files-list__column-sort-button-text"},[e._v(e._s(e.name))])])},Qs=[],Js=m(Gs,Ys,Qs,!1,null,"b843f133");const Xs=Js.exports,Zs=y({name:"FilesListTableHeader",components:{FilesListTableHeaderButton:Xs,NcCheckboxRadioSwitch:te},mixins:[ue],props:{isMtimeAvailable:{type:Boolean,default:!1},isSizeAvailable:{type:Boolean,default:!1},nodes:{type:Array,required:!0},filesListWidth:{type:Number,default:0}},setup(){const e=C(),i=N();return{filesStore:e,selectionStore:i}},computed:{currentView(){return this.$navigation.active},columns(){var e;return this.filesListWidth<512?[]:((e=this.currentView)==null?void 0:e.columns)||[]},dir(){var e,i;return(((i=(e=this.$route)==null?void 0:e.query)==null?void 0:i.dir)||"/").replace(/^(.+)\/$/,"$1")},selectAllBind(){const e=a("files","Toggle selection for all files and folders");return{"aria-label":e,checked:this.isAllSelected,indeterminate:this.isSomeSelected,title:e}},selectedNodes(){return this.selectionStore.selected},isAllSelected(){return this.selectedNodes.length===this.nodes.length},isNoneSelected(){return this.selectedNodes.length===0},isSomeSelected(){return!this.isAllSelected&&!this.isNoneSelected}},methods:{ariaSortForMode(e){return this.sortingMode===e?this.isAscSorting?"ascending":"descending":null},classForColumn(e){var i;return{"files-list__column":!0,"files-list__column--sortable":!!e.sort,"files-list__row-column-custom":!0,["files-list__row-".concat((i=this.currentView)==null?void 0:i.id,"-").concat(e.id)]:!0}},onToggleAll(e){if(e){const i=this.nodes.map(s=>s.source).filter(Boolean);c.debug("Added all nodes to selection",{selection:i}),this.selectionStore.setLastIndex(null),this.selectionStore.set(i)}else c.debug("Cleared selection"),this.selectionStore.reset()},resetSelection(){this.selectionStore.reset()},t:a}});var er=function(){var e=this,i=e._self._c;return e._self._setupProxy,i("tr",{staticClass:"files-list__row-head"},[i("th",{staticClass:"files-list__column files-list__row-checkbox",on:{keyup:function(s){return!s.type.indexOf("key")&&e._k(s.keyCode,"esc",27,s.key,["Esc","Escape"])||s.ctrlKey||s.shiftKey||s.altKey||s.metaKey?null:e.resetSelection.apply(null,arguments)}}},[i("NcCheckboxRadioSwitch",e._b({on:{"update:checked":e.onToggleAll}},"NcCheckboxRadioSwitch",e.selectAllBind,!1))],1),i("th",{staticClass:"files-list__column files-list__row-name files-list__column--sortable",attrs:{"aria-sort":e.ariaSortForMode("basename")}},[i("span",{staticClass:"files-list__row-icon"}),i("FilesListTableHeaderButton",{attrs:{name:e.t("files","Name"),mode:"basename"}})],1),i("th",{staticClass:"files-list__row-actions"}),e.isSizeAvailable?i("th",{staticClass:"files-list__column files-list__row-size",class:{"files-list__column--sortable":e.isSizeAvailable},attrs:{"aria-sort":e.ariaSortForMode("size")}},[i("FilesListTableHeaderButton",{attrs:{name:e.t("files","Size"),mode:"size"}})],1):e._e(),e.isMtimeAvailable?i("th",{staticClass:"files-list__column files-list__row-mtime",class:{"files-list__column--sortable":e.isMtimeAvailable},attrs:{"aria-sort":e.ariaSortForMode("mtime")}},[i("FilesListTableHeaderButton",{attrs:{name:e.t("files","Modified"),mode:"mtime"}})],1):e._e(),e._l(e.columns,function(s){return i("th",{key:s.id,class:e.classForColumn(s),attrs:{"aria-sort":e.ariaSortForMode(s.id)}},[s.sort?i("FilesListTableHeaderButton",{attrs:{name:s.title,mode:s.id}}):i("span",[e._v(" "+e._s(s.title)+" ")])],1)})],2)},tr=[],ir=m(Zs,er,tr,!1,null,"4fb6fcaa");const sr=ir.exports,rr=h.extend({name:"VirtualList",mixins:[z],props:{dataComponent:{type:[Object,Function],required:!0},dataKey:{type:String,required:!0},dataSources:{type:Array,required:!0},extraProps:{type:Object,default:()=>({})},scrollToIndex:{type:Number,default:0},gridMode:{type:Boolean,default:!1},caption:{type:String,default:""}},data(){return{index:this.scrollToIndex,beforeHeight:0,headerHeight:0,tableHeight:0,resizeObserver:null}},computed:{isReady(){return this.tableHeight>0},bufferItems(){return this.gridMode?this.columnCount:3},itemHeight(){return this.gridMode?197:55},itemWidth(){return 175},rowCount(){return Math.ceil((this.tableHeight-this.headerHeight)/this.itemHeight)+this.bufferItems/this.columnCount*2+1},columnCount(){return this.gridMode?Math.floor(this.filesListWidth/this.itemWidth):1},startIndex(){return Math.max(0,this.index-this.bufferItems)},shownItems(){return this.gridMode?this.rowCount*this.columnCount:this.rowCount},renderedItems(){if(!this.isReady)return[];const e=this.dataSources.slice(this.startIndex,this.startIndex+this.shownItems),i=e.filter(r=>Object.values(this.$_recycledPool).includes(r[this.dataKey])).map(r=>r[this.dataKey]),s=Object.keys(this.$_recycledPool).filter(r=>!i.includes(this.$_recycledPool[r]));return e.map(r=>{const n=Object.values(this.$_recycledPool).indexOf(r[this.dataKey]);if(n!==-1)return{key:Object.keys(this.$_recycledPool)[n],item:r};const o=s.pop()||Math.random().toString(36).substr(2);return this.$_recycledPool[o]=r[this.dataKey],{key:o,item:r}})},totalRowCount(){return Math.floor(this.dataSources.length/this.columnCount)},tbodyStyle(){const e=this.startIndex+this.rowCount>this.dataSources.length,i=this.dataSources.length-this.startIndex-this.shownItems,s=Math.floor(Math.min(this.dataSources.length-this.startIndex,i)/this.columnCount);return{paddingTop:"".concat(Math.floor(this.startIndex/this.columnCount)*this.itemHeight,"px"),paddingBottom:e?0:"".concat(s*this.itemHeight,"px"),minHeight:"".concat(this.totalRowCount*this.itemHeight+this.beforeHeight,"px")}}},watch:{scrollToIndex(e){this.scrollTo(e)},totalRowCount(){this.scrollToIndex&&this.$nextTick(()=>this.scrollTo(this.scrollToIndex))},columnCount(e,i){if(i===0){console.debug("VirtualList: columnCount is 0, skipping scroll");return}this.scrollTo(this.index)}},mounted(){var e,i;const s=(e=this.$refs)==null?void 0:e.before,r=this.$el,n=(i=this.$refs)==null?void 0:i.thead;this.resizeObserver=new ResizeObserver(ii.debounce(()=>{var o,l,d;this.beforeHeight=(o=s==null?void 0:s.clientHeight)!=null?o:0,this.headerHeight=(l=n==null?void 0:n.clientHeight)!=null?l:0,this.tableHeight=(d=r==null?void 0:r.clientHeight)!=null?d:0,c.debug("VirtualList: resizeObserver updated"),this.onScroll()},100,!1)),this.resizeObserver.observe(s),this.resizeObserver.observe(r),this.resizeObserver.observe(n),this.scrollToIndex&&this.scrollTo(this.scrollToIndex),this.$el.addEventListener("scroll",this.onScroll,{passive:!0}),this.$_recycledPool={}},beforeDestroy(){this.resizeObserver&&this.resizeObserver.disconnect()},methods:{scrollTo(e){const i=Math.ceil(this.dataSources.length/this.columnCount);if(i<this.rowCount){c.debug("VirtualList: Skip scrolling. nothing to scroll",{index:e,targetRow:i,rowCount:this.rowCount});return}this.index=e;const s=(Math.floor(e/this.columnCount)-.5)*this.itemHeight+this.beforeHeight;c.debug("VirtualList: scrolling to index "+e,{scrollTop:s,columnCount:this.columnCount}),this.$el.scrollTop=s},onScroll(){var e;(e=this._onScrollHandle)!=null||(this._onScrollHandle=requestAnimationFrame(()=>{this._onScrollHandle=null;const i=this.$el.scrollTop-this.beforeHeight,s=Math.floor(i/this.itemHeight)*this.columnCount;this.index=Math.max(0,s),this.$emit("scroll")}))}}});var nr=function(){var e=this,i=e._self._c;return e._self._setupProxy,i("div",{staticClass:"files-list",attrs:{"data-cy-files-list":""}},[i("div",{ref:"before",staticClass:"files-list__before"},[e._t("before")],2),e.$scopedSlots["header-overlay"]?i("div",{staticClass:"files-list__thead-overlay"},[e._t("header-overlay")],2):e._e(),i("table",{staticClass:"files-list__table",class:{"files-list__table--with-thead-overlay":!!e.$scopedSlots["header-overlay"]}},[e.caption?i("caption",{staticClass:"hidden-visually"},[e._v(" "+e._s(e.caption)+" ")]):e._e(),i("thead",{ref:"thead",staticClass:"files-list__thead",attrs:{"data-cy-files-list-thead":""}},[e._t("header")],2),i("tbody",{staticClass:"files-list__tbody",class:e.gridMode?"files-list__tbody--grid":"files-list__tbody--list",style:e.tbodyStyle,attrs:{"data-cy-files-list-tbody":""}},e._l(e.renderedItems,function({key:s,item:r},n){return i(e.dataComponent,e._b({key:s,tag:"component",attrs:{source:r,index:n}},"component",e.extraProps,!1))}),1),i("tfoot",{directives:[{name:"show",rawName:"v-show",value:e.isReady,expression:"isReady"}],staticClass:"files-list__tfoot",attrs:{"data-cy-files-list-tfoot":""}},[e._t("footer")],2)])])},or=[],ar=m(rr,nr,or,!1,null,null);const lr=ar.exports,cr=X(),dr=y({name:"FilesListTableHeaderActions",components:{NcActions:Me,NcActionButton:Ve,NcIconSvgWrapper:$,NcLoadingIcon:K},mixins:[z],props:{currentView:{type:Object,required:!0},selectedNodes:{type:Array,default:()=>[]}},setup(){const e=ce(),i=C(),s=N();return{actionsMenuStore:e,filesStore:i,selectionStore:s}},data(){return{loading:null}},computed:{dir(){var e,i;return(((i=(e=this.$route)==null?void 0:e.query)==null?void 0:i.dir)||"/").replace(/^(.+)\/$/,"$1")},enabledActions(){return cr.filter(e=>e.execBatch).filter(e=>!e.enabled||e.enabled(this.nodes,this.currentView)).sort((e,i)=>(e.order||0)-(i.order||0))},nodes(){return this.selectedNodes.map(e=>this.getNode(e)).filter(Boolean)},areSomeNodesLoading(){return this.nodes.some(e=>e.status===D.LOADING)},openedMenu:{get(){return this.actionsMenuStore.opened==="global"},set(e){this.actionsMenuStore.opened=e?"global":null}},inlineActions(){return this.filesListWidth<512?0:this.filesListWidth<768?1:this.filesListWidth<1024?2:3}},methods:{getNode(e){return this.filesStore.getNode(e)},async onActionClick(e){const i=e.displayName(this.nodes,this.currentView),s=this.selectedNodes;try{this.loading=e.id,this.nodes.forEach(n=>{h.set(n,"status",D.LOADING)});const r=await e.execBatch(this.nodes,this.currentView,this.dir);if(!r.some(n=>n!==null)){this.selectionStore.reset();return}if(r.some(n=>n===!1)){const n=s.filter((o,l)=>r[l]===!1);if(this.selectionStore.set(n),r.some(o=>o===null))return;p(this.t("files",'"{displayName}" failed on some elements ',{displayName:i}));return}O(this.t("files",'"{displayName}" batch action executed successfully',{displayName:i})),this.selectionStore.reset()}catch(r){c.error("Error while executing action",{action:e,e:r}),p(this.t("files",'"{displayName}" action failed',{displayName:i}))}finally{this.loading=null,this.nodes.forEach(r=>{h.set(r,"status",void 0)})}},t:a}});var ur=function(){var e=this,i=e._self._c;return e._self._setupProxy,i("div",{staticClass:"files-list__column files-list__row-actions-batch"},[i("NcActions",{ref:"actionsMenu",attrs:{disabled:!!e.loading||e.areSomeNodesLoading,"force-name":!0,inline:e.inlineActions,"menu-name":e.inlineActions<=1?e.t("files","Actions"):null,open:e.openedMenu},on:{"update:open":function(s){e.openedMenu=s}}},e._l(e.enabledActions,function(s){return i("NcActionButton",{key:s.id,class:"files-list__row-actions-batch-"+s.id,on:{click:function(r){return e.onActionClick(s)}},scopedSlots:e._u([{key:"icon",fn:function(){return[e.loading===s.id?i("NcLoadingIcon",{attrs:{size:18}}):i("NcIconSvgWrapper",{attrs:{svg:s.iconSvgInline(e.nodes,e.currentView)}})]},proxy:!0}],null,!0)},[e._v(" "+e._s(s.displayName(e.nodes,e.currentView))+" ")])}),1)],1)},hr=[],fr=m(dr,ur,hr,!1,null,"4ef2aefc");const pr=fr.exports,gr=y({name:"FilesListVirtual",components:{FilesListHeader:Bs,FilesListTableFooter:js,FilesListTableHeader:sr,VirtualList:lr,FilesListTableHeaderActions:pr},mixins:[z],props:{currentView:{type:Ee,required:!0},currentFolder:{type:Z,required:!0},nodes:{type:Array,required:!0}},setup(){const e=j(),i=N();return{userConfigStore:e,selectionStore:i}},data(){return{FileEntry:Es,FileEntryGrid:$s,headers:at(),scrollToIndex:0,openFileId:null}},computed:{userConfig(){return this.userConfigStore.userConfig},fileId(){return parseInt(this.$route.params.fileid)||null},openFile(){return!!this.$route.query.openfile},summary(){return Re(this.nodes)},isMtimeAvailable(){return this.filesListWidth<768?!1:this.nodes.some(e=>e.mtime!==void 0)},isSizeAvailable(){return this.filesListWidth<768?!1:this.nodes.some(e=>e.size!==void 0)},sortedHeaders(){return!this.currentFolder||!this.currentView?[]:[...this.headers].sort((e,i)=>e.order-i.order)},caption(){const e=a("files","List of files and folders."),i=this.currentView.caption||e,s=a("files","Column headers with buttons are sortable."),r=a("files","This list is not fully rendered for performance reasons. The files will be rendered as you navigate through the list.");return"".concat(i,"\n").concat(s,"\n").concat(r)},selectedNodes(){return this.selectionStore.selected},isNoneSelected(){return this.selectedNodes.length===0}},watch:{fileId(e){this.scrollToFile(e,!1)},openFile(e){e&&this.$nextTick(()=>this.handleOpenFile(this.fileId))}},mounted(){window.document.querySelector("main.app-content").addEventListener("dragover",this.onDragOver);const{id:e}=P("files","openFileInfo",{});this.scrollToFile(e!=null?e:this.fileId),this.openSidebarForFile(e!=null?e:this.fileId),this.handleOpenFile(e!=null?e:null)},beforeDestroy(){window.document.querySelector("main.app-content").removeEventListener("dragover",this.onDragOver)},methods:{openSidebarForFile(e){var i,s;if(document.documentElement.clientWidth>1024&&this.currentFolder.fileid!==e){const r=this.nodes.find(n=>n.fileid===e);r&&(s=(i=q)==null?void 0:i.enabled)!=null&&s.call(i,[r],this.currentView)&&(c.debug("Opening sidebar on file "+r.path,{node:r}),q.exec(r,this.currentView,this.currentFolder.path))}},scrollToFile(e,i=!0){if(e){const s=this.nodes.findIndex(r=>r.fileid===e);i&&s===-1&&e!==this.currentFolder.fileid&&p(this.t("files","File not found")),this.scrollToIndex=Math.max(0,s)}},handleOpenFile(e){if(e===null||this.openFileId===e)return;const i=this.nodes.find(r=>r.fileid===e);if(i===void 0||i.type===w.Folder)return;c.debug("Opening file "+i.path,{node:i}),this.openFileId=e;const s=X().filter(r=>!!(r!=null&&r.default)).filter(r=>!r.enabled||r.enabled([i],this.currentView)).sort((r,n)=>(r.order||0)-(n.order||0)).at(0);s==null||s.exec(i,this.currentView,this.currentFolder.path)},onDragOver(e){var i;if((i=e.dataTransfer)!=null&&i.types.includes("Files"))return;e.preventDefault(),e.stopPropagation();const s=this.$refs.table.$el,r=s.getBoundingClientRect().top,n=r+s.getBoundingClientRect().height;if(e.clientY<r+100){s.scrollTop=s.scrollTop-25;return}e.clientY>n-50&&(s.scrollTop=s.scrollTop+25)},t:a}});var mr=function(){var e=this,i=e._self._c;return e._self._setupProxy,i("VirtualList",{ref:"table",attrs:{"data-component":e.userConfig.grid_view?e.FileEntryGrid:e.FileEntry,"data-key":"source","data-sources":e.nodes,"grid-mode":e.userConfig.grid_view,"extra-props":{isMtimeAvailable:e.isMtimeAvailable,isSizeAvailable:e.isSizeAvailable,nodes:e.nodes,filesListWidth:e.filesListWidth},"scroll-to-index":e.scrollToIndex,caption:e.caption},scopedSlots:e._u([e.isNoneSelected?null:{key:"header-overlay",fn:function(){return[i("span",{staticClass:"files-list__selected"},[e._v(e._s(e.t("files","{count} selected",{count:e.selectedNodes.length})))]),i("FilesListTableHeaderActions",{attrs:{"current-view":e.currentView,"selected-nodes":e.selectedNodes}})]},proxy:!0},{key:"before",fn:function(){return e._l(e.sortedHeaders,function(s){return i("FilesListHeader",{key:s.id,attrs:{"current-folder":e.currentFolder,"current-view":e.currentView,header:s}})})},proxy:!0},{key:"header",fn:function(){return[i("FilesListTableHeader",{ref:"thead",attrs:{"files-list-width":e.filesListWidth,"is-mtime-available":e.isMtimeAvailable,"is-size-available":e.isSizeAvailable,nodes:e.nodes}})]},proxy:!0},{key:"footer",fn:function(){return[i("FilesListTableFooter",{attrs:{"current-view":e.currentView,"files-list-width":e.filesListWidth,"is-mtime-available":e.isMtimeAvailable,"is-size-available":e.isSizeAvailable,nodes:e.nodes,summary:e.summary}})]},proxy:!0}],null,!0)})},vr=[],yr=m(gr,mr,vr,!1,null,"f96fe07d");const _r=yr.exports,br=y({name:"DragAndDropNotice",components:{TrayArrowDownIcon:Yt},props:{currentFolder:{type:Z,required:!0}},data(){return{dragover:!1}},computed:{currentView(){return this.$navigation.active},canUpload(){return this.currentFolder&&(this.currentFolder.permissions&L.CREATE)!==0},isQuotaExceeded(){var e,i;return((i=(e=this.currentFolder)==null?void 0:e.attributes)==null?void 0:i["quota-available-bytes"])===0},cantUploadLabel(){return this.isQuotaExceeded?this.t("files","Your have used your space quota and cannot upload files anymore"):this.canUpload?null:this.t("files","You don’t have permission to upload or create files here")}},mounted(){const e=window.document.querySelector("main.app-content");e.addEventListener("dragover",this.onDragOver),e.addEventListener("dragleave",this.onDragLeave),e.addEventListener("drop",this.onContentDrop)},beforeDestroy(){const e=window.document.querySelector("main.app-content");e.removeEventListener("dragover",this.onDragOver),e.removeEventListener("dragleave",this.onDragLeave),e.removeEventListener("drop",this.onContentDrop)},methods:{onDragOver(e){var i;e.preventDefault(),(i=e.dataTransfer)!=null&&i.types.includes("Files")&&(this.dragover=!0)},onDragLeave(e){var i;const s=e.currentTarget;s!=null&&s.contains((i=e.relatedTarget)!=null?i:e.target)||this.dragover&&(this.dragover=!1)},onContentDrop(e){c.debug("Drag and drop cancelled, dropped on empty space",{event:e}),e.preventDefault(),this.dragover&&(this.dragover=!1)},async onDrop(e){var i,s,r,n,o;if(this.cantUploadLabel){p(this.cantUploadLabel);return}if((i=this.$el.querySelector("tbody"))!=null&&i.contains(e.target))return;e.preventDefault(),e.stopPropagation();const l=[...((s=e.dataTransfer)==null?void 0:s.items)||[]],d=await oe(l),u=await((r=this.currentView)==null?void 0:r.getContents(this.currentFolder.path)),f=u==null?void 0:u.folder;if(!f){p(this.t("files","Target folder does not exist any more"));return}if(e.button)return;c.debug("Dropped",{event:e,folder:f,fileTree:d});const g=(await ae(d,f,u.contents)).findLast(v=>{var _,x;return v.status!==Tt.FAILED&&!v.file.webkitRelativePath.includes("/")&&((x=(_=v.response)==null?void 0:_.headers)==null?void 0:x["oc-fileid"])&&v.source.replace(f.source,"").split("/").length===2});g!==void 0&&(c.debug("Scrolling to last upload in current folder",{lastUpload:g}),this.$router.push({...this.$route,params:{view:(o=(n=this.$route.params)==null?void 0:n.view)!=null?o:"files",fileid:parseInt(g.response.headers["oc-fileid"])}})),this.dragover=!1},t:a}});var wr=function(){var e=this,i=e._self._c;return e._self._setupProxy,i("div",{directives:[{name:"show",rawName:"v-show",value:e.dragover,expression:"dragover"}],staticClass:"files-list__drag-drop-notice",attrs:{"data-cy-files-drag-drop-area":""},on:{drop:e.onDrop}},[i("div",{staticClass:"files-list__drag-drop-notice-wrapper"},[e.canUpload&&!e.isQuotaExceeded?[i("TrayArrowDownIcon",{attrs:{size:48}}),i("h3",{staticClass:"files-list-drag-drop-notice__title"},[e._v(" "+e._s(e.t("files","Drag and drop files here to upload"))+" ")])]:[i("h3",{staticClass:"files-list-drag-drop-notice__title"},[e._v(" "+e._s(e.cantUploadLabel)+" ")])]],2)])},Sr=[],Cr=m(br,wr,Sr,!1,null,"3e4f64e2");const Nr=Cr.exports;var xe;const xr=((xe=Nt())==null?void 0:xe.files_sharing)!==void 0,Fr=y({name:"FilesList",components:{BreadCrumbs:Bi,DragAndDropNotice:Nr,FilesListVirtual:_r,LinkIcon:J,ListViewIcon:Qt,NcAppContent:xt,NcButton:Pe,NcEmptyContent:Ft,NcIconSvgWrapper:$,NcLoadingIcon:K,PlusIcon:Jt,AccountPlusIcon:Q,UploadPicker:Vt,ViewGridIcon:Xt},mixins:[z,ue],setup(){var e;const i=C(),s=re(),r=N(),n=Ue(),o=j(),l=se(),d=(e=P("core","config",[])["enable_non-accessible_features"])!=null?e:!0;return{filesStore:i,pathsStore:s,selectionStore:r,uploaderStore:n,userConfigStore:o,viewConfigStore:l,enableGridView:d,Type:k}},data(){return{filterText:"",loading:!0,promise:null,unsubscribeStoreCallback:()=>{}}},computed:{onSearch(){return si(e=>{console.debug("Files app handling search event from unified search...",e),this.filterText=e.query},500)},userConfig(){return this.userConfigStore.userConfig},currentView(){return this.$navigation.active||this.$navigation.views.find(e=>{var i,s;return e.id===((s=(i=this.$route.params)==null?void 0:i.view)!=null?s:"files")})},pageHeading(){var e,i;return(i=(e=this.currentView)==null?void 0:e.name)!=null?i:a("files","Files")},dir(){var e,i,s;return(((s=(i=(e=this.$route)==null?void 0:e.query)==null?void 0:i.dir)==null?void 0:s.toString())||"/").replace(/^(.+)\/$/,"$1")},fileId(){var e,i;const s=Number.parseInt((i=(e=this.$route)==null?void 0:e.params.fileid)!=null?i:"");return Number.isNaN(s)?null:s},currentFolder(){var e;if(!((e=this.currentView)!=null&&e.id))return;if(this.dir==="/")return this.filesStore.getRoot(this.currentView.id);const i=this.pathsStore.getPath(this.currentView.id,this.dir);if(i!==void 0)return this.filesStore.getNode(i)},sortingParameters(){const e=[...this.userConfig.sort_favorites_first?[s=>{var r;return((r=s.attributes)==null?void 0:r.favorite)!==1}]:[],...this.userConfig.sort_folders_first?[s=>s.type!=="folder"]:[],...this.sortingMode!=="basename"?[s=>s[this.sortingMode]]:[],s=>{var r;return((r=s.attributes)==null?void 0:r.displayName)||s.basename},s=>s.basename],i=[...this.userConfig.sort_favorites_first?["asc"]:[],...this.userConfig.sort_folders_first?["asc"]:[],...this.sortingMode==="mtime"?[this.isAscSorting?"desc":"asc"]:[],...this.sortingMode!=="mtime"&&this.sortingMode!=="basename"?[this.isAscSorting?"asc":"desc"]:[],this.isAscSorting?"asc":"desc",this.isAscSorting?"asc":"desc"];return[e,i]},dirContentsSorted(){var e;if(!this.currentView)return[];let i=[...this.dirContents];this.filterText&&(i=i.filter(r=>r.basename.toLowerCase().includes(this.filterText.toLowerCase())),console.debug("Files view filtered",i));const s=(((e=this.currentView)==null?void 0:e.columns)||[]).find(r=>r.id===this.sortingMode);if(s!=null&&s.sort&&typeof s.sort=="function"){const r=[...this.dirContents].sort(s.sort);return this.isAscSorting?r:r.reverse()}return Ei(i,...this.sortingParameters)},dirContents(){var e,i;const s=(e=this.userConfigStore)==null?void 0:e.userConfig.show_hidden;return(((i=this.currentFolder)==null?void 0:i._children)||[]).map(this.getNode).filter(r=>{var n;return s?!!r:r&&((n=r==null?void 0:r.attributes)==null?void 0:n.hidden)!==!0&&!(r!=null&&r.basename.startsWith("."))})},isEmptyDir(){return this.dirContents.length===0},isRefreshing(){return this.currentFolder!==void 0&&!this.isEmptyDir&&this.loading},toPreviousDir(){const e=this.dir.split("/").slice(0,-1).join("/")||"/";return{...this.$route,query:{dir:e}}},shareAttributes(){var e,i,s,r;if((i=(e=this.currentFolder)==null?void 0:e.attributes)!=null&&i["share-types"])return Object.values(((r=(s=this.currentFolder)==null?void 0:s.attributes)==null?void 0:r["share-types"])||{}).flat()},shareButtonLabel(){return this.shareAttributes?this.shareButtonType===k.SHARE_TYPE_LINK?a("files","Shared by link"):a("files","Shared"):a("files","Share")},shareButtonType(){return this.shareAttributes?this.shareAttributes.some(e=>e===k.SHARE_TYPE_LINK)?k.SHARE_TYPE_LINK:k.SHARE_TYPE_USER:null},gridViewButtonLabel(){return this.userConfig.grid_view?a("files","Switch to list view"):a("files","Switch to grid view")},canUpload(){return this.currentFolder&&(this.currentFolder.permissions&L.CREATE)!==0},isQuotaExceeded(){var e,i;return((i=(e=this.currentFolder)==null?void 0:e.attributes)==null?void 0:i["quota-available-bytes"])===0},cantUploadLabel(){return this.isQuotaExceeded?a("files","Your have used your space quota and cannot upload files anymore"):a("files","You don’t have permission to upload or create files here")},canShare(){return xr&&this.currentFolder&&(this.currentFolder.permissions&L.SHARE)!==0}},watch:{currentView(e,i){(e==null?void 0:e.id)!==(i==null?void 0:i.id)&&(c.debug("View changed",{newView:e,oldView:i}),this.selectionStore.reset(),this.resetSearch(),this.fetchContent())},dir(e,i){var s;c.debug("Directory changed",{newDir:e,oldDir:i}),this.selectionStore.reset(),this.resetSearch(),this.fetchContent();const r=(s=this.$refs)==null?void 0:s.filesListVirtual;r!=null&&r.$el&&(r.$el.scrollTop=0)},dirContents(e){c.debug("Directory contents changed",{view:this.currentView,folder:this.currentFolder,contents:e}),T("files:list:updated",{view:this.currentView,folder:this.currentFolder,contents:e})}},mounted(){this.fetchContent(),b("files:node:deleted",this.onNodeDeleted),b("files:node:updated",this.onUpdatedNode),b("nextcloud:unified-search.search",this.onSearch),b("nextcloud:unified-search.reset",this.onSearch),this.unsubscribeStoreCallback=this.userConfigStore.$subscribe(()=>this.fetchContent(),{deep:!0})},unmounted(){H("files:node:deleted",this.onNodeDeleted),H("files:node:updated",this.onUpdatedNode),H("nextcloud:unified-search.search",this.onSearch),H("nextcloud:unified-search.reset",this.onSearch),this.unsubscribeStoreCallback()},methods:{t:a,async fetchContent(){this.loading=!0;const e=this.dir,i=this.currentView;if(!i){c.debug("The current view doesn't exists or is not ready.",{currentView:i});return}this.promise&&"cancel"in this.promise&&(this.promise.cancel(),c.debug("Cancelled previous ongoing fetch")),this.promise=i.getContents(e);try{const{folder:s,contents:r}=await this.promise;c.debug("Fetched contents",{dir:e,folder:s,contents:r}),this.filesStore.updateNodes(r),this.$set(s,"_children",r.map(n=>n.source)),e==="/"?this.filesStore.setRoot({service:i.id,root:s}):s.fileid?(this.filesStore.updateNodes([s]),this.pathsStore.addPath({service:i.id,source:s.source,path:e})):c.fatal("Invalid root folder returned",{dir:e,folder:s,currentView:i}),r.filter(n=>n.type==="folder").forEach(n=>{this.pathsStore.addPath({service:i.id,source:n.source,path:V.join(e,n.basename)})})}catch(s){c.error("Error while fetching content",{error:s})}finally{this.loading=!1}},getNode(e){return this.filesStore.getNode(e)},onNodeDeleted(e){var i,s,r;e.fileid&&e.fileid===this.fileId&&(e.fileid===((i=this.currentFolder)==null?void 0:i.fileid)?window.OCP.Files.Router.goToRoute(null,{view:this.$route.params.view},{dir:(r=(s=this.currentFolder)==null?void 0:s.dirname)!=null?r:"/"}):window.OCP.Files.Router.goToRoute(null,{...this.$route.params,fileid:void 0},{...this.$route.query,openfile:void 0}))},onUpload(e){var i;V.dirname(e.source)===((i=this.currentFolder)==null?void 0:i.source)&&this.fetchContent()},async onUploadFail(e){var i,s,r,n;const o=((i=e.response)==null?void 0:i.status)||0;if(o===507){p(a("files","Not enough free space"));return}else if(o===404||o===409){p(a("files","Target folder does not exist any more"));return}else if(o===403){p(a("files","Operation is blocked by access control"));return}if(typeof((s=e.response)==null?void 0:s.data)=="string")try{const l=(n=(r=new DOMParser().parseFromString(e.response.data,"text/xml").getElementsByTagName("s:message")[0])==null?void 0:r.textContent)!=null?n:"";if(l.trim()!==""){p(a("files","Error during upload: {message}",{message:l}));return}}catch(l){c.error("Could not parse message",{error:l})}if(o!==0){p(a("files","Error during upload, status code {status}",{status:o}));return}p(a("files","Unknown error during upload"))},onUpdatedNode(e){var i;(e==null?void 0:e.fileid)===((i=this.currentFolder)==null?void 0:i.fileid)&&this.fetchContent()},resetSearch(){this.filterText=""},openSharingSidebar(){var e,i,s;if(!this.currentFolder){c.debug("No current folder found for opening sharing sidebar");return}(s=(i=(e=window==null?void 0:window.OCA)==null?void 0:e.Files)==null?void 0:i.Sidebar)!=null&&s.setActiveTab&&window.OCA.Files.Sidebar.setActiveTab("sharing"),q.exec(this.currentFolder,this.currentView,this.currentFolder.path)},toggleGridView(){this.userConfigStore.update("grid_view",!this.userConfig.grid_view)}}});var Ar=function(){var s,r;var e=this,i=e._self._c;return e._self._setupProxy,i("NcAppContent",{attrs:{"page-heading":e.pageHeading,"data-cy-files-content":""}},[i("div",{staticClass:"files-list__header"},[i("BreadCrumbs",{attrs:{path:e.dir},on:{reload:e.fetchContent},scopedSlots:e._u([{key:"actions",fn:function(){return[e.canShare&&e.filesListWidth>=512?i("NcButton",{staticClass:"files-list__header-share-button",class:{"files-list__header-share-button--shared":e.shareButtonType},attrs:{"aria-label":e.shareButtonLabel,title:e.shareButtonLabel,type:"tertiary"},on:{click:e.openSharingSidebar},scopedSlots:e._u([{key:"icon",fn:function(){return[e.shareButtonType===e.Type.SHARE_TYPE_LINK?i("LinkIcon"):i("AccountPlusIcon",{attrs:{size:20}})]},proxy:!0}],null,!1,2969853559)}):e._e(),!e.canUpload||e.isQuotaExceeded?i("NcButton",{staticClass:"files-list__header-upload-button--disabled",attrs:{"aria-label":e.cantUploadLabel,title:e.cantUploadLabel,disabled:!0,type:"secondary"},scopedSlots:e._u([{key:"icon",fn:function(){return[i("PlusIcon",{attrs:{size:20}})]},proxy:!0}],null,!1,2953566425)},[e._v(" "+e._s(e.t("files","New"))+" ")]):e.currentFolder?i("UploadPicker",{staticClass:"files-list__header-upload-button",attrs:{content:e.dirContents,destination:e.currentFolder,multiple:!0},on:{failed:e.onUploadFail,uploaded:e.onUpload}}):e._e()]},proxy:!0}])}),e.filesListWidth>=512&&e.enableGridView?i("NcButton",{staticClass:"files-list__header-grid-button",attrs:{"aria-label":e.gridViewButtonLabel,title:e.gridViewButtonLabel,type:"tertiary"},on:{click:e.toggleGridView},scopedSlots:e._u([{key:"icon",fn:function(){return[e.userConfig.grid_view?i("ListViewIcon"):i("ViewGridIcon")]},proxy:!0}],null,!1,1682960703)}):e._e(),e.isRefreshing?i("NcLoadingIcon",{staticClass:"files-list__refresh-icon"}):e._e()],1),!e.loading&&e.canUpload?i("DragAndDropNotice",{attrs:{"current-folder":e.currentFolder}}):e._e(),e.loading&&!e.isRefreshing?i("NcLoadingIcon",{staticClass:"files-list__loading-icon",attrs:{size:38,name:e.t("files","Loading current folder")}}):!e.loading&&e.isEmptyDir?i("NcEmptyContent",{attrs:{name:((s=e.currentView)==null?void 0:s.emptyTitle)||e.t("files","No files in here"),description:((r=e.currentView)==null?void 0:r.emptyCaption)||e.t("files","Upload some content or sync with your devices!"),"data-cy-files-content-empty":""},scopedSlots:e._u([e.dir!=="/"?{key:"action",fn:function(){return[e.currentFolder&&e.canUpload&&!e.isQuotaExceeded?i("UploadPicker",{staticClass:"files-list__header-upload-button",attrs:{content:e.dirContents,destination:e.currentFolder,multiple:""},on:{failed:e.onUploadFail,uploaded:e.onUpload}}):i("NcButton",{attrs:{"aria-label":e.t("files","Go to the previous folder"),to:e.toPreviousDir,type:"primary"}},[e._v(" "+e._s(e.t("files","Go back"))+" ")])]},proxy:!0}:null,{key:"icon",fn:function(){return[i("NcIconSvgWrapper",{attrs:{svg:e.currentView.icon}})]},proxy:!0}],null,!0)}):i("FilesListVirtual",{ref:"filesListVirtual",attrs:{"current-folder":e.currentFolder,"current-view":e.currentView,nodes:e.dirContentsSorted}})],1)},kr=[],Ir=m(Fr,Ar,kr,!1,null,"69a01187");const Dr=Ir.exports,Lr=y({name:"FilesApp",components:{NcContent:At,FilesList:Dr,Navigation:Li}});var Er=function(){var e=this,i=e._self._c;return e._self._setupProxy,i("NcContent",{attrs:{"app-name":"files"}},[i("Navigation"),i("FilesList")],1)},Tr=[],Vr=m(Lr,Er,Tr,!1,null,null);const Mr=Vr.exports;var Fe,Ae;window.OCA.Files=(Fe=window.OCA.Files)!=null?Fe:{},window.OCP.Files=(Ae=window.OCP.Files)!=null?Ae:{};const Pr=new ai(ze);Object.assign(window.OCP.Files,{Router:Pr}),h.use(it);const $r=h.observable(Le());h.prototype.$navigation=$r;const Or=new ci;Object.assign(window.OCA.Files,{Settings:Or}),Object.assign(window.OCA.Files.Settings,{Setting:li});const Rr=h.extend(Mr);new Rr({router:ze,pinia:Mt}).$mount("#content");
