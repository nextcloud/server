/*! third party licenses: dist/vendor.LICENSE.txt */
import{bS as n,b$ as E,bR as u,bZ as d,aV as w,bW as f,c1 as b,b_ as y}from"./core-common.mjs";import{e as C,F as p,D as _,k as h,P as c,n as N,V as R,q as m,r as l}from"./chunks/index-DG15V7L3.mjs";import{ag as T,ah as O,ai as I}from"./chunks/icons-TElqpmA8.mjs";import"./chunks/index-PaKKd09k.mjs";import{z as U,B as M,_ as D}from"./chunks/_plugin-vue2_normalizer-VrK6B12S-BQkexw0P.mjs";import"./chunks/index-CiG5J8j_.mjs";import"./chunks/index-CPb3EwrS.mjs";import"./chunks/index-tn-fAC9x.mjs";var r=(e=>(e[e.SUCCESS=0]="SUCCESS",e[e.ERROR=1]="ERROR",e[e.INDETERMINATE=2]="INDETERMINATE",e[e.INCOMPLETE_CONF=3]="INCOMPLETE_CONF",e[e.UNAUTHORIZED=4]="UNAUTHORIZED",e[e.TIMEOUT=5]="TIMEOUT",e[e.NETWORK_ERROR=6]="NETWORK_ERROR",e))(r||{});const v=function(e){return!e.status||e.status===0?!1:e.userProvided||e.authMechanism==="password::global::user"},S=function(e){if(e.type===C.File)return!1;const t=e.attributes;return!t.scope||!t.backend?!1:t.scope==="personal"||t.scope==="system"},A=new p({id:"credentials-external-storage",displayName:()=>n("files","Enter missing credentials"),iconSvgInline:()=>T,enabled:e=>{var t;if(e.length!==1)return!1;const s=e[0];if(!S(s))return!1;const a=((t=s.attributes)==null?void 0:t.config)||{};return!!v(a)},async exec(e){const t=await fetch(E("/apps/files_external/api/v1/auth"),{headers:new Headers({Accept:"application/json"}),credentials:"include"}),s=await(t==null?void 0:t.json())||{};if(s.ocs.data.user&&s.ocs.data.password){const a=(await u.put(d("apps/files_external/userglobalstorages/{id}",e.attributes),{backendOptions:s.ocs.data})).data;if(a.status!==r.SUCCESS)return U(n("files_external","Unable to update this external storage config. {statusMessage}",{statusMessage:(a==null?void 0:a.statusMessage)||""})),null;M(n("files_external","New configuration successfully saved")),w.set(e.attributes,"config",a)}return null},order:-1e3,default:_.DEFAULT,inline:()=>!0});var x;const i="/files/".concat((x=f())==null?void 0:x.uid),k=e=>{var t;const s=(e.path+"/"+e.name).replace(/^\//gm,"");return new h({id:e.id,source:b("dav"+i+"/"+s),root:i,owner:((t=f())==null?void 0:t.uid)||null,permissions:e.config.status!==r.SUCCESS?c.NONE:(e==null?void 0:e.permissions)||c.READ,attributes:{displayName:s,...e}})},F=async()=>{var e;const t=(await u.get(E("apps/files_external/api/v1/mounts"))).data.ocs.data.map(k);return{folder:new h({id:0,source:b("dav"+i),root:i,owner:((e=f())==null?void 0:e.uid)||null,permissions:c.READ}),contents:t}},P=function(e,t=!0){const s=t?"userglobalstorages":"userstorages";return u.get(d("apps/files_external/".concat(s,"/").concat(e,"?testOnly=false")))},L=new p({id:"check-external-storage",displayName:()=>"",iconSvgInline:()=>"",enabled:e=>e.every(t=>S(t)===!0),exec:async()=>null,async renderInline(e){let t=null;try{if(t=(await P(e.attributes.id,e.attributes.scope==="system")).data,w.set(e.attributes,"config",t),t.status!==r.SUCCESS)throw new Error((t==null?void 0:t.statusMessage)||n("files_external","There was an error with this external storage."));return null}catch(s){if(s.response&&!t)return D(n("files_external","We were unable to check the external storage {basename}",{basename:e.basename})),null;const a=v(t),g=document.createElement("span");g.classList.add("files-list__row-status--".concat(a?"warning":"error"));const o=document.createElement("span");return o.className="files-list__row-status",a||(o.innerHTML=O,o.title=s.message),o.prepend(g),o}},order:10}),H=new p({id:"open-in-files-external-storage",displayName:e=>{var t,s;return(((s=(t=e==null?void 0:e[0])==null?void 0:t.attributes)==null?void 0:s.config)||{status:r.INDETERMINATE}).status!==r.SUCCESS?n("files_external","Examine this faulty external storage configuration"):n("files","Open in Files")},iconSvgInline:()=>"",enabled:(e,t)=>t.id==="extstoragemounts",async exec(e){const t=e.attributes.config;return(t==null?void 0:t.status)!==r.SUCCESS?(window.OC.dialogs.confirm(n("files_external","There was an error with this external storage. Do you want to review this mount point config in the settings page?"),n("files_external","External mount error"),s=>{if(s===!0){const a=e.attributes.scope==="personal"?"user":"admin";window.location.href=d("/settings/".concat(a,"/externalstorages"))}}),null):(window.OCP.Files.Router.goToRoute(null,{view:"files"},{dir:e.path}),null)},order:-1e3,default:_.HIDDEN}),W=y("files_external","allowUserMounting",!1),Z=N();Z.register(new R({id:"extstoragemounts",name:n("files_external","External storage"),caption:n("files_external","List of external storage."),emptyCaption:W?n("files_external","There is no external storage configured. You can configure them in your Personal settings."):n("files_external","There is no external storage configured and you don't have the permission to configure them."),emptyTitle:n("files_external","No external storage"),icon:I,order:30,columns:[new m({id:"storage-type",title:n("files_external","Storage type"),render(e){var t;const s=((t=e.attributes)==null?void 0:t.backend)||n("files_external","Unknown"),a=document.createElement("span");return a.textContent=s,a}}),new m({id:"scope",title:n("files_external","Scope"),render(e){var t;const s=document.createElement("span");let a=n("files_external","Personal");return((t=e.attributes)==null?void 0:t.scope)==="system"&&(a=n("files_external","System")),s.textContent=a,s}})],getContents:F})),l(A),l(L),l(H);
