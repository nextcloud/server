/*! third party licenses: dist/vendor.LICENSE.txt */
import{g as w}from"./chunks/index-CiG5J8j_.mjs";import{a0 as q,b_ as c,bR as u,b$ as b,b as k,v as x,X as $,Z as C,al as I,cg as L,c0 as N,bQ as l,aV as v,bS as R,c5 as F}from"./core-common.mjs";import{d as U}from"./chunks/index-DCgLaXhm.mjs";import"./chunks/index-PaKKd09k.mjs";import{z as D}from"./chunks/_plugin-vue2_normalizer-VrK6B12S-BQkexw0P.mjs";import{n as h,af as P}from"./chunks/icons-TElqpmA8.mjs";const E={name:"LegacySearchResult",components:{NcHighlight:q},props:{thumbnailUrl:{type:String,default:null},title:{type:String,required:!0},subline:{type:String,default:null},resourceUrl:{type:String,default:null},icon:{type:String,default:""},rounded:{type:Boolean,default:!1},query:{type:String,default:""},focused:{type:Boolean,default:!1}},data(){return{hasValidThumbnail:this.thumbnailUrl&&this.thumbnailUrl.trim()!=="",loaded:!1}},computed:{isIconUrl(){if(this.icon.startsWith("/"))return!0;try{new URL(this.icon)}catch{return!1}return!0}},watch:{thumbnailUrl(){this.hasValidThumbnail=this.thumbnailUrl&&this.thumbnailUrl.trim()!=="",this.loaded=!1}},methods:{reEmitEvent(e){this.$emit(e.type,e)},onError(){this.hasValidThumbnail=!1},onLoad(){this.loaded=!0}}};var M=function(){var e=this,s=e._self._c;return s("a",{staticClass:"unified-search__result",class:{"unified-search__result--focused":e.focused},attrs:{href:e.resourceUrl||"#"},on:{click:e.reEmitEvent,focus:e.reEmitEvent}},[s("div",{staticClass:"unified-search__result-icon",class:{"unified-search__result-icon--rounded":e.rounded,"unified-search__result-icon--no-preview":!e.hasValidThumbnail&&!e.loaded,"unified-search__result-icon--with-thumbnail":e.hasValidThumbnail&&e.loaded,[e.icon]:!e.loaded&&!e.isIconUrl},style:{backgroundImage:e.isIconUrl?"url(".concat(e.icon,")"):""}},[e.hasValidThumbnail?s("img",{directives:[{name:"show",rawName:"v-show",value:e.loaded,expression:"loaded"}],attrs:{src:e.thumbnailUrl,alt:""},on:{error:e.onError,load:e.onLoad}}):e._e()]),s("span",{staticClass:"unified-search__result-content"},[s("span",{staticClass:"unified-search__result-line-one",attrs:{title:e.title}},[s("NcHighlight",{attrs:{text:e.title,search:e.query}})],1),e.subline?s("span",{staticClass:"unified-search__result-line-two",attrs:{title:e.subline}},[e._v(e._s(e.subline))]):e._e()])])},A=[],T=h(E,M,A,!1,null,"2fd0fd33");const Q=T.exports,V={name:"SearchResultPlaceholders",data(){return{light:null,dark:null}},mounted(){const e=getComputedStyle(document.documentElement);this.dark=e.getPropertyValue("--color-placeholder-dark"),this.light=e.getPropertyValue("--color-placeholder-light")},methods:{randWidth(){return Math.floor(Math.random()*20)+30}}};var O=function(){var e=this,s=e._self._c;return s("ul",[s("svg",{staticClass:"unified-search__result-placeholder-gradient"},[s("defs",[s("linearGradient",{attrs:{id:"unified-search__result-placeholder-gradient"}},[s("stop",{attrs:{offset:"0%","stop-color":e.light}},[s("animate",{attrs:{attributeName:"stop-color",values:"".concat(e.light,"; ").concat(e.light,"; ").concat(e.dark,"; ").concat(e.dark,"; ").concat(e.light),dur:"2s",repeatCount:"indefinite"}})]),s("stop",{attrs:{offset:"100%","stop-color":e.dark}},[s("animate",{attrs:{attributeName:"stop-color",values:"".concat(e.dark,"; ").concat(e.light,"; ").concat(e.light,"; ").concat(e.dark,"; ").concat(e.dark),dur:"2s",repeatCount:"indefinite"}})])],1)],1)]),e._l([1,2,3],function(i){return s("li",{key:i},[s("svg",{staticClass:"unified-search__result-placeholder",attrs:{xmlns:"http://www.w3.org/2000/svg",fill:"url(#unified-search__result-placeholder-gradient)"}},[s("rect",{staticClass:"unified-search__result-placeholder-icon"}),s("rect",{staticClass:"unified-search__result-placeholder-line-one"}),s("rect",{staticClass:"unified-search__result-placeholder-line-two",style:{width:"calc(".concat(e.randWidth(),"%)")}})])])})],2)},j=[],z=h(V,O,j,!1,null,"bdadf4ed");const B=z.exports,H=c("unified-search","limit-default"),d=c("unified-search","min-search-length",1),f=c("unified-search","live-search",!0),p=/(^|\s)in:([a-z_-]+)/ig,y=/(^|\s)-in:([a-z_-]+)/ig,K=()=>u.CancelToken.source();async function g(){try{const{data:e}=await u.get(b("search/providers"),{params:{from:window.location.pathname.replace("/index.php","")+window.location.search}});if("ocs"in e&&"data"in e.ocs&&Array.isArray(e.ocs.data)&&e.ocs.data.length>0)return e.ocs.data}catch(e){console.error(e)}return[]}function m({type:e,query:s,cursor:i}){const r=K();return{request:async()=>u.get(b("search/providers/{type}/search",{type:e}),{cancelToken:r.token,params:{term:s,cursor:i,from:window.location.pathname.replace("/index.php","")+window.location.search}}),cancel:r.cancel}}const W=0,G=1,_=2,X={name:"LegacyUnifiedSearch",components:{Magnify:P,NcActionButton:k,NcActions:x,NcEmptyContent:$,NcHeaderMenu:C,SearchResult:Q,SearchResultPlaceholders:B,NcTextField:I},data(){return{types:[],cursors:{},limits:{},loading:{},reached:{},requests:[],results:{},query:"",focused:null,triggered:!1,defaultLimit:H,minSearchLength:d,enableLiveSearch:f,open:!1}},computed:{typesIDs(){return this.types.map(e=>e.id)},typesNames(){return this.types.map(e=>e.name)},typesMap(){return this.types.reduce((e,s)=>(e[s.id]=s.name,e),{})},ariaLabel(){return t("core","Search")},hasResults(){return Object.keys(this.results).length!==0},orderedResults(){return this.typesIDs.filter(e=>e in this.results).map(e=>({type:e,list:this.results[e]}))},availableFilters(){return Object.keys(this.results)},usedFiltersIn(){let e;const s=[];for(;(e=p.exec(this.query))!==null;)s.push(e[2]);return s},usedFiltersNot(){let e;const s=[];for(;(e=y.exec(this.query))!==null;)s.push(e[2]);return s},validQueryTitle(){return this.triggered?t("core","No results for {query}",{query:this.query}):t("core","Press Enter to start searching")},shortQueryDescription(){return this.isShortQuery?n("core","Please enter {minSearchLength} character or more to search","Please enter {minSearchLength} characters  or more to search",this.minSearchLength,{minSearchLength:this.minSearchLength}):""},isShortQuery(){return this.query&&this.query.trim().length<d},isValidQuery(){return this.query&&this.query.trim()!==""&&!this.isShortQuery},isDoneSearching(){return Object.values(this.reached).every(e=>e===!1)},isLoading(){return Object.values(this.loading).some(e=>e===!0)}},async created(){this.types=await g(),this.logger.debug("Unified Search initialized with the following providers",this.types)},beforeDestroy(){L("files:navigation:changed",this.onNavigationChange)},mounted(){N("files:navigation:changed",this.onNavigationChange),!OCP.Accessibility.disableKeyboardShortcuts()&&document.addEventListener("keydown",e=>{e.ctrlKey&&e.code==="KeyF"&&!this.open?(e.preventDefault(),this.open=!0):e.ctrlKey&&e.key==="f"&&this.open&&(this.open=!1),this.open&&(e.key==="ArrowDown"&&this.focusNext(e),e.key==="ArrowUp"&&this.focusPrev(e))})},methods:{async onOpen(){this.types=await g()},onClose(){l("nextcloud:unified-search.close")},onNavigationChange(){var e,s,i,r;(r=(i=(s=(e=this.$el)==null?void 0:e.querySelector)==null?void 0:s.call(e,'form[role="search"]'))==null?void 0:i.reset)==null||r.call(i)},onReset(){l("nextcloud:unified-search.reset"),this.logger.debug("Search reset"),this.query="",this.resetState(),this.focusInput()},async resetState(){this.cursors={},this.limits={},this.reached={},this.results={},this.focused=null,this.triggered=!1,await this.cancelPendingRequests()},async cancelPendingRequests(){const e=this.requests.slice(0);this.requests=[],await Promise.all(e.map(s=>s()))},focusInput(){this.$nextTick(()=>{this.$refs.input.focus(),this.$refs.input.select()})},onInputEnter(){if(this.hasResults){this.getResultsList()[0].click();return}this.onInput()},async onInput(){if(l("nextcloud:unified-search.search",{query:this.query}),this.query.trim()===""||this.isShortQuery){for(const i of this.typesIDs)this.$delete(this.results,i);return}let e=this.typesIDs,s=this.query;if(this.usedFiltersNot.length>0&&(e=this.typesIDs.filter(i=>this.usedFiltersNot.indexOf(i)===-1)),this.usedFiltersIn.length>0&&(e=this.typesIDs.filter(i=>this.usedFiltersIn.indexOf(i)>-1)),s=s.replace(p,"").replace(y,""),await this.resetState(),this.triggered=!0,!e.length){this.logger.error("No types to search in");return}this.$set(this.loading,"all",!0),this.logger.debug("Searching ".concat(s," in"),e),Promise.all(e.map(async i=>{try{const{request:r,cancel:o}=m({type:i,query:s});this.requests.push(o);const{data:a}=await r();return a.ocs.data.entries.length>0?this.$set(this.results,i,a.ocs.data.entries):this.$delete(this.results,i),a.ocs.data.cursor?this.$set(this.cursors,i,a.ocs.data.cursor):a.ocs.data.isPaginated||this.$set(this.limits,i,this.defaultLimit),a.ocs.data.entries.length<this.defaultLimit&&this.$set(this.reached,i,!0),this.focused===null&&(this.focused=0),G}catch(r){return this.$delete(this.results,i),r.response&&r.response.status?(this.logger.error("Error searching for ".concat(this.typesMap[i]),r),D(this.t("core","An error occurred while searching for {type}",{type:this.typesMap[i]})),W):_}})).then(i=>{i.some(r=>r===_)||(this.loading={})})},onInputDebounced:f?U(function(e){this.onInput(e)},500):function(){this.triggered=!1},async loadMore(e){if(!this.loading[e]){if(this.cursors[e]){const{request:s,cancel:i}=m({type:e,query:this.query,cursor:this.cursors[e]});this.requests.push(i);const{data:r}=await s();r.ocs.data.cursor&&this.$set(this.cursors,e,r.ocs.data.cursor),r.ocs.data.entries.length>0&&this.results[e].push(...r.ocs.data.entries),r.ocs.data.entries.length<this.defaultLimit&&this.$set(this.reached,e,!0)}else this.limits[e]&&this.limits[e]>=0&&(this.limits[e]+=this.defaultLimit,this.limits[e]>=this.results[e].length&&this.$set(this.reached,e,!0));this.focused!==null&&this.$nextTick(()=>{this.focusIndex(this.focused)})}},limitIfAny(e,s){return s in this.limits?e.slice(0,this.limits[s]):e},getResultsList(){return this.$el.querySelectorAll(".unified-search__results .unified-search__result")},focusFirst(e){const s=this.getResultsList();s&&s.length>0&&(e&&e.preventDefault(),this.focused=0,this.focusIndex(this.focused))},focusNext(e){if(this.focused===null){this.focusFirst(e);return}const s=this.getResultsList();s&&s.length>0&&this.focused+1<s.length&&(e.preventDefault(),this.focused++,this.focusIndex(this.focused))},focusPrev(e){if(this.focused===null){this.focusFirst(e);return}const s=this.getResultsList();s&&s.length>0&&this.focused>0&&(e.preventDefault(),this.focused--,this.focusIndex(this.focused))},focusIndex(e){const s=this.getResultsList();s&&s[e]&&s[e].focus()},setFocusedIndex(e){const s=e.target,i=[...this.getResultsList()].findIndex(r=>r===s);i>-1&&(this.focused=i)},onClickFilter(e){this.query="".concat(this.query," ").concat(e).replace(/ {2}/g," ").trim(),this.onInput()}}};var Z=function(){var e=this,s=e._self._c;return s("NcHeaderMenu",{staticClass:"unified-search",attrs:{id:"unified-search","exclude-click-outside-selectors":[".popover"],open:e.open,"aria-label":e.ariaLabel},on:{"update:open":function(i){e.open=i},open:e.onOpen,close:e.onClose},scopedSlots:e._u([{key:"trigger",fn:function(){return[s("Magnify",{staticClass:"unified-search__trigger-icon",attrs:{size:20}})]},proxy:!0}])},[s("div",{staticClass:"unified-search__input-wrapper"},[s("div",{staticClass:"unified-search__input-row"},[s("NcTextField",{ref:"input",staticClass:"unified-search__form-input",class:{"unified-search__form-input--with-reset":!!e.query},attrs:{value:e.query,"trailing-button-icon":"close",label:e.ariaLabel,"trailing-button-label":e.t("core","Reset search"),"show-trailing-button":e.query!=="","aria-describedby":"unified-search-desc",placeholder:e.t("core","Search {types} …",{types:e.typesNames.join(", ")})},on:{"update:value":function(i){e.query=i},"trailing-button-click":e.onReset,input:e.onInputDebounced}}),s("p",{staticClass:"hidden-visually",attrs:{id:"unified-search-desc"}},[e._v(" "+e._s(e.t("core","Search starts once you start typing and results may be reached with the arrow keys"))+" ")]),e.availableFilters.length>1?s("NcActions",{staticClass:"unified-search__filters",attrs:{placement:"bottom-end",container:".unified-search__input-wrapper"}},e._l(e.availableFilters,function(i){return s("NcActionButton",{key:i,attrs:{icon:"icon-filter"},on:{click:function(r){return r.stopPropagation(),e.onClickFilter("in:".concat(i))}}},[e._v(" "+e._s(e.t("core","Search for {name} only",{name:e.typesMap[i]}))+" ")])}),1):e._e()],1)]),e.hasResults?e._l(e.orderedResults,function({list:i,type:r},o){return[s("h2",{key:r,staticClass:"unified-search__results-header"},[e._v(" "+e._s(e.typesMap[r])+" ")]),s("ul",{key:r,staticClass:"unified-search__results",class:"unified-search__results-".concat(r),attrs:{"aria-label":e.typesMap[r]}},[e._l(e.limitIfAny(i,r),function(a,S){return s("li",{key:a.resourceUrl},[s("SearchResult",e._b({attrs:{query:e.query,focused:e.focused===0&&o===0&&S===0},on:{focus:e.setFocusedIndex}},"SearchResult",a,!1))],1)}),s("li",[e.reached[r]?e._e():s("SearchResult",{staticClass:"unified-search__result-more",attrs:{title:e.loading[r]?e.t("core","Loading more results …"):e.t("core","Load more results"),"icon-class":e.loading[r]?"icon-loading-small":""},on:{click:function(a){return a.preventDefault(),a.stopPropagation(),e.loadMore(r)},focus:e.setFocusedIndex}})],1)],2)]}):[e.isLoading?s("SearchResultPlaceholders"):e.isValidQuery?s("NcEmptyContent",{attrs:{title:e.validQueryTitle},scopedSlots:e._u([{key:"icon",fn:function(){return[s("Magnify")]},proxy:!0}],null,!1,931131664)}):!e.isLoading||e.isShortQuery?s("NcEmptyContent",{attrs:{title:e.t("core","Start typing to search"),description:e.shortQueryDescription},scopedSlots:e._u([{key:"icon",fn:function(){return[s("Magnify")]},proxy:!0}],null,!1,931131664)}):e._e()]],2)},J=[],Y=h(X,Z,J,!1,null,"6ceeb0ad");const ee=Y.exports,te=w().setApp("unified-search").detectUser().build();v.mixin({data(){return{logger:te}},methods:{t:R,n:F}});const le=new v({el:"#unified-search",name:"UnifiedSearchRoot",render:e=>e(ee)});export{le as default};
