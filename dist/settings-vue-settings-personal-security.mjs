/*! third party licenses: dist/vendor.LICENSE.txt */
import{bZ as C,b_ as _,bR as p,bS as a,a_ as c,v as b,b as S,k as A,F as k,P,a1 as N,al as g,T as x,bO as O,aV as u}from"./core-common.mjs";import{p as E}from"./chunks/v-tooltip.esm-DFdYkWpQ.mjs";import"./chunks/index-PaKKd09k.mjs";import{z as r}from"./chunks/_plugin-vue2_normalizer-VrK6B12S-BQkexw0P.mjs";import{x as y}from"./chunks/index-CDMqmWCu.mjs";import{d as R,c as L,P as M}from"./chunks/pinia-CcZmjq9w.mjs";import{l as s}from"./chunks/logger-C7fGMvfA.mjs";import{e as m,j as D,E as W,aT as B,A as I,aU as K,aV as $,aW as F,aX as z,aY as G,aZ as Q,a_ as U,n as l,a$ as f}from"./chunks/icons-TElqpmA8.mjs";import{i as X}from"./chunks/vue-qrcode.esm-CarG3uCI.mjs";/* empty css                      */import"./chunks/_overRest-DjFtaWRq.mjs";import"./chunks/_setToArray-V03nfpyh.mjs";import"./chunks/_isIterateeCall-CX-rKv74.mjs";import"./chunks/isPlainObject-CnMaw-ru.mjs";import"./chunks/index-CiG5J8j_.mjs";const d=C("/settings/personal/authtokens"),q=()=>new Promise(e=>{window.OC.dialogs.confirm(a("settings","Do you really want to wipe your data from this device?"),a("settings","Confirm wipe"),e,!0)});var h=(e=>(e[e.TEMPORARY_TOKEN=0]="TEMPORARY_TOKEN",e[e.PERMANENT_TOKEN=1]="PERMANENT_TOKEN",e[e.WIPING_TOKEN=2]="WIPING_TOKEN",e))(h||{});const w=R("auth-token",{state(){return{tokens:_("settings","app_tokens",[])}},actions:{async updateToken(e){const{data:n}=await p.put("".concat(d,"/").concat(e.id),e);return n},async addToken(e){s.debug("Creating a new app token");try{await y();const{data:n}=await p.post(d,{name:e});return this.tokens.push(n.deviceToken),s.debug("App token created"),n}catch{return null}},async deleteToken(e){s.debug("Deleting app token",{token:e}),this.tokens=this.tokens.filter(({id:n})=>n!==e.id);try{return await p.delete("".concat(d,"/").concat(e.id)),s.debug("App token deleted"),!0}catch(n){s.error("Could not delete app token",{error:n}),r(a("settings","Could not delete the app token")),this.tokens.push(e)}return!1},async wipeToken(e){s.debug("Wiping app token",{token:e});try{if(await y(),!await q()){s.debug("Wipe aborted by user");return}return await p.post("".concat(d,"/wipe/").concat(e.id)),s.debug("App token marked for wipe",{token:e}),e.type=2,e.canRename=!1,!0}catch(n){s.error("Could not wipe app token",{error:n}),r(a("settings","Error while wiping the device with the token"))}return!1},async renameToken(e,n){s.debug("renaming app token ".concat(e.id," from ").concat(e.name," to '").concat(n,"'"));const o=e.name;e.name=n;try{return await this.updateToken(e),s.debug("App token name updated"),!0}catch(i){s.error("Could not update app token name",{error:i}),r(a("settings","Error while updating device token name")),e.name=o}return!1},async setTokenScope(e,n,o){s.debug("Updating app token scope",{token:e,scope:n,value:o});const i=e.scope[n];e.scope[n]=o;try{return await this.updateToken(e),s.debug("app token scope updated"),!0}catch(T){s.error("could not update app token scope",{error:T}),r(a("settings","Error while updating device token scope")),e.scope[n]=i}return!1}}}),v={ie:/(?:MSIE|Trident|Trident\/7.0; rv)[ :](\d+)/,edge:/^Mozilla\/5\.0 \([^)]+\) AppleWebKit\/[0-9.]+ \(KHTML, like Gecko\) Chrome\/[0-9.]+ (?:Mobile Safari|Safari)\/[0-9.]+ Edge\/[0-9.]+$/,firefox:/^Mozilla\/5\.0 \([^)]*(Windows|OS X|Linux)[^)]+\) Gecko\/[0-9.]+ Firefox\/(\d+)(?:\.\d)?$/,chrome:/^Mozilla\/5\.0 \([^)]*(Windows|OS X|Linux)[^)]+\) AppleWebKit\/[0-9.]+ \(KHTML, like Gecko\) Chrome\/(\d+)[0-9.]+ (?:Mobile Safari|Safari)\/[0-9.]+$/,safari:/^Mozilla\/5\.0 \([^)]*(Windows|OS X)[^)]+\) AppleWebKit\/[0-9.]+ \(KHTML, like Gecko\)(?: Version\/([0-9]+)[0-9.]+)? Safari\/[0-9.A-Z]+$/,androidChrome:/Android.*(?:; (.*) Build\/).*Chrome\/(\d+)[0-9.]+/,iphone:/ *CPU +iPhone +OS +([0-9]+)_(?:[0-9_])+ +like +Mac +OS +X */,ipad:/\(iPad; *CPU +OS +([0-9]+)_(?:[0-9_])+ +like +Mac +OS +X */,iosClient:/^Mozilla\/5\.0 \(iOS\) (?:ownCloud|Nextcloud)-iOS.*$/,androidClient:/^Mozilla\/5\.0 \(Android\) (?:ownCloud|Nextcloud)-android.*$/,iosTalkClient:/^Mozilla\/5\.0 \(iOS\) Nextcloud-Talk.*$/,androidTalkClient:/^Mozilla\/5\.0 \(Android\) Nextcloud-Talk.*$/,davx5:/DAV(?:droid|x5)\/([^ ]+)/,webPirate:/(Sailfish).*WebPirate\/(\d+)/,sailfishBrowser:/(Sailfish).*SailfishBrowser\/(\d+)/,neon:/Neon \d+\.\d+\.\d+\+\d+/},V={edge:"Microsoft Edge",firefox:"Firefox",chrome:"Google Chrome",safari:"Safari",androidChrome:a("settings","Google Chrome for Android"),iphone:"iPhone",ipad:"iPad",iosClient:a("settings","{productName} iOS app",{productName:window.oc_defaults.productName}),androidClient:a("settings","{productName} Android app",{productName:window.oc_defaults.productName}),iosTalkClient:a("settings","{productName} Talk for iOS",{productName:window.oc_defaults.productName}),androidTalkClient:a("settings","{productName} Talk for Android",{productName:window.oc_defaults.productName}),syncClient:a("settings","Sync client"),davx5:"DAVx5",webPirate:"WebPirate",sailfishBrowser:"SailfishBrowser",neon:"Neon"},H=c({name:"AuthToken",components:{NcActions:b,NcActionButton:S,NcActionCheckbox:A,NcButton:k,NcDateTime:P,NcIconSvgWrapper:N,NcTextField:g},props:{token:{type:Object,required:!0}},setup(){return{authTokenStore:w()}},data(){return{actionOpen:!1,renaming:!1,newName:"",oldName:"",mdiCheck:m}},computed:{canChangeScope(){return this.token.type===h.PERMANENT_TOKEN},client(){var e;const n=this.token.name.match(/Mozilla\/5\.0 \((\w+)\) (?:mirall|csyncoC)\/(\d+\.\d+\.\d+)/);if(n)return{id:"syncClient",os:n[1],version:n[2]};for(const o in v){const i=this.token.name.match(v[o]);if(i)return{id:o,os:i[2]&&i[1],version:(e=i[2])!=null?e:i[1]}}return null},tokenLastActivity(){return this.token.lastActivity*1e3},tokenIcon(){var e;if(this.token.type===h.PERMANENT_TOKEN)return D;switch((e=this.client)==null?void 0:e.id){case"edge":return U;case"firefox":return Q;case"chrome":return G;case"safari":return z;case"androidChrome":case"androidClient":case"androidTalkClient":return F;case"iphone":case"iosClient":case"iosTalkClient":return $;case"ipad":return K;case"davx5":return I;case"syncClient":return B;case"webPirate":case"sailfishBrowser":default:return W}},tokenLabel(){if(this.token.current)return a("settings","This session");if(this.client===null)return this.token.name;const e=V[this.client.id];return this.client.os?a("settings","{client} - {version} ({system})",{client:e,system:this.client.os,version:this.client.version}):this.client.version?a("settings","{client} - {version}",{client:e,version:this.client.version}):e},wiping(){return this.token.type===h.WIPING_TOKEN}},methods:{t:a,updateFileSystemScope(e){this.authTokenStore.setTokenScope(this.token,"filesystem",e)},startRename(){this.actionOpen=!1,this.oldName=this.token.name,this.newName=this.token.name,this.renaming=!0,this.$nextTick(()=>{this.$refs.input.select()})},cancelRename(){this.renaming=!1},revoke(){this.actionOpen=!1,this.authTokenStore.deleteToken(this.token)},rename(){this.renaming=!1,this.authTokenStore.renameToken(this.token,this.newName)},wipe(){this.actionOpen=!1,this.authTokenStore.wipeToken(this.token)}}});var j=function(){var e=this,n=e._self._c;return e._self._setupProxy,n("tr",{class:["auth-token",{"auth-token--wiping":e.wiping}],attrs:{"data-id":e.token.id}},[n("td",{staticClass:"auth-token__name"},[n("NcIconSvgWrapper",{attrs:{path:e.tokenIcon}}),n("div",{staticClass:"auth-token__name-wrapper"},[e.token.canRename&&e.renaming?n("form",{staticClass:"auth-token__name-form",on:{submit:function(o){return o.preventDefault(),o.stopPropagation(),e.rename.apply(null,arguments)}}},[n("NcTextField",{ref:"input",attrs:{value:e.newName,label:e.t("settings","Device name"),"show-trailing-button":!0,"trailing-button-label":e.t("settings","Cancel renaming")},on:{"update:value":function(o){e.newName=o},"trailing-button-click":e.cancelRename,keyup:function(o){return!o.type.indexOf("key")&&e._k(o.keyCode,"esc",27,o.key,["Esc","Escape"])?null:e.cancelRename.apply(null,arguments)}}}),n("NcButton",{attrs:{"aria-label":e.t("settings","Save new name"),type:"tertiary","native-type":"submit"},scopedSlots:e._u([{key:"icon",fn:function(){return[n("NcIconSvgWrapper",{attrs:{path:e.mdiCheck}})]},proxy:!0}],null,!1,1018299955)})],1):n("span",[e._v(e._s(e.tokenLabel))]),e.wiping?n("span",{staticClass:"wiping-warning"},[e._v("("+e._s(e.t("settings","Marked for remote wipe"))+")")]):e._e()])],1),n("td",[n("NcDateTime",{staticClass:"auth-token__last-activity",attrs:{"ignore-seconds":!0,timestamp:e.tokenLastActivity}})],1),n("td",{staticClass:"auth-token__actions"},[e.token.current?e._e():n("NcActions",{attrs:{title:e.t("settings","Device settings"),"aria-label":e.t("settings","Device settings"),open:e.actionOpen},on:{"update:open":function(o){e.actionOpen=o}}},[e.canChangeScope?n("NcActionCheckbox",{attrs:{checked:e.token.scope.filesystem},on:{"update:checked":e.updateFileSystemScope}},[e._v(" "+e._s(e.t("settings","Allow filesystem access"))+" ")]):e._e(),e.token.canRename?n("NcActionButton",{attrs:{icon:"icon-rename"},on:{click:function(o){return o.stopPropagation(),o.preventDefault(),e.startRename.apply(null,arguments)}}},[e._v(" "+e._s(e.t("settings","Rename"))+" ")]):e._e(),e.token.canDelete?[e.token.type!==2?[n("NcActionButton",{attrs:{icon:"icon-delete"},on:{click:function(o){return o.stopPropagation(),o.preventDefault(),e.revoke.apply(null,arguments)}}},[e._v(" "+e._s(e.t("settings","Revoke"))+" ")]),n("NcActionButton",{attrs:{icon:"icon-delete"},on:{click:function(o){return o.stopPropagation(),o.preventDefault(),e.wipe.apply(null,arguments)}}},[e._v(" "+e._s(e.t("settings","Wipe device"))+" ")])]:e.token.type===2?n("NcActionButton",{attrs:{icon:"icon-delete",name:e.t("settings","Revoke")},on:{click:function(o){return o.stopPropagation(),o.preventDefault(),e.revoke.apply(null,arguments)}}},[e._v(" "+e._s(e.t("settings","Revoking this token might prevent the wiping of your device if it has not started the wipe yet."))+" ")]):e._e()]:e._e()],2)],1)])},Y=[],Z=l(H,j,Y,!1,null,"2ded2365");const J=Z.exports,ee=c({name:"AuthTokenList",components:{AuthToken:J},setup(){return{authTokenStore:w()}},computed:{sortedTokens(){return[...this.authTokenStore.tokens].sort((e,n)=>n.lastActivity-e.lastActivity)}},methods:{t:a}});var te=function(){var e=this,n=e._self._c;return e._self._setupProxy,n("table",{staticClass:"token-list",attrs:{id:"app-tokens-table"}},[n("thead",[n("tr",[n("th",{staticClass:"token-list__header-device"},[e._v(" "+e._s(e.t("settings","Device"))+" ")]),n("th",{staticClass:"toke-list__header-activity"},[e._v(" "+e._s(e.t("settings","Last activity"))+" ")]),n("th",[n("span",{staticClass:"hidden-visually"},[e._v(" "+e._s(e.t("settings","Actions"))+" ")])])])]),n("tbody",{staticClass:"token-list__body"},e._l(e.sortedTokens,function(o){return n("AuthToken",{key:o.id,attrs:{token:o}})}),1)])},ne=[],oe=l(ee,te,ne,!1,null,"8dcf02ec");const ae=oe.exports,se=c({name:"AuthTokenSetupDialog",components:{NcButton:k,NcDialog:x,NcIconSvgWrapper:N,NcTextField:g,QR:X},props:{token:{type:Object,required:!1,default:null}},data(){return{isNameCopied:!1,isPasswordCopied:!1,showQRCode:!1}},computed:{open:{get(){return this.token!==null},set(e){e||this.$emit("close")}},copyPasswordIcon(){return this.isPasswordCopied?m:f},copyNameIcon(){return this.isNameCopied?m:f},appPassword(){var e,n;return(n=(e=this.token)==null?void 0:e.token)!=null?n:""},loginName(){var e,n;return(n=(e=this.token)==null?void 0:e.loginName)!=null?n:""},qrUrl(){const e=window.location.protocol+"//"+window.location.host+O();return"nc://login/user:".concat(this.loginName,"&password:").concat(this.appPassword,"&server:").concat(e)},copyPasswordLabel(){return this.isPasswordCopied?a("settings","App password copied!"):a("settings","Copy app password")},copyLoginNameLabel(){return this.isNameCopied?a("settings","Login name copied!"):a("settings","Copy login name")}},watch:{token(){this.showQRCode=!1},open(){this.open&&this.$nextTick(()=>{this.$refs.appPassword.select()})}},methods:{t:a,async copyPassword(){try{await navigator.clipboard.writeText(this.appPassword),this.isPasswordCopied=!0}catch(e){this.isPasswordCopied=!1,s.error(e),r(a("settings","Could not copy app password. Please copy it manually."))}finally{setTimeout(()=>{this.isPasswordCopied=!1},4e3)}},async copyLoginName(){try{await navigator.clipboard.writeText(this.loginName),this.isNameCopied=!0}catch(e){this.isNameCopied=!1,s.error(e),r(a("settings","Could not copy login name. Please copy it manually."))}finally{setTimeout(()=>{this.isNameCopied=!1},4e3)}}}});var ie=function(){var e=this,n=e._self._c;return e._self._setupProxy,n("NcDialog",{attrs:{open:e.open,name:e.t("settings","New app password"),"content-classes":"token-dialog"},on:{"update:open":function(o){e.open=o}}},[n("p",[e._v(" "+e._s(e.t("settings","Use the credentials below to configure your app or device. For security reasons this password will only be shown once."))+" ")]),n("div",{staticClass:"token-dialog__name"},[n("NcTextField",{attrs:{label:e.t("settings","Login"),value:e.loginName,readonly:""}}),n("NcButton",{attrs:{type:"tertiary",title:e.copyLoginNameLabel,"aria-label":e.copyLoginNameLabel},on:{click:e.copyLoginName},scopedSlots:e._u([{key:"icon",fn:function(){return[n("NcIconSvgWrapper",{attrs:{path:e.copyNameIcon}})]},proxy:!0}])})],1),n("div",{staticClass:"token-dialog__password"},[n("NcTextField",{ref:"appPassword",attrs:{label:e.t("settings","Password"),value:e.appPassword,readonly:""}}),n("NcButton",{attrs:{type:"tertiary",title:e.copyPasswordLabel,"aria-label":e.copyPasswordLabel},on:{click:e.copyPassword},scopedSlots:e._u([{key:"icon",fn:function(){return[n("NcIconSvgWrapper",{attrs:{path:e.copyPasswordIcon}})]},proxy:!0}])})],1),n("div",{staticClass:"token-dialog__qrcode"},[e.showQRCode?n("QR",{attrs:{value:e.qrUrl}}):n("NcButton",{on:{click:function(o){e.showQRCode=!0}}},[e._v(" "+e._s(e.t("settings","Show QR code for mobile apps"))+" ")])],1)])},re=[],ce=l(se,ie,re,!1,null,"b6289944");const le=ce.exports,pe=c({name:"AuthTokenSetup",components:{NcButton:k,NcTextField:g,AuthTokenSetupDialog:le},setup(){return{authTokenStore:w()}},data(){return{deviceName:"",loading:!1,newToken:null}},methods:{t:a,reset(){this.loading=!1,this.deviceName="",this.newToken=null},async submit(){try{this.loading=!0,this.newToken=await this.authTokenStore.addToken(this.deviceName)}catch(e){s.error(e),r(a("settings","Error while creating device token")),this.reset()}finally{this.loading=!1}}}});var de=function(){var e=this,n=e._self._c;return e._self._setupProxy,n("form",{staticClass:"row spacing",attrs:{id:"generate-app-token-section"},on:{submit:function(o){return o.preventDefault(),e.submit.apply(null,arguments)}}},[n("NcTextField",{staticClass:"app-name-text-field",attrs:{value:e.deviceName,type:"text",maxlength:120,disabled:e.loading,label:e.t("settings","App name"),placeholder:e.t("settings","App name")},on:{"update:value":function(o){e.deviceName=o}}}),n("NcButton",{attrs:{type:"primary",disabled:e.loading||e.deviceName.length===0,"native-type":"submit"}},[e._v(" "+e._s(e.t("settings","Create new app password"))+" ")]),n("AuthTokenSetupDialog",{attrs:{token:e.newToken},on:{close:function(o){e.newToken=null}}})],1)},ue=[],he=l(pe,de,ue,!1,null,"93838e96");const me=he.exports,ke=c({name:"AuthTokenSection",components:{AuthTokenList:ae,AuthTokenSetup:me},data(){return{canCreateToken:_("settings","can_create_app_token")}},methods:{t:a}});var ge=function(){var e=this,n=e._self._c;return e._self._setupProxy,n("div",{staticClass:"section",attrs:{id:"security"}},[n("h2",[e._v(e._s(e.t("settings","Devices & sessions",{},void 0,{sanitize:!1})))]),n("p",{staticClass:"settings-hint hidden-when-empty"},[e._v(" "+e._s(e.t("settings","Web, desktop and mobile clients currently logged in to your account."))+" ")]),n("AuthTokenList"),e.canCreateToken?n("AuthTokenSetup"):e._e()],1)},we=[],ye=l(ke,ge,we,!1,null,null);const fe=ye.exports,ve=L();u.use(M),u.use(E,{defaultHtml:!1}),u.prototype.t=t;const _e=u.extend(fe);new _e({pinia:ve}).$mount("#security-authtokens");
