{"version":3,"file":"dav-Cbt6Q9c0.chunk.mjs","sources":["../node_modules/@nextcloud/files/dist/dav.mjs"],"sourcesContent":["import { getCurrentUser, onRequestTokenUpdate, getRequestToken } from \"@nextcloud/auth\";\nimport { isPublicShare, getSharingToken } from \"@nextcloud/sharing/public\";\nimport { generateRemoteUrl } from \"@nextcloud/router\";\nimport { createClient, getPatcher } from \"webdav\";\nimport { P as Permission, l as logger, c as NodeStatus, a as File, b as Folder } from \"./chunks/folder-Bf-tAYWu.mjs\";\nconst parsePermissions = function(permString = \"\") {\n  let permissions = Permission.NONE;\n  if (!permString) {\n    return permissions;\n  }\n  if (permString.includes(\"C\") || permString.includes(\"K\")) {\n    permissions |= Permission.CREATE;\n  }\n  if (permString.includes(\"G\")) {\n    permissions |= Permission.READ;\n  }\n  if (permString.includes(\"W\") || permString.includes(\"N\") || permString.includes(\"V\")) {\n    permissions |= Permission.UPDATE;\n  }\n  if (permString.includes(\"D\")) {\n    permissions |= Permission.DELETE;\n  }\n  if (permString.includes(\"R\")) {\n    permissions |= Permission.SHARE;\n  }\n  return permissions;\n};\nconst defaultDavProperties = [\n  \"d:getcontentlength\",\n  \"d:getcontenttype\",\n  \"d:getetag\",\n  \"d:getlastmodified\",\n  \"d:creationdate\",\n  \"d:displayname\",\n  \"d:quota-available-bytes\",\n  \"d:resourcetype\",\n  \"nc:has-preview\",\n  \"nc:is-encrypted\",\n  \"nc:mount-type\",\n  \"oc:comments-unread\",\n  \"oc:favorite\",\n  \"oc:fileid\",\n  \"oc:owner-display-name\",\n  \"oc:owner-id\",\n  \"oc:permissions\",\n  \"oc:size\"\n];\nconst defaultDavNamespaces = {\n  d: \"DAV:\",\n  nc: \"http://nextcloud.org/ns\",\n  oc: \"http://owncloud.org/ns\",\n  ocs: \"http://open-collaboration-services.org/ns\"\n};\nconst registerDavProperty = function(prop, namespace = { nc: \"http://nextcloud.org/ns\" }) {\n  if (typeof window._nc_dav_properties === \"undefined\") {\n    window._nc_dav_properties = [...defaultDavProperties];\n    window._nc_dav_namespaces = { ...defaultDavNamespaces };\n  }\n  const namespaces = { ...window._nc_dav_namespaces, ...namespace };\n  if (window._nc_dav_properties.find((search) => search === prop)) {\n    logger.warn(`${prop} already registered`, { prop });\n    return false;\n  }\n  if (prop.startsWith(\"<\") || prop.split(\":\").length !== 2) {\n    logger.error(`${prop} is not valid. See example: 'oc:fileid'`, { prop });\n    return false;\n  }\n  const ns = prop.split(\":\")[0];\n  if (!namespaces[ns]) {\n    logger.error(`${prop} namespace unknown`, { prop, namespaces });\n    return false;\n  }\n  window._nc_dav_properties.push(prop);\n  window._nc_dav_namespaces = namespaces;\n  return true;\n};\nconst getDavProperties = function() {\n  if (typeof window._nc_dav_properties === \"undefined\") {\n    window._nc_dav_properties = [...defaultDavProperties];\n  }\n  return window._nc_dav_properties.map((prop) => `<${prop} />`).join(\" \");\n};\nconst getDavNameSpaces = function() {\n  if (typeof window._nc_dav_namespaces === \"undefined\") {\n    window._nc_dav_namespaces = { ...defaultDavNamespaces };\n  }\n  return Object.keys(window._nc_dav_namespaces).map((ns) => `xmlns:${ns}=\"${window._nc_dav_namespaces?.[ns]}\"`).join(\" \");\n};\nconst getDefaultPropfind = function() {\n  return `<?xml version=\"1.0\"?>\n\t\t<d:propfind ${getDavNameSpaces()}>\n\t\t\t<d:prop>\n\t\t\t\t${getDavProperties()}\n\t\t\t</d:prop>\n\t\t</d:propfind>`;\n};\nconst getFavoritesReport = function() {\n  return `<?xml version=\"1.0\"?>\n\t\t<oc:filter-files ${getDavNameSpaces()}>\n\t\t\t<d:prop>\n\t\t\t\t${getDavProperties()}\n\t\t\t</d:prop>\n\t\t\t<oc:filter-rules>\n\t\t\t\t<oc:favorite>1</oc:favorite>\n\t\t\t</oc:filter-rules>\n\t\t</oc:filter-files>`;\n};\nconst getRecentSearch = function(lastModified) {\n  return `<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<d:searchrequest ${getDavNameSpaces()}\n\txmlns:ns=\"https://github.com/icewind1991/SearchDAV/ns\">\n\t<d:basicsearch>\n\t\t<d:select>\n\t\t\t<d:prop>\n\t\t\t\t${getDavProperties()}\n\t\t\t</d:prop>\n\t\t</d:select>\n\t\t<d:from>\n\t\t\t<d:scope>\n\t\t\t\t<d:href>/files/${getCurrentUser()?.uid}/</d:href>\n\t\t\t\t<d:depth>infinity</d:depth>\n\t\t\t</d:scope>\n\t\t</d:from>\n\t\t<d:where>\n\t\t\t<d:and>\n\t\t\t\t<d:or>\n\t\t\t\t\t<d:not>\n\t\t\t\t\t\t<d:eq>\n\t\t\t\t\t\t\t<d:prop>\n\t\t\t\t\t\t\t\t<d:getcontenttype/>\n\t\t\t\t\t\t\t</d:prop>\n\t\t\t\t\t\t\t<d:literal>httpd/unix-directory</d:literal>\n\t\t\t\t\t\t</d:eq>\n\t\t\t\t\t</d:not>\n\t\t\t\t\t<d:eq>\n\t\t\t\t\t\t<d:prop>\n\t\t\t\t\t\t\t<oc:size/>\n\t\t\t\t\t\t</d:prop>\n\t\t\t\t\t\t<d:literal>0</d:literal>\n\t\t\t\t\t</d:eq>\n\t\t\t\t</d:or>\n\t\t\t\t<d:gt>\n\t\t\t\t\t<d:prop>\n\t\t\t\t\t\t<d:getlastmodified/>\n\t\t\t\t\t</d:prop>\n\t\t\t\t\t<d:literal>${lastModified}</d:literal>\n\t\t\t\t</d:gt>\n\t\t\t</d:and>\n\t\t</d:where>\n\t\t<d:orderby>\n\t\t\t<d:order>\n\t\t\t\t<d:prop>\n\t\t\t\t\t<d:getlastmodified/>\n\t\t\t\t</d:prop>\n\t\t\t\t<d:descending/>\n\t\t\t</d:order>\n\t\t</d:orderby>\n\t\t<d:limit>\n\t\t\t<d:nresults>100</d:nresults>\n\t\t\t<ns:firstresult>0</ns:firstresult>\n\t\t</d:limit>\n\t</d:basicsearch>\n</d:searchrequest>`;\n};\nfunction getRootPath() {\n  if (isPublicShare()) {\n    return `/files/${getSharingToken()}`;\n  }\n  return `/files/${getCurrentUser()?.uid}`;\n}\nconst defaultRootPath = getRootPath();\nfunction getRemoteURL() {\n  const url = generateRemoteUrl(\"dav\");\n  if (isPublicShare()) {\n    return url.replace(\"remote.php\", \"public.php\");\n  }\n  return url;\n}\nconst defaultRemoteURL = getRemoteURL();\nconst getClient = function(remoteURL = defaultRemoteURL, headers = {}) {\n  const client = createClient(remoteURL, { headers });\n  function setHeaders(token) {\n    client.setHeaders({\n      ...headers,\n      // Add this so the server knows it is an request from the browser\n      \"X-Requested-With\": \"XMLHttpRequest\",\n      // Inject user auth\n      requesttoken: token ?? \"\"\n    });\n  }\n  onRequestTokenUpdate(setHeaders);\n  setHeaders(getRequestToken());\n  const patcher = getPatcher();\n  patcher.patch(\"fetch\", (url, options) => {\n    const headers2 = options.headers;\n    if (headers2?.method) {\n      options.method = headers2.method;\n      delete headers2.method;\n    }\n    return fetch(url, options);\n  });\n  return client;\n};\nasync function getFavoriteNodes(options = {}) {\n  const client = options.client ?? getClient();\n  const path = options.path ?? \"/\";\n  const davRoot = options.davRoot ?? defaultRootPath;\n  const contentsResponse = await client.getDirectoryContents(`${davRoot}${path}`, {\n    signal: options.signal,\n    details: true,\n    data: getFavoritesReport(),\n    headers: {\n      // see getClient for patched webdav client\n      method: \"REPORT\"\n    },\n    includeSelf: true\n  });\n  return contentsResponse.data.filter((node) => node.filename !== path).map((result) => resultToNode(result, davRoot));\n}\nconst resultToNode = function(node, filesRoot = defaultRootPath, remoteURL = defaultRemoteURL) {\n  let userId = getCurrentUser()?.uid;\n  if (isPublicShare()) {\n    userId = userId ?? \"anonymous\";\n  } else if (!userId) {\n    throw new Error(\"No user id found\");\n  }\n  const props = node.props;\n  const permissions = parsePermissions(props?.permissions);\n  const owner = String(props?.[\"owner-id\"] || userId);\n  const id = props.fileid || 0;\n  const mtime = new Date(Date.parse(node.lastmod));\n  const crtime = new Date(Date.parse(props.creationdate));\n  const nodeData = {\n    id,\n    source: `${remoteURL}${node.filename}`,\n    mtime: !isNaN(mtime.getTime()) && mtime.getTime() !== 0 ? mtime : void 0,\n    crtime: !isNaN(crtime.getTime()) && crtime.getTime() !== 0 ? crtime : void 0,\n    mime: node.mime || \"application/octet-stream\",\n    // Manually cast to work around for https://github.com/perry-mitchell/webdav-client/pull/380\n    displayname: props.displayname !== void 0 ? String(props.displayname) : void 0,\n    size: props?.size || Number.parseInt(props.getcontentlength || \"0\"),\n    // The fileid is set to -1 for failed requests\n    status: id < 0 ? NodeStatus.FAILED : void 0,\n    permissions,\n    owner,\n    root: filesRoot,\n    attributes: {\n      ...node,\n      ...props,\n      hasPreview: props?.[\"has-preview\"]\n    }\n  };\n  delete nodeData.attributes?.props;\n  return node.type === \"file\" ? new File(nodeData) : new Folder(nodeData);\n};\nexport {\n  defaultDavNamespaces,\n  defaultDavProperties,\n  defaultRemoteURL,\n  defaultRootPath,\n  getClient,\n  getDavNameSpaces,\n  getDavProperties,\n  getDefaultPropfind,\n  getFavoriteNodes,\n  getFavoritesReport,\n  getRecentSearch,\n  getRemoteURL,\n  getRootPath,\n  parsePermissions,\n  registerDavProperty,\n  resultToNode\n};\n//# sourceMappingURL=dav.mjs.map\n"],"names":["parsePermissions","permString","permissions","Permission","defaultDavProperties","defaultDavNamespaces","registerDavProperty","prop","namespace","namespaces","search","logger","ns","getDavProperties","getDavNameSpaces","getRootPath","isPublicShare","getSharingToken","getCurrentUser","defaultRootPath","getRemoteURL","url","generateRemoteUrl","defaultRemoteURL","getClient","remoteURL","headers","client","createClient","setHeaders","token","onRequestTokenUpdate","getRequestToken","getPatcher","options","headers2","resultToNode","node","filesRoot","userId","props","owner","id","mtime","crtime","nodeData","NodeStatus","File","Folder"],"mappings":"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","x_google_ignoreList":[0]}