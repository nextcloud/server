import{C as m,V as _,c as v,P as x,d as V,g as H,e as A,f as C}from"./index-C12Y86mH.chunk.mjs";import{a as o,g as N,e as u}from"./index-6_gsQFyp.chunk.mjs";import{c as b,i as E}from"./index-BT4wQaDP.chunk.mjs";import{f as S,a as p,e as $,g as I}from"./index-JpgrUA2Z-nZKKuBvr.chunk.mjs";import{t as n,g as y,a as f}from"./translation-DoG5ZELJ-gw0g4US-.chunk.mjs";import{d as D,e as L,l as M}from"./index-xFugdZPW.chunk.mjs";import{g as T,b as k}from"./createElementId-DhjFt1I9--Zqj3wLs.chunk.mjs";import{g as F,a as B,b as U,r as P,d as O}from"./dav-u-1XnVEo.chunk.mjs";import{h as R}from"./runtime-dom.esm-bundler-OnXpa8v9.chunk.mjs";import{N as q}from"./NcUserBubble-DPAmU2_J-DWwZESZD.chunk.mjs";import"./string_decoder-BO00msnV.chunk.mjs";import"./NcNoteCard-CVhtNL04-CJazPt2C.chunk.mjs";import"./mdi-jSyRgDgA.chunk.mjs";import"./index-CIvQ6_fd.chunk.mjs";import"./colors-Go3zmZRD-s1bwsPD-.chunk.mjs";import"./NcAvatar-DmUGApWA-CMQTT2-F.chunk.mjs";import"./PencilOutline-D5agOoMH.chunk.mjs";import"./NcDateTime.vue_vue_type_script_setup_true_lang-BhB8yA4U-Cvo6kVaX.chunk.mjs";const z='<svg xmlns="http://www.w3.org/2000/svg" id="mdi-history" viewBox="0 0 24 24"><path d="M13.5,8H12V13L16.28,15.54L17,14.33L13.5,12.25V8M13,3A9,9 0 0,0 4,12H1L4.96,16.03L9,12H6A7,7 0 0,1 13,5A7,7 0 0,1 20,12A7,7 0 0,1 13,19C11.07,19 9.32,18.21 8.06,16.94L6.64,18.36C8.27,20 10.5,21 13,21A9,9 0 0,0 22,12A9,9 0 0,0 13,3" /></svg>',K='<svg xmlns="http://www.w3.org/2000/svg" id="mdi-trash-can-outline" viewBox="0 0 24 24"><path d="M9,3V4H4V6H5V19A2,2 0 0,0 7,21H17A2,2 0 0,0 19,19V6H20V4H15V3H9M7,6H17V19H7V6M9,8V17H11V8H9M13,8V17H15V8H13Z" /></svg>',w=`/trashbin/${o()?.uid}/trash`,Y=F(),Z=`<?xml version="1.0"?>
<d:propfind ${B()}>
	<d:prop>
		<nc:trashbin-deletion-time />
		<nc:trashbin-original-location />
		<nc:trashbin-title />
		<nc:trashbin-deleted-by-id />
		<nc:trashbin-deleted-by-display-name />
		${U()}
	</d:prop>
</d:propfind>`;function j(i){const e=P(i,w);return e.attributes.previewUrl=T("/apps/files_trashbin/preview?fileId={fileid}&x=32&y=32",{fileid:e.fileid}),e}async function G(i="/"){const e=(await Y.getDirectoryContents(`${w}${i}`,{details:!0,data:Z,includeSelf:!0})).data.map(j),[t]=e.splice(e.findIndex(s=>s.path===i),1);return{folder:t,contents:e}}const J=new m({id:"files_trashbin--original-location",title:n("files_trashbin","Original location"),render(i){const e=l(i),t=document.createElement("span");return t.title=e,t.textContent=e,t},sort(i,e){const t=l(i),s=l(e);return t.localeCompare(s,[y(),f()],{numeric:!0,usage:"sort"})}}),Q=new m({id:"files_trashbin--deleted-by",title:n("files_trashbin","Deleted by"),render(i){const{userId:e,displayName:t,label:s}=d(i);if(s){const a=document.createElement("span");return a.textContent=s,a}const r=document.createElement("div");return R(q,{size:32,user:e??void 0,displayName:t??e}).mount(r),r},sort(i,e){const t=d(i),s=t.label??t.displayName??t.userId,r=d(e),a=r.label??r.displayName??r.userId;return s.localeCompare(a,[y(),f()],{numeric:!0,usage:"sort"})}}),W=new m({id:"files_trashbin--deleted",title:n("files_trashbin","Deleted"),render(i){const e=i.attributes?.["trashbin-deletion-time"]||(i?.mtime?.getTime()??0)/1e3,t=document.createElement("span");if(e){const s=Intl.DateTimeFormat([f()],{dateStyle:"long",timeStyle:"short"}),r=new Date(e*1e3);return t.title=s.format(r),t.textContent=S(r,{ignoreSeconds:n("files","few seconds ago")}),t}return t.textContent=n("files_trashbin","A long time ago"),t},sort(i,e){const t=i.attributes?.["trashbin-deletion-time"]||(i?.mtime?.getTime()??0)/1e3;return(e.attributes?.["trashbin-deletion-time"]||(e?.mtime?.getTime()??0)/1e3)-t}});function l(i){const e=c(i.attributes?.["trashbin-original-location"]);if(!e)return n("files_trashbin","Unknown");const t=D(e);return t==="/"||t==="."?n("files_trashbin","All files"):t.replace(/^\//,"")}function d(i){const e=c(i.attributes?.["trashbin-deleted-by-id"]),t=c(i.attributes?.["trashbin-deleted-by-display-name"]);let s;const r=o()?.uid;return e===r&&(s=n("files_trashbin","You")),!e&&!t&&(s=n("files_trashbin","Unknown")),{userId:e,displayName:t,label:s}}function c(i){return i?String(i):null}const h="trashbin",X=new _({id:h,name:n("files_trashbin","Deleted files"),caption:n("files_trashbin","List of files that have been deleted."),emptyTitle:n("files_trashbin","No deleted files"),emptyCaption:n("files_trashbin","Files and folders you have deleted will show up here"),icon:K,order:50,sticky:!0,defaultSortKey:"deleted",columns:[J,Q,W],getContents:G}),g=N().setApp("files_trashbin").detectUser().build(),ee=new v({id:"restore",displayName(){return n("files_trashbin","Restore")},iconSvgInline:()=>z,enabled({nodes:i,view:e}){return e.id!==h?!1:i.length>0&&i.map(t=>t.permissions).every(t=>!!(t&x.READ))},async exec({nodes:i}){const e=i[0];try{const t=k(L(`dav/trashbin/${o().uid}/restore/${e.basename}`));return await b.request({method:"MOVE",url:e.encodedSource,headers:{destination:t}}),u("files:node:deleted",e),!0}catch(t){return E(t)&&t.response?.status===507&&p(n("files_trashbin","Not enough free space to restore the file/folder")),g.error("Failed to restore node",{error:t,node:e}),!1}},async execBatch({nodes:i,view:e,folder:t,contents:s}){return Promise.all(i.map(r=>this.exec({nodes:[r],view:e,folder:t,contents:s})))},order:1,inline:()=>!0});async function te(){try{return await b.delete(`${O}/trashbin/${o().uid}/trash`),$(n("files_trashbin","All files have been permanently deleted")),!0}catch(i){return p(n("files_trashbin","Failed to empty deleted files")),g.error("Failed to empty deleted files",{error:i}),!1}}const ie=new V({id:"empty-trash",displayName:()=>n("files_trashbin","Empty deleted files"),order:0,enabled({view:i,folder:e,contents:t}){return i.id!==h||!M("files_trashbin","config").allow_delete?!1:t.length>0&&e.path==="/"},async exec({contents:i}){return await new Promise(e=>{I(n("files_trashbin","Confirm permanent deletion")).setSeverity("warning").setText(n("files_trashbin","Are you sure you want to permanently delete all files and folders in the trash? This cannot be undone.")).setButtons([{label:n("files_trashbin","Cancel"),variant:"secondary",callback:()=>e(!1)},{label:n("files_trashbin","Empty deleted files"),variant:"error",callback:()=>e(!0)}]).build().show().then(()=>{e(!1)})})===!0&&await te()&&i.forEach(e=>u("files:node:deleted",e)),null}}),ne=H();ne.register(X),A(ie),C(ee);
//# sourceMappingURL=files_trashbin-init.mjs.map
