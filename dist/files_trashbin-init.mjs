import{C as m,V as _,c as v,P as x,d as V,g as H,e as A,f as C}from"./index-_fqk4-Qw.chunk.mjs";import{a as o,g as N,e as u}from"./string_decoder-CW7-7cc6.chunk.mjs";import{c as b,i as E}from"./index-Bis6vWHp.chunk.mjs";import{f as S,s as p,c as $,g as I}from"./index-JpgrUA2Z-Bk1urlYU.chunk.mjs";import{t as i,e as y,f,h as D,j as L,l as M}from"./mdi-C6koAnlx.chunk.mjs";import{c as T,a as k}from"./createElementId-DhjFt1I9-DYB7_VOD.chunk.mjs";import{g as F,a as B,b as U,r as P,d as O}from"./dav-DWC7082M.chunk.mjs";import{h as R}from"./index-B3fM9XzM.chunk.mjs";import{N as j}from"./NcUserBubble-DPAmU2_J-BAB1Topn.chunk.mjs";import"./index-BMztHQmx.chunk.mjs";import"./NcNoteCard-CVhtNL04-NCMYExJH.chunk.mjs";import"./PencilOutline-BIuFAr5N.chunk.mjs";import"./index-Bo08n8Cz.chunk.mjs";import"./colors-Go3zmZRD-DopeMbFY.chunk.mjs";import"./NcAvatar-DmUGApWA-CmSa2UB1.chunk.mjs";import"./NcUserStatusIcon-CGEf7fej-rG0Zbhsv.chunk.mjs";import"./NcDateTime.vue_vue_type_script_setup_true_lang-BhB8yA4U-DJmI9Yye.chunk.mjs";const q='<svg xmlns="http://www.w3.org/2000/svg" id="mdi-history" viewBox="0 0 24 24"><path d="M13.5,8H12V13L16.28,15.54L17,14.33L13.5,12.25V8M13,3A9,9 0 0,0 4,12H1L4.96,16.03L9,12H6A7,7 0 0,1 13,5A7,7 0 0,1 20,12A7,7 0 0,1 13,19C11.07,19 9.32,18.21 8.06,16.94L6.64,18.36C8.27,20 10.5,21 13,21A9,9 0 0,0 22,12A9,9 0 0,0 13,3" /></svg>',z='<svg xmlns="http://www.w3.org/2000/svg" id="mdi-trash-can-outline" viewBox="0 0 24 24"><path d="M9,3V4H4V6H5V19A2,2 0 0,0 7,21H17A2,2 0 0,0 19,19V6H20V4H15V3H9M7,6H17V19H7V6M9,8V17H11V8H9M13,8V17H15V8H13Z" /></svg>',w=`/trashbin/${o()?.uid}/trash`,K=F(),Y=`<?xml version="1.0"?>
<d:propfind ${B()}>
	<d:prop>
		<nc:trashbin-deletion-time />
		<nc:trashbin-original-location />
		<nc:trashbin-title />
		<nc:trashbin-deleted-by-id />
		<nc:trashbin-deleted-by-display-name />
		${U()}
	</d:prop>
</d:propfind>`;function Z(n){const e=P(n,w);return e.attributes.previewUrl=T("/apps/files_trashbin/preview?fileId={fileid}&x=32&y=32",{fileid:e.fileid}),e}async function G(n="/"){const e=(await K.getDirectoryContents(`${w}${n}`,{details:!0,data:Y,includeSelf:!0})).data.map(Z),[t]=e.splice(e.findIndex(s=>s.path===n),1);return{folder:t,contents:e}}const J=new m({id:"files_trashbin--original-location",title:i("files_trashbin","Original location"),render(n){const e=l(n),t=document.createElement("span");return t.title=e,t.textContent=e,t},sort(n,e){const t=l(n),s=l(e);return t.localeCompare(s,[y(),f()],{numeric:!0,usage:"sort"})}}),Q=new m({id:"files_trashbin--deleted-by",title:i("files_trashbin","Deleted by"),render(n){const{userId:e,displayName:t,label:s}=d(n);if(s){const a=document.createElement("span");return a.textContent=s,a}const r=document.createElement("div");return R(j,{size:32,user:e??void 0,displayName:t??e}).mount(r),r},sort(n,e){const t=d(n),s=t.label??t.displayName??t.userId,r=d(e),a=r.label??r.displayName??r.userId;return s.localeCompare(a,[y(),f()],{numeric:!0,usage:"sort"})}}),W=new m({id:"files_trashbin--deleted",title:i("files_trashbin","Deleted"),render(n){const e=n.attributes?.["trashbin-deletion-time"]||(n?.mtime?.getTime()??0)/1e3,t=document.createElement("span");if(e){const s=Intl.DateTimeFormat([f()],{dateStyle:"long",timeStyle:"short"}),r=new Date(e*1e3);return t.title=s.format(r),t.textContent=S(r,{ignoreSeconds:i("files","few seconds ago")}),t}return t.textContent=i("files_trashbin","A long time ago"),t},sort(n,e){const t=n.attributes?.["trashbin-deletion-time"]||(n?.mtime?.getTime()??0)/1e3;return(e.attributes?.["trashbin-deletion-time"]||(e?.mtime?.getTime()??0)/1e3)-t}});function l(n){const e=c(n.attributes?.["trashbin-original-location"]);if(!e)return i("files_trashbin","Unknown");const t=D(e);return t==="/"||t==="."?i("files_trashbin","All files"):t.replace(/^\//,"")}function d(n){const e=c(n.attributes?.["trashbin-deleted-by-id"]),t=c(n.attributes?.["trashbin-deleted-by-display-name"]);let s;const r=o()?.uid;return e===r&&(s=i("files_trashbin","You")),!e&&!t&&(s=i("files_trashbin","Unknown")),{userId:e,displayName:t,label:s}}function c(n){return n?String(n):null}const h="trashbin",X=new _({id:h,name:i("files_trashbin","Deleted files"),caption:i("files_trashbin","List of files that have been deleted."),emptyTitle:i("files_trashbin","No deleted files"),emptyCaption:i("files_trashbin","Files and folders you have deleted will show up here"),icon:z,order:50,sticky:!0,defaultSortKey:"deleted",columns:[J,Q,W],getContents:G}),g=N().setApp("files_trashbin").detectUser().build(),ee=new v({id:"restore",displayName(){return i("files_trashbin","Restore")},iconSvgInline:()=>q,enabled({nodes:n,view:e}){return e.id!==h?!1:n.length>0&&n.map(t=>t.permissions).every(t=>!!(t&x.READ))},async exec({nodes:n}){const e=n[0];try{const t=k(L(`dav/trashbin/${o().uid}/restore/${e.basename}`));return await b.request({method:"MOVE",url:e.encodedSource,headers:{destination:t}}),u("files:node:deleted",e),!0}catch(t){return E(t)&&t.response?.status===507&&p(i("files_trashbin","Not enough free space to restore the file/folder")),g.error("Failed to restore node",{error:t,node:e}),!1}},async execBatch({nodes:n,view:e,folder:t,contents:s}){return Promise.all(n.map(r=>this.exec({nodes:[r],view:e,folder:t,contents:s})))},order:1,inline:()=>!0});async function te(){try{return await b.delete(`${O}/trashbin/${o().uid}/trash`),$(i("files_trashbin","All files have been permanently deleted")),!0}catch(n){return p(i("files_trashbin","Failed to empty deleted files")),g.error("Failed to empty deleted files",{error:n}),!1}}const ne=new V({id:"empty-trash",displayName:()=>i("files_trashbin","Empty deleted files"),order:0,enabled({view:n,folder:e,contents:t}){return n.id!==h||!M("files_trashbin","config").allow_delete?!1:t.length>0&&e.path==="/"},async exec({contents:n}){return await new Promise(e=>{I(i("files_trashbin","Confirm permanent deletion")).setSeverity("warning").setText(i("files_trashbin","Are you sure you want to permanently delete all files and folders in the trash? This cannot be undone.")).setButtons([{label:i("files_trashbin","Cancel"),variant:"secondary",callback:()=>e(!1)},{label:i("files_trashbin","Empty deleted files"),variant:"error",callback:()=>e(!0)}]).build().show().then(()=>{e(!1)})})===!0&&await te()&&n.forEach(e=>u("files:node:deleted",e)),null}}),ie=H();ie.register(X),A(ne),C(ee);
//# sourceMappingURL=files_trashbin-init.mjs.map
