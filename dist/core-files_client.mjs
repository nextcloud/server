/*! third party licenses: dist/vendor.LICENSE.txt */
import{bP as O}from"./core-common.mjs";(function(c,m){var n=function(t){this._root=t.root,this._root.charAt(this._root.length-1)==="/"&&(this._root=this._root.substr(0,this._root.length-1));let e=n.PROTOCOL_HTTP+"://";t.useHTTPS&&(e=n.PROTOCOL_HTTPS+"://"),e+=t.host+this._root,this._host=t.host,this._defaultHeaders=t.defaultHeaders||{"X-Requested-With":"XMLHttpRequest",requesttoken:c.requestToken},this._baseUrl=e;const s={baseUrl:this._baseUrl,xmlNamespaces:{"DAV:":"d","http://owncloud.org/ns":"oc","http://nextcloud.org/ns":"nc","http://open-collaboration-services.org/ns":"ocs"}};t.userName&&(s.userName=t.userName),t.password&&(s.password=t.password),this._client=new window.dav.Client(s),this._client.xhrProvider=window._.bind(this._xhrProvider,this),this._fileInfoParsers=[]};n.NS_OWNCLOUD="http://owncloud.org/ns",n.NS_NEXTCLOUD="http://nextcloud.org/ns",n.NS_DAV="DAV:",n.NS_OCS="http://open-collaboration-services.org/ns",n.PROPERTY_GETLASTMODIFIED="{"+n.NS_DAV+"}getlastmodified",n.PROPERTY_GETETAG="{"+n.NS_DAV+"}getetag",n.PROPERTY_GETCONTENTTYPE="{"+n.NS_DAV+"}getcontenttype",n.PROPERTY_RESOURCETYPE="{"+n.NS_DAV+"}resourcetype",n.PROPERTY_INTERNAL_FILEID="{"+n.NS_OWNCLOUD+"}fileid",n.PROPERTY_PERMISSIONS="{"+n.NS_OWNCLOUD+"}permissions",n.PROPERTY_SIZE="{"+n.NS_OWNCLOUD+"}size",n.PROPERTY_GETCONTENTLENGTH="{"+n.NS_DAV+"}getcontentlength",n.PROPERTY_ISENCRYPTED="{"+n.NS_DAV+"}is-encrypted",n.PROPERTY_SHARE_PERMISSIONS="{"+n.NS_OCS+"}share-permissions",n.PROPERTY_SHARE_ATTRIBUTES="{"+n.NS_NEXTCLOUD+"}share-attributes",n.PROPERTY_QUOTA_AVAILABLE_BYTES="{"+n.NS_DAV+"}quota-available-bytes",n.PROTOCOL_HTTP="http",n.PROTOCOL_HTTPS="https",n._PROPFIND_PROPERTIES=[[n.NS_DAV,"getlastmodified"],[n.NS_DAV,"getetag"],[n.NS_DAV,"getcontenttype"],[n.NS_DAV,"resourcetype"],[n.NS_OWNCLOUD,"fileid"],[n.NS_OWNCLOUD,"permissions"],[n.NS_OWNCLOUD,"size"],[n.NS_DAV,"getcontentlength"],[n.NS_DAV,"quota-available-bytes"],[n.NS_NEXTCLOUD,"has-preview"],[n.NS_NEXTCLOUD,"mount-type"],[n.NS_NEXTCLOUD,"is-encrypted"],[n.NS_OCS,"share-permissions"],[n.NS_NEXTCLOUD,"share-attributes"]],n.prototype={_root:null,_client:null,_fileInfoParsers:[],_xhrProvider:function(){const t=this._defaultHeaders,e=new XMLHttpRequest,s=e.open;return e.open=function(){const i=s.apply(this,arguments);return _.each(t,function(o,a){e.setRequestHeader(a,o)}),i},c.registerXHRForErrorProcessing(e),e},_buildUrl:function(){let t=this._buildPath.apply(this,arguments);return t.charAt([t.length-1])==="/"&&(t=t.substr(0,t.length-1)),t.charAt(0)==="/"&&(t=t.substr(1)),this._baseUrl+"/"+t},_buildPath:function(){let t=c.joinPaths.apply(this,arguments);const e=t.split("/");let s;for(s=0;s<e.length;s++)e[s]=encodeURIComponent(e[s]);return t=e.join("/"),t},_parseHeaders:function(t){const e=t.split("\n"),s={};for(let i=0;i<e.length;i++){const o=e[i].indexOf(":");if(o<0)continue;const a=e[i].substr(0,o),r=e[i].substr(o+2);s[a]||(s[a]=[]),s[a].push(r)}return s},_parseEtag:function(t){return t.charAt(0)==='"'?t.split('"')[1]:t},_parseFileInfo:function(t){let e=decodeURIComponent(t.href);if(e.substr(0,this._root.length)===this._root&&(e=e.substr(this._root.length)),e.charAt(e.length-1)==="/"&&(e=e.substr(0,e.length-1)),t.propStat.length===0||t.propStat[0].status!=="HTTP/1.1 200 OK")return null;const s=t.propStat[0].properties,i={id:s[n.PROPERTY_INTERNAL_FILEID],path:c.dirname(e)||"/",name:c.basename(e),mtime:new Date(s[n.PROPERTY_GETLASTMODIFIED]).getTime()},o=s[n.PROPERTY_GETETAG];_.isUndefined(o)||(i.etag=this._parseEtag(o));let a=s[n.PROPERTY_GETCONTENTLENGTH];_.isUndefined(a)||(i.size=parseInt(a,10)),a=s[n.PROPERTY_SIZE],_.isUndefined(a)||(i.size=parseInt(a,10));const r=s["{"+n.NS_NEXTCLOUD+"}has-preview"];_.isUndefined(r)?i.hasPreview=!0:i.hasPreview=r==="true";const l=s["{"+n.NS_NEXTCLOUD+"}is-encrypted"];_.isUndefined(l)?i.isEncrypted=!1:i.isEncrypted=l==="1";const u=s["{"+n.NS_OWNCLOUD+"}favorite"];_.isUndefined(u)?i.isFavourited=!1:i.isFavourited=u==="1";const p=s[n.PROPERTY_GETCONTENTTYPE];_.isUndefined(p)||(i.mimetype=p);const E=s[n.PROPERTY_RESOURCETYPE];if(!i.mimetype&&E){const h=E[0];h.namespaceURI===n.NS_DAV&&h.nodeName.split(":")[1]==="collection"&&(i.mimetype="httpd/unix-directory")}i.permissions=c.PERMISSION_NONE;const S=s[n.PROPERTY_PERMISSIONS];if(!_.isUndefined(S)){const h=S||"";i.mountType=null;for(let f=0;f<h.length;f++)switch(h.charAt(f)){case"C":case"K":i.permissions|=c.PERMISSION_CREATE;break;case"G":i.permissions|=c.PERMISSION_READ;break;case"W":case"N":case"V":i.permissions|=c.PERMISSION_UPDATE;break;case"D":i.permissions|=c.PERMISSION_DELETE;break;case"R":i.permissions|=c.PERMISSION_SHARE;break;case"M":i.mountType||(i.mountType="external");break;case"S":i.mountType="shared";break}}const P=s[n.PROPERTY_SHARE_PERMISSIONS];_.isUndefined(P)||(i.sharePermissions=parseInt(P));const d=s[n.PROPERTY_SHARE_ATTRIBUTES];if(_.isUndefined(d))i.shareAttributes=[];else try{i.shareAttributes=JSON.parse(d)}catch{console.warn('Could not parse share attributes returned by server: "'+d+'"'),i.shareAttributes=[]}const T=s["{"+n.NS_NEXTCLOUD+"}mount-type"];_.isUndefined(T)||(i.mountType=T);const N=s["{"+n.NS_DAV+"}quota-available-bytes"];return _.isUndefined(N)||(i.quotaAvailableBytes=N),_.each(this._fileInfoParsers,function(h){_.extend(i,h(t,i)||{})}),new m(i)},_parseResult:function(t){const e=this;return _.map(t,function(s){return e._parseFileInfo(s)})},_isSuccessStatus:function(t){return t>=200&&t<=299},_getSabreException:function(t){const e={},s=t.xhr.responseXML;if(s===null)return e;const i=s.getElementsByTagNameNS("http://sabredav.org/ns","message"),o=s.getElementsByTagNameNS("http://sabredav.org/ns","exception");return i.length&&(e.message=i[0].textContent),o.length&&(e.exception=o[0].textContent),e},getPropfindProperties:function(){return this._propfindProperties||(this._propfindProperties=_.map(n._PROPFIND_PROPERTIES,function(t){return"{"+t[0]+"}"+t[1]})),this._propfindProperties},getFolderContents:function(t,e){t||(t=""),e=e||{};const s=this,i=$.Deferred(),o=i.promise();let a;return _.isUndefined(e.properties)?a=this.getPropfindProperties():a=e.properties,this._client.propFind(this._buildUrl(t),a,1).then(function(r){if(s._isSuccessStatus(r.status)){const l=s._parseResult(r.body);(!e||!e.includeParent)&&l.shift(),i.resolve(r.status,l)}else r=_.extend(r,s._getSabreException(r)),i.reject(r.status,r)}),o},getFilteredFiles:function(t,e){e=e||{};const s=this,i=$.Deferred(),o=i.promise();let a;if(_.isUndefined(e.properties)?a=this.getPropfindProperties():a=e.properties,!t||!t.systemTagIds&&_.isUndefined(t.favorite)&&!t.circlesIds)throw"Missing filter argument";let r="<oc:filter-files ",l;for(l in this._client.xmlNamespaces)r+=" xmlns:"+this._client.xmlNamespaces[l]+'="'+l+'"';return r+=">\n",r+="    <"+this._client.xmlNamespaces["DAV:"]+":prop>\n",_.each(a,function(u){const p=s._client.parseClarkNotation(u);r+="        <"+s._client.xmlNamespaces[p.namespace]+":"+p.name+" />\n"}),r+="    </"+this._client.xmlNamespaces["DAV:"]+":prop>\n",r+="    <oc:filter-rules>\n",_.each(t.systemTagIds,function(u){r+="        <oc:systemtag>"+O(u)+"</oc:systemtag>\n"}),_.each(t.circlesIds,function(u){r+="        <oc:circle>"+O(u)+"</oc:circle>\n"}),t.favorite&&(r+="        <oc:favorite>"+(t.favorite?"1":"0")+"</oc:favorite>\n"),r+="    </oc:filter-rules>\n",r+="</oc:filter-files>\n",this._client.request("REPORT",this._buildUrl(),{},r).then(function(u){if(s._isSuccessStatus(u.status)){const p=s._parseResult(u.body);i.resolve(u.status,p)}else u=_.extend(u,s._getSabreException(u)),i.reject(u.status,u)}),o},getFileInfo:function(t,e){t||(t=""),e=e||{};const s=this,i=$.Deferred(),o=i.promise();let a;return _.isUndefined(e.properties)?a=this.getPropfindProperties():a=e.properties,this._client.propFind(this._buildUrl(t),a,0).then(function(r){s._isSuccessStatus(r.status)?i.resolve(r.status,s._parseResult([r.body])[0]):(r=_.extend(r,s._getSabreException(r)),i.reject(r.status,r))}),o},getFileContents:function(t){if(!t)throw'Missing argument "path"';const e=this,s=$.Deferred(),i=s.promise();return this._client.request("GET",this._buildUrl(t)).then(function(o){e._isSuccessStatus(o.status)?s.resolve(o.status,o.body):(o=_.extend(o,e._getSabreException(o)),s.reject(o.status,o))}),i},putFileContents:function(t,e,s){if(!t)throw'Missing argument "path"';const i=this,o=$.Deferred(),a=o.promise();s=s||{};const r={};let l="text/plain;charset=utf-8";return s.contentType&&(l=s.contentType),r["Content-Type"]=l,(_.isUndefined(s.overwrite)||s.overwrite)&&(r["If-None-Match"]="*"),this._client.request("PUT",this._buildUrl(t),r,e||"").then(function(u){i._isSuccessStatus(u.status)?o.resolve(u.status):(u=_.extend(u,i._getSabreException(u)),o.reject(u.status,u))}),a},_simpleCall:function(t,e,s){if(!e)throw'Missing argument "path"';const i=this,o=$.Deferred(),a=o.promise();return this._client.request(t,this._buildUrl(e),s||{}).then(function(r){i._isSuccessStatus(r.status)?o.resolve(r.status):(r=_.extend(r,i._getSabreException(r)),o.reject(r.status,r))}),a},createDirectory:function(t,e){return this._simpleCall("MKCOL",t,e)},remove:function(t){return this._simpleCall("DELETE",t)},move:function(t,e,s,i){if(!t)throw'Missing argument "path"';if(!e)throw'Missing argument "destinationPath"';const o=this,a=$.Deferred(),r=a.promise();return i=_.extend({},i,{Destination:this._buildUrl(e)}),s||(i.Overwrite="F"),this._client.request("MOVE",this._buildUrl(t),i).then(function(l){o._isSuccessStatus(l.status)?a.resolve(l.status):(l=_.extend(l,o._getSabreException(l)),a.reject(l.status,l))}),r},copy:function(t,e,s){if(!t)throw'Missing argument "path"';if(!e)throw'Missing argument "destinationPath"';const i=this,o=$.Deferred(),a=o.promise(),r={Destination:this._buildUrl(e)};return s||(r.Overwrite="F"),this._client.request("COPY",this._buildUrl(t),r).then(function(l){i._isSuccessStatus(l.status)?o.resolve(l.status):o.reject(l.status)}),a},addFileInfoParser:function(t){this._fileInfoParsers.push(t)},getClient:function(){return this._client},getUserName:function(){return this._client.userName},getPassword:function(){return this._client.password},getBaseUrl:function(){return this._client.baseUrl},getHost:function(){return this._host}},c.Files||(c.Files={}),c.Files.getClient=function(){if(c.Files._defaultClient)return c.Files._defaultClient;const t=new c.Files.Client({host:c.getHost(),port:c.getPort(),root:c.linkToRemoteBase("dav")+"/files/"+c.getCurrentUser().uid,useHTTPS:c.getProtocol()==="https"});return c.Files._defaultClient=t,t},c.Files.Client=n})(OC,OC.Files.FileInfo);
