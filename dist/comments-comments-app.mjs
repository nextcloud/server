/*! third party licenses: dist/vendor.LICENSE.txt */
import{X as m,F as l,ch as d,bS as r,aV as c,c5 as u}from"./core-common.mjs";import"./chunks/index-PaKKd09k.mjs";import{z as p}from"./chunks/_plugin-vue2_normalizer-VrK6B12S-BQkexw0P.mjs";import{n as h,a5 as g,a6 as C,a7 as f}from"./chunks/icons-TElqpmA8.mjs";import{C as i,a as y}from"./chunks/CommentView-f2_R7DxB.mjs";import{c as _,g as w,D as a}from"./chunks/GetComments-BFQTC104.mjs";import{l as b}from"./chunks/logger-DMHE5Ua4.mjs";import"./chunks/preload-helper-BG02UnR2.mjs";import"./chunks/index-tn-fAC9x.mjs";import"./chunks/json2xml-BD0x8Z3S.mjs";import"./chunks/index-CiG5J8j_.mjs";const I=function(e){const t=new AbortController,s=t.signal;return{request:async function(o,n){return await e(o,Object.assign({signal:s},n))},abort:()=>t.abort()}},R=(e,t,s)=>{const o=["",e,t].join("/"),n=s.toUTCString();return _.customRequest(o,{method:"PROPPATCH",data:'<?xml version="1.0"?>\n			<d:propertyupdate\n				xmlns:d="DAV:"\n				xmlns:oc="http://owncloud.org/ns">\n			<d:set>\n				<d:prop>\n					<oc:readMarker>'.concat(n,"</oc:readMarker>\n				</d:prop>\n			</d:set>\n			</d:propertyupdate>")})},v={name:"Comments",components:{Comment:i,NcEmptyContent:m,NcButton:l,RefreshIcon:g,MessageReplyTextIcon:C,AlertCircleOutlineIcon:f},directives:{elementVisibility:d},mixins:[y],data(){return{error:"",loading:!1,done:!1,currentResourceId:this.resourceId,offset:0,comments:[],cancelRequest:()=>{},Comment:i,userData:{}}},computed:{hasComments(){return this.comments.length>0},isFirstLoading(){return this.loading&&this.offset===0}},watch:{resourceId(){this.currentResourceId=this.resourceId}},methods:{t:r,async onVisibilityChange(e){if(e)try{await R(this.resourceType,this.currentResourceId,new Date)}catch(t){p(t.message||r("comments","Failed to mark comments as read"))}},async update(e){this.currentResourceId=e,this.resetState(),this.getComments()},onScrollBottomReached(){this.error||this.done||this.loading||this.getComments()},async getComments(){this.cancelRequest("cancel");try{this.loading=!0,this.error="";const{request:e,abort:t}=I(w);this.cancelRequest=t;const{data:s}=await e({resourceType:this.resourceType,resourceId:this.currentResourceId},{offset:this.offset})||{data:[]};this.logger.debug("Processed ".concat(s.length," comments"),{comments:s}),s.length<a&&(this.done=!0),this.comments.push(...s),this.offset+=a}catch(e){if(e.message==="cancel")return;this.error=r("comments","Unable to load the comments list"),console.error("Error loading the comments list",e)}finally{this.loading=!1}},onNewComment(e){this.comments.unshift(e)},onDelete(e){const t=this.comments.findIndex(s=>s.props.id===e);t>-1?this.comments.splice(t,1):console.error("Could not find the deleted comment in the list",e)},resetState(){this.error="",this.loading=!1,this.done=!1,this.offset=0,this.comments=[]}}};var x=function(){var e=this,t=e._self._c;return t("div",{directives:[{name:"element-visibility",rawName:"v-element-visibility",value:e.onVisibilityChange,expression:"onVisibilityChange"}],staticClass:"comments",class:{"icon-loading":e.isFirstLoading}},[t("Comment",e._b({staticClass:"comments__writer",attrs:{"auto-complete":e.autoComplete,"resource-type":e.resourceType,editor:!0,"user-data":e.userData,"resource-id":e.currentResourceId},on:{new:e.onNewComment}},"Comment",e.editorData,!1)),e.isFirstLoading?e._e():[!e.hasComments&&e.done?t("NcEmptyContent",{staticClass:"comments__empty",attrs:{name:e.t("comments","No comments yet, start the conversation!")},scopedSlots:e._u([{key:"icon",fn:function(){return[t("MessageReplyTextIcon")]},proxy:!0}],null,!1,1033639148)}):t("ul",e._l(e.comments,function(s){return t("Comment",e._b({key:s.props.id,staticClass:"comments__list",attrs:{tag:"li","auto-complete":e.autoComplete,"resource-type":e.resourceType,message:s.props.message,"resource-id":e.currentResourceId,"user-data":e.genMentionsData(s.props.mentions)},on:{"update:message":function(o){return e.$set(s.props,"message",o)},delete:e.onDelete}},"Comment",s.props,!1))}),1),e.loading&&!e.isFirstLoading?t("div",{staticClass:"comments__info icon-loading"}):e.hasComments&&e.done?t("div",{staticClass:"comments__info"},[e._v(" "+e._s(e.t("comments","No more messages"))+" ")]):e.error?[t("NcEmptyContent",{staticClass:"comments__error",attrs:{name:e.error},scopedSlots:e._u([{key:"icon",fn:function(){return[t("AlertCircleOutlineIcon")]},proxy:!0}],null,!1,66050004)}),t("NcButton",{staticClass:"comments__retry",on:{click:e.getComments},scopedSlots:e._u([{key:"icon",fn:function(){return[t("RefreshIcon")]},proxy:!0}],null,!1,3924573781)},[e._v(" "+e._s(e.t("comments","Retry"))+" ")])]:e._e()]],2)},D=[],O=h(v,x,D,!1,null,"6c875dcc");const A=O.exports;c.mixin({data(){return{logger:b}},methods:{t:r,n:u}});class N{constructor(t="files",s={}){var n;s={...s,propsData:{...(n=s.propsData)!=null?n:{},resourceType:t}};const o=c.extend(A);return new o(s)}}window.OCA&&!window.OCA.Comments&&Object.assign(window.OCA,{Comments:{}}),Object.assign(window.OCA.Comments,{View:N}),console.debug("OCA.Comments.View initialized");
