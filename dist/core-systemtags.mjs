/*! third party licenses: dist/vendor.LICENSE.txt */
import{bP as S,c1 as C}from"./core-common.mjs";import{h as T}from"./chunks/handlebars-CXvOxsjd.mjs";(function(n){n.SystemTags={getDescriptiveTag:function(s){_.isUndefined(s.name)&&!_.isUndefined(s.toJSON)&&(s=s.toJSON());var e=document.createElement("span");if(_.isUndefined(s.name))return e.classList.add("non-existing-tag"),e.textContent=t("core","Non-existing tag #{tag}",{tag:s}),e;e.textContent=S(s.name);var i;if(s.userAssignable||(i=t("core","Restricted")),s.userVisible||(i=t("core","Invisible")),i){var o=document.createElement("em");o.textContent=" ("+i+")",e.appendChild(o)}return e}}})(OC),function(n){var s;if((s=n==null?void 0:n.Files)!=null&&s.Client){_.extend(n.Files.Client,{PROPERTY_FILEID:"{"+n.Files.Client.NS_OWNCLOUD+"}id",PROPERTY_CAN_ASSIGN:"{"+n.Files.Client.NS_OWNCLOUD+"}can-assign",PROPERTY_DISPLAYNAME:"{"+n.Files.Client.NS_OWNCLOUD+"}display-name",PROPERTY_USERVISIBLE:"{"+n.Files.Client.NS_OWNCLOUD+"}user-visible",PROPERTY_USERASSIGNABLE:"{"+n.Files.Client.NS_OWNCLOUD+"}user-assignable"});const e=n.Backbone.Model.extend({sync:n.Backbone.davSync,defaults:{userVisible:!0,userAssignable:!0,canAssign:!0},davProperties:{id:n.Files.Client.PROPERTY_FILEID,name:n.Files.Client.PROPERTY_DISPLAYNAME,userVisible:n.Files.Client.PROPERTY_USERVISIBLE,userAssignable:n.Files.Client.PROPERTY_USERASSIGNABLE,canAssign:n.Files.Client.PROPERTY_CAN_ASSIGN},parse(i){return{id:i.id,name:i.name,userVisible:i.userVisible===!0||i.userVisible==="true",userAssignable:i.userAssignable===!0||i.userAssignable==="true",canAssign:i.canAssign===!0||i.canAssign==="true"}}});n.SystemTags=n.SystemTags||{},n.SystemTags.SystemTagModel=e}}(OC),function(n){const s=n.Backbone.Collection.extend({sync:n.Backbone.davSync,usePUT:!0,_objectId:null,_objectType:"files",model:n.SystemTags.SystemTagModel,url(){return C("dav")+"/systemtags-relations/"+this._objectType+"/"+this._objectId},setObjectId(e){this._objectId=e},setObjectType(e){this._objectType=e},initialize(e,i){i=i||{},_.isUndefined(i.objectId)||(this._objectId=i.objectId),_.isUndefined(i.objectType)||(this._objectType=i.objectType)},getTagIds(){return this.map(function(e){return e.id})}});n.SystemTags=n.SystemTags||{},n.SystemTags.SystemTagsMappingCollection=s}(OC),function(n){function s(i,o){return i.get("name").substr(0,o.length).toLowerCase()===o.toLowerCase()}var e=n.Backbone.Collection.extend({sync:n.Backbone.davSync,model:n.SystemTags.SystemTagModel,url:function(){return n.linkToRemote("dav")+"/systemtags/"},filterByName:function(i){return this.filter(function(o){return s(o,i)})},reset:function(){return this.fetched=!1,n.Backbone.Collection.prototype.reset.apply(this,arguments)},fetch:function(i){var o=this;if(i=i||{},this.fetched||this.working||i.force)return i.success&&i.success(this,null,i),this.trigger("sync",this,null,i),Promise.resolve();this.working=!0;var l=i.success;return i=_.extend({},i),i.success=function(){if(o.fetched=!0,o.working=!1,l)return l.apply(this,arguments)},n.Backbone.Collection.prototype.fetch.call(this,i)}});n.SystemTags=n.SystemTags||{},n.SystemTags.SystemTagsCollection=e,n.SystemTags.collection=new n.SystemTags.SystemTagsCollection}(OC);var v={};const h=T,A=h.template,O=h.templates=h.templates||{};O.result=A({1(n,s,e,i,o){return" new-item"},3(n,s,e,i,o){let l,a;const c=n.lookupProperty||function(r,m){if(Object.prototype.hasOwnProperty.call(r,m))return r[m]};return'		<span class="label">'+((l=(a=(a=c(e,"tagMarkup")||(s!=null?c(s,"tagMarkup"):s))!=null?a:n.hooks.helperMissing,typeof a=="function"?a.call(s!=null?s:n.nullContext||{},{name:"tagMarkup",hash:{},data:o,loc:{start:{line:4,column:22},end:{line:4,column:37}}}):a))!=null?l:"")+"</span>\n"},5(n,s,e,i,o){let l;const a=n.lookupProperty||function(c,r){if(Object.prototype.hasOwnProperty.call(c,r))return c[r]};return'		<span class="label">'+n.escapeExpression((l=(l=a(e,"name")||(s!=null?a(s,"name"):s))!=null?l:n.hooks.helperMissing,typeof l=="function"?l.call(s!=null?s:n.nullContext||{},{name:"name",hash:{},data:o,loc:{start:{line:6,column:22},end:{line:6,column:30}}}):l))+"</span>\n"},7(n,s,e,i,o){let l;const a=n.lookupProperty||function(c,r){if(Object.prototype.hasOwnProperty.call(c,r))return c[r]};return'		<span class="systemtags-actions">\n			<a href="#" class="rename icon icon-rename" title="'+n.escapeExpression((l=(l=a(e,"renameTooltip")||(s!=null?a(s,"renameTooltip"):s))!=null?l:n.hooks.helperMissing,typeof l=="function"?l.call(s!=null?s:n.nullContext||{},{name:"renameTooltip",hash:{},data:o,loc:{start:{line:10,column:54},end:{line:10,column:71}}}):l))+'"></a>\n		</span>\n'},compiler:[8,">= 4.3.0"],main(n,s,e,i,o){let l,a,c;const r=s!=null?s:n.nullContext||{},m=n.hooks.helperMissing,d="function",u=n.lookupProperty||function(g,b){if(Object.prototype.hasOwnProperty.call(g,b))return g[b]};let p='<span class="systemtags-item'+((l=u(e,"if").call(r,s!=null?u(s,"isNew"):s,{name:"if",hash:{},fn:n.program(1,o,0),inverse:n.noop,data:o,loc:{start:{line:1,column:28},end:{line:1,column:57}}}))!=null?l:"")+'" data-id="'+n.escapeExpression((a=(a=u(e,"id")||(s!=null?u(s,"id"):s))!=null?a:m,typeof a===d?a.call(r,{name:"id",hash:{},data:o,loc:{start:{line:1,column:68},end:{line:1,column:74}}}):a))+'">\n<span class="checkmark icon icon-checkmark"></span>\n'+((l=u(e,"if").call(r,s!=null?u(s,"isAdmin"):s,{name:"if",hash:{},fn:n.program(3,o,0),inverse:n.program(5,o,0),data:o,loc:{start:{line:3,column:1},end:{line:7,column:8}}}))!=null?l:"");return l=(a=(a=u(e,"allowActions")||(s!=null?u(s,"allowActions"):s))!=null?a:m,c={name:"allowActions",hash:{},fn:n.program(7,o,0),inverse:n.noop,data:o,loc:{start:{line:8,column:1},end:{line:12,column:18}}},typeof a===d?a.call(r,c):a),u(e,"allowActions")||(l=n.hooks.blockHelperMissing.call(s,l,c)),l!=null&&(p+=l),p+"</span>\n"},useData:!0});var k={};const f=T,w=f.template,P=f.templates=f.templates||{};P.result_form=w({1(n,s,e,i,o){let l;const a=n.lookupProperty||function(c,r){if(Object.prototype.hasOwnProperty.call(c,r))return c[r]};return'		<a href="#" class="delete icon icon-delete" title="'+n.escapeExpression((l=(l=a(e,"deleteTooltip")||(s!=null?a(s,"deleteTooltip"):s))!=null?l:n.hooks.helperMissing,typeof l=="function"?l.call(s!=null?s:n.nullContext||{},{name:"deleteTooltip",hash:{},data:o,loc:{start:{line:5,column:53},end:{line:5,column:70}}}):l))+'"></a>\n'},compiler:[8,">= 4.3.0"],main(n,s,e,i,o){let l,a;const c=s!=null?s:n.nullContext||{},r=n.hooks.helperMissing,m="function",d=n.escapeExpression,u=n.lookupProperty||function(p,g){if(Object.prototype.hasOwnProperty.call(p,g))return p[g]};return'<form class="systemtags-rename-form">\n	 <label class="hidden-visually" for="'+d((a=(a=u(e,"cid")||(s!=null?u(s,"cid"):s))!=null?a:r,typeof a===m?a.call(c,{name:"cid",hash:{},data:o,loc:{start:{line:2,column:38},end:{line:2,column:45}}}):a))+'-rename-input">'+d((a=(a=u(e,"renameLabel")||(s!=null?u(s,"renameLabel"):s))!=null?a:r,typeof a===m?a.call(c,{name:"renameLabel",hash:{},data:o,loc:{start:{line:2,column:60},end:{line:2,column:75}}}):a))+'</label>\n	<input id="'+d((a=(a=u(e,"cid")||(s!=null?u(s,"cid"):s))!=null?a:r,typeof a===m?a.call(c,{name:"cid",hash:{},data:o,loc:{start:{line:3,column:12},end:{line:3,column:19}}}):a))+'-rename-input" type="text" value="'+d((a=(a=u(e,"name")||(s!=null?u(s,"name"):s))!=null?a:r,typeof a===m?a.call(c,{name:"name",hash:{},data:o,loc:{start:{line:3,column:53},end:{line:3,column:61}}}):a))+'">\n'+((l=u(e,"if").call(c,s!=null?u(s,"isAdmin"):s,{name:"if",hash:{},fn:n.program(1,o,0),inverse:n.noop,data:o,loc:{start:{line:4,column:1},end:{line:6,column:8}}}))!=null?l:"")+"</form>\n"},useData:!0});var R={};const y=T,x=y.template,E=y.templates=y.templates||{};E.selection=x({1(n,s,e,i,o){let l,a;const c=n.lookupProperty||function(r,m){if(Object.prototype.hasOwnProperty.call(r,m))return r[m]};return'	<span class="label">'+((l=(a=(a=c(e,"tagMarkup")||(s!=null?c(s,"tagMarkup"):s))!=null?a:n.hooks.helperMissing,typeof a=="function"?a.call(s!=null?s:n.nullContext||{},{name:"tagMarkup",hash:{},data:o,loc:{start:{line:2,column:21},end:{line:2,column:36}}}):a))!=null?l:"")+"</span>\n"},3(n,s,e,i,o){let l;const a=n.lookupProperty||function(c,r){if(Object.prototype.hasOwnProperty.call(c,r))return c[r]};return'	<span class="label">'+n.escapeExpression((l=(l=a(e,"name")||(s!=null?a(s,"name"):s))!=null?l:n.hooks.helperMissing,typeof l=="function"?l.call(s!=null?s:n.nullContext||{},{name:"name",hash:{},data:o,loc:{start:{line:4,column:21},end:{line:4,column:29}}}):l))+"</span>\n"},compiler:[8,">= 4.3.0"],main(n,s,e,i,o){let l;const a=n.lookupProperty||function(c,r){if(Object.prototype.hasOwnProperty.call(c,r))return c[r]};return(l=a(e,"if").call(s!=null?s:n.nullContext||{},s!=null?a(s,"isAdmin"):s,{name:"if",hash:{},fn:n.program(1,o,0),inverse:n.program(3,o,0),data:o,loc:{start:{line:1,column:0},end:{line:5,column:7}}}))!=null?l:""},useData:!0}),function(n){var s=n.Backbone.View.extend({_rendered:!1,_newTag:null,_lastUsedTags:[],className:"systemTagsInputFieldContainer",template:function(e){return'<input class="systemTagsInputField" type="hidden" name="tags" value=""/>'},initialize:function(e){e=e||{},this._multiple=!!e.multiple,this._allowActions=_.isUndefined(e.allowActions)||!!e.allowActions,this._allowCreate=_.isUndefined(e.allowCreate)||!!e.allowCreate,this._isAdmin=!!e.isAdmin,_.isFunction(e.initSelection)&&(this._initSelection=e.initSelection),this.collection=e.collection||n.SystemTags.collection;var i=this;this.collection.on("change:name remove",function(){_.defer(i._refreshSelection)}),_.defer(_.bind(this._getLastUsedTags,this)),_.bindAll(this,"_refreshSelection","_onClickRenameTag","_onClickDeleteTag","_onSelectTag","_onDeselectTag","_onSubmitRenameTag")},_getLastUsedTags:function(){var e=this;$.ajax({type:"GET",url:n.generateUrl("/apps/systemtags/lastused"),success:function(i){e._lastUsedTags=i}})},_refreshSelection:function(){this.$tagsField.select2("val",this.$tagsField.val())},_onClickRenameTag:function(e){var i=$(e.target).closest(".systemtags-item"),o=i.attr("data-id"),l=this.collection.get(o),a=l.get("name"),c=$(k({cid:this.cid,name:a,deleteTooltip:t("core","Delete"),renameLabel:t("core","Rename"),isAdmin:this._isAdmin}));return i.find(".label").after(c),i.find(".label, .systemtags-actions").addClass("hidden"),i.closest(".select2-result").addClass("has-form"),c.find("[title]").tooltip({placement:"bottom",container:"body"}),c.find("input").focus().selectRange(0,a.length),!1},_onSubmitRenameTag:function(e){e.preventDefault();var i=$(e.target),o=i.closest(".systemtags-item"),l=o.attr("data-id"),a=this.collection.get(l),c=$(e.target).find("input").val().trim();c&&c!==a.get("name")&&(a.save({name:c}),o.find(".label").text(c)),o.find(".label, .systemtags-actions").removeClass("hidden"),i.remove(),o.closest(".select2-result").removeClass("has-form")},_onClickDeleteTag:function(e){var i=$(e.target).closest(".systemtags-item"),o=i.attr("data-id");return this.collection.get(o).destroy(),$(e.target).tooltip("option","hide"),i.closest(".select2-result").remove(),!1},_addToSelect2Selection:function(e){var i=this.$tagsField.select2("data");i.push(e),this.$tagsField.select2("data",i)},_onSelectTag:function(e){var i=this,o;if(e.object&&e.object.isNew)return o=this.collection.create({name:e.object.name.trim(),userVisible:!0,userAssignable:!0,canAssign:!0},{success:function(l){i._addToSelect2Selection(l.toJSON()),i._lastUsedTags.unshift(l.id),i.trigger("select",l)},error:function(l,a){a.status===409&&(i.collection.reset(),i.collection.fetch({success:function(c){var r=c.where({name:e.object.name.trim(),userVisible:!0,userAssignable:!0});r.length&&(r=r[0],i._addToSelect2Selection(r.toJSON()),i.trigger("select",r))}}))}}),this.$tagsField.select2("close"),e.preventDefault(),!1;o=this.collection.get(e.object.id),this._lastUsedTags.unshift(o.id),this._newTag=null,this.trigger("select",o)},_onDeselectTag:function(e){this.trigger("deselect",e.choice.id)},_queryTagsAutocomplete:function(e){var i=this;this.collection.fetch({success:function(o){var l=o.filterByName(e.term.trim());i._isAdmin||(l=_.filter(l,function(a){return a.get("canAssign")})),e.callback({results:_.invoke(l,"toJSON")})}})},_preventDefault:function(e){e.stopPropagation()},_formatDropDownResult:function(e){return v(_.extend({renameTooltip:t("core","Rename"),allowActions:this._allowActions,tagMarkup:this._isAdmin?n.SystemTags.getDescriptiveTag(e).innerHTML:null,isAdmin:this._isAdmin},e))},_formatSelection:function(e){return R(_.extend({tagMarkup:this._isAdmin?n.SystemTags.getDescriptiveTag(e).innerHTML:null,isAdmin:this._isAdmin},e))},_createSearchChoice:function(e){if(e=e.trim(),!this.collection.filter(function(i){return i.get("name")===e}).length)return this._newTag?this._newTag.name=e:this._newTag={id:-1,name:e,userAssignable:!0,userVisible:!0,canAssign:!0,isNew:!0},this._newTag},_initSelection:function(e,i){var o=this,l=$(e).val().split(",");function a(r){var m=r.toJSON();return!o._isAdmin&&!m.canAssign&&(m.locked=!0),m}function c(r){var m=o.collection.filter(function(d){return r.indexOf(d.id)>=0&&(o._isAdmin||d.get("userVisible"))});return _.map(m,a)}this.collection.fetch({success:function(){i(c(l))}})},render:function(){var e=this;this.$el.html(this.template()),this.$el.find("[title]").tooltip({placement:"bottom"}),this.$tagsField=this.$el.find("[name=tags]"),this.$tagsField.select2({placeholder:t("core","Collaborative tags"),containerCssClass:"systemtags-select2-container",dropdownCssClass:"systemtags-select2-dropdown",closeOnSelect:!1,allowClear:!1,multiple:this._multiple,toggleSelect:this._multiple,query:_.bind(this._queryTagsAutocomplete,this),id:function(o){return o.id},initSelection:_.bind(this._initSelection,this),formatResult:_.bind(this._formatDropDownResult,this),formatSelection:_.bind(this._formatSelection,this),createSearchChoice:this._allowCreate?_.bind(this._createSearchChoice,this):void 0,sortResults:function(o){var l=_.pluck(e.$tagsField.select2("data"),"id");return o.sort(function(a,c){var r=l.indexOf(a.id)>=0,m=l.indexOf(c.id)>=0;if(r===m){var d=e._lastUsedTags.indexOf(a.id),u=e._lastUsedTags.indexOf(c.id);return d!==u?u===-1?-1:d===-1?1:d<u?-1:1:n.Util.naturalSortCompare(a.name,c.name)}return r&&!m?-1:1}),o},formatNoMatches:function(){return t("core","No tags found")}}).on("select2-selecting",this._onSelectTag).on("select2-removing",this._onDeselectTag);var i=this.$tagsField.select2("dropdown");i.on("mouseup",".rename",this._onClickRenameTag),i.on("mouseup",".delete",this._onClickDeleteTag),i.on("mouseup",".select2-result-selectable.has-form",this._preventDefault),i.on("submit",".systemtags-rename-form",this._onSubmitRenameTag),this.delegateEvents()},remove:function(){this.$tagsField&&this.$tagsField.select2("destroy")},getValues:function(){this.$tagsField.select2("val")},setValues:function(e){this.$tagsField.select2("val",e)},setData:function(e){this.$tagsField.select2("data",e)}});n.SystemTags=n.SystemTags||{},n.SystemTags.SystemTagsInputField=s}(OC);
