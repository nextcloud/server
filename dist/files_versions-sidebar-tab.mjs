import{aw as ve,ax as fe,_ as $,F as y,o as f,I as H,G as k,t as V,z as U,k as P,q as L,l as me,s as C,d as p,A as D,aq as re,c as x,w as _,y as b,b as N,a as S,a3 as te,p as he,ay as ae,x as B,U as le,B as de,C as pe,D as ge,K as ne,a9 as be,J as we,az as ye,au as _e,P as Ce,Q as ke,a7 as X,e as Ae}from"./_plugin-vue_export-helper-sUpjG1-Y.chunk.mjs";import{t as se,N as Ve,h as He,v as Se,d as Y,s as G}from"./index-JpgrUA2Z-hoZOv0I-.chunk.mjs";import{N as Le}from"./mdi-BrEv6Slh.chunk.mjs";import{f as xe,P as Q}from"./index-BA-QMfCr.chunk.mjs";import{m as oe,N as Ie}from"./index-I0e37rkN.chunk.mjs";import{b as q,a as ze,_ as $e}from"./NcDateTime.vue_vue_type_script_setup_true_lang-BhB8yA4U-Cq-oANUr.chunk.mjs";import{N as Ee}from"./NcAvatar-DmUGApWA-HHJYMSvr.chunk.mjs";import{I as Oe,_ as Me}from"./TrashCanOutline-DMH4BocM.chunk.mjs";import{D as Te,s as Ne}from"./TrayArrowDown-ItfJEWXj.chunk.mjs";import{g as De}from"./string_decoder-CKkZVVJW.chunk.mjs";import{c as Re}from"./index-Cvjfo1ma.chunk.mjs";import{a as Be}from"./index-D8QEQJpI.chunk.mjs";import"./colors-Go3zmZRD-B3dC1KT2.chunk.mjs";import"./NcUserStatusIcon-CGEf7fej-CSAsMs-R.chunk.mjs";import"./NcInputField-Bwsh2aHY-fSb6LlM4.chunk.mjs";const qe='<svg xmlns="http://www.w3.org/2000/svg" id="mdi-backup-restore" viewBox="0 0 24 24"><path d="M12,3A9,9 0 0,0 3,12H0L4,16L8,12H5A7,7 0 0,1 12,5A7,7 0 0,1 19,12A7,7 0 0,1 12,19C10.5,19 9.09,18.5 7.94,17.7L6.5,19.14C8.04,20.3 9.94,21 12,21A9,9 0 0,0 21,12A9,9 0 0,0 12,3M14,12A2,2 0 0,0 12,10A2,2 0 0,0 10,12A2,2 0 0,0 12,14A2,2 0 0,0 14,12Z" /></svg>';var ee,ue;function Fe(){if(ue)return ee;ue=1;function i(e){if(typeof e!="string")throw new TypeError("Path must be a string. Received "+JSON.stringify(e))}function d(e,t){for(var s="",a=0,c=-1,o=0,r,v=0;v<=e.length;++v){if(v<e.length)r=e.charCodeAt(v);else{if(r===47)break;r=47}if(r===47){if(!(c===v-1||o===1))if(c!==v-1&&o===2){if(s.length<2||a!==2||s.charCodeAt(s.length-1)!==46||s.charCodeAt(s.length-2)!==46){if(s.length>2){var h=s.lastIndexOf("/");if(h!==s.length-1){h===-1?(s="",a=0):(s=s.slice(0,h),a=s.length-1-s.lastIndexOf("/")),c=v,o=0;continue}}else if(s.length===2||s.length===1){s="",a=0,c=v,o=0;continue}}t&&(s.length>0?s+="/..":s="..",a=2)}else s.length>0?s+="/"+e.slice(c+1,v):s=e.slice(c+1,v),a=v-c-1;c=v,o=0}else r===46&&o!==-1?++o:o=-1}return s}function n(e,t){var s=t.dir||t.root,a=t.base||(t.name||"")+(t.ext||"");return s?s===t.root?s+a:s+e+a:a}var l={resolve:function(){for(var e="",t=!1,s,a=arguments.length-1;a>=-1&&!t;a--){var c;a>=0?c=arguments[a]:(s===void 0&&(s=ve.cwd()),c=s),i(c),c.length!==0&&(e=c+"/"+e,t=c.charCodeAt(0)===47)}return e=d(e,!t),t?e.length>0?"/"+e:"/":e.length>0?e:"."},normalize:function(e){if(i(e),e.length===0)return".";var t=e.charCodeAt(0)===47,s=e.charCodeAt(e.length-1)===47;return e=d(e,!t),e.length===0&&!t&&(e="."),e.length>0&&s&&(e+="/"),t?"/"+e:e},isAbsolute:function(e){return i(e),e.length>0&&e.charCodeAt(0)===47},join:function(){if(arguments.length===0)return".";for(var e,t=0;t<arguments.length;++t){var s=arguments[t];i(s),s.length>0&&(e===void 0?e=s:e+="/"+s)}return e===void 0?".":l.normalize(e)},relative:function(e,t){if(i(e),i(t),e===t||(e=l.resolve(e),t=l.resolve(t),e===t))return"";for(var s=1;s<e.length&&e.charCodeAt(s)===47;++s);for(var a=e.length,c=a-s,o=1;o<t.length&&t.charCodeAt(o)===47;++o);for(var r=t.length,v=r-o,h=c<v?c:v,w=-1,m=0;m<=h;++m){if(m===h){if(v>h){if(t.charCodeAt(o+m)===47)return t.slice(o+m+1);if(m===0)return t.slice(o+m)}else c>h&&(e.charCodeAt(s+m)===47?w=m:m===0&&(w=0));break}var E=e.charCodeAt(s+m),O=t.charCodeAt(o+m);if(E!==O)break;E===47&&(w=m)}var I="";for(m=s+w+1;m<=a;++m)(m===a||e.charCodeAt(m)===47)&&(I.length===0?I+="..":I+="/..");return I.length>0?I+t.slice(o+w):(o+=w,t.charCodeAt(o)===47&&++o,t.slice(o))},_makeLong:function(e){return e},dirname:function(e){if(i(e),e.length===0)return".";for(var t=e.charCodeAt(0),s=t===47,a=-1,c=!0,o=e.length-1;o>=1;--o)if(t=e.charCodeAt(o),t===47){if(!c){a=o;break}}else c=!1;return a===-1?s?"/":".":s&&a===1?"//":e.slice(0,a)},basename:function(e,t){if(t!==void 0&&typeof t!="string")throw new TypeError('"ext" argument must be a string');i(e);var s=0,a=-1,c=!0,o;if(t!==void 0&&t.length>0&&t.length<=e.length){if(t.length===e.length&&t===e)return"";var r=t.length-1,v=-1;for(o=e.length-1;o>=0;--o){var h=e.charCodeAt(o);if(h===47){if(!c){s=o+1;break}}else v===-1&&(c=!1,v=o+1),r>=0&&(h===t.charCodeAt(r)?--r===-1&&(a=o):(r=-1,a=v))}return s===a?a=v:a===-1&&(a=e.length),e.slice(s,a)}else{for(o=e.length-1;o>=0;--o)if(e.charCodeAt(o)===47){if(!c){s=o+1;break}}else a===-1&&(c=!1,a=o+1);return a===-1?"":e.slice(s,a)}},extname:function(e){i(e);for(var t=-1,s=0,a=-1,c=!0,o=0,r=e.length-1;r>=0;--r){var v=e.charCodeAt(r);if(v===47){if(!c){s=r+1;break}continue}a===-1&&(c=!1,a=r+1),v===46?t===-1?t=r:o!==1&&(o=1):t!==-1&&(o=-1)}return t===-1||a===-1||o===0||o===1&&t===a-1&&t===s+1?"":e.slice(t,a)},format:function(e){if(e===null||typeof e!="object")throw new TypeError('The "pathObject" argument must be of type Object. Received type '+typeof e);return n("/",e)},parse:function(e){i(e);var t={root:"",dir:"",base:"",ext:"",name:""};if(e.length===0)return t;var s=e.charCodeAt(0),a=s===47,c;a?(t.root="/",c=1):c=0;for(var o=-1,r=0,v=-1,h=!0,w=e.length-1,m=0;w>=c;--w){if(s=e.charCodeAt(w),s===47){if(!h){r=w+1;break}continue}v===-1&&(h=!1,v=w+1),s===46?o===-1?o=w:m!==1&&(m=1):o!==-1&&(m=-1)}return o===-1||v===-1||m===0||m===1&&o===v-1&&o===r+1?v!==-1&&(r===0&&a?t.base=t.name=e.slice(1,v):t.base=t.name=e.slice(r,v)):(r===0&&a?(t.name=e.slice(1,o),t.base=e.slice(1,v)):(t.name=e.slice(r,o),t.base=e.slice(r,v)),t.ext=e.slice(o,v)),r>0?t.dir=e.slice(0,r-1):a&&(t.dir="/"),t},sep:"/",delimiter:":",win32:null,posix:null};return l.posix=l,ee=l,ee}var Ue=Fe();const Pe=fe(Ue),je={name:"BackupRestoreIcon",emits:["click"],props:{title:{type:String},fillColor:{type:String,default:"currentColor"},size:{type:Number,default:24}}},We=["aria-hidden","aria-label"],Ke=["fill","width","height"],Ze={d:"M12,3A9,9 0 0,0 3,12H0L4,16L8,12H5A7,7 0 0,1 12,5A7,7 0 0,1 19,12A7,7 0 0,1 12,19C10.5,19 9.09,18.5 7.94,17.7L6.5,19.14C8.04,20.3 9.94,21 12,21A9,9 0 0,0 21,12A9,9 0 0,0 12,3M14,12A2,2 0 0,0 12,10A2,2 0 0,0 10,12A2,2 0 0,0 12,14A2,2 0 0,0 14,12Z"},Je={key:0};function Xe(i,d,n,l,e,t){return f(),y("span",U(i.$attrs,{"aria-hidden":n.title?null:"true","aria-label":n.title,class:"material-design-icon backup-restore-icon",role:"img",onClick:d[0]||(d[0]=s=>i.$emit("click",s))}),[(f(),y("svg",{fill:n.fillColor,class:"material-design-icon__svg",width:n.size,height:n.size,viewBox:"0 0 24 24"},[H("path",Ze,[n.title?(f(),y("title",Je,V(n.title),1)):k("",!0)])],8,Ke))],16,We)}const Ye=$(je,[["render",Xe]]),Ge={name:"FileCompareIcon",emits:["click"],props:{title:{type:String},fillColor:{type:String,default:"currentColor"},size:{type:Number,default:24}}},Qe=["aria-hidden","aria-label"],ei=["fill","width","height"],ii={d:"M10,18H6V16H10V18M10,14H6V12H10V14M10,1V2H6C4.89,2 4,2.89 4,4V20A2,2 0 0,0 6,22H10V23H12V1H10M20,8V20C20,21.11 19.11,22 18,22H14V20H18V11H14V9H18.5L14,4.5V2L20,8M16,14H14V12H16V14M16,18H14V16H16V18Z"},ti={key:0};function ni(i,d,n,l,e,t){return f(),y("span",U(i.$attrs,{"aria-hidden":n.title?null:"true","aria-label":n.title,class:"material-design-icon file-compare-icon",role:"img",onClick:d[0]||(d[0]=s=>i.$emit("click",s))}),[(f(),y("svg",{fill:n.fillColor,class:"material-design-icon__svg",width:n.size,height:n.size,viewBox:"0 0 24 24"},[H("path",ii,[n.title?(f(),y("title",ti,V(n.title),1)):k("",!0)])],8,ei))],16,Qe)}const si=$(Ge,[["render",ni]]),oi={name:"ImageOffOutlineIcon",emits:["click"],props:{title:{type:String},fillColor:{type:String,default:"currentColor"},size:{type:Number,default:24}}},ri=["aria-hidden","aria-label"],ai=["fill","width","height"],li={d:"M22 20.7L3.3 2L2 3.3L3 4.3V19C3 20.1 3.9 21 5 21H19.7L20.7 22L22 20.7M5 19V6.3L12.6 13.9L11.1 15.8L9 13.1L6 17H15.7L17.7 19H5M8.8 5L6.8 3H19C20.1 3 21 3.9 21 5V17.2L19 15.2V5H8.8"},ui={key:0};function ci(i,d,n,l,e,t){return f(),y("span",U(i.$attrs,{"aria-hidden":n.title?null:"true","aria-label":n.title,class:"material-design-icon image-off-outline-icon",role:"img",onClick:d[0]||(d[0]=s=>i.$emit("click",s))}),[(f(),y("svg",{fill:n.fillColor,class:"material-design-icon__svg",width:n.size,height:n.size,viewBox:"0 0 24 24"},[H("path",li,[n.title?(f(),y("title",ui,V(n.title),1)):k("",!0)])],8,ai))],16,ri)}const di=$(oi,[["render",ci]]),vi={name:"PencilOutlineIcon",emits:["click"],props:{title:{type:String},fillColor:{type:String,default:"currentColor"},size:{type:Number,default:24}}},fi=["aria-hidden","aria-label"],mi=["fill","width","height"],hi={d:"M14.06,9L15,9.94L5.92,19H5V18.08L14.06,9M17.66,3C17.41,3 17.15,3.1 16.96,3.29L15.13,5.12L18.88,8.87L20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18.17,3.09 17.92,3 17.66,3M14.06,6.19L3,17.25V21H6.75L17.81,9.94L14.06,6.19Z"},pi={key:0};function gi(i,d,n,l,e,t){return f(),y("span",U(i.$attrs,{"aria-hidden":n.title?null:"true","aria-label":n.title,class:"material-design-icon pencil-outline-icon",role:"img",onClick:d[0]||(d[0]=s=>i.$emit("click",s))}),[(f(),y("svg",{fill:n.fillColor,class:"material-design-icon__svg",width:n.size,height:n.size,viewBox:"0 0 24 24"},[H("path",hi,[n.title?(f(),y("title",pi,V(n.title),1)):k("",!0)])],8,mi))],16,fi)}const bi=$(vi,[["render",gi]]),wi={key:0,class:"version__image"},yi=["src"],_i={key:2,class:"version__image"},Ci={class:"version__info"},ki=["title"],Ai={key:1,class:"version__info","data-cy-files-version-author-name":""},Vi={key:0},Hi=["title"],Si={class:"version__info version__info__subline"},Li=P({__name:"VersionEntry",props:{version:{type:Object,required:!0},fileInfo:{type:Object,required:!0},isCurrent:{type:Boolean,default:!1},isFirstVersion:{type:Boolean,default:!1},loadPreview:{type:Boolean,default:!1},canView:{type:Boolean,default:!1},canCompare:{type:Boolean,default:!1}},emits:["click","compare","restore","delete","label-update-request"],setup(i,{emit:d}){const n=i,l=d,e=(u,g)=>(u&g)!==0,t=L(!1),s=L(!1),a=L(me("core","capabilities",{files:{version_labeling:!1,version_deletion:!1}})),c=C(()=>xe(n.version.size)),o=C(()=>{const u=n.version.label??"";return n.isCurrent?u===""?p("files_versions","Current version"):`${u} (${p("files_versions","Current version")})`:n.isFirstVersion&&u===""?p("files_versions","Initial version"):u}),r=C(()=>!n.version.author||!n.version.authorName?"":n.version.author===D()?.uid?p("files_versions","You"):n.version.authorName??n.version.author),v=C(()=>oe(n.version.mtime).format("LLLL")),h=C(()=>n.isCurrent?re()+se("/remote.php/webdav",n.fileInfo.path,n.fileInfo.name):re()+n.version.url),w=C(()=>a.value.files.version_labeling===!0),m=C(()=>a.value.files.version_deletion===!0),E=C(()=>e(n.fileInfo.permissions,Q.DELETE)),O=C(()=>e(n.fileInfo.permissions,Q.UPDATE)),I=C(()=>!((n.fileInfo.permissions&Q.READ)===0||n.fileInfo.mountType==="shared"&&(n.fileInfo.shareAttributes.find(u=>u.scope==="permissions"&&u.key==="download")||{})?.value===!1));function j(){l("label-update-request")}function W(){l("restore",n.version)}async function K(){await te(),await te(),l("delete",n.version)}function Z(){if(!n.canView){window.location.href=h.value;return}l("click",{version:n.version})}function J(){if(!n.canView)throw new Error("Cannot compare version of this file");l("compare",{version:n.version})}return(u,g)=>(f(),x(b(Ie),{class:"version","force-display-actions":!0,"actions-aria-label":b(p)("files_versions","Actions for version from {versionHumanExplicitDate}",{versionHumanExplicitDate:v.value}),"data-files-versions-version":i.version.fileVersion,onClick:Z},{icon:_(()=>[i.loadPreview||t.value?i.version.previewUrl&&!s.value?(f(),y("img",{key:1,src:i.version.previewUrl,alt:"",decoding:"async",fetchpriority:"low",loading:"lazy",class:"version__image",onLoad:g[0]||(g[0]=A=>t.value=!0),onError:g[1]||(g[1]=A=>s.value=!0)},null,40,yi)):(f(),y("div",_i,[S(di,{size:20})])):(f(),y("div",wi))]),name:_(()=>[H("div",Ci,[o.value?(f(),y("div",{key:0,class:"version__info__label","data-cy-files-version-label":"",title:o.value},V(o.value),9,ki)):k("",!0),r.value?(f(),y("div",Ai,[o.value?(f(),y("span",Vi,"•")):k("",!0),S(b(Ee),{class:"avatar",user:i.version.author??void 0,size:20,"disable-menu":"","disable-tooltip":"","hide-status":""},null,8,["user"]),H("div",{class:"version__info__author_name",title:r.value},V(r.value),9,Hi)])):k("",!0)])]),subname:_(()=>[H("div",Si,[S(b($e),{class:"version__info__date","relative-time":"short",timestamp:i.version.mtime},null,8,["timestamp"]),g[2]||(g[2]=H("span",null,"•",-1)),H("span",null,V(c.value),1)])]),actions:_(()=>[w.value&&O.value?(f(),x(b(q),{key:0,"data-cy-files-versions-version-action":"label","close-after-click":!0,onClick:j},{icon:_(()=>[S(bi,{size:22})]),default:_(()=>[N(" "+V(i.version.label===""?b(p)("files_versions","Name this version"):b(p)("files_versions","Edit version name")),1)]),_:1})):k("",!0),!i.isCurrent&&i.canView&&i.canCompare?(f(),x(b(q),{key:1,"data-cy-files-versions-version-action":"compare","close-after-click":!0,onClick:J},{icon:_(()=>[S(si,{size:22})]),default:_(()=>[N(" "+V(b(p)("files_versions","Compare to current version")),1)]),_:1})):k("",!0),!i.isCurrent&&O.value?(f(),x(b(q),{key:2,"data-cy-files-versions-version-action":"restore","close-after-click":!0,onClick:W},{icon:_(()=>[S(Ye,{size:22})]),default:_(()=>[N(" "+V(b(p)("files_versions","Restore version")),1)]),_:1})):k("",!0),I.value?(f(),x(b(ze),{key:3,"data-cy-files-versions-version-action":"download",href:h.value,"close-after-click":!0,download:h.value},{icon:_(()=>[S(Te,{size:22})]),default:_(()=>[N(" "+V(b(p)("files_versions","Download version")),1)]),_:1},8,["href","download"])):k("",!0),!i.isCurrent&&m.value&&E.value?(f(),x(b(q),{key:4,"data-cy-files-versions-version-action":"delete","close-after-click":!0,onClick:K},{icon:_(()=>[S(Oe,{size:22})]),default:_(()=>[N(" "+V(b(p)("files_versions","Delete version")),1)]),_:1})):k("",!0)]),_:1},8,["actions-aria-label","data-files-versions-version"]))}}),xi=$(Li,[["__scopeId","data-v-4088eb3b"]]),Ii={class:"version-label-modal__info"},zi=P({__name:"VersionLabelDialog",props:{open:{type:Boolean,default:!1},label:{type:String,default:""}},emits:["update:open","update:label"],setup(i,{emit:d}){const n=i,l=d,e=he("labelInput"),t=L(""),s=C(()=>{const c=[];return n.label.trim()===""?c.push({label:p("files_versions","Cancel")}):c.push({label:p("files_versions","Remove version name"),type:"reset",variant:"error",callback:()=>{a("")}}),[...c,{label:p("files_versions","Save version name"),icon:Ne,type:"submit",variant:"primary"}]});ae(()=>{t.value=n.label??""}),ae(()=>{n.open&&te(()=>e.value?.focus()),t.value=n.label});function a(c){l("update:label",c)}return(c,o)=>(f(),x(b(Ve),{buttons:s.value,"content-classes":"version-label-modal","is-form":"",open:i.open,size:"normal",name:b(p)("files_versions","Name this version"),"onUpdate:open":o[1]||(o[1]=r=>c.$emit("update:open",r)),onSubmit:o[2]||(o[2]=r=>a(t.value))},{default:_(()=>[S(b(Me),{ref_key:"labelInput",ref:e,modelValue:t.value,"onUpdate:modelValue":o[0]||(o[0]=r=>t.value=r),class:"version-label-modal__input",label:b(p)("files_versions","Version name"),placeholder:b(p)("files_versions","Version name")},null,8,["modelValue","label","placeholder"]),H("p",Ii,V(b(p)("files_versions","Named versions are persisted, and excluded from automatic cleanups when your storage quota is full.")),1)]),_:1},8,["buttons","open","name"]))}}),$i=$(zi,[["__scopeId","data-v-6a69577b"]]),z=De().setApp("files_version").detectUser().build(),Ei=P({name:"VirtualScrolling",props:{sections:{type:Array,required:!0},containerElement:{type:HTMLElement,default:null},useWindow:{type:Boolean,default:!1},headerHeight:{type:Number,default:75},renderDistance:{type:Number,default:.5},bottomBufferRatio:{type:Number,default:2},scrollToKey:{type:String,default:""}},emits:["need-content"],data(){return{scrollPosition:0,containerHeight:0,rowsContainerHeight:0,resizeObserver:null}},computed:{visibleSections(){z.debug("[VirtualScrolling] Computing visible section",{sections:this.sections});const i=this.containerHeight,d=this.scrollPosition,n=d+i;let l=0,e=0;const t=this.sections.map(r=>(e+=this.headerHeight,{...r,rows:r.rows.reduce((v,h)=>{l=e,e+=h.height;let w=0;return e<d?w=(d-e)/i:l>n&&(w=(l-n)/i),w>this.renderDistance?v:[...v,{...h,distance:w}]},[])})).filter(r=>r.rows.length>0),s=t.flatMap(({rows:r})=>r).flatMap(({items:r})=>r),a=this._rowIdToKeyMap;s.forEach(r=>r.key=a[r.id]);const c=s.map(({key:r})=>r).filter(r=>r!==void 0),o=Object.values(a).filter(r=>!c.includes(r));return s.filter(({key:r})=>r===void 0).forEach(r=>r.key=o.pop()??Math.random().toString(36).substr(2)),this._rowIdToKeyMap=s.reduce((r,{id:v,key:h})=>({...r,[`${v}`]:h}),{}),t},totalHeight(){return this.sections.map(i=>this.headerHeight+i.height).reduce((i,d)=>i+d,0)+0},paddingTop(){if(this.visibleSections.length===0)return 0;let i=0;for(const d of this.sections){if(d.key!==this.visibleSections[0].rows[0].sectionKey){i+=this.headerHeight+d.height;continue}for(const n of d.rows){if(n.key===this.visibleSections[0].rows[0].key)return i;i+=n.height}i+=this.headerHeight}return i},rowsContainerStyle(){return{height:`${this.totalHeight}px`,paddingTop:`${this.paddingTop}px`}},isNearBottom(){const i=this.containerHeight*this.bottomBufferRatio;return this.scrollPosition+this.containerHeight>=this.totalHeight-i},container(){return z.debug("[VirtualScrolling] Computing container"),this.containerElement!==null?this.containerElement:this.useWindow?window:this.$refs.container}},watch:{isNearBottom(i){z.debug("[VirtualScrolling] isNearBottom changed",{value:i}),i&&this.$emit("need-content")},visibleSections(){this.isNearBottom&&this.$emit("need-content")},scrollToKey(i){let d=0;for(const n of this.sections){if(n.key!==i){d+=this.headerHeight+n.height;continue}break}z.debug("[VirtualScrolling] Scrolling to",{currentRowTopDistanceFromTop:d}),this.container.scrollTo({top:d,behavior:"smooth"})}},beforeCreate(){this._rowIdToKeyMap={}},mounted(){this.resizeObserver=new ResizeObserver(i=>{for(const d of i){const n=d.contentRect;d.target===this.container&&(this.containerHeight=n.height),d.target.classList.contains("vs-rows-container")&&(this.rowsContainerHeight=n.height)}}),this.useWindow?(window.addEventListener("resize",this.updateContainerSize,{passive:!0}),this.containerHeight=window.innerHeight):this.resizeObserver.observe(this.container),this.resizeObserver.observe(this.$refs.rowsContainer),this.container.addEventListener("scroll",this.updateScrollPosition,{passive:!0})},beforeUnmount(){this.useWindow&&window.removeEventListener("resize",this.updateContainerSize),this.resizeObserver?.disconnect(),this.container.removeEventListener("scroll",this.updateScrollPosition)},methods:{updateScrollPosition(){this._onScrollHandle??=requestAnimationFrame(()=>{this._onScrollHandle=null,this.useWindow?this.scrollPosition=this.container.scrollY:this.scrollPosition=this.container.scrollTop})},updateContainerSize(){this.containerHeight=window.innerHeight}}}),Oi={key:0,ref:"container",class:"vs-container"};function Mi(i,d,n,l,e,t){return!i.useWindow&&i.containerElement===null?(f(),y("div",Oi,[H("div",{ref:"rowsContainer",class:"vs-rows-container",style:le(i.rowsContainerStyle)},[B(i.$slots,"default",{visibleSections:i.visibleSections},void 0,!0),B(i.$slots,"loader",{},void 0,!0)],4)],512)):(f(),y("div",{key:1,ref:"rowsContainer",class:"vs-rows-container",style:le(i.rowsContainerStyle)},[B(i.$slots,"default",{visibleSections:i.visibleSections},void 0,!0),B(i.$slots,"loader",{},void 0,!0)],4))}const Ti=$(Ei,[["render",Mi],["__scopeId","data-v-b0f92288"]]),Ni="dav",Di=de(Ni),R=Be(Di);function ce(i){R.setHeaders({"X-Requested-With":"XMLHttpRequest",requesttoken:i??""})}ge(ce),ce(pe());const Ri=`<?xml version="1.0"?>
<d:propfind xmlns:d="DAV:"
	xmlns:oc="http://owncloud.org/ns"
	xmlns:nc="http://nextcloud.org/ns"
	xmlns:ocs="http://open-collaboration-services.org/ns">
	<d:prop>
		<d:getcontentlength />
		<d:getcontenttype />
		<d:getlastmodified />
		<d:getetag />
		<nc:version-label />
		<nc:version-author />
		<nc:has-preview />
	</d:prop>
</d:propfind>`;async function ie(i){const d=`/versions/${D()?.uid}/versions/${i.id}`;try{const n=(await R.getDirectoryContents(d,{data:Ri,details:!0})).data.filter(({mime:t})=>t!=="").map(t=>qi(t,i)),l=new Set(n.map(t=>String(t.author))),e=await Re.post(ne("/displaynames"),{users:[...l]});for(const t of n){const s=e.data.users[t.author??""];s&&(t.authorName=s)}return n}catch(n){throw z.error("Could not fetch version",{exception:n}),n}}async function Bi(i){try{z.debug("Restoring version",{url:i.url}),await R.moveFile(`/versions/${D()?.uid}/versions/${i.fileId}/${i.fileVersion}`,`/versions/${D()?.uid}/restore/target`)}catch(d){throw z.error("Could not restore version",{exception:d}),d}}function qi(i,d){const n=oe(i.lastmod).unix()*1e3;let l="";return n===d.mtime?l=ne("/core/preview?fileId={fileId}&c={fileEtag}&x=250&y=250&forceIcon=0&a=0&forceIcon=1&mimeFallback=1",{fileId:d.id,fileEtag:d.etag}):l=ne("/apps/files_versions/preview?file={file}&version={fileVersion}&mimeFallback=1",{file:se(d.path,d.name),fileVersion:i.basename}),{fileId:d.id,label:i.props["version-label"]?String(i.props["version-label"]):"",author:i.props["version-author"]?String(i.props["version-author"]):null,authorName:null,filename:i.filename,basename:oe(n).format("LLL"),mime:i.mime,etag:`${i.props.getetag}`,size:i.size,type:i.type,mtime:n,permissions:"R",previewUrl:l,url:se("/remote.php/dav",i.filename),source:de("dav")+He(i.filename),fileVersion:i.basename}}async function Fi(i,d){return await R.customRequest(i.filename,{method:"PROPPATCH",data:`<?xml version="1.0"?>
					<d:propertyupdate xmlns:d="DAV:"
						xmlns:oc="http://owncloud.org/ns"
						xmlns:nc="http://nextcloud.org/ns"
						xmlns:ocs="http://open-collaboration-services.org/ns">
					<d:set>
						<d:prop>
							<nc:version-label>${d}</nc:version-label>
						</d:prop>
					</d:set>
					</d:propertyupdate>`})}async function Ui(i){await R.deleteFile(i.filename)}const Pi={key:0,class:"versions-tab__container"},ji=["aria-label"],Wi=P({__name:"FilesVersionsSidebarTab",setup(i,{expose:d}){const n=Se(),l=L(null),e=L(!1),t=L([]),s=L(!1),a=L(!1),c=L(null),o=C(()=>[...t.value].sort((u,g)=>l.value===null?0:u.mtime===l.value.mtime?-1:g.mtime===l.value.mtime?1:g.mtime-u.mtime)),r=C(()=>[{key:"versions",rows:o.value.map(u=>({key:u.mtime.toString(),height:68,sectionKey:"versions",items:[{id:u.mtime.toString(),version:u}]})),height:68*o.value.length}]),v=C(()=>t.value.map(u=>u.mtime).reduce((u,g)=>Math.min(u,g))),h=C(()=>{if(l.value===null)return null;let u="";return l.value.permissions&1&&(u+="R"),l.value.permissions&2&&(u+="W"),l.value.permissions&8&&(u+="D"),{...l.value,mime:l.value.mimetype,basename:l.value.name,filename:l.value.path+"/"+l.value.name,permissions:u,fileid:l.value.id}}),w=C(()=>l.value===null?!1:window.OCA.Viewer?.mimetypesCompare?.includes(l.value.mimetype)),m=C(()=>!n.value);be(()=>{we("files_versions:restore:restored",ie)}),ye(()=>{_e("files_versions:restore:restored",ie)}),d({async update(u){l.value=u,K(),E()},async setIsActive(u){e.value=u}});async function E(){try{s.value=!0,t.value=await ie(l.value)}finally{s.value=!1}}async function O(u){const g=l.value;l.value={...l.value,size:u.size,mtime:u.mtime};const A={preventDefault:!1,fileInfo:l.value,version:u};if(X("files_versions:restore:requested",A),!A.preventDefault)try{await Bi(u),u.label?Y(p("files_versions",`${u.label} restored`)):u.mtime===v.value?Y(p("files_versions","Initial version restored")):Y(p("files_versions","Version restored")),X("files_versions:restore:restored",u)}catch{l.value=g,G(p("files_versions","Could not restore version")),X("files_versions:restore:failed",u)}}function I(u){a.value=!0,c.value=u}async function j(u){if(c.value===null)throw new Error("editedVersion should be set at that point");const g=c.value.label;c.value.label=u,a.value=!1;try{await Fi(c.value,u),c.value=null}catch(A){c.value.label=g,G(p("files_versions","Could not set version label")),z.error("Could not set version label",{exception:A})}}async function W(u){const g=t.value.indexOf(u);t.value.splice(g,1);try{await Ui(u)}catch{t.value.push(u),G(p("files_versions","Could not delete version"))}}function K(){t.value=[]}function Z({version:u}){if(l.value!==null){if(u.mtime===l.value.mtime){window.OCA.Viewer.open({fileInfo:h.value});return}window.OCA.Viewer.open({fileInfo:{...u,filename:u.mtime===l.value.mtime?Pe.join("files",D()?.uid??"",l.value.path,l.value.name):u.filename,previewUrl:void 0},enableSidebar:!1})}}function J({version:u}){const g=t.value.map(A=>({...A,previewUrl:void 0}));window.OCA.Viewer.compare(h.value,g.find(A=>A.source===u.source))}return(u,g)=>l.value!==null?(f(),y("div",Pi,[S(Ti,{sections:r.value,"header-height":0},{default:_(({visibleSections:A})=>[H("ul",{"aria-label":b(p)("files_versions","File versions"),"data-files-versions-versions-list":""},[A.length===1?(f(!0),y(Ce,{key:0},ke(A[0].rows,T=>(f(),x(xi,{key:T.items[0].version.mtime,"can-view":w.value,"can-compare":m.value,"load-preview":e.value,version:T.items[0].version,"file-info":l.value,"is-current":T.items[0].version.mtime===l.value.mtime,"is-first-version":T.items[0].version.mtime===v.value,onClick:Z,onCompare:J,onRestore:O,onLabelUpdateRequest:Ki=>I(T.items[0].version),onDelete:W},null,8,["can-view","can-compare","load-preview","version","file-info","is-current","is-first-version","onLabelUpdateRequest"]))),128)):k("",!0)],8,ji)]),loader:_(()=>[s.value?(f(),x(b(Le),{key:0,class:"files-list-viewer__loader"})):k("",!0)]),_:1},8,["sections"]),c.value?(f(),x($i,{key:0,open:a.value,"onUpdate:open":g[0]||(g[0]=A=>a.value=A),label:c.value.label,"onUpdate:label":j},null,8,["open","label"])):k("",!0)])):k("",!0)}});let M=null,F=null;window.addEventListener("DOMContentLoaded",function(){window.OCA.Files?.Sidebar!==void 0&&window.OCA.Files.Sidebar.registerTab(new window.OCA.Files.Sidebar.Tab({id:"files_versions",name:p("files_versions","Versions"),iconSvg:qe,async mount(i,d){M&&M.unmount(),M=Ae(Wi),F=M.mount(i),F.update(d)},update(i){F.update(i)},setIsActive(i){F?.setIsActive(i)},destroy(){M?.unmount(),M=null},enabled(i){return!(i?.isDirectory()??!0)}}))});
//# sourceMappingURL=files_versions-sidebar-tab.mjs.map
