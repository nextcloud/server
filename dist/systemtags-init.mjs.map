{"version":3,"file":"systemtags-init.mjs","sources":["../apps/systemtags/src/actions/inlineSystemTagsAction.ts","../apps/systemtags/src/services/systemtags.ts","../apps/systemtags/src/init.ts"],"sourcesContent":["/**\n * SPDX-FileCopyrightText: 2023 Nextcloud GmbH and Nextcloud contributors\n * SPDX-License-Identifier: AGPL-3.0-or-later\n */\nimport { FileAction, Node, registerDavProperty, registerFileAction } from '@nextcloud/files'\nimport { translate as t } from '@nextcloud/l10n'\n\nimport '../css/fileEntryInlineSystemTags.scss'\n\nconst getNodeSystemTags = function(node: Node): string[] {\n\tconst tags = node.attributes?.['system-tags']?.['system-tag'] as string|string[]|undefined\n\n\tif (tags === undefined) {\n\t\treturn []\n\t}\n\n\treturn [tags].flat()\n}\n\nconst renderTag = function(tag: string, isMore = false): HTMLElement {\n\tconst tagElement = document.createElement('li')\n\ttagElement.classList.add('files-list__system-tag')\n\ttagElement.textContent = tag\n\n\tif (isMore) {\n\t\ttagElement.classList.add('files-list__system-tag--more')\n\t}\n\n\treturn tagElement\n}\n\nexport const action = new FileAction({\n\tid: 'system-tags',\n\tdisplayName: () => '',\n\ticonSvgInline: () => '',\n\n\tenabled(nodes: Node[]) {\n\t\t// Only show the action on single nodes\n\t\tif (nodes.length !== 1) {\n\t\t\treturn false\n\t\t}\n\n\t\tconst node = nodes[0]\n\t\tconst tags = getNodeSystemTags(node)\n\n\t\t// Only show the action if the node has system tags\n\t\tif (tags.length === 0) {\n\t\t\treturn false\n\t\t}\n\n\t\treturn true\n\t},\n\n\texec: async () => null,\n\n\tasync renderInline(node: Node) {\n\t\t// Ensure we have the system tags as an array\n\t\tconst tags = getNodeSystemTags(node)\n\n\t\tif (tags.length === 0) {\n\t\t\treturn null\n\t\t}\n\n\t\tconst systemTagsElement = document.createElement('ul')\n\t\tsystemTagsElement.classList.add('files-list__system-tags')\n\n\t\tif (tags.length === 1) {\n\t\t\tsystemTagsElement.setAttribute('aria-label', t('files', 'This file has the tag {tag}', { tag: tags[0] }))\n\t\t} else {\n\t\t\tconst firstTags = tags.slice(0, -1).join(', ')\n\t\t\tconst lastTag = tags[tags.length - 1]\n\t\t\tsystemTagsElement.setAttribute('aria-label', t('files', 'This file has the tags {firstTags} and {lastTag}', { firstTags, lastTag }))\n\t\t}\n\n\t\tsystemTagsElement.append(renderTag(tags[0]))\n\n\t\t// More tags than the one we're showing\n\t\tif (tags.length > 1) {\n\t\t\tconst moreTagElement = renderTag('+' + (tags.length - 1), true)\n\t\t\tmoreTagElement.setAttribute('title', tags.slice(1).join(', '))\n\t\t\tsystemTagsElement.append(moreTagElement)\n\t\t}\n\n\t\treturn systemTagsElement\n\t},\n\n\torder: 0,\n})\n\nregisterDavProperty('nc:system-tags')\nregisterFileAction(action)\n","/**\n * SPDX-FileCopyrightText: 2023 Nextcloud GmbH and Nextcloud contributors\n * SPDX-License-Identifier: AGPL-3.0-or-later\n */\nimport type { ContentsWithRoot } from '@nextcloud/files'\nimport type { FileStat, ResponseDataDetailed } from 'webdav'\nimport type { TagWithId } from '../types'\n\nimport { Folder, Permission, getDavNameSpaces, getDavProperties, davGetClient, davResultToNode } from '@nextcloud/files'\nimport { generateRemoteUrl } from '@nextcloud/router'\nimport { getCurrentUser } from '@nextcloud/auth'\n\nimport { fetchTags } from './api'\n\nconst client = davGetClient()\nconst resultToNode = (node: FileStat) => davResultToNode(node)\n\nconst formatReportPayload = (tagId: number) => `<?xml version=\"1.0\"?>\n<oc:filter-files ${getDavNameSpaces()}>\n\t<d:prop>\n\t\t${getDavProperties()}\n\t</d:prop>\n    <oc:filter-rules>\n        <oc:systemtag>${tagId}</oc:systemtag>\n    </oc:filter-rules>\n</oc:filter-files>`\n\nconst tagToNode = function(tag: TagWithId): Folder {\n\treturn new Folder({\n\t\tid: tag.id,\n\t\tsource: generateRemoteUrl('dav/systemtags/' + tag.id),\n\t\towner: getCurrentUser()?.uid as string,\n\t\troot: '/systemtags',\n\t\tpermissions: Permission.READ,\n\t\tattributes: {\n\t\t\t...tag,\n\t\t\t'is-tag': true,\n\t\t},\n\t})\n}\n\nexport const getContents = async (path = '/'): Promise<ContentsWithRoot> => {\n\t// List tags in the root\n\tconst tagsCache = (await fetchTags()).filter(tag => tag.userVisible) as TagWithId[]\n\n\tif (path === '/') {\n\t\treturn {\n\t\t\tfolder: new Folder({\n\t\t\t\tid: 0,\n\t\t\t\tsource: generateRemoteUrl('dav/systemtags'),\n\t\t\t\towner: getCurrentUser()?.uid as string,\n\t\t\t\troot: '/systemtags',\n\t\t\t\tpermissions: Permission.NONE,\n\t\t\t}),\n\t\t\tcontents: tagsCache.map(tagToNode),\n\t\t}\n\t}\n\n\tconst tagId = parseInt(path.replace('/', ''), 10)\n\tconst tag = tagsCache.find(tag => tag.id === tagId)\n\n\tif (!tag) {\n\t\tthrow new Error('Tag not found')\n\t}\n\n\tconst folder = tagToNode(tag)\n\tconst contentsResponse = await client.getDirectoryContents('/', {\n\t\tdetails: true,\n\t\t// Only filter favorites if we're at the root\n\t\tdata: formatReportPayload(tagId),\n\t\theaders: {\n\t\t\t// Patched in WebdavClient.ts\n\t\t\tmethod: 'REPORT',\n\t\t},\n\t}) as ResponseDataDetailed<FileStat[]>\n\n\treturn {\n\t\tfolder,\n\t\tcontents: contentsResponse.data.map(resultToNode),\n\t}\n\n}\n","/**\n * SPDX-FileCopyrightText: 2016 Nextcloud GmbH and Nextcloud contributors\n * SPDX-License-Identifier: AGPL-3.0-or-later\n */\nimport './actions/inlineSystemTagsAction.js'\n\nimport { translate as t } from '@nextcloud/l10n'\nimport { View, getNavigation } from '@nextcloud/files'\nimport TagMultipleSvg from '@mdi/svg/svg/tag-multiple.svg?raw'\n\nimport { getContents } from './services/systemtags.js'\n\nconst Navigation = getNavigation()\nNavigation.register(new View({\n\tid: 'tags',\n\tname: t('systemtags', 'Tags'),\n\tcaption: t('systemtags', 'List of tags and their associated files and folders.'),\n\n\temptyTitle: t('systemtags', 'No tags found'),\n\temptyCaption: t('systemtags', 'Tags you have created will show up here.'),\n\n\ticon: TagMultipleSvg,\n\torder: 25,\n\n\tgetContents,\n}))\n"],"names":["getNodeSystemTags","node","_a","_b","tags","renderTag","tag","isMore","tagElement","action","FileAction","nodes","systemTagsElement","t","firstTags","lastTag","moreTagElement","registerDavProperty","registerFileAction","client","davGetClient","resultToNode","davResultToNode","formatReportPayload","tagId","getDavNameSpaces","getDavProperties","tagToNode","Folder","generateRemoteUrl","getCurrentUser","Permission","getContents","path","tagsCache","fetchTags","folder","contentsResponse","Navigation","getNavigation","View","TagMultipleSvg"],"mappings":"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"}