/*! third party licenses: dist/vendor.LICENSE.txt */
import{c1 as N,c9 as T,c8 as z,bW as p,bZ as S,a_ as C,u as H,b as E,D as F,P as O,a2 as B,aq as $,b_ as U,bS as c,bO as k,bR as M,b$ as q,F as W,al as K,a4 as j,a6 as Q,aE as X,c0 as Y,cg as Z,bQ as _,aV as m,c5 as G}from"./core-common.mjs";import{a as J}from"./chunks/index-PaKKd09k.mjs";import{B as w,z as y}from"./chunks/_plugin-vue2_normalizer-VrK6B12S-BQkexw0P.mjs";import{j as V,e as ee}from"./chunks/index-CPb3EwrS.mjs";import{m as x}from"./chunks/index-DaZEPb_2.mjs";import{c as ie}from"./chunks/index-tn-fAC9x.mjs";import{g as te}from"./chunks/index-CiG5J8j_.mjs";import{aO as se,aP as ne,aQ as oe,S as re,a3 as ae,aR as le,n as b,ac as ce,aS as de}from"./chunks/icons-TElqpmA8.mjs";import{i as ue,P as g}from"./chunks/index-DG15V7L3.mjs";import{p as fe}from"./chunks/v-tooltip.esm-DFdYkWpQ.mjs";import"./chunks/_overRest-DjFtaWRq.mjs";import"./chunks/_setToArray-V03nfpyh.mjs";import"./chunks/_isIterateeCall-CX-rKv74.mjs";import"./chunks/isPlainObject-CnMaw-ru.mjs";const he="dav",ve=N(he),u=ie(ve),A=e=>{u.setHeaders({"X-Requested-With":"XMLHttpRequest",requesttoken:e!=null?e:""})};z(A),A(T());const me='<?xml version="1.0"?>\n<d:propfind xmlns:d="DAV:"\n	xmlns:oc="http://owncloud.org/ns"\n	xmlns:nc="http://nextcloud.org/ns"\n	xmlns:ocs="http://open-collaboration-services.org/ns">\n	<d:prop>\n		<d:getcontentlength />\n		<d:getcontenttype />\n		<d:getlastmodified />\n		<d:getetag />\n		<nc:version-label />\n		<nc:version-author />\n		<nc:has-preview />\n	</d:prop>\n</d:propfind>',d=te().setApp("files_version").detectUser().build();async function pe(e){var i;const s="/versions/".concat((i=p())==null?void 0:i.uid,"/versions/").concat(e.id);try{return(await u.getDirectoryContents(s,{data:me,details:!0})).data.filter(({mime:n})=>n!=="").map(n=>_e(n,e))}catch(n){throw d.error("Could not fetch version",{exception:n}),n}}async function be(e){var i,s;try{d.debug("Restoring version",{url:e.url}),await u.moveFile("/versions/".concat((i=p())==null?void 0:i.uid,"/versions/").concat(e.fileId,"/").concat(e.fileVersion),"/versions/".concat((s=p())==null?void 0:s.uid,"/restore/target"))}catch(n){throw d.error("Could not restore version",{exception:n}),n}}function _e(e,i){var s;const n=x(e.lastmod).unix()*1e3;let r="";return n===i.mtime?r=S("/core/preview?fileId={fileId}&c={fileEtag}&x=250&y=250&forceIcon=0&a=0",{fileId:i.id,fileEtag:i.etag}):r=S("/apps/files_versions/preview?file={file}&version={fileVersion}",{file:V(i.path,i.name),fileVersion:e.basename}),{fileId:i.id,label:e.props["version-label"],author:(s=e.props["version-author"])!=null?s:null,filename:e.filename,basename:x(n).format("LLL"),mime:e.mime,etag:"".concat(e.props.getetag),size:e.size,type:e.type,mtime:n,permissions:"R",hasPreview:e.props["has-preview"]===1,previewUrl:r,url:V("/remote.php/dav",e.filename),source:N("dav")+ee(e.filename),fileVersion:e.basename}}async function we(e,i){return await u.customRequest(e.filename,{method:"PROPPATCH",data:'<?xml version="1.0"?>\n					<d:propertyupdate xmlns:d="DAV:"\n						xmlns:oc="http://owncloud.org/ns"\n						xmlns:nc="http://nextcloud.org/ns"\n						xmlns:ocs="http://open-collaboration-services.org/ns">\n					<d:set>\n						<d:prop>\n							<nc:version-label>'.concat(i,"</nc:version-label>\n						</d:prop>\n					</d:set>\n					</d:propertyupdate>")})}async function ye(e){await u.deleteFile(e.filename)}const D=(e,i)=>(e&i)!==0,ge=C({name:"Version",components:{NcActionLink:H,NcActionButton:E,NcAvatar:F,NcDateTime:O,NcListItem:B,BackupRestore:se,Download:ne,FileCompare:oe,Pencil:re,Delete:ae,ImageOffOutline:le},directives:{tooltip:$},props:{version:{type:Object,required:!0},fileInfo:{type:Object,required:!0},isCurrent:{type:Boolean,default:!1},isFirstVersion:{type:Boolean,default:!1},loadPreview:{type:Boolean,default:!1},canView:{type:Boolean,default:!1},canCompare:{type:Boolean,default:!1}},emits:["click","compare","restore","delete","label-update-request"],data(){return{previewLoaded:!1,previewErrored:!1,capabilities:U("core","capabilities",{files:{version_labeling:!1,version_deletion:!1}}),versionAuthor:""}},computed:{humanReadableSize(){return ue(this.version.size)},versionLabel(){var e;const i=(e=this.version.label)!=null?e:"";return this.isCurrent?i===""?c("files_versions","Current version"):"".concat(i," (").concat(c("files_versions","Current version"),")"):this.isFirstVersion&&i===""?c("files_versions","Initial version"):i},downloadURL(){return this.isCurrent?k()+V("/remote.php/webdav",this.fileInfo.path,this.fileInfo.name):k()+this.version.url},enableLabeling(){return this.capabilities.files.version_labeling===!0},enableDeletion(){return this.capabilities.files.version_deletion===!0},hasDeletePermissions(){return D(this.fileInfo.permissions,g.DELETE)},hasUpdatePermissions(){return D(this.fileInfo.permissions,g.UPDATE)},isDownloadable(){if(!(this.fileInfo.permissions&g.READ))return!1;if(this.fileInfo.mountType==="shared"){const e=this.fileInfo.shareAttributes.find(i=>i.scope==="permissions"&&i.key==="download")||{};if((e==null?void 0:e.enabled)===!1)return!1}return!0}},created(){this.fetchDisplayName()},methods:{labelUpdate(){this.$emit("label-update-request")},restoreVersion(){this.$emit("restore",this.version)},async deleteVersion(){await this.$nextTick(),await this.$nextTick(),this.$emit("delete",this.version)},async fetchDisplayName(){if(this.version.author)try{const{data:e}=await M.get(q("/cloud/users/".concat(this.version.author)));this.versionAuthor=e.ocs.data.displayname}catch{this.versionAuthor=null}},click(){if(!this.canView){window.location=this.downloadURL;return}this.$emit("click",{version:this.version})},compareVersion(){if(!this.canView)throw new Error("Cannot compare version of this file");this.$emit("compare",{version:this.version})},t:c}});var Ve=function(){var e=this,i=e._self._c;return e._self._setupProxy,i("NcListItem",{staticClass:"version",attrs:{"force-display-actions":!0,"data-files-versions-version":e.version.fileVersion},on:{click:e.click},scopedSlots:e._u([{key:"icon",fn:function(){return[e.loadPreview||e.previewLoaded?(e.isCurrent||e.version.hasPreview)&&!e.previewErrored?i("img",{staticClass:"version__image",attrs:{src:e.version.previewUrl,alt:"",decoding:"async",fetchpriority:"low",loading:"lazy"},on:{load:function(s){e.previewLoaded=!0},error:function(s){e.previewErrored=!0}}}):i("div",{staticClass:"version__image"},[i("ImageOffOutline",{attrs:{size:20}})],1):i("div",{staticClass:"version__image"})]},proxy:!0},{key:"name",fn:function(){return[i("div",{staticClass:"version__info"},[e.versionLabel?i("div",{staticClass:"version__info__label",attrs:{title:e.versionLabel}},[e._v(" "+e._s(e.versionLabel)+" ")]):e._e(),e.versionAuthor?i("div",{staticClass:"version__info"},[e.versionLabel?i("span",[e._v("•")]):e._e(),i("NcAvatar",{staticClass:"avatar",attrs:{user:e.version.author,size:16,"disable-menu":!0,"disable-tooltip":!0,"show-user-status":!1}}),i("div",[e._v(e._s(e.versionAuthor))])],1):e._e()])]},proxy:!0},{key:"subname",fn:function(){return[i("div",{staticClass:"version__info version__info__subline"},[i("NcDateTime",{staticClass:"version__info__date",attrs:{"relative-time":"short",timestamp:e.version.mtime}}),i("span",[e._v("•")]),i("span",[e._v(e._s(e.humanReadableSize))])],1)]},proxy:!0},{key:"actions",fn:function(){return[e.enableLabeling&&e.hasUpdatePermissions?i("NcActionButton",{attrs:{"data-cy-files-versions-version-action":"label","close-after-click":!0},on:{click:e.labelUpdate},scopedSlots:e._u([{key:"icon",fn:function(){return[i("Pencil",{attrs:{size:22}})]},proxy:!0}],null,!1,3072546167)},[e._v(" "+e._s(e.version.label===""?e.t("files_versions","Name this version"):e.t("files_versions","Edit version name"))+" ")]):e._e(),!e.isCurrent&&e.canView&&e.canCompare?i("NcActionButton",{attrs:{"data-cy-files-versions-version-action":"compare","close-after-click":!0},on:{click:e.compareVersion},scopedSlots:e._u([{key:"icon",fn:function(){return[i("FileCompare",{attrs:{size:22}})]},proxy:!0}],null,!1,1958207595)},[e._v(" "+e._s(e.t("files_versions","Compare to current version"))+" ")]):e._e(),!e.isCurrent&&e.hasUpdatePermissions?i("NcActionButton",{attrs:{"data-cy-files-versions-version-action":"restore","close-after-click":!0},on:{click:e.restoreVersion},scopedSlots:e._u([{key:"icon",fn:function(){return[i("BackupRestore",{attrs:{size:22}})]},proxy:!0}],null,!1,2239038444)},[e._v(" "+e._s(e.t("files_versions","Restore version"))+" ")]):e._e(),e.isDownloadable?i("NcActionLink",{attrs:{"data-cy-files-versions-version-action":"download",href:e.downloadURL,"close-after-click":!0,download:e.downloadURL},scopedSlots:e._u([{key:"icon",fn:function(){return[i("Download",{attrs:{size:22}})]},proxy:!0}],null,!1,927269758)},[e._v(" "+e._s(e.t("files_versions","Download version"))+" ")]):e._e(),!e.isCurrent&&e.enableDeletion&&e.hasDeletePermissions?i("NcActionButton",{attrs:{"data-cy-files-versions-version-action":"delete","close-after-click":!0},on:{click:e.deleteVersion},scopedSlots:e._u([{key:"icon",fn:function(){return[i("Delete",{attrs:{size:22}})]},proxy:!0}],null,!1,2429175571)},[e._v(" "+e._s(e.t("files_versions","Delete version"))+" ")]):e._e()]},proxy:!0}])})},Ce=[],Ie=b(ge,Ve,Ce,!1,null,"17647be6");const Le=Ie.exports,Se=C({name:"VirtualScrolling",props:{sections:{type:Array,required:!0},containerElement:{type:HTMLElement,default:null},useWindow:{type:Boolean,default:!1},headerHeight:{type:Number,default:75},renderDistance:{type:Number,default:.5},bottomBufferRatio:{type:Number,default:2},scrollToKey:{type:String,default:""}},data(){return{scrollPosition:0,containerHeight:0,rowsContainerHeight:0,resizeObserver:null}},computed:{visibleSections(){d.debug("[VirtualScrolling] Computing visible section",{sections:this.sections});const e=this.containerHeight,i=this.scrollPosition,s=i+e;let n=0,r=0;const I=this.sections.map(o=>(r+=this.headerHeight,{...o,rows:o.rows.reduce((l,h)=>{n=r,r+=h.height;let v=0;return r<i?v=(i-r)/e:n>s&&(v=(n-s)/e),v>this.renderDistance?l:[...l,{...h,distance:v}]},[])})).filter(o=>o.rows.length>0),f=I.flatMap(({rows:o})=>o).flatMap(({items:o})=>o),L=this._rowIdToKeyMap;f.forEach(o=>o.key=L[o.id]);const P=f.map(({key:o})=>o).filter(o=>o!==void 0),R=Object.values(L).filter(o=>!P.includes(o));return f.filter(({key:o})=>o===void 0).forEach(o=>{var l;return o.key=(l=R.pop())!=null?l:Math.random().toString(36).substr(2)}),this._rowIdToKeyMap=f.reduce((o,{id:l,key:h})=>({...o,["".concat(l)]:h}),{}),I},totalHeight(){return this.sections.map(e=>this.headerHeight+e.height).reduce((e,i)=>e+i,0)+0},paddingTop(){if(this.visibleSections.length===0)return 0;let e=0;for(const i of this.sections){if(i.key!==this.visibleSections[0].rows[0].sectionKey){e+=this.headerHeight+i.height;continue}for(const s of i.rows){if(s.key===this.visibleSections[0].rows[0].key)return e;e+=s.height}e+=this.headerHeight}return e},rowsContainerStyle(){return{height:"".concat(this.totalHeight,"px"),paddingTop:"".concat(this.paddingTop,"px")}},isNearBottom(){const e=this.containerHeight*this.bottomBufferRatio;return this.scrollPosition+this.containerHeight>=this.totalHeight-e},container(){return d.debug("[VirtualScrolling] Computing container"),this.containerElement!==null?this.containerElement:this.useWindow?window:this.$refs.container}},watch:{isNearBottom(e){d.debug("[VirtualScrolling] isNearBottom changed",{value:e}),e&&this.$emit("need-content")},visibleSections(){this.isNearBottom&&this.$emit("need-content")},scrollToKey(e){let i=0;for(const s of this.sections){if(s.key!==e){i+=this.headerHeight+s.height;continue}break}d.debug("[VirtualScrolling] Scrolling to",{currentRowTopDistanceFromTop:i}),this.container.scrollTo({top:i,behavior:"smooth"})}},beforeCreate(){this._rowIdToKeyMap={}},mounted(){this.resizeObserver=new ResizeObserver(e=>{for(const i of e){const s=i.contentRect;i.target===this.container&&(this.containerHeight=s.height),i.target.classList.contains("vs-rows-container")&&(this.rowsContainerHeight=s.height)}}),this.useWindow?(window.addEventListener("resize",this.updateContainerSize,{passive:!0}),this.containerHeight=window.innerHeight):this.resizeObserver.observe(this.container),this.resizeObserver.observe(this.$refs.rowsContainer),this.container.addEventListener("scroll",this.updateScrollPosition,{passive:!0})},beforeDestroy(){var e;this.useWindow&&window.removeEventListener("resize",this.updateContainerSize),(e=this.resizeObserver)==null||e.disconnect(),this.container.removeEventListener("scroll",this.updateScrollPosition)},methods:{updateScrollPosition(){var e;(e=this._onScrollHandle)!=null||(this._onScrollHandle=requestAnimationFrame(()=>{this._onScrollHandle=null,this.useWindow?this.scrollPosition=this.container.scrollY:this.scrollPosition=this.container.scrollTop}))},updateContainerSize(){this.containerHeight=window.innerHeight}}});var ke=function(){var e=this,i=e._self._c;return e._self._setupProxy,!e.useWindow&&e.containerElement===null?i("div",{ref:"container",staticClass:"vs-container"},[i("div",{ref:"rowsContainer",staticClass:"vs-rows-container",style:e.rowsContainerStyle},[e._t("default",null,{visibleSections:e.visibleSections}),e._t("loader")],2)]):i("div",{ref:"rowsContainer",staticClass:"vs-rows-container",style:e.rowsContainerStyle},[e._t("default",null,{visibleSections:e.visibleSections}),e._t("loader")],2)},xe=[],Ae=b(Se,ke,xe,!1,null,"198f1dd9");const De=Ae.exports,Ne=C({name:"VersionLabelForm",components:{NcButton:W,NcTextField:K,Check:ce},props:{versionLabel:{type:String,default:""}},data(){return{innerVersionLabel:this.versionLabel}},mounted(){this.$nextTick(()=>{this.$refs.labelInput.$el.getElementsByTagName("input")[0].focus()})},methods:{setVersionLabel(e){this.$emit("label-update",e)},t:c}});var Pe=function(){var e=this,i=e._self._c;return e._self._setupProxy,i("form",{staticClass:"version-label-modal",on:{submit:function(s){return s.preventDefault(),e.setVersionLabel(e.innerVersionLabel)}}},[i("label",[i("div",{staticClass:"version-label-modal__title"},[e._v(e._s(e.t("files_versions","Version name")))]),i("NcTextField",{ref:"labelInput",attrs:{value:e.innerVersionLabel,placeholder:e.t("files_versions","Version name"),"label-outside":!0},on:{"update:value":function(s){e.innerVersionLabel=s}}})],1),i("div",{staticClass:"version-label-modal__info"},[e._v(" "+e._s(e.t("files_versions","Named versions are persisted, and excluded from automatic cleanups when your storage quota is full."))+" ")]),i("div",{staticClass:"version-label-modal__actions"},[i("NcButton",{attrs:{disabled:e.innerVersionLabel.trim().length===0},on:{click:function(s){return e.setVersionLabel("")}}},[e._v(" "+e._s(e.t("files_versions","Remove version name"))+" ")]),i("NcButton",{attrs:{type:"primary","native-type":"submit"},scopedSlots:e._u([{key:"icon",fn:function(){return[i("Check")]},proxy:!0}])},[e._v(" "+e._s(e.t("files_versions","Save version name"))+" ")])],1)])},Re=[],Te=b(Ne,Pe,Re,!1,null,"3ba383a3");const ze=Te.exports,He={name:"VersionTab",components:{Version:Le,VirtualScrolling:De,VersionLabelForm:ze,NcLoadingIcon:j,NcModal:Q},mixins:[X],data(){return{fileInfo:null,isActive:!1,versions:[],loading:!1,showVersionLabelForm:!1}},computed:{sections(){return[{key:"versions",rows:this.orderedVersions.map(e=>({key:e.mtime,height:68,sectionKey:"versions",items:[e]})),height:68*this.orderedVersions.length}]},orderedVersions(){return[...this.versions].sort((e,i)=>e.mtime===this.fileInfo.mtime?-1:i.mtime===this.fileInfo.mtime?1:i.mtime-e.mtime)},initialVersionMtime(){return this.versions.map(e=>e.mtime).reduce((e,i)=>Math.min(e,i))},viewerFileInfo(){let e="";return this.fileInfo.permissions&1&&(e+="R"),this.fileInfo.permissions&2&&(e+="W"),this.fileInfo.permissions&8&&(e+="D"),{...this.fileInfo,mime:this.fileInfo.mimetype,basename:this.fileInfo.name,filename:this.fileInfo.path+"/"+this.fileInfo.name,permissions:e,fileid:this.fileInfo.id}},canView(){var e,i;return(i=(e=window.OCA.Viewer)==null?void 0:e.mimetypesCompare)==null?void 0:i.includes(this.fileInfo.mimetype)},canCompare(){return!this.isMobile}},mounted(){Y("files_versions:restore:restored",this.fetchVersions)},beforeUnmount(){Z("files_versions:restore:restored",this.fetchVersions)},methods:{async update(e){this.fileInfo=e,this.resetState(),this.fetchVersions()},async setIsActive(e){this.isActive=e},async fetchVersions(){try{this.loading=!0,this.versions=await pe(this.fileInfo)}finally{this.loading=!1}},async handleRestore(e){const i=this.fileInfo;this.fileInfo={...this.fileInfo,size:e.size,mtime:e.mtime};const s={preventDefault:!1,fileInfo:this.fileInfo,version:e};if(_("files_versions:restore:requested",s),!s.preventDefault)try{await be(e),e.label!==""?w(t("files_versions","".concat(e.label," restored"))):e.mtime===this.initialVersionMtime?w(t("files_versions","Initial version restored")):w(t("files_versions","Version restored")),_("files_versions:restore:restored",e)}catch{this.fileInfo=i,y(t("files_versions","Could not restore version")),_("files_versions:restore:failed",e)}},handleLabelUpdateRequest(e){this.showVersionLabelForm=!0,this.editedVersion=e},async handleLabelUpdate(e){const i=this.editedVersion.label;this.editedVersion.label=e,this.showVersionLabelForm=!1;try{await we(this.editedVersion,e),this.editedVersion=null}catch(s){this.editedVersion.label=i,y(this.t("files_versions","Could not set version label")),logger.error("Could not set version label",{exception:s})}},async handleDelete(e){const i=this.versions.indexOf(e);this.versions.splice(i,1);try{await ye(e)}catch{this.versions.push(e),y(t("files_versions","Could not delete version"))}},resetState(){this.$set(this,"versions",[])},openVersion({version:e}){if(e.mtime===this.fileInfo.mtime){OCA.Viewer.open({fileInfo:this.viewerFileInfo});return}const i=this.versions.map(s=>{var n,r;return{...s,filename:s.mtime===this.fileInfo.mtime?J.join("files",(r=(n=p())==null?void 0:n.uid)!=null?r:"",this.fileInfo.path,this.fileInfo.name):s.filename,hasPreview:!1,previewUrl:void 0}});OCA.Viewer.open({fileInfo:i.find(s=>s.source===e.source),enableSidebar:!1})},compareVersion({version:e}){const i=this.versions.map(s=>({...s,hasPreview:!1,previewUrl:void 0}));OCA.Viewer.compare(this.viewerFileInfo,i.find(s=>s.source===e.source))}}};var Ee=function(){var e=this,i=e._self._c;return i("div",{staticClass:"versions-tab__container"},[i("VirtualScrolling",{attrs:{sections:e.sections,"header-height":0},scopedSlots:e._u([{key:"default",fn:function({visibleSections:s}){return[i("ul",{attrs:{"data-files-versions-versions-list":""}},[s.length===1?e._l(s[0].rows,function(n){return i("Version",{key:n.items[0].mtime,attrs:{"can-view":e.canView,"can-compare":e.canCompare,"load-preview":e.isActive,version:n.items[0],"file-info":e.fileInfo,"is-current":n.items[0].mtime===e.fileInfo.mtime,"is-first-version":n.items[0].mtime===e.initialVersionMtime},on:{click:e.openVersion,compare:e.compareVersion,restore:e.handleRestore,"label-update-request":function(r){return e.handleLabelUpdateRequest(n.items[0])},delete:e.handleDelete}})}):e._e()],2)]}}])},[e.loading?i("NcLoadingIcon",{staticClass:"files-list-viewer__loader",attrs:{slot:"loader"},slot:"loader"}):e._e()],1),e.showVersionLabelForm?i("NcModal",{attrs:{title:e.t("files_versions","Name this version")},on:{close:function(s){e.showVersionLabelForm=!1}}},[i("VersionLabelForm",{attrs:{"version-label":e.editedVersion.label},on:{"label-update":e.handleLabelUpdate}})],1):e._e()],1)},Fe=[],Oe=b(He,Ee,Fe,!1,null,null);const Be=Oe.exports;m.prototype.t=c,m.prototype.n=G,m.use(fe);const $e=m.extend(Be);let a=null;window.addEventListener("DOMContentLoaded",function(){var e;((e=OCA.Files)==null?void 0:e.Sidebar)!==void 0&&OCA.Files.Sidebar.registerTab(new OCA.Files.Sidebar.Tab({id:"version_vue",name:c("files_versions","Versions"),iconSvg:de,async mount(i,s,n){a&&a.$destroy(),a=new $e({parent:n}),await a.update(s),a.$mount(i)},update(i){a.update(i)},setIsActive(i){a&&a.setIsActive(i)},destroy(){a.$destroy(),a=null},enabled(i){var s;return!((s=i==null?void 0:i.isDirectory())==null||s)}}))});
