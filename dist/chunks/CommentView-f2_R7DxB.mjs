/*! third party licenses: dist/vendor.LICENSE.txt */
import{_ as y}from"./preload-helper-BG02UnR2.mjs";import{bR as p,bW as n,b as _,v as f,l as C,D as b,F as D,P as N,a4 as v,aL as I,bS as w,a_ as T,b$ as x,b_ as M}from"../core-common.mjs";import{n as S,aj as A,ak as E,a3 as k,S as L}from"./icons-TElqpmA8.mjs";import"./index-PaKKd09k.mjs";import{z as c,U as j,A as R}from"./_plugin-vue2_normalizer-VrK6B12S-BQkexw0P.mjs";import{a as $,c as d}from"./GetComments-BFQTC104.mjs";import{l as m}from"./logger-DMHE5Ua4.mjs";function u(e,s=1){const o=new DOMParser;let a=e;for(let i=0;i<s;i++)a=o.parseFromString(a,"text/html").documentElement.textContent;return a}async function O(e,s,o){const a=["",e,s].join("/"),i=await p.post($()+a,{actorDisplayName:n().displayName,actorId:n().uid,actorType:"users",creationDateTime:new Date().toUTCString(),message:o,objectType:e,verb:"comment"}),h=parseInt(i.headers["content-location"].split("/").pop()),g=a+"/"+h,l=await d.stat(g,{details:!0}),r=l.data.props;return r.actorDisplayName=u(r.actorDisplayName,2),r.message=u(r.message,2),l.data}async function P(e,s,o){const a=["",e,s,o].join("/");await d.deleteFile(a)}async function B(e,s,o,a){const i=["",e,s,o].join("/");return await d.customRequest(i,Object.assign({method:"PROPPATCH",data:'<?xml version="1.0"?>\n			<d:propertyupdate\n				xmlns:d="DAV:"\n				xmlns:oc="http://owncloud.org/ns">\n			<d:set>\n				<d:prop>\n					<oc:message>'.concat(a,"</oc:message>\n				</d:prop>\n			</d:set>\n			</d:propertyupdate>")}))}const q={props:{id:{type:Number,default:null},message:{type:String,default:""},resourceId:{type:[String,Number],required:!0},resourceType:{type:String,default:"files"}},data(){return{deleted:!1,editing:!1,loading:!1}},methods:{onEdit(){this.editing=!0},onEditCancel(){this.editing=!1,this.updateLocalMessage(this.message)},async onEditComment(e){this.loading=!0;try{await B(this.resourceType,this.resourceId,this.id,e),m.debug("Comment edited",{resourceType:this.resourceType,resourceId:this.resourceId,id:this.id,message:e}),this.$emit("update:message",e),this.editing=!1}catch(s){c(t("comments","An error occurred while trying to edit the comment")),console.error(s)}finally{this.loading=!1}},onDeleteWithUndo(){this.deleted=!0;const e=setTimeout(this.onDelete,j);R(t("comments","Comment deleted"),()=>{clearTimeout(e),this.deleted=!1})},async onDelete(){try{await P(this.resourceType,this.resourceId,this.id),m.debug("Comment deleted",{resourceType:this.resourceType,resourceId:this.resourceId,id:this.id}),this.$emit("delete",this.id)}catch(e){c(t("comments","An error occurred while trying to delete the comment")),console.error(e),this.deleted=!1}},async onNewComment(e){this.loading=!0;try{const s=await O(this.resourceType,this.resourceId,e);m.debug("New comment posted",{resourceType:this.resourceType,resourceId:this.resourceId,newComment:s}),this.$emit("new",s),this.$emit("update:message",""),this.localMessage=""}catch(s){c(t("comments","An error occurred while trying to create the comment")),console.error(s)}finally{this.loading=!1}}}},z=()=>y(()=>import("../core-common.mjs").then(e=>e.e7),[],import.meta.url),F={name:"Comment",components:{IconArrowRight:A,IconClose:E,IconDelete:k,IconEdit:L,NcActionButton:_,NcActions:f,NcActionSeparator:C,NcAvatar:b,NcButton:D,NcDateTime:N,NcLoadingIcon:v,NcRichContenteditable:z},mixins:[I,q],inheritAttrs:!1,props:{actorDisplayName:{type:String,required:!0},actorId:{type:String,required:!0},creationDateTime:{type:String,default:null},editor:{type:Boolean,default:!1},autoComplete:{type:Function,required:!0},tag:{type:String,default:"div"}},data(){return{expanded:!1,localMessage:"",submitted:!1}},computed:{isOwnComment(){return n().uid===this.actorId},renderedContent(){return this.isEmptyMessage?"":this.renderContent(this.localMessage)},isEmptyMessage(){return!this.localMessage||this.localMessage.trim()===""},timestamp(){return Date.parse(this.creationDateTime)}},watch:{message(e){this.updateLocalMessage(e)}},beforeMount(){this.updateLocalMessage(this.message)},methods:{t:w,updateLocalMessage(e){this.localMessage=e.toString(),this.submitted=!1},onSubmit(){if(this.localMessage.trim()!==""){if(this.editor){this.onNewComment(this.localMessage.trim()),this.$nextTick(()=>{this.$refs.editor.$el.focus()});return}this.onEditComment(this.localMessage.trim())}},onExpand(){this.expanded=!0}}};var U=function(){var e=this,s=e._self._c;return s(e.tag,{directives:[{name:"show",rawName:"v-show",value:!e.deleted,expression:"!deleted"}],tag:"component",staticClass:"comment",class:{"comment--loading":e.loading}},[s("div",{staticClass:"comment__side"},[s("NcAvatar",{staticClass:"comment__avatar",attrs:{"display-name":e.actorDisplayName,user:e.actorId,size:32}})],1),s("div",{staticClass:"comment__body"},[s("div",{staticClass:"comment__header"},[s("span",{staticClass:"comment__author"},[e._v(e._s(e.actorDisplayName))]),e.isOwnComment&&e.id&&!e.loading?s("NcActions",{staticClass:"comment__actions"},[e.editing?s("NcActionButton",{on:{click:e.onEditCancel},scopedSlots:e._u([{key:"icon",fn:function(){return[s("IconClose",{attrs:{size:20}})]},proxy:!0}],null,!1,2888946197)},[e._v(" "+e._s(e.t("comments","Cancel edit"))+" ")]):[s("NcActionButton",{attrs:{"close-after-click":""},on:{click:e.onEdit},scopedSlots:e._u([{key:"icon",fn:function(){return[s("IconEdit",{attrs:{size:20}})]},proxy:!0}],null,!1,649782975)},[e._v(" "+e._s(e.t("comments","Edit comment"))+" ")]),s("NcActionSeparator"),s("NcActionButton",{attrs:{"close-after-click":""},on:{click:e.onDeleteWithUndo},scopedSlots:e._u([{key:"icon",fn:function(){return[s("IconDelete",{attrs:{size:20}})]},proxy:!0}],null,!1,881161434)},[e._v(" "+e._s(e.t("comments","Delete comment"))+" ")])]],2):e._e(),e.id&&e.loading?s("div",{staticClass:"comment_loading icon-loading-small"}):e.creationDateTime?s("NcDateTime",{staticClass:"comment__timestamp",attrs:{timestamp:e.timestamp,"ignore-seconds":!0}}):e._e()],1),e.editor||e.editing?s("form",{staticClass:"comment__editor",on:{submit:function(o){o.preventDefault()}}},[s("div",{staticClass:"comment__editor-group"},[s("NcRichContenteditable",{ref:"editor",attrs:{"auto-complete":e.autoComplete,contenteditable:!e.loading,label:e.editor?e.t("comments","New comment"):e.t("comments","Edit comment"),placeholder:e.t("comments","Write a comment â€¦"),value:e.localMessage,"user-data":e.userData,"aria-describedby":"tab-comments__editor-description"},on:{"update:value":e.updateLocalMessage,submit:e.onSubmit}}),s("div",{staticClass:"comment__submit"},[s("NcButton",{attrs:{type:"tertiary-no-background","native-type":"submit","aria-label":e.t("comments","Post comment"),disabled:e.isEmptyMessage},on:{click:e.onSubmit},scopedSlots:e._u([{key:"icon",fn:function(){return[e.loading?s("NcLoadingIcon"):s("IconArrowRight",{attrs:{size:20}})]},proxy:!0}],null,!1,758946661)})],1)],1),s("div",{staticClass:"comment__editor-description",attrs:{id:"tab-comments__editor-description"}},[e._v(" "+e._s(e.t("comments","@ for mentions, : for emoji, / for smart picker"))+" ")])]):s("div",{staticClass:"comment__message",class:{"comment__message--expanded":e.expanded},domProps:{innerHTML:e._s(e.renderedContent)},on:{click:e.onExpand}})])])},W=[],H=S(F,U,W,!1,null,"0dc52caf");const Z=H.exports,ee=T({props:{resourceId:{type:Number,required:!0},resourceType:{type:String,default:"files"}},data(){return{editorData:{actorDisplayName:n().displayName,actorId:n().uid,key:"editor"},userData:{}}},methods:{async autoComplete(e,s){const{data:o}=await p.get(x("core/autocomplete/get"),{params:{search:e,itemType:"files",itemId:this.resourceId,sorter:"commenters|share-recipients",limit:M("comments","maxAutoCompleteResults")}});return o.ocs.data.forEach(a=>{this.userData[a.id]=a}),s(Object.values(this.userData))},genMentionsData(e){return Object.values(e).flat().forEach(s=>{var o;this.userData[s.mentionId]={icon:"icon-user",id:s.mentionId,label:s.mentionDisplayName,source:"users",primary:((o=n())==null?void 0:o.uid)===s.mentionId}}),this.userData}}});export{Z as C,ee as a};
