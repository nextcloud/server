/*! third party licenses: dist/vendor.LICENSE.txt */
import{bR as C,b$ as P,bW as T,bZ as g,a_ as S,X as I,a6 as U,bS as l,c1 as B,bQ as N}from"../core-common.mjs";import{p as m}from"./index-PaKKd09k.mjs";import{z as W}from"./_plugin-vue2_normalizer-VrK6B12S-BQkexw0P.mjs";import{p as z}from"./index-DG15V7L3.mjs";import{e as F}from"./index-CPb3EwrS.mjs";import{n as E}from"./icons-TElqpmA8.mjs";import{l as c}from"./logger-R_K4lHwR.mjs";import"./index-CiG5J8j_.mjs";import"./index-tn-fAC9x.mjs";const q=async function(){return(await C.get(P("apps/files/api/v1/templates"))).data.ocs.data},M=async function(e,t,i){return(await C.post(P("apps/files/api/v1/templates/create"),{filePath:e,templatePath:t,templateType:i})).data.ocs.data},O=function(){return!T()},R=function(){return document.getElementById("sharingToken")&&document.getElementById("sharingToken").value},s=256,j={name:"TemplatePreview",inheritAttrs:!1,props:{basename:{type:String,required:!0},checked:{type:Boolean,default:!1},fileid:{type:[String,Number],required:!0},filename:{type:String,required:!0},previewUrl:{type:String,default:null},hasPreview:{type:Boolean,default:!0},mime:{type:String,required:!0},ratio:{type:Number,default:null}},data(){return{failedPreview:!1}},computed:{nameWithoutExt(){return this.basename.indexOf(".")>-1?this.basename.split(".").slice(0,-1).join("."):this.basename},id(){return"template-picker-".concat(this.fileid)},realPreviewUrl(){return this.failedPreview&&this.mimeIcon?this.mimeIcon:this.previewUrl?this.previewUrl:O()?g("/apps/files_sharing/publicpreview/".concat(R(),"?fileId=").concat(this.fileid,"&file=").concat(F(this.filename),"&x=").concat(s,"&y=").concat(s,"&a=1")):g("/core/preview?fileId=".concat(this.fileid,"&x=").concat(s,"&y=").concat(s,"&a=1"))},mimeIcon(){return OC.MimeType.getIconUrl(this.mime)}},methods:{onCheck(){this.$emit("check",this.fileid)},onFailure(){this.failedPreview=!0}}};var D=function(){var e=this,t=e._self._c;return t("li",{staticClass:"template-picker__item"},[t("input",{staticClass:"radio",attrs:{id:e.id,type:"radio",name:"template-picker"},domProps:{checked:e.checked},on:{change:e.onCheck}}),t("label",{staticClass:"template-picker__label",attrs:{for:e.id}},[t("div",{staticClass:"template-picker__preview",class:e.failedPreview?"template-picker__preview--failed":""},[t("img",{staticClass:"template-picker__image",attrs:{src:e.realPreviewUrl,alt:"",draggable:"false"},on:{error:e.onFailure}})]),t("span",{staticClass:"template-picker__title"},[e._v(" "+e._s(e.nameWithoutExt)+" ")])])])},A=[],L=E(j,D,A,!1,null,"8f352ebc");const Q=L.exports,x=2,n=8,X=S({name:"TemplatePicker",components:{NcEmptyContent:I,NcModal:U,TemplatePreview:Q},props:{parent:{type:Object,default:()=>null}},data(){return{checked:-1,loading:!1,name:null,opened:!1,provider:null}},computed:{extension(){var e;return m.extname((e=this.name)!=null?e:"")},nameWithoutExt(){return this.extension?this.name.slice(0,0-this.extension.length):this.name},emptyTemplate(){var e,t;return{basename:l("files","Blank"),fileid:-1,filename:l("files","Blank"),hasPreview:!1,mime:((e=this.provider)==null?void 0:e.mimetypes[0])||((t=this.provider)==null?void 0:t.mimetypes)}},selectedTemplate(){return this.provider?this.provider.templates.find(e=>e.fileid===this.checked):null},style(){if(!this.provider)return{};const e=(this.provider.ratio?this.provider.ratio:1.77)>1?n*30:n*20;return{"--margin":n+"px","--width":e+"px","--border":x+"px","--fullwidth":e+2*n+2*x+"px","--height":this.provider.ratio?Math.round(e/this.provider.ratio)+"px":null}}},methods:{t:l,async open(e,t){this.checked=this.emptyTemplate.fileid,this.name=e,this.provider=t;const i=(await q()).find(r=>r.app===t.app&&r.label===t.label);if(i===null)throw new Error("Failed to match provider in results");if(this.provider=i,i.templates.length===0){this.onSubmit();return}this.opened=!0},close(){this.checked=this.emptyTemplate.fileid,this.loading=!1,this.name=null,this.opened=!1,this.provider=null},onCheck(e){this.checked=e},async onSubmit(){var e,t,i,r,d,h,u,f,v,w,y,k,_,b;this.loading=!0;const $=new URL(window.location.href).searchParams.get("dir")||"/";this.nameWithoutExt===this.name&&(c.warn("Fixed invalid filename",{name:this.name,extension:(e=this.provider)==null?void 0:e.extension}),this.name="".concat(this.name).concat((i=(t=this.provider)==null?void 0:t.extension)!=null?i:""));try{const a=await M(m.normalize("".concat($,"/").concat(this.name)),(d=(r=this.selectedTemplate)==null?void 0:r.filename)!=null?d:"",(u=(h=this.selectedTemplate)==null?void 0:h.templateType)!=null?u:"");c.debug("Created new file",a);const o=((f=T())==null?void 0:f.uid)||null,p=new z({id:a.fileid,source:B(m.join("dav/files/".concat(o),a.filename)),root:"/files/".concat(o),mime:a.mime,mtime:new Date(a.lastmod*1e3),owner:o,size:a.size,permissions:a.permissions,attributes:{"mount-type":(w=(v=this.parent)==null?void 0:v.attributes)==null?void 0:w["mount-type"],"owner-id":(k=(y=this.parent)==null?void 0:y.attributes)==null?void 0:k["owner-id"],"owner-display-name":(b=(_=this.parent)==null?void 0:_.attributes)==null?void 0:b["owner-display-name"],...a,"has-preview":a.hasPreview}});N("files:node:created",p),window.OCP.Files.Router.goToRoute(null,{view:"files",fileid:p.fileid},{dir:p.dirname,openfile:"true"}),this.close()}catch(a){c.error("Error while creating the new file from template",{error:a}),W(l("files","Unable to create new file from template"))}finally{this.loading=!1}}}});var Z=function(){var e=this,t=e._self._c;return e._self._setupProxy,e.opened?t("NcModal",{staticClass:"templates-picker",attrs:{"clear-view-delay":-1,size:"large"},on:{close:e.close}},[t("form",{staticClass:"templates-picker__form",style:e.style,on:{submit:function(i){return i.preventDefault(),i.stopPropagation(),e.onSubmit.apply(null,arguments)}}},[t("h2",[e._v(e._s(e.t("files","Pick a template for {name}",{name:e.nameWithoutExt})))]),t("ul",{staticClass:"templates-picker__list"},[t("TemplatePreview",e._b({attrs:{checked:e.checked===e.emptyTemplate.fileid},on:{check:e.onCheck}},"TemplatePreview",e.emptyTemplate,!1)),e._l(e.provider.templates,function(i){return t("TemplatePreview",e._b({key:i.fileid,attrs:{checked:e.checked===i.fileid,ratio:e.provider.ratio},on:{check:e.onCheck}},"TemplatePreview",i,!1))})],2),t("div",{staticClass:"templates-picker__buttons"},[t("input",{staticClass:"primary",attrs:{type:"submit","aria-label":e.t("files","Create a new file with the selected template")},domProps:{value:e.t("files","Create")}})])]),e.loading?t("NcEmptyContent",{staticClass:"templates-picker__loading",attrs:{icon:"icon-loading"}},[e._v(" "+e._s(e.t("files","Creating file"))+" ")]):e._e()],1):e._e()},G=[],H=E(X,Z,G,!1,null,"20efc343");const le=H.exports;export{le as default};
