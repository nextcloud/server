# Nextcloud ç³»ç»Ÿæ¶æ„è®¾è®¡ä¸éœ€æ±‚æ–‡æ¡£

## 1. é¡¹ç›®æ¦‚è¿°

### 1.1 é¡¹ç›®ç®€ä»‹
Nextcloudæ˜¯ä¸€ä¸ªå¼€æºçš„äº‘å­˜å‚¨å’Œåä½œå¹³å°ï¼Œæä¾›æ–‡ä»¶åŒæ­¥ã€å…±äº«ã€åä½œç­‰åŠŸèƒ½ã€‚å®ƒé‡‡ç”¨æ¨¡å—åŒ–æ¶æ„è®¾è®¡ï¼Œæ”¯æŒä¸°å¯Œçš„æ’ä»¶ç”Ÿæ€ç³»ç»Ÿï¼Œä¸ºç”¨æˆ·æä¾›å®‰å…¨ã€å¯æ‰©å±•çš„ç§æœ‰äº‘è§£å†³æ–¹æ¡ˆã€‚

### 1.2 æ ¸å¿ƒç‰¹æ€§
- ğŸ“ **æ•°æ®è®¿é—®**: åœ¨è‡ªé€‰æœåŠ¡å™¨ä¸Šå­˜å‚¨æ–‡ä»¶ã€è”ç³»äººã€æ—¥å†ç­‰æ•°æ®
- ğŸ”„ **æ•°æ®åŒæ­¥**: åœ¨å¤šè®¾å¤‡é—´ä¿æŒæ•°æ®åŒæ­¥
- ğŸ™Œ **æ•°æ®å…±äº«**: ä¸ä»–äººå…±äº«å’Œåä½œ
- ğŸš€ **åº”ç”¨æ‰©å±•**: æ”¯æŒæ•°ç™¾ä¸ªåº”ç”¨æ’ä»¶
- ğŸ”’ **å®‰å…¨ä¿éšœ**: åŠ å¯†æœºåˆ¶ã€å®‰å…¨å®¡è®¡ã€åŒå› ç´ è®¤è¯

### 1.3 æŠ€æœ¯æ ˆ
- **åç«¯**: PHP 8.x, Symfonyç»„ä»¶
- **å‰ç«¯**: Vue.js 3, TypeScript, Webpack
- **æ•°æ®åº“**: MySQL/MariaDB, PostgreSQL, SQLite
- **å­˜å‚¨**: æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿ, S3, WebDAVç­‰
- **ç¼“å­˜**: Redis, APCu
- **æœç´¢**: Elasticsearch (å¯é€‰)

## 2. ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ

### 2.1 æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å®¢æˆ·ç«¯å±‚ (Client Layer)                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Webæµè§ˆå™¨  â”‚  æ¡Œé¢å®¢æˆ·ç«¯  â”‚  ç§»åŠ¨åº”ç”¨  â”‚  WebDAVå®¢æˆ·ç«¯  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   WebæœåŠ¡å™¨å±‚ (Web Server)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚           Nginx/Apache + PHP-FPM                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  åº”ç”¨å±‚ (Application Layer)                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚   æ ¸å¿ƒæ¡†æ¶   â”‚  â”‚  åº”ç”¨ç®¡ç†å™¨  â”‚  â”‚  æ’ä»¶ç³»ç»Ÿ   â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  è·¯ç”±ç³»ç»Ÿ   â”‚  â”‚  äº‹ä»¶ç³»ç»Ÿ   â”‚  â”‚  ä¸­é—´ä»¶     â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   æœåŠ¡å±‚ (Service Layer)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  ç”¨æˆ·ç®¡ç†   â”‚  â”‚  æ–‡ä»¶æœåŠ¡   â”‚  â”‚  å…±äº«æœåŠ¡   â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  è®¤è¯æœåŠ¡   â”‚  â”‚  é€šçŸ¥æœåŠ¡   â”‚  â”‚  æœç´¢æœåŠ¡   â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   æ•°æ®å±‚ (Data Layer)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚   æ•°æ®åº“    â”‚  â”‚  æ–‡ä»¶å­˜å‚¨   â”‚  â”‚    ç¼“å­˜     â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ ¸å¿ƒç»„ä»¶

#### 2.2.1 æ ¸å¿ƒæ¡†æ¶ (Core Framework)
- **OCç±»**: å…¨å±€å‘½åç©ºé—´ï¼Œç®¡ç†æœåŠ¡å™¨æ ¹è·¯å¾„ã€Webæ ¹è·¯å¾„ç­‰
- **Serverå®¹å™¨**: ä¾èµ–æ³¨å…¥å®¹å™¨ï¼Œç®¡ç†æœåŠ¡å®ä¾‹
- **AppFramework**: åº”ç”¨å¼€å‘æ¡†æ¶ï¼Œæä¾›MVCæ¨¡å¼æ”¯æŒ

#### 2.2.2 åº”ç”¨ç®¡ç†å™¨ (App Manager)
- **åº”ç”¨åŠ è½½**: è‡ªåŠ¨åŠ è½½å·²å¯ç”¨çš„åº”ç”¨
- **åº”ç”¨æ³¨å†Œ**: æ³¨å†Œåº”ç”¨çš„è‡ªåŠ¨åŠ è½½è·¯å¾„
- **ç”Ÿå‘½å‘¨æœŸç®¡ç†**: ç®¡ç†åº”ç”¨çš„å¯åŠ¨ã€åœæ­¢ç­‰ç”Ÿå‘½å‘¨æœŸ

#### 2.2.3 è·¯ç”±ç³»ç»Ÿ (Routing System)
- **URLè·¯ç”±**: å°†HTTPè¯·æ±‚è·¯ç”±åˆ°å¯¹åº”çš„æ§åˆ¶å™¨
- **APIè·¯ç”±**: æ”¯æŒRESTful APIå’ŒOCS API
- **WebDAVè·¯ç”±**: æ”¯æŒWebDAVåè®®è®¿é—®

## 3. æ ¸å¿ƒæ¨¡å—è®¾è®¡

### 3.1 ä¾èµ–æ³¨å…¥ç³»ç»Ÿ

#### 3.1.1 å®¹å™¨æ¶æ„
```php
// æœåŠ¡å™¨å®¹å™¨
class ServerContainer extends SimpleContainer {
    // å…¨å±€æœåŠ¡æ³¨å†Œ
}

// åº”ç”¨å®¹å™¨  
class DIContainer extends SimpleContainer implements IAppContainer {
    // åº”ç”¨çº§æœåŠ¡æ³¨å†Œ
    // ä¸­é—´ä»¶æ³¨å†Œ
    // æœåŠ¡æŸ¥è¯¢å’Œå®ä¾‹åŒ–
}
```

#### 3.1.2 æœåŠ¡æ³¨å†Œæœºåˆ¶
- **æœåŠ¡åˆ«å**: æ”¯æŒæ¥å£åˆ°å®ç°ç±»çš„æ˜ å°„
- **å»¶è¿ŸåŠ è½½**: æ”¯æŒæœåŠ¡çš„å»¶è¿Ÿå®ä¾‹åŒ–
- **ä½œç”¨åŸŸç®¡ç†**: åŒºåˆ†å…¨å±€æœåŠ¡å’Œåº”ç”¨çº§æœåŠ¡

### 3.2 äº‹ä»¶ç³»ç»Ÿ

#### 3.2.1 äº‹ä»¶åˆ†å‘å™¨
```php
interface IEventDispatcher {
    public function addListener(string $eventName, callable $listener, int $priority = 0): void;
    public function dispatchTyped(Event $event): void;
}
```

#### 3.2.2 äº‹ä»¶ç±»å‹
- **ç³»ç»Ÿäº‹ä»¶**: ç”¨æˆ·ç™»å½•ã€æ–‡ä»¶æ“ä½œç­‰æ ¸å¿ƒäº‹ä»¶
- **åº”ç”¨äº‹ä»¶**: åº”ç”¨è‡ªå®šä¹‰äº‹ä»¶
- **å¹¿æ’­äº‹ä»¶**: æ”¯æŒè·¨å®ä¾‹çš„äº‹ä»¶å¹¿æ’­

### 3.3 ä¸­é—´ä»¶ç³»ç»Ÿ

#### 3.3.1 ä¸­é—´ä»¶ç±»å‹
- **å®‰å…¨ä¸­é—´ä»¶**: CORSã€CSRFä¿æŠ¤
- **è®¤è¯ä¸­é—´ä»¶**: ç”¨æˆ·è®¤è¯å’Œæˆæƒ
- **ç¼“å­˜ä¸­é—´ä»¶**: HTTPç¼“å­˜æ§åˆ¶
- **å‹ç¼©ä¸­é—´ä»¶**: å“åº”å†…å®¹å‹ç¼©

#### 3.3.2 ä¸­é—´ä»¶æ³¨å†Œ
```php
$dispatcher = new MiddlewareDispatcher();
$dispatcher->registerMiddleware($compressionMiddleware);
$dispatcher->registerMiddleware($authMiddleware);
```

## 4. æ’ä»¶ç³»ç»Ÿè®¾è®¡

### 4.1 åº”ç”¨ç»“æ„

#### 4.1.1 æ ‡å‡†åº”ç”¨ç›®å½•ç»“æ„
```
apps/[app_name]/
â”œâ”€â”€ appinfo/
â”‚   â”œâ”€â”€ info.xml          # åº”ç”¨å…ƒæ•°æ®
â”‚   â”œâ”€â”€ routes.php        # è·¯ç”±å®šä¹‰
â”‚   â””â”€â”€ Application.php   # åº”ç”¨å¯åŠ¨ç±»
â”œâ”€â”€ lib/                  # PHPç±»åº“
â”‚   â”œâ”€â”€ Controller/       # æ§åˆ¶å™¨
â”‚   â”œâ”€â”€ Service/         # æœåŠ¡å±‚
â”‚   â”œâ”€â”€ Db/              # æ•°æ®è®¿é—®å±‚
â”‚   â””â”€â”€ Migration/       # æ•°æ®åº“è¿ç§»
â”œâ”€â”€ src/                 # å‰ç«¯æºç 
â”œâ”€â”€ templates/           # æ¨¡æ¿æ–‡ä»¶
â”œâ”€â”€ css/                # æ ·å¼æ–‡ä»¶
â”œâ”€â”€ img/                # å›¾ç‰‡èµ„æº
â”œâ”€â”€ l10n/               # å›½é™…åŒ–æ–‡ä»¶
â””â”€â”€ tests/              # æµ‹è¯•æ–‡ä»¶
```

#### 4.1.2 åº”ç”¨å…ƒæ•°æ® (info.xml)
```xml
<info>
    <id>app_name</id>
    <name>åº”ç”¨åç§°</name>
    <description>åº”ç”¨æè¿°</description>
    <version>1.0.0</version>
    <licence>agpl</licence>
    <author>ä½œè€…</author>
    <types>
        <filesystem/>
    </types>
    <dependencies>
        <nextcloud min-version="32" max-version="32"/>
    </dependencies>
    <background-jobs>
        <job>OCA\AppName\BackgroundJob\SomeJob</job>
    </background-jobs>
    <commands>
        <command>OCA\AppName\Command\SomeCommand</command>
    </commands>
</info>
```

### 4.2 åº”ç”¨ç”Ÿå‘½å‘¨æœŸ

#### 4.2.1 åº”ç”¨æ³¨å†Œé˜¶æ®µ
1. **è‡ªåŠ¨åŠ è½½æ³¨å†Œ**: æ³¨å†Œåº”ç”¨çš„PSR-4è‡ªåŠ¨åŠ è½½
2. **åº”ç”¨å®ä¾‹åŒ–**: åˆ›å»ºApplicationç±»å®ä¾‹
3. **æœåŠ¡æ³¨å†Œ**: æ³¨å†Œåº”ç”¨æä¾›çš„æœåŠ¡
4. **äº‹ä»¶ç›‘å¬å™¨æ³¨å†Œ**: æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨

#### 4.2.2 åº”ç”¨å¯åŠ¨é˜¶æ®µ
1. **ä¾èµ–æ£€æŸ¥**: æ£€æŸ¥åº”ç”¨ä¾èµ–æ˜¯å¦æ»¡è¶³
2. **æ•°æ®åº“è¿ç§»**: æ‰§è¡Œå¿…è¦çš„æ•°æ®åº“è¿ç§»
3. **è·¯ç”±æ³¨å†Œ**: æ³¨å†Œåº”ç”¨çš„è·¯ç”±è§„åˆ™
4. **åå°ä»»åŠ¡æ³¨å†Œ**: æ³¨å†Œåå°ä»»åŠ¡

### 4.3 æ’ä»¶å¼€å‘æ¥å£

#### 4.3.1 Bootstrapæ¥å£
```php
interface IBootstrap {
    public function register(IRegistrationContext $context): void;
    public function boot(IBootContext $context): void;
}
```

#### 4.3.2 åº”ç”¨åŸºç±»
```php
class Application extends App implements IBootstrap {
    public function register(IRegistrationContext $context): void {
        // æ³¨å†ŒæœåŠ¡ã€äº‹ä»¶ç›‘å¬å™¨ç­‰
    }
    
    public function boot(IBootContext $context): void {
        // åº”ç”¨å¯åŠ¨é€»è¾‘
    }
}
```

## 5. æ•°æ®åº“è®¾è®¡

### 5.1 æ•°æ®åº“æŠ½è±¡å±‚

#### 5.1.1 è¿æ¥ç®¡ç†
- **è¿æ¥æ± **: æ”¯æŒæ•°æ®åº“è¿æ¥æ± 
- **è¯»å†™åˆ†ç¦»**: æ”¯æŒä¸»ä»æ•°æ®åº“é…ç½®
- **äº‹åŠ¡ç®¡ç†**: æ”¯æŒæ•°æ®åº“äº‹åŠ¡

#### 5.1.2 æŸ¥è¯¢æ„å»ºå™¨
```php
$qb = $this->db->getQueryBuilder();
$qb->select('*')
   ->from('users')
   ->where($qb->expr()->eq('uid', $qb->createNamedParameter($uid)));
```

### 5.2 å®ä½“æ˜ å°„

#### 5.2.1 EntityåŸºç±»
```php
abstract class Entity {
    protected function addType(string $fieldName, string $type): void;
    public function fromRow(array $row): void;
    public function toRow(): array;
}
```

#### 5.2.2 MapperåŸºç±»
```php
abstract class QBMapper {
    public function find(int $id): Entity;
    public function findAll(): array;
    public function insert(Entity $entity): Entity;
    public function update(Entity $entity): Entity;
    public function delete(Entity $entity): Entity;
}
```

### 5.3 æ ¸å¿ƒæ•°æ®è¡¨

#### 5.3.1 ç”¨æˆ·ç›¸å…³è¡¨
- `oc_users`: ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
- `oc_preferences`: ç”¨æˆ·åå¥½è®¾ç½®
- `oc_groups`: ç”¨æˆ·ç»„ä¿¡æ¯
- `oc_group_user`: ç”¨æˆ·ç»„å…³ç³»

#### 5.3.2 æ–‡ä»¶ç›¸å…³è¡¨
- `oc_filecache`: æ–‡ä»¶ç¼“å­˜ä¿¡æ¯
- `oc_storages`: å­˜å‚¨åç«¯ä¿¡æ¯
- `oc_mounts`: æŒ‚è½½ç‚¹ä¿¡æ¯
- `oc_share`: æ–‡ä»¶åˆ†äº«ä¿¡æ¯

#### 5.3.3 åº”ç”¨ç›¸å…³è¡¨
- `oc_appconfig`: åº”ç”¨é…ç½®
- `oc_jobs`: åå°ä»»åŠ¡é˜Ÿåˆ—
- `oc_activity`: æ´»åŠ¨æ—¥å¿—

## 6. å®‰å…¨æ¶æ„

### 6.1 è®¤è¯ç³»ç»Ÿ

#### 6.1.1 è®¤è¯æ–¹å¼
- **ç”¨æˆ·åå¯†ç **: ä¼ ç»Ÿè®¤è¯æ–¹å¼
- **åŒå› ç´ è®¤è¯**: TOTPã€å¤‡ä»½ç ç­‰
- **LDAP/AD**: ä¼ä¸šç›®å½•æœåŠ¡é›†æˆ
- **SAML/OAuth**: å•ç‚¹ç™»å½•æ”¯æŒ

#### 6.1.2 ä¼šè¯ç®¡ç†
- **ä¼šè¯å­˜å‚¨**: æ•°æ®åº“æˆ–Rediså­˜å‚¨
- **ä¼šè¯å®‰å…¨**: CSRFä¿æŠ¤ã€ä¼šè¯å›ºå®šæ”»å‡»é˜²æŠ¤
- **ä¼šè¯è¿‡æœŸ**: å¯é…ç½®çš„ä¼šè¯è¶…æ—¶

### 6.2 æˆæƒç³»ç»Ÿ

#### 6.2.1 æƒé™æ¨¡å‹
- **ç”¨æˆ·æƒé™**: åŸºäºç”¨æˆ·çš„æƒé™æ§åˆ¶
- **ç»„æƒé™**: åŸºäºç”¨æˆ·ç»„çš„æƒé™æ§åˆ¶
- **æ–‡ä»¶æƒé™**: ç»†ç²’åº¦çš„æ–‡ä»¶è®¿é—®æ§åˆ¶

#### 6.2.2 è®¿é—®æ§åˆ¶
- **ACL**: è®¿é—®æ§åˆ¶åˆ—è¡¨
- **å…±äº«æƒé™**: æ–‡ä»¶å…±äº«æƒé™ç®¡ç†
- **APIæƒé™**: APIè®¿é—®æƒé™æ§åˆ¶

### 6.3 æ•°æ®å®‰å…¨

#### 6.3.1 åŠ å¯†æœºåˆ¶
- **ä¼ è¾“åŠ å¯†**: HTTPS/TLSåŠ å¯†
- **å­˜å‚¨åŠ å¯†**: æ–‡ä»¶çº§åŠ å¯†æ”¯æŒ
- **å¯†ç åŠ å¯†**: å¼ºå¯†ç å“ˆå¸Œç®—æ³•

#### 6.3.2 å®‰å…¨å®¡è®¡
- **æ“ä½œæ—¥å¿—**: ç”¨æˆ·æ“ä½œå®¡è®¡
- **å®‰å…¨äº‹ä»¶**: å®‰å…¨ç›¸å…³äº‹ä»¶è®°å½•
- **åˆè§„æŠ¥å‘Š**: å®‰å…¨åˆè§„æŠ¥å‘Šç”Ÿæˆ

## 7. APIè®¾è®¡

### 7.1 RESTful API

#### 7.1.1 APIç‰ˆæœ¬æ§åˆ¶
- **URLç‰ˆæœ¬**: `/api/v1/users`
- **Headerç‰ˆæœ¬**: `Accept: application/json; version=1`

#### 7.1.2 å“åº”æ ¼å¼
```json
{
    "data": {},
    "meta": {
        "status": "success",
        "message": "",
        "pagination": {}
    }
}
```

### 7.2 WebDAV API

#### 7.2.1 æ–‡ä»¶æ“ä½œ
- **PROPFIND**: è·å–æ–‡ä»¶å±æ€§
- **GET/PUT**: æ–‡ä»¶ä¸‹è½½/ä¸Šä¼ 
- **MOVE/COPY**: æ–‡ä»¶ç§»åŠ¨/å¤åˆ¶
- **DELETE**: æ–‡ä»¶åˆ é™¤

#### 7.2.2 æ‰©å±•å±æ€§
- **è‡ªå®šä¹‰å±æ€§**: æ”¯æŒè‡ªå®šä¹‰æ–‡ä»¶å±æ€§
- **å…ƒæ•°æ®**: æ–‡ä»¶å…ƒæ•°æ®ç®¡ç†

### 7.3 OCS API

#### 7.3.1 äº‘æœåŠ¡API
- **ç”¨æˆ·ç®¡ç†**: ç”¨æˆ·CRUDæ“ä½œ
- **åº”ç”¨ç®¡ç†**: åº”ç”¨å®‰è£…ã€å¯ç”¨ã€ç¦ç”¨
- **é…ç½®ç®¡ç†**: ç³»ç»Ÿé…ç½®ç®¡ç†

#### 7.3.2 è”é‚¦API
- **æœåŠ¡å‘ç°**: è”é‚¦æœåŠ¡å‘ç°
- **è·¨å®ä¾‹å…±äº«**: è·¨Nextcloudå®ä¾‹çš„æ–‡ä»¶å…±äº«

## 8. æ€§èƒ½ä¼˜åŒ–

### 8.1 ç¼“å­˜ç­–ç•¥

#### 8.1.1 å¤šçº§ç¼“å­˜
- **OPcache**: PHPå­—èŠ‚ç ç¼“å­˜
- **APCu**: ç”¨æˆ·æ•°æ®ç¼“å­˜
- **Redis**: åˆ†å¸ƒå¼ç¼“å­˜
- **HTTPç¼“å­˜**: æµè§ˆå™¨ç¼“å­˜æ§åˆ¶

#### 8.1.2 ç¼“å­˜å¤±æ•ˆ
- **TTL**: åŸºäºæ—¶é—´çš„ç¼“å­˜å¤±æ•ˆ
- **æ ‡ç­¾ç¼“å­˜**: åŸºäºæ ‡ç­¾çš„ç¼“å­˜å¤±æ•ˆ
- **äº‹ä»¶é©±åŠ¨**: åŸºäºäº‹ä»¶çš„ç¼“å­˜å¤±æ•ˆ

### 8.2 æ•°æ®åº“ä¼˜åŒ–

#### 8.2.1 æŸ¥è¯¢ä¼˜åŒ–
- **ç´¢å¼•ä¼˜åŒ–**: åˆç†çš„æ•°æ®åº“ç´¢å¼•è®¾è®¡
- **æŸ¥è¯¢ç¼“å­˜**: æ•°æ®åº“æŸ¥è¯¢ç»“æœç¼“å­˜
- **è¿æ¥æ± **: æ•°æ®åº“è¿æ¥æ± ç®¡ç†

#### 8.2.2 åˆ†åº“åˆ†è¡¨
- **æ°´å¹³åˆ†ç‰‡**: åŸºäºç”¨æˆ·IDçš„æ•°æ®åˆ†ç‰‡
- **å‚ç›´åˆ†ç‰‡**: åŸºäºåŠŸèƒ½æ¨¡å—çš„æ•°æ®åˆ†ç¦»

### 8.3 æ–‡ä»¶ç³»ç»Ÿä¼˜åŒ–

#### 8.3.1 å­˜å‚¨åç«¯
- **æœ¬åœ°å­˜å‚¨**: é«˜æ€§èƒ½æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿ
- **å¯¹è±¡å­˜å‚¨**: S3å…¼å®¹çš„å¯¹è±¡å­˜å‚¨
- **åˆ†å¸ƒå¼å­˜å‚¨**: åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿæ”¯æŒ

#### 8.3.2 æ–‡ä»¶ç¼“å­˜
- **æ–‡ä»¶ç¼“å­˜**: æ–‡ä»¶å…ƒæ•°æ®ç¼“å­˜
- **ç¼©ç•¥å›¾ç¼“å­˜**: å›¾ç‰‡ç¼©ç•¥å›¾ç¼“å­˜
- **é¢„è§ˆç¼“å­˜**: æ–‡ä»¶é¢„è§ˆç¼“å­˜

## 9. éƒ¨ç½²æ¶æ„

### 9.1 å•æœºéƒ¨ç½²

#### 9.1.1 LAMP/LEMPæ ˆ
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Load Balancer â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Web Server    â”‚
â”‚  (Nginx/Apache) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   PHP-FPM       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Database      â”‚
â”‚ (MySQL/MariaDB) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 9.1.2 å®¹å™¨åŒ–éƒ¨ç½²
```yaml
version: '3.8'
services:
  nextcloud:
    image: nextcloud:latest
    environment:
      - MYSQL_HOST=db
      - REDIS_HOST=redis
    volumes:
      - nextcloud_data:/var/www/html
  
  db:
    image: mariadb:latest
    environment:
      - MYSQL_ROOT_PASSWORD=secret
    volumes:
      - db_data:/var/lib/mysql
  
  redis:
    image: redis:alpine
```

### 9.2 é›†ç¾¤éƒ¨ç½²

#### 9.2.1 é«˜å¯ç”¨æ¶æ„
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Load Balancer  â”‚    â”‚  Load Balancer  â”‚
â”‚    (Primary)    â”‚    â”‚   (Secondary)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”´â”€â”€â”€â”€â”
    â”‚         â”‚                 â”‚     â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â” â”Œâ”€â”€â–¼â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ–¼â”€â”€â”€â–¼â”€â”
â”‚Web 1  â”‚ â”‚Web 2 â”‚ â”‚  Web 3  â”‚ â”‚Web N â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜
    â”‚         â”‚         â”‚         â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
         â”‚                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Database      â”‚ â”‚     Redis      â”‚
â”‚   Cluster       â”‚ â”‚    Cluster     â”‚
â”‚ (Master/Slave)  â”‚ â”‚ (Sentinel/HA)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 9.2.2 å¾®æœåŠ¡æ¶æ„
- **APIç½‘å…³**: ç»Ÿä¸€APIå…¥å£
- **æœåŠ¡æ³¨å†Œ**: æœåŠ¡å‘ç°å’Œæ³¨å†Œ
- **é…ç½®ä¸­å¿ƒ**: é›†ä¸­é…ç½®ç®¡ç†
- **ç›‘æ§å‘Šè­¦**: æœåŠ¡ç›‘æ§å’Œå‘Šè­¦

### 9.3 äº‘åŸç”Ÿéƒ¨ç½²

#### 9.3.1 Kuberneteséƒ¨ç½²
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nextcloud
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nextcloud
  template:
    metadata:
      labels:
        app: nextcloud
    spec:
      containers:
      - name: nextcloud
        image: nextcloud:latest
        ports:
        - containerPort: 80
        env:
        - name: MYSQL_HOST
          value: "mysql-service"
        volumeMounts:
        - name: nextcloud-data
          mountPath: /var/www/html
```

#### 9.3.2 æœåŠ¡ç½‘æ ¼
- **Istio**: æœåŠ¡é—´é€šä¿¡ç®¡ç†
- **Envoy**: ä»£ç†å’Œè´Ÿè½½å‡è¡¡
- **Jaeger**: åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ª

## 10. ç›‘æ§ä¸è¿ç»´

### 10.1 ç›‘æ§ä½“ç³»

#### 10.1.1 ç³»ç»Ÿç›‘æ§
- **èµ„æºç›‘æ§**: CPUã€å†…å­˜ã€ç£ç›˜ã€ç½‘ç»œ
- **æœåŠ¡ç›‘æ§**: WebæœåŠ¡ã€æ•°æ®åº“ã€ç¼“å­˜
- **åº”ç”¨ç›‘æ§**: åº”ç”¨æ€§èƒ½ã€é”™è¯¯ç‡ã€å“åº”æ—¶é—´

#### 10.1.2 ä¸šåŠ¡ç›‘æ§
- **ç”¨æˆ·è¡Œä¸º**: ç”¨æˆ·æ´»è·ƒåº¦ã€åŠŸèƒ½ä½¿ç”¨æƒ…å†µ
- **æ–‡ä»¶æ“ä½œ**: æ–‡ä»¶ä¸Šä¼ ä¸‹è½½ç»Ÿè®¡
- **å…±äº«ç»Ÿè®¡**: æ–‡ä»¶å…±äº«ä½¿ç”¨æƒ…å†µ

### 10.2 æ—¥å¿—ç®¡ç†

#### 10.2.1 æ—¥å¿—æ”¶é›†
- **åº”ç”¨æ—¥å¿—**: Nextcloudåº”ç”¨æ—¥å¿—
- **è®¿é—®æ—¥å¿—**: WebæœåŠ¡å™¨è®¿é—®æ—¥å¿—
- **ç³»ç»Ÿæ—¥å¿—**: æ“ä½œç³»ç»Ÿæ—¥å¿—

#### 10.2.2 æ—¥å¿—åˆ†æ
- **ELK Stack**: Elasticsearch + Logstash + Kibana
- **æ—¥å¿—èšåˆ**: å¤šèŠ‚ç‚¹æ—¥å¿—èšåˆ
- **å®æ—¶åˆ†æ**: å®æ—¶æ—¥å¿—åˆ†æå’Œå‘Šè­¦

### 10.3 å¤‡ä»½æ¢å¤

#### 10.3.1 å¤‡ä»½ç­–ç•¥
- **æ•°æ®å¤‡ä»½**: æ•°æ®åº“å’Œæ–‡ä»¶æ•°æ®å¤‡ä»½
- **é…ç½®å¤‡ä»½**: ç³»ç»Ÿé…ç½®æ–‡ä»¶å¤‡ä»½
- **å¢é‡å¤‡ä»½**: å¢é‡æ•°æ®å¤‡ä»½

#### 10.3.2 æ¢å¤æœºåˆ¶
- **è‡ªåŠ¨æ¢å¤**: è‡ªåŠ¨æ•…éšœæ¢å¤
- **æ‰‹åŠ¨æ¢å¤**: æ‰‹åŠ¨æ•°æ®æ¢å¤
- **ç¾éš¾æ¢å¤**: ç¾éš¾æ¢å¤é¢„æ¡ˆ

## 11. å¼€å‘è§„èŒƒ

### 11.1 ä»£ç è§„èŒƒ

#### 11.1.1 PHPä»£ç è§„èŒƒ
- **PSRæ ‡å‡†**: éµå¾ªPSR-1ã€PSR-2ã€PSR-4æ ‡å‡†
- **ç±»å‹å£°æ˜**: ä½¿ç”¨ä¸¥æ ¼ç±»å‹å£°æ˜
- **æ–‡æ¡£æ³¨é‡Š**: å®Œæ•´çš„PHPDocæ³¨é‡Š

#### 11.1.2 å‰ç«¯ä»£ç è§„èŒƒ
- **ESLint**: JavaScriptä»£ç æ£€æŸ¥
- **TypeScript**: ç±»å‹å®‰å…¨çš„JavaScript
- **Vueé£æ ¼æŒ‡å—**: éµå¾ªVue.jså®˜æ–¹é£æ ¼æŒ‡å—

### 11.2 æµ‹è¯•è§„èŒƒ

#### 11.2.1 å•å…ƒæµ‹è¯•
- **PHPUnit**: PHPå•å…ƒæµ‹è¯•æ¡†æ¶
- **Jest**: JavaScriptå•å…ƒæµ‹è¯•æ¡†æ¶
- **è¦†ç›–ç‡**: ä»£ç è¦†ç›–ç‡è¦æ±‚

#### 11.2.2 é›†æˆæµ‹è¯•
- **APIæµ‹è¯•**: RESTful APIé›†æˆæµ‹è¯•
- **ç«¯åˆ°ç«¯æµ‹è¯•**: Cypressç«¯åˆ°ç«¯æµ‹è¯•
- **æ€§èƒ½æµ‹è¯•**: æ€§èƒ½åŸºå‡†æµ‹è¯•

### 11.3 ç‰ˆæœ¬æ§åˆ¶

#### 11.3.1 Gitå·¥ä½œæµ
- **åˆ†æ”¯ç­–ç•¥**: Git Flowåˆ†æ”¯ç­–ç•¥
- **æäº¤è§„èŒƒ**: è§„èŒƒçš„æäº¤ä¿¡æ¯æ ¼å¼
- **ä»£ç å®¡æŸ¥**: Pull Requestä»£ç å®¡æŸ¥

#### 11.3.2 å‘å¸ƒç®¡ç†
- **è¯­ä¹‰åŒ–ç‰ˆæœ¬**: éµå¾ªè¯­ä¹‰åŒ–ç‰ˆæœ¬è§„èŒƒ
- **å‘å¸ƒæµç¨‹**: è‡ªåŠ¨åŒ–å‘å¸ƒæµç¨‹
- **å›æ»šæœºåˆ¶**: å¿«é€Ÿå›æ»šæœºåˆ¶

## 12. æ‰©å±•æ€§è®¾è®¡

### 12.1 æ°´å¹³æ‰©å±•

#### 12.1.1 æ— çŠ¶æ€è®¾è®¡
- **ä¼šè¯å¤–ç½®**: ä¼šè¯å­˜å‚¨å¤–ç½®åˆ°Redis
- **æ–‡ä»¶å­˜å‚¨**: ä½¿ç”¨åˆ†å¸ƒå¼æ–‡ä»¶å­˜å‚¨
- **ç¼“å­˜åˆ†ç¦»**: ç¼“å­˜æœåŠ¡ç‹¬ç«‹éƒ¨ç½²

#### 12.1.2 è´Ÿè½½å‡è¡¡
- **åº”ç”¨å±‚è´Ÿè½½å‡è¡¡**: å¤šä¸ªWebæœåŠ¡å™¨å®ä¾‹
- **æ•°æ®åº“è´Ÿè½½å‡è¡¡**: è¯»å†™åˆ†ç¦»å’Œåˆ†åº“åˆ†è¡¨
- **å­˜å‚¨è´Ÿè½½å‡è¡¡**: åˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿ

### 12.2 å‚ç›´æ‰©å±•

#### 12.2.1 æ€§èƒ½ä¼˜åŒ–
- **ä»£ç ä¼˜åŒ–**: ç®—æ³•å’Œæ•°æ®ç»“æ„ä¼˜åŒ–
- **æ•°æ®åº“ä¼˜åŒ–**: æŸ¥è¯¢ä¼˜åŒ–å’Œç´¢å¼•ä¼˜åŒ–
- **ç¼“å­˜ä¼˜åŒ–**: å¤šçº§ç¼“å­˜ç­–ç•¥

#### 12.2.2 èµ„æºæ‰©å±•
- **ç¡¬ä»¶å‡çº§**: CPUã€å†…å­˜ã€å­˜å‚¨å‡çº§
- **ç½‘ç»œä¼˜åŒ–**: ç½‘ç»œå¸¦å®½å’Œå»¶è¿Ÿä¼˜åŒ–
- **å­˜å‚¨ä¼˜åŒ–**: SSDå­˜å‚¨å’Œå­˜å‚¨ä¼˜åŒ–

### 12.3 åŠŸèƒ½æ‰©å±•

#### 12.3.1 æ’ä»¶æœºåˆ¶
- **Hookç³»ç»Ÿ**: äº‹ä»¶é’©å­æœºåˆ¶
- **APIæ‰©å±•**: å¯æ‰©å±•çš„APIæ¥å£
- **ä¸»é¢˜ç³»ç»Ÿ**: å¯å®šåˆ¶çš„ä¸»é¢˜ç³»ç»Ÿ

#### 12.3.2 é›†æˆèƒ½åŠ›
- **ç¬¬ä¸‰æ–¹é›†æˆ**: ç¬¬ä¸‰æ–¹æœåŠ¡é›†æˆ
- **APIå¼€æ”¾**: å¼€æ”¾APIä¾›ç¬¬ä¸‰æ–¹è°ƒç”¨
- **Webhook**: äº‹ä»¶é€šçŸ¥æœºåˆ¶

## 13. æ’ä»¶å¼€å‘è¯¦ç»†æŒ‡å—

### 13.1 æ’ä»¶å¼€å‘ç¯å¢ƒæ­å»º

#### 13.1.1 å¼€å‘ç¯å¢ƒè¦æ±‚
```bash
# åŸºç¡€ç¯å¢ƒ
- PHP 8.1+
- Node.js 18+
- Composer 2.x
- npm/yarn

# å¼€å‘å·¥å…·
- PHPStorm/VSCode
- Xdebug (è°ƒè¯•)
- PHPUnit (æµ‹è¯•)
- Webpack (å‰ç«¯æ„å»º)
```

#### 13.1.2 åˆ›å»ºæ–°æ’ä»¶
```bash
# 1. åˆ›å»ºæ’ä»¶ç›®å½•
mkdir apps/my_plugin
cd apps/my_plugin

# 2. åˆå§‹åŒ–composer
composer init

# 3. åˆ›å»ºåŸºç¡€ç›®å½•ç»“æ„
mkdir -p {appinfo,lib/{Controller,Service,Db},src,templates,css,img,l10n,tests}

# 4. åˆ›å»ºinfo.xml
cat > appinfo/info.xml << EOF
<?xml version="1.0"?>
<info>
    <id>my_plugin</id>
    <name>My Plugin</name>
    <summary>A sample plugin</summary>
    <description>This is a sample plugin for Nextcloud</description>
    <version>1.0.0</version>
    <licence>agpl</licence>
    <author>Your Name</author>
    <category>tools</category>
    <dependencies>
        <nextcloud min-version="32" max-version="32"/>
    </dependencies>
</info>
EOF
```

### 13.2 æ’ä»¶æ ¸å¿ƒç»„ä»¶å¼€å‘

#### 13.2.1 Applicationç±»å®ç°
```php
<?php
// lib/AppInfo/Application.php
namespace OCA\MyPlugin\AppInfo;

use OCP\AppFramework\App;
use OCP\AppFramework\Bootstrap\IBootContext;
use OCP\AppFramework\Bootstrap\IBootstrap;
use OCP\AppFramework\Bootstrap\IRegistrationContext;

class Application extends App implements IBootstrap {
    public const APP_ID = 'my_plugin';

    public function __construct(array $urlParams = []) {
        parent::__construct(self::APP_ID, $urlParams);
    }

    public function register(IRegistrationContext $context): void {
        // æ³¨å†ŒæœåŠ¡
        $context->registerService('MyService', function($c) {
            return new \OCA\MyPlugin\Service\MyService(
                $c->get(\OCP\IDBConnection::class),
                $c->get(\Psr\Log\LoggerInterface::class)
            );
        });

        // æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨
        $context->registerEventListener(
            \OCP\Files\Events\Node\NodeCreatedEvent::class,
            \OCA\MyPlugin\Listener\FileCreatedListener::class
        );

        // æ³¨å†Œä¸­é—´ä»¶
        $context->registerMiddleware(\OCA\MyPlugin\Middleware\AuthMiddleware::class);

        // æ³¨å†Œåå°ä»»åŠ¡
        $context->registerBackgroundJob(\OCA\MyPlugin\BackgroundJob\CleanupJob::class);
    }

    public function boot(IBootContext $context): void {
        // åº”ç”¨å¯åŠ¨é€»è¾‘
        $container = $context->getAppContainer();

        // æ³¨å†Œå¯¼èˆªèœå•
        $navigationManager = $container->get(\OCP\INavigationManager::class);
        $navigationManager->add([
            'id' => self::APP_ID,
            'order' => 10,
            'href' => $container->get(\OCP\IURLGenerator::class)->linkToRoute('my_plugin.page.index'),
            'icon' => $container->get(\OCP\IURLGenerator::class)->imagePath(self::APP_ID, 'app.svg'),
            'name' => 'My Plugin'
        ]);
    }
}
```

#### 13.2.2 æ§åˆ¶å™¨å¼€å‘
```php
<?php
// lib/Controller/ApiController.php
namespace OCA\MyPlugin\Controller;

use OCP\AppFramework\ApiController;
use OCP\AppFramework\Http\DataResponse;
use OCP\IRequest;

class ApiController extends ApiController {
    private $service;

    public function __construct(
        string $appName,
        IRequest $request,
        \OCA\MyPlugin\Service\MyService $service
    ) {
        parent::__construct($appName, $request);
        $this->service = $service;
    }

    /**
     * @NoAdminRequired
     * @NoCSRFRequired
     */
    public function index(): DataResponse {
        try {
            $data = $this->service->getData();
            return new DataResponse($data);
        } catch (\Exception $e) {
            return new DataResponse(['error' => $e->getMessage()], 500);
        }
    }

    /**
     * @NoAdminRequired
     */
    public function create(string $name, string $description): DataResponse {
        try {
            $item = $this->service->create($name, $description);
            return new DataResponse($item);
        } catch (\Exception $e) {
            return new DataResponse(['error' => $e->getMessage()], 400);
        }
    }
}
```

#### 13.2.3 æœåŠ¡å±‚å¼€å‘
```php
<?php
// lib/Service/MyService.php
namespace OCA\MyPlugin\Service;

use OCP\IDBConnection;
use Psr\Log\LoggerInterface;

class MyService {
    private $db;
    private $logger;

    public function __construct(IDBConnection $db, LoggerInterface $logger) {
        $this->db = $db;
        $this->logger = $logger;
    }

    public function getData(): array {
        $qb = $this->db->getQueryBuilder();
        $qb->select('*')
           ->from('my_plugin_items')
           ->orderBy('created_at', 'DESC');

        $result = $qb->execute();
        $data = $result->fetchAll();
        $result->closeCursor();

        return $data;
    }

    public function create(string $name, string $description): array {
        $qb = $this->db->getQueryBuilder();
        $qb->insert('my_plugin_items')
           ->values([
               'name' => $qb->createNamedParameter($name),
               'description' => $qb->createNamedParameter($description),
               'created_at' => $qb->createNamedParameter(time())
           ]);

        $qb->execute();
        $id = $qb->getLastInsertId();

        $this->logger->info('Created new item', ['id' => $id, 'name' => $name]);

        return [
            'id' => $id,
            'name' => $name,
            'description' => $description,
            'created_at' => time()
        ];
    }
}
```

#### 13.2.4 æ•°æ®è®¿é—®å±‚å¼€å‘
```php
<?php
// lib/Db/Item.php
namespace OCA\MyPlugin\Db;

use OCP\AppFramework\Db\Entity;

/**
 * @method int getId()
 * @method void setId(int $id)
 * @method string getName()
 * @method void setName(string $name)
 * @method string getDescription()
 * @method void setDescription(string $description)
 * @method int getCreatedAt()
 * @method void setCreatedAt(int $createdAt)
 */
class Item extends Entity {
    protected $name;
    protected $description;
    protected $createdAt;

    public function __construct() {
        $this->addType('id', 'integer');
        $this->addType('name', 'string');
        $this->addType('description', 'string');
        $this->addType('createdAt', 'integer');
    }
}

// lib/Db/ItemMapper.php
namespace OCA\MyPlugin\Db;

use OCP\AppFramework\Db\QBMapper;
use OCP\IDBConnection;

class ItemMapper extends QBMapper {
    public function __construct(IDBConnection $db) {
        parent::__construct($db, 'my_plugin_items', Item::class);
    }

    public function findAll(): array {
        $qb = $this->db->getQueryBuilder();
        $qb->select('*')
           ->from($this->getTableName())
           ->orderBy('created_at', 'DESC');

        return $this->findEntities($qb);
    }

    public function findByName(string $name): array {
        $qb = $this->db->getQueryBuilder();
        $qb->select('*')
           ->from($this->getTableName())
           ->where($qb->expr()->like('name', $qb->createNamedParameter('%' . $name . '%')));

        return $this->findEntities($qb);
    }
}
```

### 13.3 å‰ç«¯å¼€å‘

#### 13.3.1 Vue.jsç»„ä»¶å¼€å‘
```javascript
// src/components/ItemList.vue
<template>
  <div class="item-list">
    <h2>{{ t('my_plugin', 'My Items') }}</h2>

    <div class="item-form">
      <input v-model="newItem.name"
             :placeholder="t('my_plugin', 'Item name')" />
      <textarea v-model="newItem.description"
                :placeholder="t('my_plugin', 'Description')"></textarea>
      <button @click="createItem">{{ t('my_plugin', 'Create') }}</button>
    </div>

    <div class="items">
      <div v-for="item in items" :key="item.id" class="item">
        <h3>{{ item.name }}</h3>
        <p>{{ item.description }}</p>
        <small>{{ formatDate(item.created_at) }}</small>
      </div>
    </div>
  </div>
</template>

<script>
import axios from '@nextcloud/axios'
import { generateUrl } from '@nextcloud/router'
import { translate as t } from '@nextcloud/l10n'

export default {
  name: 'ItemList',
  data() {
    return {
      items: [],
      newItem: {
        name: '',
        description: ''
      }
    }
  },
  async mounted() {
    await this.loadItems()
  },
  methods: {
    t,
    async loadItems() {
      try {
        const response = await axios.get(generateUrl('/apps/my_plugin/api/items'))
        this.items = response.data
      } catch (error) {
        console.error('Failed to load items:', error)
      }
    },
    async createItem() {
      try {
        const response = await axios.post(generateUrl('/apps/my_plugin/api/items'), {
          name: this.newItem.name,
          description: this.newItem.description
        })
        this.items.unshift(response.data)
        this.newItem = { name: '', description: '' }
      } catch (error) {
        console.error('Failed to create item:', error)
      }
    },
    formatDate(timestamp) {
      return new Date(timestamp * 1000).toLocaleDateString()
    }
  }
}
</script>

<style scoped>
.item-list {
  padding: 20px;
}

.item-form {
  margin-bottom: 20px;
  display: flex;
  gap: 10px;
  flex-direction: column;
  max-width: 400px;
}

.item {
  border: 1px solid #ddd;
  padding: 15px;
  margin-bottom: 10px;
  border-radius: 5px;
}
</style>
```

#### 13.3.2 Webpacké…ç½®
```javascript
// webpack.config.js
const path = require('path')
const { VueLoaderPlugin } = require('vue-loader')

module.exports = {
  entry: {
    main: path.join(__dirname, 'src', 'main.js')
  },
  output: {
    path: path.resolve(__dirname, 'js'),
    filename: '[name].js',
    chunkFilename: '[name].[contenthash].js'
  },
  module: {
    rules: [
      {
        test: /\.vue$/,
        loader: 'vue-loader'
      },
      {
        test: /\.js$/,
        loader: 'babel-loader',
        exclude: /node_modules/
      },
      {
        test: /\.css$/,
        use: ['style-loader', 'css-loader']
      }
    ]
  },
  plugins: [
    new VueLoaderPlugin()
  ],
  resolve: {
    extensions: ['.js', '.vue'],
    alias: {
      '@': path.resolve(__dirname, 'src')
    }
  }
}
```

### 13.4 æ•°æ®åº“è¿ç§»

#### 13.4.1 è¿ç§»æ–‡ä»¶
```php
<?php
// lib/Migration/Version1000Date20240101000000.php
namespace OCA\MyPlugin\Migration;

use Closure;
use OCP\DB\ISchemaWrapper;
use OCP\Migration\IOutput;
use OCP\Migration\SimpleMigrationStep;

class Version1000Date20240101000000 extends SimpleMigrationStep {
    public function changeSchema(IOutput $output, Closure $schemaClosure, array $options): ?ISchemaWrapper {
        /** @var ISchemaWrapper $schema */
        $schema = $schemaClosure();

        if (!$schema->hasTable('my_plugin_items')) {
            $table = $schema->createTable('my_plugin_items');
            $table->addColumn('id', 'bigint', [
                'autoincrement' => true,
                'notnull' => true,
                'unsigned' => true,
            ]);
            $table->addColumn('name', 'string', [
                'notnull' => true,
                'length' => 255,
            ]);
            $table->addColumn('description', 'text', [
                'notnull' => false,
            ]);
            $table->addColumn('created_at', 'integer', [
                'notnull' => true,
                'unsigned' => true,
            ]);
            $table->addColumn('updated_at', 'integer', [
                'notnull' => true,
                'unsigned' => true,
            ]);

            $table->setPrimaryKey(['id']);
            $table->addIndex(['name'], 'my_plugin_items_name_idx');
            $table->addIndex(['created_at'], 'my_plugin_items_created_at_idx');
        }

        return $schema;
    }
}
```

### 13.5 äº‹ä»¶ç›‘å¬å™¨

#### 13.5.1 æ–‡ä»¶äº‹ä»¶ç›‘å¬
```php
<?php
// lib/Listener/FileCreatedListener.php
namespace OCA\MyPlugin\Listener;

use OCP\EventDispatcher\Event;
use OCP\EventDispatcher\IEventListener;
use OCP\Files\Events\Node\NodeCreatedEvent;
use Psr\Log\LoggerInterface;

class FileCreatedListener implements IEventListener {
    private $logger;

    public function __construct(LoggerInterface $logger) {
        $this->logger = $logger;
    }

    public function handle(Event $event): void {
        if (!($event instanceof NodeCreatedEvent)) {
            return;
        }

        $node = $event->getNode();

        // è®°å½•æ–‡ä»¶åˆ›å»ºäº‹ä»¶
        $this->logger->info('File created', [
            'path' => $node->getPath(),
            'size' => $node->getSize(),
            'mimetype' => $node->getMimetype()
        ]);

        // æ‰§è¡Œè‡ªå®šä¹‰é€»è¾‘
        if ($node->getMimetype() === 'image/jpeg') {
            // å¤„ç†JPEGå›¾ç‰‡
            $this->processImage($node);
        }
    }

    private function processImage($node): void {
        // å›¾ç‰‡å¤„ç†é€»è¾‘
    }
}
```

### 13.6 åå°ä»»åŠ¡

#### 13.6.1 å®šæ—¶ä»»åŠ¡
```php
<?php
// lib/BackgroundJob/CleanupJob.php
namespace OCA\MyPlugin\BackgroundJob;

use OCP\BackgroundJob\TimedJob;
use OCP\IDBConnection;
use Psr\Log\LoggerInterface;

class CleanupJob extends TimedJob {
    private $db;
    private $logger;

    public function __construct(IDBConnection $db, LoggerInterface $logger) {
        $this->db = $db;
        $this->logger = $logger;

        // æ¯å°æ—¶æ‰§è¡Œä¸€æ¬¡
        $this->setInterval(3600);
    }

    protected function run($argument): void {
        $this->logger->info('Running cleanup job');

        // æ¸…ç†30å¤©å‰çš„æ•°æ®
        $cutoff = time() - (30 * 24 * 3600);

        $qb = $this->db->getQueryBuilder();
        $qb->delete('my_plugin_items')
           ->where($qb->expr()->lt('created_at', $qb->createNamedParameter($cutoff)));

        $deletedCount = $qb->execute();

        $this->logger->info('Cleanup job completed', ['deleted' => $deletedCount]);
    }
}
```

### 13.7 å‘½ä»¤è¡Œå·¥å…·

#### 13.7.1 è‡ªå®šä¹‰å‘½ä»¤
```php
<?php
// lib/Command/ImportCommand.php
namespace OCA\MyPlugin\Command;

use Symfony\Component\Console\Command\Command;
use Symfony\Component\Console\Input\InputArgument;
use Symfony\Component\Console\Input\InputInterface;
use Symfony\Component\Console\Output\OutputInterface;

class ImportCommand extends Command {
    private $service;

    public function __construct(\OCA\MyPlugin\Service\MyService $service) {
        parent::__construct();
        $this->service = $service;
    }

    protected function configure(): void {
        $this->setName('my-plugin:import')
             ->setDescription('Import data from file')
             ->addArgument('file', InputArgument::REQUIRED, 'Path to import file');
    }

    protected function execute(InputInterface $input, OutputInterface $output): int {
        $file = $input->getArgument('file');

        if (!file_exists($file)) {
            $output->writeln('<error>File not found: ' . $file . '</error>');
            return 1;
        }

        $output->writeln('Importing data from: ' . $file);

        $data = json_decode(file_get_contents($file), true);
        $count = 0;

        foreach ($data as $item) {
            $this->service->create($item['name'], $item['description']);
            $count++;
        }

        $output->writeln('<info>Imported ' . $count . ' items successfully</info>');
        return 0;
    }
}
```

### 13.8 æµ‹è¯•å¼€å‘

#### 13.8.1 å•å…ƒæµ‹è¯•
```php
<?php
// tests/Unit/Service/MyServiceTest.php
namespace OCA\MyPlugin\Tests\Unit\Service;

use OCA\MyPlugin\Service\MyService;
use OCP\IDBConnection;
use PHPUnit\Framework\TestCase;
use Psr\Log\LoggerInterface;

class MyServiceTest extends TestCase {
    private $service;
    private $db;
    private $logger;

    protected function setUp(): void {
        $this->db = $this->createMock(IDBConnection::class);
        $this->logger = $this->createMock(LoggerInterface::class);
        $this->service = new MyService($this->db, $this->logger);
    }

    public function testCreate(): void {
        $qb = $this->createMock(\OCP\DB\QueryBuilder\IQueryBuilder::class);
        $this->db->expects($this->once())
                 ->method('getQueryBuilder')
                 ->willReturn($qb);

        $qb->expects($this->once())
           ->method('insert')
           ->with('my_plugin_items')
           ->willReturnSelf();

        $result = $this->service->create('Test Item', 'Test Description');

        $this->assertIsArray($result);
        $this->assertEquals('Test Item', $result['name']);
        $this->assertEquals('Test Description', $result['description']);
    }
}
```

#### 13.8.2 é›†æˆæµ‹è¯•
```php
<?php
// tests/Integration/ApiTest.php
namespace OCA\MyPlugin\Tests\Integration;

use OCP\AppFramework\App;
use Test\TestCase;

class ApiTest extends TestCase {
    private $container;

    protected function setUp(): void {
        parent::setUp();
        $app = new App('my_plugin');
        $this->container = $app->getContainer();
    }

    public function testApiEndpoint(): void {
        $controller = $this->container->get(\OCA\MyPlugin\Controller\ApiController::class);
        $response = $controller->index();

        $this->assertEquals(200, $response->getStatus());
        $this->assertIsArray($response->getData());
    }
}
```

### 13.9 å›½é™…åŒ–æ”¯æŒ

#### 13.9.1 ç¿»è¯‘æ–‡ä»¶
```json
// l10n/zh_CN.json
{
    "My Plugin": "æˆ‘çš„æ’ä»¶",
    "Item name": "é¡¹ç›®åç§°",
    "Description": "æè¿°",
    "Create": "åˆ›å»º",
    "My Items": "æˆ‘çš„é¡¹ç›®",
    "Import data from file": "ä»æ–‡ä»¶å¯¼å…¥æ•°æ®",
    "File not found": "æ–‡ä»¶æœªæ‰¾åˆ°"
}
```

#### 13.9.2 å‰ç«¯å›½é™…åŒ–
```javascript
// src/main.js
import { translate as t, translatePlural as n } from '@nextcloud/l10n'

// åœ¨ç»„ä»¶ä¸­ä½¿ç”¨
export default {
    methods: {
        t,
        n,
        getMessage() {
            return this.t('my_plugin', 'Hello {name}', { name: 'World' })
        }
    }
}
```

### 13.10 æ’ä»¶å‘å¸ƒ

#### 13.10.1 åº”ç”¨å•†åº—å‘å¸ƒ
```bash
# 1. å‡†å¤‡å‘å¸ƒåŒ…
make appstore

# 2. åˆ›å»ºç­¾å
openssl dgst -sha512 -sign ~/.nextcloud/certificates/my_plugin.key my_plugin.tar.gz | openssl base64

# 3. ä¸Šä¼ åˆ°åº”ç”¨å•†åº—
# è®¿é—® https://apps.nextcloud.com/developer/
```

#### 13.10.2 ç‰ˆæœ¬ç®¡ç†
```xml
<!-- appinfo/info.xml -->
<info>
    <version>1.1.0</version>
    <dependencies>
        <nextcloud min-version="32" max-version="33"/>
    </dependencies>
</info>
```

---

*æœ¬æ–‡æ¡£å°†æŒç»­æ›´æ–°ï¼Œä»¥åæ˜ ç³»ç»Ÿæ¶æ„çš„æœ€æ–°å˜åŒ–å’Œæ”¹è¿›ã€‚*
