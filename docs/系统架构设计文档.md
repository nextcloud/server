# Nextcloud 系统架构设计与需求文档

## 1. 项目概述

### 1.1 项目简介
Nextcloud是一个开源的云存储和协作平台，提供文件同步、共享、协作等功能。它采用模块化架构设计，支持丰富的插件生态系统，为用户提供安全、可扩展的私有云解决方案。

### 1.2 核心特性
- 📁 **数据访问**: 在自选服务器上存储文件、联系人、日历等数据
- 🔄 **数据同步**: 在多设备间保持数据同步
- 🙌 **数据共享**: 与他人共享和协作
- 🚀 **应用扩展**: 支持数百个应用插件
- 🔒 **安全保障**: 加密机制、安全审计、双因素认证

### 1.3 技术栈
- **后端**: PHP 8.x, Symfony组件
- **前端**: Vue.js 3, TypeScript, Webpack
- **数据库**: MySQL/MariaDB, PostgreSQL, SQLite
- **存储**: 本地文件系统, S3, WebDAV等
- **缓存**: Redis, APCu
- **搜索**: Elasticsearch (可选)

## 2. 系统架构概览

### 2.1 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    客户端层 (Client Layer)                    │
├─────────────────────────────────────────────────────────────┤
│  Web浏览器  │  桌面客户端  │  移动应用  │  WebDAV客户端  │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                   Web服务器层 (Web Server)                   │
├─────────────────────────────────────────────────────────────┤
│           Nginx/Apache + PHP-FPM                           │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                  应用层 (Application Layer)                  │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │   核心框架   │  │  应用管理器  │  │  插件系统   │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │  路由系统   │  │  事件系统   │  │  中间件     │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                   服务层 (Service Layer)                     │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │  用户管理   │  │  文件服务   │  │  共享服务   │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │  认证服务   │  │  通知服务   │  │  搜索服务   │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                   数据层 (Data Layer)                        │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │   数据库    │  │  文件存储   │  │    缓存     │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 核心组件

#### 2.2.1 核心框架 (Core Framework)
- **OC类**: 全局命名空间，管理服务器根路径、Web根路径等
- **Server容器**: 依赖注入容器，管理服务实例
- **AppFramework**: 应用开发框架，提供MVC模式支持

#### 2.2.2 应用管理器 (App Manager)
- **应用加载**: 自动加载已启用的应用
- **应用注册**: 注册应用的自动加载路径
- **生命周期管理**: 管理应用的启动、停止等生命周期

#### 2.2.3 路由系统 (Routing System)
- **URL路由**: 将HTTP请求路由到对应的控制器
- **API路由**: 支持RESTful API和OCS API
- **WebDAV路由**: 支持WebDAV协议访问

## 3. 核心模块设计

### 3.1 依赖注入系统

#### 3.1.1 容器架构
```php
// 服务器容器
class ServerContainer extends SimpleContainer {
    // 全局服务注册
}

// 应用容器  
class DIContainer extends SimpleContainer implements IAppContainer {
    // 应用级服务注册
    // 中间件注册
    // 服务查询和实例化
}
```

#### 3.1.2 服务注册机制
- **服务别名**: 支持接口到实现类的映射
- **延迟加载**: 支持服务的延迟实例化
- **作用域管理**: 区分全局服务和应用级服务

### 3.2 事件系统

#### 3.2.1 事件分发器
```php
interface IEventDispatcher {
    public function addListener(string $eventName, callable $listener, int $priority = 0): void;
    public function dispatchTyped(Event $event): void;
}
```

#### 3.2.2 事件类型
- **系统事件**: 用户登录、文件操作等核心事件
- **应用事件**: 应用自定义事件
- **广播事件**: 支持跨实例的事件广播

### 3.3 中间件系统

#### 3.3.1 中间件类型
- **安全中间件**: CORS、CSRF保护
- **认证中间件**: 用户认证和授权
- **缓存中间件**: HTTP缓存控制
- **压缩中间件**: 响应内容压缩

#### 3.3.2 中间件注册
```php
$dispatcher = new MiddlewareDispatcher();
$dispatcher->registerMiddleware($compressionMiddleware);
$dispatcher->registerMiddleware($authMiddleware);
```

## 4. 插件系统设计

### 4.1 应用结构

#### 4.1.1 标准应用目录结构
```
apps/[app_name]/
├── appinfo/
│   ├── info.xml          # 应用元数据
│   ├── routes.php        # 路由定义
│   └── Application.php   # 应用启动类
├── lib/                  # PHP类库
│   ├── Controller/       # 控制器
│   ├── Service/         # 服务层
│   ├── Db/              # 数据访问层
│   └── Migration/       # 数据库迁移
├── src/                 # 前端源码
├── templates/           # 模板文件
├── css/                # 样式文件
├── img/                # 图片资源
├── l10n/               # 国际化文件
└── tests/              # 测试文件
```

#### 4.1.2 应用元数据 (info.xml)
```xml
<info>
    <id>app_name</id>
    <name>应用名称</name>
    <description>应用描述</description>
    <version>1.0.0</version>
    <licence>agpl</licence>
    <author>作者</author>
    <types>
        <filesystem/>
    </types>
    <dependencies>
        <nextcloud min-version="32" max-version="32"/>
    </dependencies>
    <background-jobs>
        <job>OCA\AppName\BackgroundJob\SomeJob</job>
    </background-jobs>
    <commands>
        <command>OCA\AppName\Command\SomeCommand</command>
    </commands>
</info>
```

### 4.2 应用生命周期

#### 4.2.1 应用注册阶段
1. **自动加载注册**: 注册应用的PSR-4自动加载
2. **应用实例化**: 创建Application类实例
3. **服务注册**: 注册应用提供的服务
4. **事件监听器注册**: 注册事件监听器

#### 4.2.2 应用启动阶段
1. **依赖检查**: 检查应用依赖是否满足
2. **数据库迁移**: 执行必要的数据库迁移
3. **路由注册**: 注册应用的路由规则
4. **后台任务注册**: 注册后台任务

### 4.3 插件开发接口

#### 4.3.1 Bootstrap接口
```php
interface IBootstrap {
    public function register(IRegistrationContext $context): void;
    public function boot(IBootContext $context): void;
}
```

#### 4.3.2 应用基类
```php
class Application extends App implements IBootstrap {
    public function register(IRegistrationContext $context): void {
        // 注册服务、事件监听器等
    }
    
    public function boot(IBootContext $context): void {
        // 应用启动逻辑
    }
}
```

## 5. 数据库设计

### 5.1 数据库抽象层

#### 5.1.1 连接管理
- **连接池**: 支持数据库连接池
- **读写分离**: 支持主从数据库配置
- **事务管理**: 支持数据库事务

#### 5.1.2 查询构建器
```php
$qb = $this->db->getQueryBuilder();
$qb->select('*')
   ->from('users')
   ->where($qb->expr()->eq('uid', $qb->createNamedParameter($uid)));
```

### 5.2 实体映射

#### 5.2.1 Entity基类
```php
abstract class Entity {
    protected function addType(string $fieldName, string $type): void;
    public function fromRow(array $row): void;
    public function toRow(): array;
}
```

#### 5.2.2 Mapper基类
```php
abstract class QBMapper {
    public function find(int $id): Entity;
    public function findAll(): array;
    public function insert(Entity $entity): Entity;
    public function update(Entity $entity): Entity;
    public function delete(Entity $entity): Entity;
}
```

### 5.3 核心数据表

#### 5.3.1 用户相关表
- `oc_users`: 用户基本信息
- `oc_preferences`: 用户偏好设置
- `oc_groups`: 用户组信息
- `oc_group_user`: 用户组关系

#### 5.3.2 文件相关表
- `oc_filecache`: 文件缓存信息
- `oc_storages`: 存储后端信息
- `oc_mounts`: 挂载点信息
- `oc_share`: 文件分享信息

#### 5.3.3 应用相关表
- `oc_appconfig`: 应用配置
- `oc_jobs`: 后台任务队列
- `oc_activity`: 活动日志

## 6. 安全架构

### 6.1 认证系统

#### 6.1.1 认证方式
- **用户名密码**: 传统认证方式
- **双因素认证**: TOTP、备份码等
- **LDAP/AD**: 企业目录服务集成
- **SAML/OAuth**: 单点登录支持

#### 6.1.2 会话管理
- **会话存储**: 数据库或Redis存储
- **会话安全**: CSRF保护、会话固定攻击防护
- **会话过期**: 可配置的会话超时

### 6.2 授权系统

#### 6.2.1 权限模型
- **用户权限**: 基于用户的权限控制
- **组权限**: 基于用户组的权限控制
- **文件权限**: 细粒度的文件访问控制

#### 6.2.2 访问控制
- **ACL**: 访问控制列表
- **共享权限**: 文件共享权限管理
- **API权限**: API访问权限控制

### 6.3 数据安全

#### 6.3.1 加密机制
- **传输加密**: HTTPS/TLS加密
- **存储加密**: 文件级加密支持
- **密码加密**: 强密码哈希算法

#### 6.3.2 安全审计
- **操作日志**: 用户操作审计
- **安全事件**: 安全相关事件记录
- **合规报告**: 安全合规报告生成

## 7. API设计

### 7.1 RESTful API

#### 7.1.1 API版本控制
- **URL版本**: `/api/v1/users`
- **Header版本**: `Accept: application/json; version=1`

#### 7.1.2 响应格式
```json
{
    "data": {},
    "meta": {
        "status": "success",
        "message": "",
        "pagination": {}
    }
}
```

### 7.2 WebDAV API

#### 7.2.1 文件操作
- **PROPFIND**: 获取文件属性
- **GET/PUT**: 文件下载/上传
- **MOVE/COPY**: 文件移动/复制
- **DELETE**: 文件删除

#### 7.2.2 扩展属性
- **自定义属性**: 支持自定义文件属性
- **元数据**: 文件元数据管理

### 7.3 OCS API

#### 7.3.1 云服务API
- **用户管理**: 用户CRUD操作
- **应用管理**: 应用安装、启用、禁用
- **配置管理**: 系统配置管理

#### 7.3.2 联邦API
- **服务发现**: 联邦服务发现
- **跨实例共享**: 跨Nextcloud实例的文件共享

## 8. 性能优化

### 8.1 缓存策略

#### 8.1.1 多级缓存
- **OPcache**: PHP字节码缓存
- **APCu**: 用户数据缓存
- **Redis**: 分布式缓存
- **HTTP缓存**: 浏览器缓存控制

#### 8.1.2 缓存失效
- **TTL**: 基于时间的缓存失效
- **标签缓存**: 基于标签的缓存失效
- **事件驱动**: 基于事件的缓存失效

### 8.2 数据库优化

#### 8.2.1 查询优化
- **索引优化**: 合理的数据库索引设计
- **查询缓存**: 数据库查询结果缓存
- **连接池**: 数据库连接池管理

#### 8.2.2 分库分表
- **水平分片**: 基于用户ID的数据分片
- **垂直分片**: 基于功能模块的数据分离

### 8.3 文件系统优化

#### 8.3.1 存储后端
- **本地存储**: 高性能本地文件系统
- **对象存储**: S3兼容的对象存储
- **分布式存储**: 分布式文件系统支持

#### 8.3.2 文件缓存
- **文件缓存**: 文件元数据缓存
- **缩略图缓存**: 图片缩略图缓存
- **预览缓存**: 文件预览缓存

## 9. 部署架构

### 9.1 单机部署

#### 9.1.1 LAMP/LEMP栈
```
┌─────────────────┐
│   Load Balancer │
└─────────────────┘
         │
┌─────────────────┐
│   Web Server    │
│  (Nginx/Apache) │
└─────────────────┘
         │
┌─────────────────┐
│   PHP-FPM       │
└─────────────────┘
         │
┌─────────────────┐
│   Database      │
│ (MySQL/MariaDB) │
└─────────────────┘
```

#### 9.1.2 容器化部署
```yaml
version: '3.8'
services:
  nextcloud:
    image: nextcloud:latest
    environment:
      - MYSQL_HOST=db
      - REDIS_HOST=redis
    volumes:
      - nextcloud_data:/var/www/html
  
  db:
    image: mariadb:latest
    environment:
      - MYSQL_ROOT_PASSWORD=secret
    volumes:
      - db_data:/var/lib/mysql
  
  redis:
    image: redis:alpine
```

### 9.2 集群部署

#### 9.2.1 高可用架构
```
┌─────────────────┐    ┌─────────────────┐
│  Load Balancer  │    │  Load Balancer  │
│    (Primary)    │    │   (Secondary)   │
└─────────────────┘    └─────────────────┘
         │                       │
    ┌────┴────┬─────────────────┬┴────┐
    │         │                 │     │
┌───▼───┐ ┌──▼───┐ ┌─────────┐ ┌▼───▼─┐
│Web 1  │ │Web 2 │ │  Web 3  │ │Web N │
└───────┘ └──────┘ └─────────┘ └──────┘
    │         │         │         │
    └────┬────┴─────────┴────┬────┘
         │                   │
┌────────▼────────┐ ┌───────▼────────┐
│   Database      │ │     Redis      │
│   Cluster       │ │    Cluster     │
│ (Master/Slave)  │ │ (Sentinel/HA)  │
└─────────────────┘ └────────────────┘
```

#### 9.2.2 微服务架构
- **API网关**: 统一API入口
- **服务注册**: 服务发现和注册
- **配置中心**: 集中配置管理
- **监控告警**: 服务监控和告警

### 9.3 云原生部署

#### 9.3.1 Kubernetes部署
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nextcloud
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nextcloud
  template:
    metadata:
      labels:
        app: nextcloud
    spec:
      containers:
      - name: nextcloud
        image: nextcloud:latest
        ports:
        - containerPort: 80
        env:
        - name: MYSQL_HOST
          value: "mysql-service"
        volumeMounts:
        - name: nextcloud-data
          mountPath: /var/www/html
```

#### 9.3.2 服务网格
- **Istio**: 服务间通信管理
- **Envoy**: 代理和负载均衡
- **Jaeger**: 分布式链路追踪

## 10. 监控与运维

### 10.1 监控体系

#### 10.1.1 系统监控
- **资源监控**: CPU、内存、磁盘、网络
- **服务监控**: Web服务、数据库、缓存
- **应用监控**: 应用性能、错误率、响应时间

#### 10.1.2 业务监控
- **用户行为**: 用户活跃度、功能使用情况
- **文件操作**: 文件上传下载统计
- **共享统计**: 文件共享使用情况

### 10.2 日志管理

#### 10.2.1 日志收集
- **应用日志**: Nextcloud应用日志
- **访问日志**: Web服务器访问日志
- **系统日志**: 操作系统日志

#### 10.2.2 日志分析
- **ELK Stack**: Elasticsearch + Logstash + Kibana
- **日志聚合**: 多节点日志聚合
- **实时分析**: 实时日志分析和告警

### 10.3 备份恢复

#### 10.3.1 备份策略
- **数据备份**: 数据库和文件数据备份
- **配置备份**: 系统配置文件备份
- **增量备份**: 增量数据备份

#### 10.3.2 恢复机制
- **自动恢复**: 自动故障恢复
- **手动恢复**: 手动数据恢复
- **灾难恢复**: 灾难恢复预案

## 11. 开发规范

### 11.1 代码规范

#### 11.1.1 PHP代码规范
- **PSR标准**: 遵循PSR-1、PSR-2、PSR-4标准
- **类型声明**: 使用严格类型声明
- **文档注释**: 完整的PHPDoc注释

#### 11.1.2 前端代码规范
- **ESLint**: JavaScript代码检查
- **TypeScript**: 类型安全的JavaScript
- **Vue风格指南**: 遵循Vue.js官方风格指南

### 11.2 测试规范

#### 11.2.1 单元测试
- **PHPUnit**: PHP单元测试框架
- **Jest**: JavaScript单元测试框架
- **覆盖率**: 代码覆盖率要求

#### 11.2.2 集成测试
- **API测试**: RESTful API集成测试
- **端到端测试**: Cypress端到端测试
- **性能测试**: 性能基准测试

### 11.3 版本控制

#### 11.3.1 Git工作流
- **分支策略**: Git Flow分支策略
- **提交规范**: 规范的提交信息格式
- **代码审查**: Pull Request代码审查

#### 11.3.2 发布管理
- **语义化版本**: 遵循语义化版本规范
- **发布流程**: 自动化发布流程
- **回滚机制**: 快速回滚机制

## 12. 扩展性设计

### 12.1 水平扩展

#### 12.1.1 无状态设计
- **会话外置**: 会话存储外置到Redis
- **文件存储**: 使用分布式文件存储
- **缓存分离**: 缓存服务独立部署

#### 12.1.2 负载均衡
- **应用层负载均衡**: 多个Web服务器实例
- **数据库负载均衡**: 读写分离和分库分表
- **存储负载均衡**: 分布式存储系统

### 12.2 垂直扩展

#### 12.2.1 性能优化
- **代码优化**: 算法和数据结构优化
- **数据库优化**: 查询优化和索引优化
- **缓存优化**: 多级缓存策略

#### 12.2.2 资源扩展
- **硬件升级**: CPU、内存、存储升级
- **网络优化**: 网络带宽和延迟优化
- **存储优化**: SSD存储和存储优化

### 12.3 功能扩展

#### 12.3.1 插件机制
- **Hook系统**: 事件钩子机制
- **API扩展**: 可扩展的API接口
- **主题系统**: 可定制的主题系统

#### 12.3.2 集成能力
- **第三方集成**: 第三方服务集成
- **API开放**: 开放API供第三方调用
- **Webhook**: 事件通知机制

## 13. 插件开发详细指南

### 13.1 插件开发环境搭建

#### 13.1.1 开发环境要求
```bash
# 基础环境
- PHP 8.1+
- Node.js 18+
- Composer 2.x
- npm/yarn

# 开发工具
- PHPStorm/VSCode
- Xdebug (调试)
- PHPUnit (测试)
- Webpack (前端构建)
```

#### 13.1.2 创建新插件
```bash
# 1. 创建插件目录
mkdir apps/my_plugin
cd apps/my_plugin

# 2. 初始化composer
composer init

# 3. 创建基础目录结构
mkdir -p {appinfo,lib/{Controller,Service,Db},src,templates,css,img,l10n,tests}

# 4. 创建info.xml
cat > appinfo/info.xml << EOF
<?xml version="1.0"?>
<info>
    <id>my_plugin</id>
    <name>My Plugin</name>
    <summary>A sample plugin</summary>
    <description>This is a sample plugin for Nextcloud</description>
    <version>1.0.0</version>
    <licence>agpl</licence>
    <author>Your Name</author>
    <category>tools</category>
    <dependencies>
        <nextcloud min-version="32" max-version="32"/>
    </dependencies>
</info>
EOF
```

### 13.2 插件核心组件开发

#### 13.2.1 Application类实现
```php
<?php
// lib/AppInfo/Application.php
namespace OCA\MyPlugin\AppInfo;

use OCP\AppFramework\App;
use OCP\AppFramework\Bootstrap\IBootContext;
use OCP\AppFramework\Bootstrap\IBootstrap;
use OCP\AppFramework\Bootstrap\IRegistrationContext;

class Application extends App implements IBootstrap {
    public const APP_ID = 'my_plugin';

    public function __construct(array $urlParams = []) {
        parent::__construct(self::APP_ID, $urlParams);
    }

    public function register(IRegistrationContext $context): void {
        // 注册服务
        $context->registerService('MyService', function($c) {
            return new \OCA\MyPlugin\Service\MyService(
                $c->get(\OCP\IDBConnection::class),
                $c->get(\Psr\Log\LoggerInterface::class)
            );
        });

        // 注册事件监听器
        $context->registerEventListener(
            \OCP\Files\Events\Node\NodeCreatedEvent::class,
            \OCA\MyPlugin\Listener\FileCreatedListener::class
        );

        // 注册中间件
        $context->registerMiddleware(\OCA\MyPlugin\Middleware\AuthMiddleware::class);

        // 注册后台任务
        $context->registerBackgroundJob(\OCA\MyPlugin\BackgroundJob\CleanupJob::class);
    }

    public function boot(IBootContext $context): void {
        // 应用启动逻辑
        $container = $context->getAppContainer();

        // 注册导航菜单
        $navigationManager = $container->get(\OCP\INavigationManager::class);
        $navigationManager->add([
            'id' => self::APP_ID,
            'order' => 10,
            'href' => $container->get(\OCP\IURLGenerator::class)->linkToRoute('my_plugin.page.index'),
            'icon' => $container->get(\OCP\IURLGenerator::class)->imagePath(self::APP_ID, 'app.svg'),
            'name' => 'My Plugin'
        ]);
    }
}
```

#### 13.2.2 控制器开发
```php
<?php
// lib/Controller/ApiController.php
namespace OCA\MyPlugin\Controller;

use OCP\AppFramework\ApiController;
use OCP\AppFramework\Http\DataResponse;
use OCP\IRequest;

class ApiController extends ApiController {
    private $service;

    public function __construct(
        string $appName,
        IRequest $request,
        \OCA\MyPlugin\Service\MyService $service
    ) {
        parent::__construct($appName, $request);
        $this->service = $service;
    }

    /**
     * @NoAdminRequired
     * @NoCSRFRequired
     */
    public function index(): DataResponse {
        try {
            $data = $this->service->getData();
            return new DataResponse($data);
        } catch (\Exception $e) {
            return new DataResponse(['error' => $e->getMessage()], 500);
        }
    }

    /**
     * @NoAdminRequired
     */
    public function create(string $name, string $description): DataResponse {
        try {
            $item = $this->service->create($name, $description);
            return new DataResponse($item);
        } catch (\Exception $e) {
            return new DataResponse(['error' => $e->getMessage()], 400);
        }
    }
}
```

#### 13.2.3 服务层开发
```php
<?php
// lib/Service/MyService.php
namespace OCA\MyPlugin\Service;

use OCP\IDBConnection;
use Psr\Log\LoggerInterface;

class MyService {
    private $db;
    private $logger;

    public function __construct(IDBConnection $db, LoggerInterface $logger) {
        $this->db = $db;
        $this->logger = $logger;
    }

    public function getData(): array {
        $qb = $this->db->getQueryBuilder();
        $qb->select('*')
           ->from('my_plugin_items')
           ->orderBy('created_at', 'DESC');

        $result = $qb->execute();
        $data = $result->fetchAll();
        $result->closeCursor();

        return $data;
    }

    public function create(string $name, string $description): array {
        $qb = $this->db->getQueryBuilder();
        $qb->insert('my_plugin_items')
           ->values([
               'name' => $qb->createNamedParameter($name),
               'description' => $qb->createNamedParameter($description),
               'created_at' => $qb->createNamedParameter(time())
           ]);

        $qb->execute();
        $id = $qb->getLastInsertId();

        $this->logger->info('Created new item', ['id' => $id, 'name' => $name]);

        return [
            'id' => $id,
            'name' => $name,
            'description' => $description,
            'created_at' => time()
        ];
    }
}
```

#### 13.2.4 数据访问层开发
```php
<?php
// lib/Db/Item.php
namespace OCA\MyPlugin\Db;

use OCP\AppFramework\Db\Entity;

/**
 * @method int getId()
 * @method void setId(int $id)
 * @method string getName()
 * @method void setName(string $name)
 * @method string getDescription()
 * @method void setDescription(string $description)
 * @method int getCreatedAt()
 * @method void setCreatedAt(int $createdAt)
 */
class Item extends Entity {
    protected $name;
    protected $description;
    protected $createdAt;

    public function __construct() {
        $this->addType('id', 'integer');
        $this->addType('name', 'string');
        $this->addType('description', 'string');
        $this->addType('createdAt', 'integer');
    }
}

// lib/Db/ItemMapper.php
namespace OCA\MyPlugin\Db;

use OCP\AppFramework\Db\QBMapper;
use OCP\IDBConnection;

class ItemMapper extends QBMapper {
    public function __construct(IDBConnection $db) {
        parent::__construct($db, 'my_plugin_items', Item::class);
    }

    public function findAll(): array {
        $qb = $this->db->getQueryBuilder();
        $qb->select('*')
           ->from($this->getTableName())
           ->orderBy('created_at', 'DESC');

        return $this->findEntities($qb);
    }

    public function findByName(string $name): array {
        $qb = $this->db->getQueryBuilder();
        $qb->select('*')
           ->from($this->getTableName())
           ->where($qb->expr()->like('name', $qb->createNamedParameter('%' . $name . '%')));

        return $this->findEntities($qb);
    }
}
```

### 13.3 前端开发

#### 13.3.1 Vue.js组件开发
```javascript
// src/components/ItemList.vue
<template>
  <div class="item-list">
    <h2>{{ t('my_plugin', 'My Items') }}</h2>

    <div class="item-form">
      <input v-model="newItem.name"
             :placeholder="t('my_plugin', 'Item name')" />
      <textarea v-model="newItem.description"
                :placeholder="t('my_plugin', 'Description')"></textarea>
      <button @click="createItem">{{ t('my_plugin', 'Create') }}</button>
    </div>

    <div class="items">
      <div v-for="item in items" :key="item.id" class="item">
        <h3>{{ item.name }}</h3>
        <p>{{ item.description }}</p>
        <small>{{ formatDate(item.created_at) }}</small>
      </div>
    </div>
  </div>
</template>

<script>
import axios from '@nextcloud/axios'
import { generateUrl } from '@nextcloud/router'
import { translate as t } from '@nextcloud/l10n'

export default {
  name: 'ItemList',
  data() {
    return {
      items: [],
      newItem: {
        name: '',
        description: ''
      }
    }
  },
  async mounted() {
    await this.loadItems()
  },
  methods: {
    t,
    async loadItems() {
      try {
        const response = await axios.get(generateUrl('/apps/my_plugin/api/items'))
        this.items = response.data
      } catch (error) {
        console.error('Failed to load items:', error)
      }
    },
    async createItem() {
      try {
        const response = await axios.post(generateUrl('/apps/my_plugin/api/items'), {
          name: this.newItem.name,
          description: this.newItem.description
        })
        this.items.unshift(response.data)
        this.newItem = { name: '', description: '' }
      } catch (error) {
        console.error('Failed to create item:', error)
      }
    },
    formatDate(timestamp) {
      return new Date(timestamp * 1000).toLocaleDateString()
    }
  }
}
</script>

<style scoped>
.item-list {
  padding: 20px;
}

.item-form {
  margin-bottom: 20px;
  display: flex;
  gap: 10px;
  flex-direction: column;
  max-width: 400px;
}

.item {
  border: 1px solid #ddd;
  padding: 15px;
  margin-bottom: 10px;
  border-radius: 5px;
}
</style>
```

#### 13.3.2 Webpack配置
```javascript
// webpack.config.js
const path = require('path')
const { VueLoaderPlugin } = require('vue-loader')

module.exports = {
  entry: {
    main: path.join(__dirname, 'src', 'main.js')
  },
  output: {
    path: path.resolve(__dirname, 'js'),
    filename: '[name].js',
    chunkFilename: '[name].[contenthash].js'
  },
  module: {
    rules: [
      {
        test: /\.vue$/,
        loader: 'vue-loader'
      },
      {
        test: /\.js$/,
        loader: 'babel-loader',
        exclude: /node_modules/
      },
      {
        test: /\.css$/,
        use: ['style-loader', 'css-loader']
      }
    ]
  },
  plugins: [
    new VueLoaderPlugin()
  ],
  resolve: {
    extensions: ['.js', '.vue'],
    alias: {
      '@': path.resolve(__dirname, 'src')
    }
  }
}
```

### 13.4 数据库迁移

#### 13.4.1 迁移文件
```php
<?php
// lib/Migration/Version1000Date20240101000000.php
namespace OCA\MyPlugin\Migration;

use Closure;
use OCP\DB\ISchemaWrapper;
use OCP\Migration\IOutput;
use OCP\Migration\SimpleMigrationStep;

class Version1000Date20240101000000 extends SimpleMigrationStep {
    public function changeSchema(IOutput $output, Closure $schemaClosure, array $options): ?ISchemaWrapper {
        /** @var ISchemaWrapper $schema */
        $schema = $schemaClosure();

        if (!$schema->hasTable('my_plugin_items')) {
            $table = $schema->createTable('my_plugin_items');
            $table->addColumn('id', 'bigint', [
                'autoincrement' => true,
                'notnull' => true,
                'unsigned' => true,
            ]);
            $table->addColumn('name', 'string', [
                'notnull' => true,
                'length' => 255,
            ]);
            $table->addColumn('description', 'text', [
                'notnull' => false,
            ]);
            $table->addColumn('created_at', 'integer', [
                'notnull' => true,
                'unsigned' => true,
            ]);
            $table->addColumn('updated_at', 'integer', [
                'notnull' => true,
                'unsigned' => true,
            ]);

            $table->setPrimaryKey(['id']);
            $table->addIndex(['name'], 'my_plugin_items_name_idx');
            $table->addIndex(['created_at'], 'my_plugin_items_created_at_idx');
        }

        return $schema;
    }
}
```

### 13.5 事件监听器

#### 13.5.1 文件事件监听
```php
<?php
// lib/Listener/FileCreatedListener.php
namespace OCA\MyPlugin\Listener;

use OCP\EventDispatcher\Event;
use OCP\EventDispatcher\IEventListener;
use OCP\Files\Events\Node\NodeCreatedEvent;
use Psr\Log\LoggerInterface;

class FileCreatedListener implements IEventListener {
    private $logger;

    public function __construct(LoggerInterface $logger) {
        $this->logger = $logger;
    }

    public function handle(Event $event): void {
        if (!($event instanceof NodeCreatedEvent)) {
            return;
        }

        $node = $event->getNode();

        // 记录文件创建事件
        $this->logger->info('File created', [
            'path' => $node->getPath(),
            'size' => $node->getSize(),
            'mimetype' => $node->getMimetype()
        ]);

        // 执行自定义逻辑
        if ($node->getMimetype() === 'image/jpeg') {
            // 处理JPEG图片
            $this->processImage($node);
        }
    }

    private function processImage($node): void {
        // 图片处理逻辑
    }
}
```

### 13.6 后台任务

#### 13.6.1 定时任务
```php
<?php
// lib/BackgroundJob/CleanupJob.php
namespace OCA\MyPlugin\BackgroundJob;

use OCP\BackgroundJob\TimedJob;
use OCP\IDBConnection;
use Psr\Log\LoggerInterface;

class CleanupJob extends TimedJob {
    private $db;
    private $logger;

    public function __construct(IDBConnection $db, LoggerInterface $logger) {
        $this->db = $db;
        $this->logger = $logger;

        // 每小时执行一次
        $this->setInterval(3600);
    }

    protected function run($argument): void {
        $this->logger->info('Running cleanup job');

        // 清理30天前的数据
        $cutoff = time() - (30 * 24 * 3600);

        $qb = $this->db->getQueryBuilder();
        $qb->delete('my_plugin_items')
           ->where($qb->expr()->lt('created_at', $qb->createNamedParameter($cutoff)));

        $deletedCount = $qb->execute();

        $this->logger->info('Cleanup job completed', ['deleted' => $deletedCount]);
    }
}
```

### 13.7 命令行工具

#### 13.7.1 自定义命令
```php
<?php
// lib/Command/ImportCommand.php
namespace OCA\MyPlugin\Command;

use Symfony\Component\Console\Command\Command;
use Symfony\Component\Console\Input\InputArgument;
use Symfony\Component\Console\Input\InputInterface;
use Symfony\Component\Console\Output\OutputInterface;

class ImportCommand extends Command {
    private $service;

    public function __construct(\OCA\MyPlugin\Service\MyService $service) {
        parent::__construct();
        $this->service = $service;
    }

    protected function configure(): void {
        $this->setName('my-plugin:import')
             ->setDescription('Import data from file')
             ->addArgument('file', InputArgument::REQUIRED, 'Path to import file');
    }

    protected function execute(InputInterface $input, OutputInterface $output): int {
        $file = $input->getArgument('file');

        if (!file_exists($file)) {
            $output->writeln('<error>File not found: ' . $file . '</error>');
            return 1;
        }

        $output->writeln('Importing data from: ' . $file);

        $data = json_decode(file_get_contents($file), true);
        $count = 0;

        foreach ($data as $item) {
            $this->service->create($item['name'], $item['description']);
            $count++;
        }

        $output->writeln('<info>Imported ' . $count . ' items successfully</info>');
        return 0;
    }
}
```

### 13.8 测试开发

#### 13.8.1 单元测试
```php
<?php
// tests/Unit/Service/MyServiceTest.php
namespace OCA\MyPlugin\Tests\Unit\Service;

use OCA\MyPlugin\Service\MyService;
use OCP\IDBConnection;
use PHPUnit\Framework\TestCase;
use Psr\Log\LoggerInterface;

class MyServiceTest extends TestCase {
    private $service;
    private $db;
    private $logger;

    protected function setUp(): void {
        $this->db = $this->createMock(IDBConnection::class);
        $this->logger = $this->createMock(LoggerInterface::class);
        $this->service = new MyService($this->db, $this->logger);
    }

    public function testCreate(): void {
        $qb = $this->createMock(\OCP\DB\QueryBuilder\IQueryBuilder::class);
        $this->db->expects($this->once())
                 ->method('getQueryBuilder')
                 ->willReturn($qb);

        $qb->expects($this->once())
           ->method('insert')
           ->with('my_plugin_items')
           ->willReturnSelf();

        $result = $this->service->create('Test Item', 'Test Description');

        $this->assertIsArray($result);
        $this->assertEquals('Test Item', $result['name']);
        $this->assertEquals('Test Description', $result['description']);
    }
}
```

#### 13.8.2 集成测试
```php
<?php
// tests/Integration/ApiTest.php
namespace OCA\MyPlugin\Tests\Integration;

use OCP\AppFramework\App;
use Test\TestCase;

class ApiTest extends TestCase {
    private $container;

    protected function setUp(): void {
        parent::setUp();
        $app = new App('my_plugin');
        $this->container = $app->getContainer();
    }

    public function testApiEndpoint(): void {
        $controller = $this->container->get(\OCA\MyPlugin\Controller\ApiController::class);
        $response = $controller->index();

        $this->assertEquals(200, $response->getStatus());
        $this->assertIsArray($response->getData());
    }
}
```

### 13.9 国际化支持

#### 13.9.1 翻译文件
```json
// l10n/zh_CN.json
{
    "My Plugin": "我的插件",
    "Item name": "项目名称",
    "Description": "描述",
    "Create": "创建",
    "My Items": "我的项目",
    "Import data from file": "从文件导入数据",
    "File not found": "文件未找到"
}
```

#### 13.9.2 前端国际化
```javascript
// src/main.js
import { translate as t, translatePlural as n } from '@nextcloud/l10n'

// 在组件中使用
export default {
    methods: {
        t,
        n,
        getMessage() {
            return this.t('my_plugin', 'Hello {name}', { name: 'World' })
        }
    }
}
```

### 13.10 插件发布

#### 13.10.1 应用商店发布
```bash
# 1. 准备发布包
make appstore

# 2. 创建签名
openssl dgst -sha512 -sign ~/.nextcloud/certificates/my_plugin.key my_plugin.tar.gz | openssl base64

# 3. 上传到应用商店
# 访问 https://apps.nextcloud.com/developer/
```

#### 13.10.2 版本管理
```xml
<!-- appinfo/info.xml -->
<info>
    <version>1.1.0</version>
    <dependencies>
        <nextcloud min-version="32" max-version="33"/>
    </dependencies>
</info>
```

---

*本文档将持续更新，以反映系统架构的最新变化和改进。*
