# Nextcloud å¼€å‘å·¥å…·ä¸è„šæœ¬

## ğŸ› ï¸ å¼€å‘å·¥å…·é›†

### 1. æ’ä»¶è„šæ‰‹æ¶ç”Ÿæˆå™¨

#### 1.1 è‡ªåŠ¨ç”Ÿæˆæ’ä»¶ç»“æ„
```bash
#!/bin/bash
# scripts/create-plugin.sh

APP_NAME=$1
NAMESPACE=$2
AUTHOR_NAME=$3
AUTHOR_EMAIL=$4

if [ -z "$APP_NAME" ]; then
    echo "Usage: $0 <app_name> [namespace] [author_name] [author_email]"
    exit 1
fi

NAMESPACE=${NAMESPACE:-$(echo $APP_NAME | sed 's/_//g' | sed 's/\b\w/\U&/g')}
AUTHOR_NAME=${AUTHOR_NAME:-"Developer"}
AUTHOR_EMAIL=${AUTHOR_EMAIL:-"developer@example.com"}

echo "Creating Nextcloud app: $APP_NAME"
echo "Namespace: $NAMESPACE"
echo "Author: $AUTHOR_NAME <$AUTHOR_EMAIL>"

# åˆ›å»ºç›®å½•ç»“æ„
mkdir -p "apps/$APP_NAME"/{appinfo,lib/{AppInfo,Controller,Service,Db,Migration,Command,BackgroundJob,Listener,Middleware},src/{components,views,store},templates,css,img,l10n,tests/{Unit,Integration}}

# ç”Ÿæˆ info.xml
cat > "apps/$APP_NAME/appinfo/info.xml" << EOF
<?xml version="1.0"?>
<info xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:noNamespaceSchemaLocation="https://apps.nextcloud.com/schema/apps/info.xsd">
    <id>$APP_NAME</id>
    <name>$(echo $APP_NAME | sed 's/_/ /g' | sed 's/\b\w/\U&/g')</name>
    <summary>A new Nextcloud application</summary>
    <description>This is a new Nextcloud application created with the plugin generator.</description>
    <version>1.0.0</version>
    <licence>agpl</licence>
    <author mail="$AUTHOR_EMAIL">$AUTHOR_NAME</author>
    <namespace>$NAMESPACE</namespace>
    <category>tools</category>
    <dependencies>
        <nextcloud min-version="32" max-version="33"/>
        <php min-version="8.1"/>
    </dependencies>
    <navigations>
        <navigation>
            <name>$(echo $APP_NAME | sed 's/_/ /g' | sed 's/\b\w/\U&/g')</name>
            <route>$APP_NAME.page.index</route>
            <icon>app.svg</icon>
            <order>10</order>
        </navigation>
    </navigations>
</info>
EOF

# ç”Ÿæˆ routes.php
cat > "apps/$APP_NAME/appinfo/routes.php" << EOF
<?php
return [
    'routes' => [
        ['name' => 'page#index', 'url' => '/', 'verb' => 'GET'],
        ['name' => 'api#items', 'url' => '/api/v1/items', 'verb' => 'GET'],
        ['name' => 'api#createItem', 'url' => '/api/v1/items', 'verb' => 'POST'],
        ['name' => 'api#updateItem', 'url' => '/api/v1/items/{id}', 'verb' => 'PUT'],
        ['name' => 'api#deleteItem', 'url' => '/api/v1/items/{id}', 'verb' => 'DELETE'],
    ]
];
EOF

# ç”Ÿæˆ Application.php
cat > "apps/$APP_NAME/lib/AppInfo/Application.php" << EOF
<?php
namespace OCA\\$NAMESPACE\\AppInfo;

use OCP\\AppFramework\\App;
use OCP\\AppFramework\\Bootstrap\\IBootContext;
use OCP\\AppFramework\\Bootstrap\\IBootstrap;
use OCP\\AppFramework\\Bootstrap\\IRegistrationContext;

class Application extends App implements IBootstrap {
    public const APP_ID = '$APP_NAME';

    public function __construct(array \$urlParams = []) {
        parent::__construct(self::APP_ID, \$urlParams);
    }

    public function register(IRegistrationContext \$context): void {
        // Register services, event listeners, middleware, etc.
    }

    public function boot(IBootContext \$context): void {
        // Application boot logic
    }
}
EOF

# ç”ŸæˆåŸºç¡€æ§åˆ¶å™¨
cat > "apps/$APP_NAME/lib/Controller/PageController.php" << EOF
<?php
namespace OCA\\$NAMESPACE\\Controller;

use OCP\\AppFramework\\Controller;
use OCP\\AppFramework\\Http\\TemplateResponse;
use OCP\\IRequest;
use OCP\\Util;

class PageController extends Controller {
    public function __construct(
        string \$appName,
        IRequest \$request
    ) {
        parent::__construct(\$appName, \$request);
    }

    /**
     * @NoAdminRequired
     * @NoCSRFRequired
     */
    public function index(): TemplateResponse {
        Util::addScript(\$this->appName, 'main');
        Util::addStyle(\$this->appName, 'main');
        
        return new TemplateResponse(\$this->appName, 'index');
    }
}
EOF

# ç”Ÿæˆ package.json
cat > "apps/$APP_NAME/package.json" << EOF
{
  "name": "$APP_NAME",
  "version": "1.0.0",
  "description": "A Nextcloud application",
  "main": "src/main.js",
  "scripts": {
    "build": "webpack --mode production",
    "dev": "webpack --mode development",
    "watch": "webpack --mode development --watch",
    "lint": "eslint src",
    "lint:fix": "eslint src --fix"
  },
  "dependencies": {
    "@nextcloud/auth": "^2.0.0",
    "@nextcloud/axios": "^2.0.0",
    "@nextcloud/router": "^3.0.0",
    "@nextcloud/vue": "^8.0.0",
    "vue": "^3.0.0"
  },
  "devDependencies": {
    "@babel/core": "^7.0.0",
    "@babel/preset-env": "^7.0.0",
    "babel-loader": "^9.0.0",
    "css-loader": "^6.0.0",
    "eslint": "^8.0.0",
    "style-loader": "^3.0.0",
    "vue-loader": "^17.0.0",
    "webpack": "^5.0.0",
    "webpack-cli": "^5.0.0"
  }
}
EOF

# ç”Ÿæˆ composer.json
cat > "apps/$APP_NAME/composer.json" << EOF
{
    "name": "nextcloud/$APP_NAME",
    "description": "A Nextcloud application",
    "type": "project",
    "license": "AGPL-3.0-or-later",
    "authors": [
        {
            "name": "$AUTHOR_NAME",
            "email": "$AUTHOR_EMAIL"
        }
    ],
    "require": {
        "php": ">=8.1"
    },
    "require-dev": {
        "phpunit/phpunit": "^10.0",
        "nextcloud/coding-standard": "^1.0"
    },
    "autoload": {
        "psr-4": {
            "OCA\\\\$NAMESPACE\\\\": "lib/"
        }
    },
    "autoload-dev": {
        "psr-4": {
            "OCA\\\\$NAMESPACE\\\\Tests\\\\": "tests/"
        }
    }
}
EOF

echo "Plugin $APP_NAME created successfully!"
echo "Next steps:"
echo "1. cd apps/$APP_NAME"
echo "2. composer install"
echo "3. npm install"
echo "4. npm run build"
echo "5. Enable the app in Nextcloud admin panel"
```

#### 1.2 æ•°æ®åº“è¿ç§»ç”Ÿæˆå™¨
```bash
#!/bin/bash
# scripts/create-migration.sh

APP_NAME=$1
MIGRATION_NAME=$2

if [ -z "$APP_NAME" ] || [ -z "$MIGRATION_NAME" ]; then
    echo "Usage: $0 <app_name> <migration_name>"
    exit 1
fi

NAMESPACE=$(echo $APP_NAME | sed 's/_//g' | sed 's/\b\w/\U&/g')
VERSION=$(date +%Y%m%d%H%M%S)
CLASS_NAME="Version1000Date${VERSION}"

MIGRATION_FILE="apps/$APP_NAME/lib/Migration/${CLASS_NAME}.php"

cat > "$MIGRATION_FILE" << EOF
<?php
namespace OCA\\$NAMESPACE\\Migration;

use Closure;
use OCP\\DB\\ISchemaWrapper;
use OCP\\Migration\\IOutput;
use OCP\\Migration\\SimpleMigrationStep;

class $CLASS_NAME extends SimpleMigrationStep {
    public function changeSchema(IOutput \$output, Closure \$schemaClosure, array \$options): ?ISchemaWrapper {
        /** @var ISchemaWrapper \$schema */
        \$schema = \$schemaClosure();

        // Add your schema changes here
        
        return \$schema;
    }
}
EOF

echo "Migration created: $MIGRATION_FILE"
```

### 2. å¼€å‘è¾…åŠ©è„šæœ¬

#### 2.1 ä»£ç è´¨é‡æ£€æŸ¥
```bash
#!/bin/bash
# scripts/check-quality.sh

APP_NAME=$1

if [ -z "$APP_NAME" ]; then
    echo "Usage: $0 <app_name>"
    exit 1
fi

cd "apps/$APP_NAME"

echo "ğŸ” Running code quality checks for $APP_NAME..."

# PHPä»£ç æ£€æŸ¥
echo "ğŸ“‹ Checking PHP code style..."
if command -v php-cs-fixer &> /dev/null; then
    php-cs-fixer fix --dry-run --diff
else
    echo "âš ï¸  php-cs-fixer not found, skipping PHP style check"
fi

# PHPé™æ€åˆ†æ
echo "ğŸ”¬ Running PHP static analysis..."
if command -v phpstan &> /dev/null; then
    phpstan analyse lib/ --level=5
else
    echo "âš ï¸  phpstan not found, skipping static analysis"
fi

# JavaScriptä»£ç æ£€æŸ¥
echo "ğŸ“‹ Checking JavaScript code style..."
if [ -f "package.json" ]; then
    npm run lint
else
    echo "âš ï¸  package.json not found, skipping JS lint"
fi

# è¿è¡Œæµ‹è¯•
echo "ğŸ§ª Running tests..."
if [ -f "vendor/bin/phpunit" ]; then
    vendor/bin/phpunit
else
    echo "âš ï¸  PHPUnit not found, skipping PHP tests"
fi

if [ -f "package.json" ] && grep -q "test" package.json; then
    npm test
else
    echo "âš ï¸  No JS tests configured"
fi

echo "âœ… Quality check completed!"
```

#### 2.2 è‡ªåŠ¨åŒ–æ„å»ºè„šæœ¬
```bash
#!/bin/bash
# scripts/build-app.sh

APP_NAME=$1
BUILD_TYPE=${2:-development}

if [ -z "$APP_NAME" ]; then
    echo "Usage: $0 <app_name> [development|production]"
    exit 1
fi

cd "apps/$APP_NAME"

echo "ğŸ—ï¸  Building $APP_NAME for $BUILD_TYPE..."

# å®‰è£…ä¾èµ–
echo "ğŸ“¦ Installing dependencies..."
if [ -f "composer.json" ]; then
    composer install --no-dev --optimize-autoloader
fi

if [ -f "package.json" ]; then
    npm ci
fi

# æ„å»ºå‰ç«¯èµ„æº
echo "ğŸ¨ Building frontend assets..."
if [ "$BUILD_TYPE" = "production" ]; then
    npm run build
else
    npm run dev
fi

# ç”Ÿæˆè¯­è¨€æ–‡ä»¶
echo "ğŸŒ Generating language files..."
if command -v php &> /dev/null; then
    php ../../occ l10n:createjs $APP_NAME
fi

# æ¸…ç†å¼€å‘æ–‡ä»¶
if [ "$BUILD_TYPE" = "production" ]; then
    echo "ğŸ§¹ Cleaning up development files..."
    rm -rf node_modules
    rm -rf tests
    rm -f package*.json
    rm -f webpack.config.js
    rm -f .eslintrc.js
fi

echo "âœ… Build completed!"
```

#### 2.3 åº”ç”¨æ‰“åŒ…è„šæœ¬
```bash
#!/bin/bash
# scripts/package-app.sh

APP_NAME=$1
VERSION=$2

if [ -z "$APP_NAME" ]; then
    echo "Usage: $0 <app_name> [version]"
    exit 1
fi

if [ -z "$VERSION" ]; then
    VERSION=$(grep -o '<version>[^<]*' "apps/$APP_NAME/appinfo/info.xml" | sed 's/<version>//')
fi

echo "ğŸ“¦ Packaging $APP_NAME version $VERSION..."

# åˆ›å»ºä¸´æ—¶ç›®å½•
TEMP_DIR=$(mktemp -d)
PACKAGE_DIR="$TEMP_DIR/$APP_NAME"

# å¤åˆ¶åº”ç”¨æ–‡ä»¶
cp -r "apps/$APP_NAME" "$PACKAGE_DIR"

# è¿›å…¥åº”ç”¨ç›®å½•è¿›è¡Œæ„å»º
cd "$PACKAGE_DIR"

# æ„å»ºç”Ÿäº§ç‰ˆæœ¬
../../../scripts/build-app.sh "$APP_NAME" production

# è¿”å›åŸç›®å½•
cd - > /dev/null

# åˆ›å»ºå‹ç¼©åŒ…
PACKAGE_NAME="${APP_NAME}-${VERSION}.tar.gz"
cd "$TEMP_DIR"
tar -czf "$PACKAGE_NAME" "$APP_NAME"

# ç§»åŠ¨åˆ°è¾“å‡ºç›®å½•
mv "$PACKAGE_NAME" "$OLDPWD/build/"

# æ¸…ç†ä¸´æ—¶æ–‡ä»¶
rm -rf "$TEMP_DIR"

echo "âœ… Package created: build/$PACKAGE_NAME"

# ç”Ÿæˆç­¾åï¼ˆå¦‚æœæœ‰ç§é’¥ï¼‰
if [ -f "~/.nextcloud/certificates/${APP_NAME}.key" ]; then
    echo "ğŸ” Generating signature..."
    openssl dgst -sha512 -sign "~/.nextcloud/certificates/${APP_NAME}.key" "build/$PACKAGE_NAME" | openssl base64 > "build/${PACKAGE_NAME}.sig"
    echo "âœ… Signature created: build/${PACKAGE_NAME}.sig"
fi
```

### 3. è°ƒè¯•å·¥å…·

#### 3.1 æ—¥å¿—ç›‘æ§è„šæœ¬
```bash
#!/bin/bash
# scripts/monitor-logs.sh

APP_NAME=$1
LOG_LEVEL=${2:-info}

if [ -z "$APP_NAME" ]; then
    echo "Usage: $0 <app_name> [debug|info|warning|error]"
    exit 1
fi

echo "ğŸ“Š Monitoring logs for $APP_NAME (level: $LOG_LEVEL)..."

# ç›‘æ§Nextcloudæ—¥å¿—
tail -f data/nextcloud.log | grep -i "$APP_NAME\|$LOG_LEVEL" --color=always &

# ç›‘æ§WebæœåŠ¡å™¨æ—¥å¿—
if [ -f "/var/log/nginx/error.log" ]; then
    tail -f /var/log/nginx/error.log | grep -i "$APP_NAME" --color=always &
fi

if [ -f "/var/log/apache2/error.log" ]; then
    tail -f /var/log/apache2/error.log | grep -i "$APP_NAME" --color=always &
fi

# ç­‰å¾…ç”¨æˆ·ä¸­æ–­
wait
```

#### 3.2 æ€§èƒ½åˆ†æè„šæœ¬
```bash
#!/bin/bash
# scripts/performance-test.sh

APP_NAME=$1
BASE_URL=${2:-"http://localhost:8080"}

if [ -z "$APP_NAME" ]; then
    echo "Usage: $0 <app_name> [base_url]"
    exit 1
fi

echo "âš¡ Running performance tests for $APP_NAME..."

# APIæ€§èƒ½æµ‹è¯•
echo "ğŸ”— Testing API endpoints..."
if command -v ab &> /dev/null; then
    ab -n 100 -c 10 "$BASE_URL/apps/$APP_NAME/api/v1/items"
else
    echo "âš ï¸  Apache Bench (ab) not found"
fi

# é¡µé¢åŠ è½½æµ‹è¯•
echo "ğŸ“„ Testing page load performance..."
if command -v curl &> /dev/null; then
    time curl -s "$BASE_URL/apps/$APP_NAME/" > /dev/null
else
    echo "âš ï¸  curl not found"
fi

# å†…å­˜ä½¿ç”¨åˆ†æ
echo "ğŸ’¾ Analyzing memory usage..."
if command -v php &> /dev/null; then
    php -d memory_limit=512M -f occ app:enable "$APP_NAME"
    echo "Memory usage: $(php -r 'echo memory_get_peak_usage(true) / 1024 / 1024;') MB"
fi

echo "âœ… Performance test completed!"
```

### 4. æµ‹è¯•å·¥å…·

#### 4.1 è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬
```bash
#!/bin/bash
# scripts/run-tests.sh

APP_NAME=$1
TEST_TYPE=${2:-all}

if [ -z "$APP_NAME" ]; then
    echo "Usage: $0 <app_name> [unit|integration|e2e|all]"
    exit 1
fi

cd "apps/$APP_NAME"

echo "ğŸ§ª Running tests for $APP_NAME (type: $TEST_TYPE)..."

# å•å…ƒæµ‹è¯•
if [ "$TEST_TYPE" = "unit" ] || [ "$TEST_TYPE" = "all" ]; then
    echo "ğŸ”¬ Running unit tests..."
    if [ -f "vendor/bin/phpunit" ]; then
        vendor/bin/phpunit tests/Unit/
    fi
    
    if [ -f "package.json" ] && grep -q "test:unit" package.json; then
        npm run test:unit
    fi
fi

# é›†æˆæµ‹è¯•
if [ "$TEST_TYPE" = "integration" ] || [ "$TEST_TYPE" = "all" ]; then
    echo "ğŸ”— Running integration tests..."
    if [ -f "vendor/bin/phpunit" ]; then
        vendor/bin/phpunit tests/Integration/
    fi
    
    if [ -f "package.json" ] && grep -q "test:integration" package.json; then
        npm run test:integration
    fi
fi

# ç«¯åˆ°ç«¯æµ‹è¯•
if [ "$TEST_TYPE" = "e2e" ] || [ "$TEST_TYPE" = "all" ]; then
    echo "ğŸŒ Running e2e tests..."
    if [ -f "package.json" ] && grep -q "test:e2e" package.json; then
        npm run test:e2e
    fi
fi

echo "âœ… Tests completed!"
```

#### 4.2 æµ‹è¯•æ•°æ®ç”Ÿæˆå™¨
```php
<?php
// scripts/generate-test-data.php

if ($argc < 2) {
    echo "Usage: php generate-test-data.php <app_name> [count]\n";
    exit(1);
}

$appName = $argv[1];
$count = isset($argv[2]) ? (int)$argv[2] : 10;

require_once __DIR__ . '/../lib/base.php';

\OC::$CLI = true;

try {
    $app = new \OCP\AppFramework\App($appName);
    $container = $app->getContainer();
    
    // è·å–æœåŠ¡å®ä¾‹
    $service = $container->get("OCA\\{$appName}\\Service\\ItemService");
    
    echo "Generating {$count} test items for {$appName}...\n";
    
    for ($i = 1; $i <= $count; $i++) {
        $name = "Test Item {$i}";
        $description = "This is test item number {$i} generated automatically.";
        
        $item = $service->create($name, $description);
        echo "Created item {$i}: {$item->getName()}\n";
    }
    
    echo "Test data generation completed!\n";
    
} catch (Exception $e) {
    echo "Error: " . $e->getMessage() . "\n";
    exit(1);
}
```

### 5. éƒ¨ç½²å·¥å…·

#### 5.1 Dockerå¼€å‘ç¯å¢ƒ
```dockerfile
# docker/Dockerfile.dev
FROM nextcloud:latest

# å®‰è£…å¼€å‘å·¥å…·
RUN apt-get update && apt-get install -y \
    git \
    nodejs \
    npm \
    composer \
    && rm -rf /var/lib/apt/lists/*

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /var/www/html

# å¤åˆ¶å¼€å‘é…ç½®
COPY docker/config.php /var/www/html/config/

# æš´éœ²ç«¯å£
EXPOSE 80

# å¯åŠ¨å‘½ä»¤
CMD ["apache2-foreground"]
```

```yaml
# docker-compose.dev.yml
version: '3.8'

services:
  nextcloud:
    build:
      context: .
      dockerfile: docker/Dockerfile.dev
    ports:
      - "8080:80"
    volumes:
      - ./apps:/var/www/html/apps
      - ./data:/var/www/html/data
    environment:
      - MYSQL_HOST=db
      - REDIS_HOST=redis
    depends_on:
      - db
      - redis

  db:
    image: mariadb:latest
    environment:
      - MYSQL_ROOT_PASSWORD=nextcloud
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=nextcloud
      - MYSQL_PASSWORD=nextcloud
    volumes:
      - db_data:/var/lib/mysql

  redis:
    image: redis:alpine
    
volumes:
  db_data:
```

#### 5.2 CI/CDé…ç½®
```yaml
# .github/workflows/test.yml
name: Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  php-tests:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        php-version: [8.1, 8.2, 8.3]
        nextcloud-version: [32, 33]
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ matrix.php-version }}
        extensions: mbstring, intl, gd, xml, zip, json, mysql, pgsql
        
    - name: Install dependencies
      run: composer install --prefer-dist --no-progress
      
    - name: Run tests
      run: vendor/bin/phpunit
      
  js-tests:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run linting
      run: npm run lint
      
    - name: Run tests
      run: npm test
```

## ğŸ“‹ ä½¿ç”¨è¯´æ˜

### å®‰è£…å¼€å‘å·¥å…·
```bash
# 1. å…‹éš†å·¥å…·è„šæœ¬
git clone <repository> nextcloud-dev-tools
cd nextcloud-dev-tools

# 2. è®¾ç½®æ‰§è¡Œæƒé™
chmod +x scripts/*.sh

# 3. æ·»åŠ åˆ°PATHï¼ˆå¯é€‰ï¼‰
export PATH=$PATH:$(pwd)/scripts
```

### åˆ›å»ºæ–°æ’ä»¶
```bash
# ä½¿ç”¨è„šæ‰‹æ¶åˆ›å»ºæ’ä»¶
./scripts/create-plugin.sh my_awesome_plugin MyAwesomePlugin "Your Name" "your.email@example.com"

# è¿›å…¥æ’ä»¶ç›®å½•
cd apps/my_awesome_plugin

# å®‰è£…ä¾èµ–
composer install
npm install

# æ„å»ºå‰ç«¯èµ„æº
npm run build
```

### å¼€å‘å·¥ä½œæµ
```bash
# 1. å¯åŠ¨å¼€å‘ç¯å¢ƒ
docker-compose -f docker-compose.dev.yml up -d

# 2. ç›‘æ§æ—¥å¿—
./scripts/monitor-logs.sh my_awesome_plugin

# 3. è¿è¡Œè´¨é‡æ£€æŸ¥
./scripts/check-quality.sh my_awesome_plugin

# 4. è¿è¡Œæµ‹è¯•
./scripts/run-tests.sh my_awesome_plugin

# 5. æ„å»ºå’Œæ‰“åŒ…
./scripts/build-app.sh my_awesome_plugin production
./scripts/package-app.sh my_awesome_plugin 1.0.0
```

è¿™äº›å·¥å…·å’Œè„šæœ¬å°†å¤§å¤§æé«˜Nextcloudæ’ä»¶çš„å¼€å‘æ•ˆç‡ï¼Œæä¾›äº†ä»é¡¹ç›®åˆ›å»ºåˆ°éƒ¨ç½²çš„å®Œæ•´å·¥å…·é“¾æ”¯æŒã€‚
