# Nextcloud 开发工具与脚本

## 🛠️ 开发工具集

### 1. 插件脚手架生成器

#### 1.1 自动生成插件结构
```bash
#!/bin/bash
# scripts/create-plugin.sh

APP_NAME=$1
NAMESPACE=$2
AUTHOR_NAME=$3
AUTHOR_EMAIL=$4

if [ -z "$APP_NAME" ]; then
    echo "Usage: $0 <app_name> [namespace] [author_name] [author_email]"
    exit 1
fi

NAMESPACE=${NAMESPACE:-$(echo $APP_NAME | sed 's/_//g' | sed 's/\b\w/\U&/g')}
AUTHOR_NAME=${AUTHOR_NAME:-"Developer"}
AUTHOR_EMAIL=${AUTHOR_EMAIL:-"developer@example.com"}

echo "Creating Nextcloud app: $APP_NAME"
echo "Namespace: $NAMESPACE"
echo "Author: $AUTHOR_NAME <$AUTHOR_EMAIL>"

# 创建目录结构
mkdir -p "apps/$APP_NAME"/{appinfo,lib/{AppInfo,Controller,Service,Db,Migration,Command,BackgroundJob,Listener,Middleware},src/{components,views,store},templates,css,img,l10n,tests/{Unit,Integration}}

# 生成 info.xml
cat > "apps/$APP_NAME/appinfo/info.xml" << EOF
<?xml version="1.0"?>
<info xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:noNamespaceSchemaLocation="https://apps.nextcloud.com/schema/apps/info.xsd">
    <id>$APP_NAME</id>
    <name>$(echo $APP_NAME | sed 's/_/ /g' | sed 's/\b\w/\U&/g')</name>
    <summary>A new Nextcloud application</summary>
    <description>This is a new Nextcloud application created with the plugin generator.</description>
    <version>1.0.0</version>
    <licence>agpl</licence>
    <author mail="$AUTHOR_EMAIL">$AUTHOR_NAME</author>
    <namespace>$NAMESPACE</namespace>
    <category>tools</category>
    <dependencies>
        <nextcloud min-version="32" max-version="33"/>
        <php min-version="8.1"/>
    </dependencies>
    <navigations>
        <navigation>
            <name>$(echo $APP_NAME | sed 's/_/ /g' | sed 's/\b\w/\U&/g')</name>
            <route>$APP_NAME.page.index</route>
            <icon>app.svg</icon>
            <order>10</order>
        </navigation>
    </navigations>
</info>
EOF

# 生成 routes.php
cat > "apps/$APP_NAME/appinfo/routes.php" << EOF
<?php
return [
    'routes' => [
        ['name' => 'page#index', 'url' => '/', 'verb' => 'GET'],
        ['name' => 'api#items', 'url' => '/api/v1/items', 'verb' => 'GET'],
        ['name' => 'api#createItem', 'url' => '/api/v1/items', 'verb' => 'POST'],
        ['name' => 'api#updateItem', 'url' => '/api/v1/items/{id}', 'verb' => 'PUT'],
        ['name' => 'api#deleteItem', 'url' => '/api/v1/items/{id}', 'verb' => 'DELETE'],
    ]
];
EOF

# 生成 Application.php
cat > "apps/$APP_NAME/lib/AppInfo/Application.php" << EOF
<?php
namespace OCA\\$NAMESPACE\\AppInfo;

use OCP\\AppFramework\\App;
use OCP\\AppFramework\\Bootstrap\\IBootContext;
use OCP\\AppFramework\\Bootstrap\\IBootstrap;
use OCP\\AppFramework\\Bootstrap\\IRegistrationContext;

class Application extends App implements IBootstrap {
    public const APP_ID = '$APP_NAME';

    public function __construct(array \$urlParams = []) {
        parent::__construct(self::APP_ID, \$urlParams);
    }

    public function register(IRegistrationContext \$context): void {
        // Register services, event listeners, middleware, etc.
    }

    public function boot(IBootContext \$context): void {
        // Application boot logic
    }
}
EOF

# 生成基础控制器
cat > "apps/$APP_NAME/lib/Controller/PageController.php" << EOF
<?php
namespace OCA\\$NAMESPACE\\Controller;

use OCP\\AppFramework\\Controller;
use OCP\\AppFramework\\Http\\TemplateResponse;
use OCP\\IRequest;
use OCP\\Util;

class PageController extends Controller {
    public function __construct(
        string \$appName,
        IRequest \$request
    ) {
        parent::__construct(\$appName, \$request);
    }

    /**
     * @NoAdminRequired
     * @NoCSRFRequired
     */
    public function index(): TemplateResponse {
        Util::addScript(\$this->appName, 'main');
        Util::addStyle(\$this->appName, 'main');
        
        return new TemplateResponse(\$this->appName, 'index');
    }
}
EOF

# 生成 package.json
cat > "apps/$APP_NAME/package.json" << EOF
{
  "name": "$APP_NAME",
  "version": "1.0.0",
  "description": "A Nextcloud application",
  "main": "src/main.js",
  "scripts": {
    "build": "webpack --mode production",
    "dev": "webpack --mode development",
    "watch": "webpack --mode development --watch",
    "lint": "eslint src",
    "lint:fix": "eslint src --fix"
  },
  "dependencies": {
    "@nextcloud/auth": "^2.0.0",
    "@nextcloud/axios": "^2.0.0",
    "@nextcloud/router": "^3.0.0",
    "@nextcloud/vue": "^8.0.0",
    "vue": "^3.0.0"
  },
  "devDependencies": {
    "@babel/core": "^7.0.0",
    "@babel/preset-env": "^7.0.0",
    "babel-loader": "^9.0.0",
    "css-loader": "^6.0.0",
    "eslint": "^8.0.0",
    "style-loader": "^3.0.0",
    "vue-loader": "^17.0.0",
    "webpack": "^5.0.0",
    "webpack-cli": "^5.0.0"
  }
}
EOF

# 生成 composer.json
cat > "apps/$APP_NAME/composer.json" << EOF
{
    "name": "nextcloud/$APP_NAME",
    "description": "A Nextcloud application",
    "type": "project",
    "license": "AGPL-3.0-or-later",
    "authors": [
        {
            "name": "$AUTHOR_NAME",
            "email": "$AUTHOR_EMAIL"
        }
    ],
    "require": {
        "php": ">=8.1"
    },
    "require-dev": {
        "phpunit/phpunit": "^10.0",
        "nextcloud/coding-standard": "^1.0"
    },
    "autoload": {
        "psr-4": {
            "OCA\\\\$NAMESPACE\\\\": "lib/"
        }
    },
    "autoload-dev": {
        "psr-4": {
            "OCA\\\\$NAMESPACE\\\\Tests\\\\": "tests/"
        }
    }
}
EOF

echo "Plugin $APP_NAME created successfully!"
echo "Next steps:"
echo "1. cd apps/$APP_NAME"
echo "2. composer install"
echo "3. npm install"
echo "4. npm run build"
echo "5. Enable the app in Nextcloud admin panel"
```

#### 1.2 数据库迁移生成器
```bash
#!/bin/bash
# scripts/create-migration.sh

APP_NAME=$1
MIGRATION_NAME=$2

if [ -z "$APP_NAME" ] || [ -z "$MIGRATION_NAME" ]; then
    echo "Usage: $0 <app_name> <migration_name>"
    exit 1
fi

NAMESPACE=$(echo $APP_NAME | sed 's/_//g' | sed 's/\b\w/\U&/g')
VERSION=$(date +%Y%m%d%H%M%S)
CLASS_NAME="Version1000Date${VERSION}"

MIGRATION_FILE="apps/$APP_NAME/lib/Migration/${CLASS_NAME}.php"

cat > "$MIGRATION_FILE" << EOF
<?php
namespace OCA\\$NAMESPACE\\Migration;

use Closure;
use OCP\\DB\\ISchemaWrapper;
use OCP\\Migration\\IOutput;
use OCP\\Migration\\SimpleMigrationStep;

class $CLASS_NAME extends SimpleMigrationStep {
    public function changeSchema(IOutput \$output, Closure \$schemaClosure, array \$options): ?ISchemaWrapper {
        /** @var ISchemaWrapper \$schema */
        \$schema = \$schemaClosure();

        // Add your schema changes here
        
        return \$schema;
    }
}
EOF

echo "Migration created: $MIGRATION_FILE"
```

### 2. 开发辅助脚本

#### 2.1 代码质量检查
```bash
#!/bin/bash
# scripts/check-quality.sh

APP_NAME=$1

if [ -z "$APP_NAME" ]; then
    echo "Usage: $0 <app_name>"
    exit 1
fi

cd "apps/$APP_NAME"

echo "🔍 Running code quality checks for $APP_NAME..."

# PHP代码检查
echo "📋 Checking PHP code style..."
if command -v php-cs-fixer &> /dev/null; then
    php-cs-fixer fix --dry-run --diff
else
    echo "⚠️  php-cs-fixer not found, skipping PHP style check"
fi

# PHP静态分析
echo "🔬 Running PHP static analysis..."
if command -v phpstan &> /dev/null; then
    phpstan analyse lib/ --level=5
else
    echo "⚠️  phpstan not found, skipping static analysis"
fi

# JavaScript代码检查
echo "📋 Checking JavaScript code style..."
if [ -f "package.json" ]; then
    npm run lint
else
    echo "⚠️  package.json not found, skipping JS lint"
fi

# 运行测试
echo "🧪 Running tests..."
if [ -f "vendor/bin/phpunit" ]; then
    vendor/bin/phpunit
else
    echo "⚠️  PHPUnit not found, skipping PHP tests"
fi

if [ -f "package.json" ] && grep -q "test" package.json; then
    npm test
else
    echo "⚠️  No JS tests configured"
fi

echo "✅ Quality check completed!"
```

#### 2.2 自动化构建脚本
```bash
#!/bin/bash
# scripts/build-app.sh

APP_NAME=$1
BUILD_TYPE=${2:-development}

if [ -z "$APP_NAME" ]; then
    echo "Usage: $0 <app_name> [development|production]"
    exit 1
fi

cd "apps/$APP_NAME"

echo "🏗️  Building $APP_NAME for $BUILD_TYPE..."

# 安装依赖
echo "📦 Installing dependencies..."
if [ -f "composer.json" ]; then
    composer install --no-dev --optimize-autoloader
fi

if [ -f "package.json" ]; then
    npm ci
fi

# 构建前端资源
echo "🎨 Building frontend assets..."
if [ "$BUILD_TYPE" = "production" ]; then
    npm run build
else
    npm run dev
fi

# 生成语言文件
echo "🌍 Generating language files..."
if command -v php &> /dev/null; then
    php ../../occ l10n:createjs $APP_NAME
fi

# 清理开发文件
if [ "$BUILD_TYPE" = "production" ]; then
    echo "🧹 Cleaning up development files..."
    rm -rf node_modules
    rm -rf tests
    rm -f package*.json
    rm -f webpack.config.js
    rm -f .eslintrc.js
fi

echo "✅ Build completed!"
```

#### 2.3 应用打包脚本
```bash
#!/bin/bash
# scripts/package-app.sh

APP_NAME=$1
VERSION=$2

if [ -z "$APP_NAME" ]; then
    echo "Usage: $0 <app_name> [version]"
    exit 1
fi

if [ -z "$VERSION" ]; then
    VERSION=$(grep -o '<version>[^<]*' "apps/$APP_NAME/appinfo/info.xml" | sed 's/<version>//')
fi

echo "📦 Packaging $APP_NAME version $VERSION..."

# 创建临时目录
TEMP_DIR=$(mktemp -d)
PACKAGE_DIR="$TEMP_DIR/$APP_NAME"

# 复制应用文件
cp -r "apps/$APP_NAME" "$PACKAGE_DIR"

# 进入应用目录进行构建
cd "$PACKAGE_DIR"

# 构建生产版本
../../../scripts/build-app.sh "$APP_NAME" production

# 返回原目录
cd - > /dev/null

# 创建压缩包
PACKAGE_NAME="${APP_NAME}-${VERSION}.tar.gz"
cd "$TEMP_DIR"
tar -czf "$PACKAGE_NAME" "$APP_NAME"

# 移动到输出目录
mv "$PACKAGE_NAME" "$OLDPWD/build/"

# 清理临时文件
rm -rf "$TEMP_DIR"

echo "✅ Package created: build/$PACKAGE_NAME"

# 生成签名（如果有私钥）
if [ -f "~/.nextcloud/certificates/${APP_NAME}.key" ]; then
    echo "🔐 Generating signature..."
    openssl dgst -sha512 -sign "~/.nextcloud/certificates/${APP_NAME}.key" "build/$PACKAGE_NAME" | openssl base64 > "build/${PACKAGE_NAME}.sig"
    echo "✅ Signature created: build/${PACKAGE_NAME}.sig"
fi
```

### 3. 调试工具

#### 3.1 日志监控脚本
```bash
#!/bin/bash
# scripts/monitor-logs.sh

APP_NAME=$1
LOG_LEVEL=${2:-info}

if [ -z "$APP_NAME" ]; then
    echo "Usage: $0 <app_name> [debug|info|warning|error]"
    exit 1
fi

echo "📊 Monitoring logs for $APP_NAME (level: $LOG_LEVEL)..."

# 监控Nextcloud日志
tail -f data/nextcloud.log | grep -i "$APP_NAME\|$LOG_LEVEL" --color=always &

# 监控Web服务器日志
if [ -f "/var/log/nginx/error.log" ]; then
    tail -f /var/log/nginx/error.log | grep -i "$APP_NAME" --color=always &
fi

if [ -f "/var/log/apache2/error.log" ]; then
    tail -f /var/log/apache2/error.log | grep -i "$APP_NAME" --color=always &
fi

# 等待用户中断
wait
```

#### 3.2 性能分析脚本
```bash
#!/bin/bash
# scripts/performance-test.sh

APP_NAME=$1
BASE_URL=${2:-"http://localhost:8080"}

if [ -z "$APP_NAME" ]; then
    echo "Usage: $0 <app_name> [base_url]"
    exit 1
fi

echo "⚡ Running performance tests for $APP_NAME..."

# API性能测试
echo "🔗 Testing API endpoints..."
if command -v ab &> /dev/null; then
    ab -n 100 -c 10 "$BASE_URL/apps/$APP_NAME/api/v1/items"
else
    echo "⚠️  Apache Bench (ab) not found"
fi

# 页面加载测试
echo "📄 Testing page load performance..."
if command -v curl &> /dev/null; then
    time curl -s "$BASE_URL/apps/$APP_NAME/" > /dev/null
else
    echo "⚠️  curl not found"
fi

# 内存使用分析
echo "💾 Analyzing memory usage..."
if command -v php &> /dev/null; then
    php -d memory_limit=512M -f occ app:enable "$APP_NAME"
    echo "Memory usage: $(php -r 'echo memory_get_peak_usage(true) / 1024 / 1024;') MB"
fi

echo "✅ Performance test completed!"
```

### 4. 测试工具

#### 4.1 自动化测试脚本
```bash
#!/bin/bash
# scripts/run-tests.sh

APP_NAME=$1
TEST_TYPE=${2:-all}

if [ -z "$APP_NAME" ]; then
    echo "Usage: $0 <app_name> [unit|integration|e2e|all]"
    exit 1
fi

cd "apps/$APP_NAME"

echo "🧪 Running tests for $APP_NAME (type: $TEST_TYPE)..."

# 单元测试
if [ "$TEST_TYPE" = "unit" ] || [ "$TEST_TYPE" = "all" ]; then
    echo "🔬 Running unit tests..."
    if [ -f "vendor/bin/phpunit" ]; then
        vendor/bin/phpunit tests/Unit/
    fi
    
    if [ -f "package.json" ] && grep -q "test:unit" package.json; then
        npm run test:unit
    fi
fi

# 集成测试
if [ "$TEST_TYPE" = "integration" ] || [ "$TEST_TYPE" = "all" ]; then
    echo "🔗 Running integration tests..."
    if [ -f "vendor/bin/phpunit" ]; then
        vendor/bin/phpunit tests/Integration/
    fi
    
    if [ -f "package.json" ] && grep -q "test:integration" package.json; then
        npm run test:integration
    fi
fi

# 端到端测试
if [ "$TEST_TYPE" = "e2e" ] || [ "$TEST_TYPE" = "all" ]; then
    echo "🌐 Running e2e tests..."
    if [ -f "package.json" ] && grep -q "test:e2e" package.json; then
        npm run test:e2e
    fi
fi

echo "✅ Tests completed!"
```

#### 4.2 测试数据生成器
```php
<?php
// scripts/generate-test-data.php

if ($argc < 2) {
    echo "Usage: php generate-test-data.php <app_name> [count]\n";
    exit(1);
}

$appName = $argv[1];
$count = isset($argv[2]) ? (int)$argv[2] : 10;

require_once __DIR__ . '/../lib/base.php';

\OC::$CLI = true;

try {
    $app = new \OCP\AppFramework\App($appName);
    $container = $app->getContainer();
    
    // 获取服务实例
    $service = $container->get("OCA\\{$appName}\\Service\\ItemService");
    
    echo "Generating {$count} test items for {$appName}...\n";
    
    for ($i = 1; $i <= $count; $i++) {
        $name = "Test Item {$i}";
        $description = "This is test item number {$i} generated automatically.";
        
        $item = $service->create($name, $description);
        echo "Created item {$i}: {$item->getName()}\n";
    }
    
    echo "Test data generation completed!\n";
    
} catch (Exception $e) {
    echo "Error: " . $e->getMessage() . "\n";
    exit(1);
}
```

### 5. 部署工具

#### 5.1 Docker开发环境
```dockerfile
# docker/Dockerfile.dev
FROM nextcloud:latest

# 安装开发工具
RUN apt-get update && apt-get install -y \
    git \
    nodejs \
    npm \
    composer \
    && rm -rf /var/lib/apt/lists/*

# 设置工作目录
WORKDIR /var/www/html

# 复制开发配置
COPY docker/config.php /var/www/html/config/

# 暴露端口
EXPOSE 80

# 启动命令
CMD ["apache2-foreground"]
```

```yaml
# docker-compose.dev.yml
version: '3.8'

services:
  nextcloud:
    build:
      context: .
      dockerfile: docker/Dockerfile.dev
    ports:
      - "8080:80"
    volumes:
      - ./apps:/var/www/html/apps
      - ./data:/var/www/html/data
    environment:
      - MYSQL_HOST=db
      - REDIS_HOST=redis
    depends_on:
      - db
      - redis

  db:
    image: mariadb:latest
    environment:
      - MYSQL_ROOT_PASSWORD=nextcloud
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=nextcloud
      - MYSQL_PASSWORD=nextcloud
    volumes:
      - db_data:/var/lib/mysql

  redis:
    image: redis:alpine
    
volumes:
  db_data:
```

#### 5.2 CI/CD配置
```yaml
# .github/workflows/test.yml
name: Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  php-tests:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        php-version: [8.1, 8.2, 8.3]
        nextcloud-version: [32, 33]
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ matrix.php-version }}
        extensions: mbstring, intl, gd, xml, zip, json, mysql, pgsql
        
    - name: Install dependencies
      run: composer install --prefer-dist --no-progress
      
    - name: Run tests
      run: vendor/bin/phpunit
      
  js-tests:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run linting
      run: npm run lint
      
    - name: Run tests
      run: npm test
```

## 📋 使用说明

### 安装开发工具
```bash
# 1. 克隆工具脚本
git clone <repository> nextcloud-dev-tools
cd nextcloud-dev-tools

# 2. 设置执行权限
chmod +x scripts/*.sh

# 3. 添加到PATH（可选）
export PATH=$PATH:$(pwd)/scripts
```

### 创建新插件
```bash
# 使用脚手架创建插件
./scripts/create-plugin.sh my_awesome_plugin MyAwesomePlugin "Your Name" "your.email@example.com"

# 进入插件目录
cd apps/my_awesome_plugin

# 安装依赖
composer install
npm install

# 构建前端资源
npm run build
```

### 开发工作流
```bash
# 1. 启动开发环境
docker-compose -f docker-compose.dev.yml up -d

# 2. 监控日志
./scripts/monitor-logs.sh my_awesome_plugin

# 3. 运行质量检查
./scripts/check-quality.sh my_awesome_plugin

# 4. 运行测试
./scripts/run-tests.sh my_awesome_plugin

# 5. 构建和打包
./scripts/build-app.sh my_awesome_plugin production
./scripts/package-app.sh my_awesome_plugin 1.0.0
```

这些工具和脚本将大大提高Nextcloud插件的开发效率，提供了从项目创建到部署的完整工具链支持。
